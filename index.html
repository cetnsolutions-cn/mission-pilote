<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portail Commercial Centralisé</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #f1ff9; user-select: none; -webkit-user-select: none; }
        .loader { border-top-color: #1e3a8a; -webkit-animation: spinner 1s linear infinite; animation: spinner 1s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Styles pour la navigation mobile */
        .mobile-nav-item { display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; color: #94a3b8; }
        .mobile-nav-item.active { color: #2563eb; font-weight: bold; }
        
        .suggestions-list { position: absolute; background: white; width: 100%; border: 1px solid #e2e8f0; border-radius: 0.5rem; z-index: 50; max-height: 200px; overflow-y: auto; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .suggestion-item { padding: 0.5rem 1rem; cursor: pointer; font-size: 0.875rem; }
        .suggestion-item:hover { background-color: #eff6ff; }
        
        /* Styles pour les popups */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 2rem; border-radius: 0.75rem; max-width: 400px; width: 90%; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        
        /* Style pour la popup d'erreur personnalisée */
        .error-popup { background: #fee2e2; border: 1px solid #fca5a5; color: #dc2626; padding: 1rem; border-radius: 0.5rem; }

        /* Animation pour la corbeille */
        @keyframes trash-shake {
            0%, 100% { transform: rotate(0deg); }
            10%, 30%, 50%, 70%, 90% { transform: rotate(5deg); }
            20%, 40%, 60%, 80% { transform: rotate(-5deg); }
        }
        .animate-trash:hover svg {
            animation: trash-shake 0.5s ease-in-out;
        }
    </style>
</head>
<body oncontextmenu="return false;">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDoc, deleteDoc, doc, setDoc, query, orderBy, limit, getDocs, updateDoc, onSnapshot, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // --- CONFIGURATION BDD ---
        const firebaseConfig = {
            apiKey: "AIzaSyA7-qZ8z9ET27RnWJiZBkYPsJdn3XU8ckg",
            authDomain: "rdv-message.firebaseapp.com",
            projectId: "rdv-message",
            storageBucket: "rdv-message.firebasestorage.app",
            messagingSenderId: "262090614175",
            appId: "1:262090614175:web:921a04c11d66e4d1a7c9aa",
            measurementId: "G-YCGJ44WY7L"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const secondaryApp = initializeApp(firebaseConfig, "Secondary");
        const secondaryAuth = getAuth(secondaryApp);

        const { useState, useEffect, useCallback } = React;
        const { jsPDF } = window.jspdf;

        // --- MAPPAGE DES STATUTS ---
        const StatusMap = {
            Pending: { label: "En attente", color: "orange" },
            Envoyé: { label: "Envoyé", color: "blue" },
            Reflection: { label: "En réflexion", color: "yellow" },
            Signed: { label: "Signé", color: "green" },
            Abandoned: { label: "Abandonné", color: "slate" },
            RequestDelete: { label: "Demande Suppr.", color: "red" }
        };

        const Icon = ({ name, size = 20, className }) => {
            const icons = {
                search: '<circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>',
                calendar: '<rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>',
                car: '<rect x="3" y="10" width="18" height="8" rx="2"></rect><path d="M5 10l2-5h10l2 5"></path><line x1="12" y1="15" x2="12" y2="15"></line>',
                settings: '<circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>',
                save: '<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline>',
                trash: '<polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>',
                users: '<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path>',
                download: '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line>',
                list: '<line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line>',
                phone: '<path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>',
                mail: '<path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline>',
                mapPin: '<path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle>',
                link: '<path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>',
                briefcase: '<rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>',
                lock: '<rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path>',
                unlock: '<rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"></path>',
                power: '<path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path><line x1="12" y1="2" x2="12" y2="12"></line>',
                eye: '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>',
                eyeOff: '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>',
                key: '<path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path>',
                layout: '<rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line>',
                fileText: '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline>',
                edit: '<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>',
                check: '<polyline points="20 6 9 17 4 12"></polyline>',
                x: '<line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>',
                refreshCw: '<path d="M23 4v6h-6"></path><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>',
                bell: '<path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path>',
                smile: '<circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line>'
            };
            return React.createElement('svg', {
                xmlns: "http://www.w3.org/2000/svg",
                width: size, height: size, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round",
                className: className,
                dangerouslySetInnerHTML: { __html: icons[name] || '' }
            });
        };

        // --- MOTEUR PDF (Inchangé) ---
        const generateOrderPDF = (orderData, settings) => {
            const doc = new jsPDF();
            
            const colors = {
                darkBlue: [15, 23, 42],
                accent: [59, 130, 246],
                text: [51, 65, 85],
                lightBg: [248, 250, 252],
                white: [255, 255, 255]
            };

            const taxLabel = settings.taxType || "HT";

            // 1. BANDEAU
            doc.setFillColor(...colors.darkBlue);
            doc.rect(0, 0, 210, 50, 'F');

            if (settings.logo) {
                try {
                    doc.addImage(settings.logo, 'PNG', 15, 10, 40, 30, undefined, 'FAST');
                } catch(e) {}
            }

            doc.setFont("helvetica", "bold");
            doc.setFontSize(24);
            doc.setTextColor(...colors.white);
            doc.text("ORDRE DE COMMANDE", 200, 25, { align: "right" });
            
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(200, 200, 200);
            
            const refString = orderData.reference || "N/A";
            const dateToDisplay = orderData.createdAt && orderData.createdAt.seconds ? orderData.createdAt.seconds * 1000 : (orderData.createdAt || new Date());
            doc.text(`RÉF: ${refString}`, 200, 35, { align: "right" });
            doc.text(`Date: ${new Date(dateToDisplay).toLocaleDateString('fr-FR')}`, 200, 40, { align: "right" });

            doc.setFillColor(255, 255, 255);
            doc.roundedRect(145, 55, 55, 10, 1, 1, 'F');
            doc.setFontSize(9);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(220, 38, 38);
            doc.text("SEMAINE PILOTE - SANS ENGAGEMENT", 172.5, 61, { align: "center" });

            // 2. INFOS
            let y = 75;
            doc.setFontSize(9);
            doc.setTextColor(...colors.text);
            doc.setFont("helvetica", "bold");
            doc.text("PRESTATAIRE", 15, y);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(0);
            y += 5;
            doc.text(settings.myCompanyName || "Votre Société", 15, y);
            doc.text(settings.myAddress || "", 15, y+5);
            doc.text(settings.myEmail || "", 15, y+10);
            if(settings.mySiret) doc.text(`SIRET: ${settings.mySiret}`, 15, y+15);

            // BOX CLIENT
            doc.setFont("helvetica", "bold");
            doc.setTextColor(...colors.darkBlue);
            doc.text("CLIENT", 115, 80);
            
            doc.setTextColor(0);
            doc.setFontSize(11);
            doc.text(orderData.companyName || "Nom Client", 115, 88);
            
            doc.setFont("helvetica", "normal");
            doc.setFontSize(9);
            
            const addressLines = doc.splitTextToSize(orderData.address || "Adresse", 85);
            doc.text(addressLines, 115, 94);
            
            let yAfterAddress = 94 + (addressLines.length * 4);
            
            const sirenDisplay = (orderData.siren === "EN COURS") ? "EN COURS D'IMMATRICULATION" : orderData.siren;
            doc.text(`SIREN: ${sirenDisplay}`, 115, yAfterAddress);
            
            if(orderData.clientEmail) {
                doc.text(orderData.clientEmail, 115, yAfterAddress + 5);
            }

            // 3. TABLEAU
            y = 130;
            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(...colors.darkBlue);
            doc.text("DÉTAILS DE LA MISSION", 15, y);

            y += 5;
            doc.setFillColor(...colors.darkBlue);
            doc.rect(15, y, 180, 10, 'F');
            doc.setTextColor(...colors.white);
            doc.setFontSize(9);
            doc.text("DESCRIPTION", 20, y+6.5);
            doc.text("DÉTAIL / VALEUR", 130, y+6.5);
            
            y += 10;

            const repCount = parseInt(orderData.salesRepsCount) || 1;
            const repLabel = repCount > 1 ? "Commerciaux" : "Commercial";

            const rows = [
                ["Période d'essai", `Du ${new Date(orderData.startDate).toLocaleDateString('fr-FR')} au ${new Date(orderData.endDate).toLocaleDateString('fr-FR')} (7 jours)`],
                ["Type de mission", "Qualification de leads automobiles"],
                ["Nombre de Commerciaux", `${repCount} ${repLabel}`],
                ["Plafond RDV (Semaine Pilote)", `${orderData.maxRdvTotal || '-'} RDV Max / Semaine`],
                ["Tarif Unitaire", `${orderData.ratePerAppointment} € ${taxLabel} / RDV`],
                ["Zone d'intervention", `${orderData.radiusKm} km autour de l'agence`],
                ["Critères Véhicule", `Max ${orderData.maxKmPerVehicle} km | Année > ${orderData.minVehicleYear}`]
            ];

            if (orderData.excludedVehicles && orderData.excludedVehicles.trim() !== "") {
                rows.push(["Modèles Exclus", orderData.excludedVehicles]);
            }

            rows.forEach((row, i) => {
                if (i % 2 === 0) {
                    doc.setFillColor(248, 250, 252);
                    doc.rect(15, y, 180, 8, 'F');
                }
                doc.setTextColor(...colors.text);
                doc.setFont("helvetica", "normal");
                doc.text(row[0], 20, y+5.5);
                doc.setFont("helvetica", "bold");
                doc.setTextColor(0);
                doc.text(row[1], 130, y+5.5);
                doc.setDrawColor(226, 232, 240);
                doc.line(15, y+8, 195, y+8);
                y += 8;
            });

            // 4. SIGNATURES
            y = 225;
            doc.setDrawColor(200);
            doc.setLineWidth(0.5);
            doc.line(15, y-5, 195, y-5);

            doc.setFontSize(8);
            doc.setTextColor(...colors.text);
            doc.text("POUR LE PRESTATAIRE", 15, y);
            doc.text("Cachet et Signature :", 15, y+5);
            
            if (settings.stamp) {
                try {
                    doc.addImage(settings.stamp, 'PNG', 15, y+8, 35, 25, undefined, 'FAST');
                } catch(e) {}
            }

            doc.text("POUR LE CLIENT", 120, y);
            doc.text("Date, Cachet et Signature :", 120, y+5);
        
            
            doc.setDrawColor(200);
            doc.rect(120, y+13, 75, 25);

            // 5. CONDITIONS GÉNÉRALES
            y = 270;
            doc.setFontSize(7);
            doc.setTextColor(100);
            doc.setFont("helvetica", "bold");
            doc.text("CONDITIONS GÉNÉRALES DE PRESTATION :", 15, y);
            doc.setFont("helvetica", "normal");
            y += 4;
            
            const cgvLines = [
                `1. Le prestataire s'engage à fournir des rendez-vous qualifiés selon les critères définis ci-dessus.`,
                `2. Seuls les rendez-vous honorés (prospect présent au rendez-vous et qualifié) seront facturés au tarif de ${orderData.ratePerAppointment} € ${taxLabel}.`,
                `3. La durée et l'engagement de mission est valable pour une durée de une semaine (7 jours) selon les dates prédéfinies ci-dessus.`,
                `4. Mission sans engagement et sans renouvellement : à l'issue de la semaine, le client est libre d'arrêter ou de signer un contrat de collaboration.`,
                `5. Le client s'engage à fournir un accès à son agenda pour permettre la pose des créneaux.`
            ];

            cgvLines.forEach(line => {
                doc.text(line, 15, y);
                y += 3.5;
            });
        
            doc.save(`Ordre_${refString}.pdf`);
        };

        // --- UTILS (Inchangé) ---

        // Fonction de formatage pour le numéro de téléphone (X XX XX XX XX)
        const formatPhoneNumber = (value) => {
            if (!value) return value;
            const numbersOnly = value.replace(/[^\d]/g, '');
            let formatted = '';

            for (let i = 0; i < numbersOnly.length; i++) {
                if (i > 0 && i % 2 === 0) {
                    formatted += ' ';
                }
                formatted += numbersOnly[i];
            }
            return formatted.substring(0, 14); // Limite à 10 chiffres + 4 espaces
        };

        // --- MODALE DE SUCCÈS POUR LE PDF (Inchangé) ---
        const SuccessModal = ({ isOpen, onClose, reference, isEditing }) => {
            if (!isOpen) return null;

            return React.createElement('div', { className: "modal-overlay" },
                React.createElement('div', { className: "modal-content w-full max-w-sm text-center" },
                    React.createElement('div', { className: "h-16 w-16 bg-green-100 rounded-full flex items-center justify-center text-green-600 mx-auto mb-4" },
                        React.createElement(Icon, { name: "check", size: 32 })
                    ),
                    React.createElement('h3', { className: "text-xl font-bold text-slate-800 mb-2" }, isEditing ? "Mise à jour réussie !" : "Commande générée !"),
                    React.createElement('p', { className: "text-slate-600 mb-6" },
                        `Le PDF de l'ordre de commande ${reference} a été ${isEditing ? 'mis à jour et téléchargé' : 'généré et téléchargé'} avec succès. Le statut est désormais : ${isEditing ? 'En attente' : 'En attente'}.`
                    ),
                    React.createElement('button', {
                        onClick: onClose,
                        className: "w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition"
                    }, "Fermer et continuer")
                )
            );
        };


        // --- COMPONENTS ---

        function Login({ onLogin }) {
            // ... (Inchangé)
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [showPassword, setShowPassword] = useState(false);
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (err) {
                    setError("Identifiants incorrects ou compte bloqué.");
                    setLoading(false);
                }
            };

            return React.createElement('div', { className: "min-h-screen flex items-center justify-center bg-slate-900 p-4" },
                React.createElement('div', { className: "bg-white rounded-xl shadow-2xl p-8 max-w-md w-full" },
                    React.createElement('div', { className: "text-center mb-8" },
                        React.createElement('h1', { className: "text-2xl font-bold text-slate-800" }, "PORTAIL PARTENAIRE"),
                        React.createElement('p', { className: "text-slate-500 text-sm mt-2" }, "Connectez-vous à votre espace centralisé.")
                    ),
                    React.createElement('form', { onSubmit: handleLogin, className: "space-y-6" },
                        React.createElement('div', null,
                            React.createElement('label', { className: "block text-sm font-medium text-slate-700 mb-1" }, "Email"),
                            React.createElement('input', {
                                type: "email",
                                required: true,
                                value: email,
                                onChange: (e) => setEmail(e.target.value),
                                className: "w-full border border-slate-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 outline-none"
                            })
                        ),
                        React.createElement('div', null,
                            React.createElement('label', { className: "block text-sm font-medium text-slate-700 mb-1" }, "Mot de passe"),
                            React.createElement('div', { className: "relative" },
                                React.createElement('input', {
                                    type: showPassword ? "text" : "password",
                                    required: true,
                                    value: password,
                                    onChange: (e) => setPassword(e.target.value),
                                    className: "w-full border border-slate-300 rounded-lg px-4 py-2 pr-12 focus:ring-2 focus:ring-blue-500 outline-none"
                                }),
                                React.createElement('button', {
                                    type: "button",
                                    onClick: () => setShowPassword(!showPassword),
                                    className: "absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 transition",
                                    title: showPassword ? "Masquer" : "Afficher"
                                }, React.createElement(Icon, { name: showPassword ? "eyeOff" : "eye", size: 20 }))
                            )
                        ),
                        error && React.createElement('p', { className: "text-red-500 text-sm text-center" }, error),
                        React.createElement('button', {
                            type: "submit",
                            disabled: loading,
                            className: "w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-3 rounded-lg transition flex justify-center"
                        }, loading ? "Connexion..." : "Se connecter")
                    )
                )
            );
        }

        // --- DASHBOARD LAYOUT ---
        function DashboardLayout({ user, userData, globalSettings, db, isAdmin, setView, currentOrder, setCurrentOrder, allSalesReps }) {
            const [currentModule, setCurrentModule] = useState('generator');
            const [showSuccessModal, setShowSuccessModal] = useState(null);

            const allMenuItems = [
                { id: 'generator', label: 'Générateur', icon: 'layout' },
                { id: 'myOrders', label: 'Mes Demandes', icon: 'list' },
                { id: 'profile', label: 'Mon Profil', icon: 'users' },
            ];

            const menuItems = allMenuItems;
            
            const getRoleLabel = (role) => {
                if (role === 'admin') return 'ADMINISTRATEUR';
                if (role === 'intern') return 'STAGIAIRE';
                return 'COMMERCIAL';
            };

            const renderModule = () => {
                switch(currentModule) {
                    case 'generator':
                        return React.createElement(FormPanel, {
                            user,
                            userData,
                            globalSettings,
                            db,
                            isAdmin,
                            setCurrentModule,
                            currentOrder,
                            setCurrentOrder,
                            setShowSuccessModal
                        });
                    case 'myOrders':
                        return React.createElement(MyOrdersModule, {
                            user,
                            userData,
                            db,
                            globalSettings,
                            setCurrentModule,
                            setCurrentOrder,
                            isAdmin,
                            allSalesReps
                        });
                    case 'profile':
                        return React.createElement(CommercialProfileModule, { user, userData, db });
                    default:
                        return React.createElement(FormPanel, { user, userData, globalSettings, db, isAdmin, setCurrentModule, currentOrder, setCurrentOrder, setShowSuccessModal });
                }
            };
            
            // Fonction pour naviguer vers l'admin (onglet Corbeille)
            const goToAdminTrash = () => {
                if(isAdmin) {
                    setView('admin', 'trash'); 
                } else {
                    alert("Accès refusé.");
                }
            };

            return React.createElement('div', { className: "min-h-screen bg-slate-100 flex flex-col md:flex-row" },
            
                // SIDEBAR (Desktop)
                React.createElement('aside', { className: "hidden md:flex flex-col w-64 bg-slate-900 text-white h-screen sticky top-0" },
                    React.createElement('div', { className: "p-8 border-b border-slate-800 flex flex-col items-center text-center" },
                        // Photo de profil ou Initiale
                        userData?.photoURL
                            ? React.createElement('img', {
                                src: userData.photoURL,
                                className: "h-24 w-24 rounded-full object-cover border-4 border-slate-700 shadow-lg mb-4"
                              })
                            : React.createElement('div', { className: "h-24 w-24 rounded-full bg-slate-800 border-4 border-slate-700 flex items-center justify-center text-slate-500 mb-4 shadow-lg" },
                                React.createElement(Icon, { name: "users", size: 40 })
                              ),
                            
                        // Nom de l'utilisateur
                        React.createElement('h1', { className: "font-bold text-lg tracking-tight text-white" }, userData?.name || "Utilisateur"),
                            
                        // Rôle
                        React.createElement('div', { className: "mt-2 bg-slate-800 px-3 py-1 rounded-full border border-slate-700" },
                            React.createElement('p', { className: "text-[10px] text-blue-400 uppercase font-bold tracking-wider" }, getRoleLabel(userData?.role))
                        )
                    ),

                    React.createElement('nav', { className: "flex-1 p-4 space-y-2 mt-4" },
                        menuItems.map(item =>
                            React.createElement('button', {
                                key: item.id,
                                onClick: () => setCurrentModule(item.id),
                                className: `w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all ${currentModule === item.id ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`
                            },
                                React.createElement(Icon, { name: item.icon, size: 20 }),
                                React.createElement('span', { className: "font-medium" }, item.label)
                            )
                        )
                    ),
                    React.createElement('div', { className: "p-4 border-t border-slate-800 space-y-2" },
                        // NOUVEL ONGLET CORBEILLE DANS LE DASHBOARD POUR L'ADMIN
                        isAdmin && React.createElement('button', {
                            onClick: goToAdminTrash,
                            className: "w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-red-400 transition"
                        }, React.createElement(Icon, { name: "trash", size: 20 }), "Corbeille (Demandes Suppr.)"),
                        
                        // BOUTON ADMINISTRATION PRINCIPAL
                        isAdmin && React.createElement('button', {
                            onClick: () => setView('admin', 'orders'),
                            className: "w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-yellow-400 transition relative"
                        }, 
                            React.createElement(Icon, { name: "settings", size: 20 }), 
                            "Administration"
                        ),
                            
                        React.createElement('button', {
                            onClick: () => signOut(auth),
                            className: "w-full flex items-center gap-3 px-4 py-3 rounded-lg text-red-400 hover:bg-red-900/20 transition"
                        }, React.createElement(Icon, { name: "power", size: 20 }), "Déconnexion")
                    )
                ),

                // MAIN CONTENT
                React.createElement('div', { className: "flex-1 flex flex-col h-screen overflow-hidden" },
                    // Mobile Header
                    React.createElement('header', { className: "md:hidden bg-white border-b border-gray-200 p-4 flex justify-between items-center sticky top-0 z-50 shadow-sm" },
                            
                        // Partie Gauche : Avatar + Infos
                        React.createElement('div', { className: "flex items-center gap-3" },
                            userData?.photoURL
                            ? React.createElement('img', { src: userData.photoURL, className: "h-10 w-10 rounded-full object-cover border border-slate-200" })
                            : React.createElement('div', { className: "h-10 w-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 border border-slate-200" }, React.createElement(Icon, { name: "users", size: 20 })),
                            
                            React.createElement('div', null,
                                React.createElement('h1', { className: "font-bold text-slate-800 text-sm leading-tight" }, userData?.name || "Utilisateur"),
                                React.createElement('p', { className: "text-[10px] text-blue-600 font-bold uppercase" }, getRoleLabel(userData?.role))
                            )
                        ),

                        React.createElement('div', { className: "flex gap-4" },
                            isAdmin && React.createElement('button', { onClick: goToAdminTrash, className: "text-slate-600" }, React.createElement(Icon, { name: "trash" })),
                            isAdmin && React.createElement('button', { onClick: () => setView('admin', 'orders'), className: "text-slate-600" }, React.createElement(Icon, { name: "settings" })),
                            React.createElement('button', { onClick: () => signOut(auth), className: "text-red-500" }, React.createElement(Icon, { name: "power" }))
                        )
                    ),
                    
                    // Mobile Nav (En haut)
                    React.createElement('nav', { className: "md:hidden bg-white border-b border-gray-200 flex justify-around p-2 z-40" },
                        menuItems.map(item =>
                            React.createElement('button', {
                                key: item.id,
                                onClick: () => setCurrentModule(item.id),
                                className: `mobile-nav-item ${currentModule === item.id ? 'active' : ''} p-2`
                            },
                                React.createElement(Icon, { name: item.icon, size: 24 }),
                                React.createElement('span', { className: "mt-1" }, item.label)
                            )
                        )
                    ),

                    // Module Content Area
                    React.createElement('main', { className: "flex-1 overflow-y-auto p-4 md:p-8" },
                        renderModule()
                    ),
                    
                    // Modale de Succès
                    React.createElement(SuccessModal, {
                        isOpen: !!showSuccessModal,
                        onClose: () => setShowSuccessModal(null),
                        reference: showSuccessModal?.reference,
                        isEditing: showSuccessModal?.isEditing
                    })
                )
            );
        }

        // --- MODULE MES DEMANDES (Inchangé) ---
        function MyOrdersModule({ user, db, globalSettings, setCurrentModule, setCurrentOrder, isAdmin, allSalesReps }) {
            const [orders, setOrders] = useState([]);
            const [loading, setLoading] = useState(true);
            const [deleteModal, setDeleteModal] = useState(null);
            const [selectedRepId, setSelectedRepId] = useState('Me');
            const [confirmDeleteModal, setConfirmDeleteModal] = useState(null);
            const [salesRepsMap, setSalesRepsMap] = useState({});

            useEffect(() => {
                if (allSalesReps) {
                    const map = {};
                    allSalesReps.forEach(rep => {
                        map[rep.id] = rep.name;
                    });
                    setSalesRepsMap(map);
                }
            }, [allSalesReps]);


            // --- LOGIQUE DE FILTRAGE DES COMMANDES ---
            const fetchOrders = useCallback(() => {
                const ordersRef = collection(db, "orders");
                let q;
                
                if (isAdmin) {
                    if (selectedRepId === 'All') {
                        q = query(ordersRef);
                    } else if (selectedRepId === 'Me') {
                        q = query(ordersRef, where("salesRepId", "==", user.uid));
                    } else {
                        q = query(ordersRef, where("salesRepId", "==", selectedRepId));
                    }
                } else {
                    q = query(ordersRef, where("salesRepId", "==", user.uid));
                }

                const unsubscribe = onSnapshot(q, (snap) => {
                    const fetchedOrders = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    fetchedOrders.sort((a, b) => {
                        const dateA = a.createdAt?.seconds || 0;
                        const dateB = b.createdAt?.seconds || 0;
                        return dateB - dateA;
                    });
                    setOrders(fetchedOrders);
                    setLoading(false);
                }, (error) => {
                    console.error("Erreur de récupération des commandes:", error);
                    setLoading(false);
                });
                return unsubscribe;
            }, [user.uid, db, selectedRepId, isAdmin]);

            useEffect(() => {
                if (!isAdmin && selectedRepId !== 'Me') {
                    setSelectedRepId('Me');
                }
                const unsubscribe = fetchOrders();
                return () => unsubscribe();
            }, [fetchOrders, isAdmin]);
            // --- FIN LOGIQUE DE FILTRAGE ---


            const instantDeleteOrder = async (orderId, orderRef) => {
                try {
                    await deleteDoc(doc(db, "orders", orderId));
                    alert(`Commande ${orderRef} supprimée.`);
                    setConfirmDeleteModal(null);
                } catch (e) {
                    console.error("Erreur de suppression:", e);
                    alert("Erreur lors de la suppression de la commande.");
                    setConfirmDeleteModal(null);
                }
            };

            const AdminDeleteConfirmationModal = () => {
                if (!confirmDeleteModal) return null;
                const { id, ref } = confirmDeleteModal;
                return React.createElement('div', { className: "modal-overlay" },
                    React.createElement('div', { className: "modal-content" },
                        React.createElement('h3', { className: "text-xl font-bold text-red-700 mb-4 flex items-center gap-2" },
                            React.createElement(Icon, { name: "trash", size: 24, className: "text-red-500" }),
                            "CONFIRMER LA SUPPRESSION"
                        ),
                        React.createElement('p', { className: "text-slate-600 mb-6" },
                            `Vous êtes sur le point de supprimer IMMÉDIATEMENT la commande ${ref}. Cette action est irréversible.`
                        ),
                        React.createElement('div', { className: "flex justify-end gap-3" },
                            React.createElement('button', {
                                onClick: () => setConfirmDeleteModal(null),
                                className: "px-4 py-2 text-slate-600 bg-slate-100 rounded-lg hover:bg-slate-200 transition"
                            }, "Annuler"),
                            React.createElement('button', {
                                onClick: () => instantDeleteOrder(id, ref),
                                className: "px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 transition"
                            }, "Supprimer Définitivement")
                        )
                    )
                );
            };
            
            // Gestion visuelle des statuts (Mise à jour pour les nouveaux statuts)
            const getStatusColorClass = (status) => {
                const statusInfo = StatusMap[status];
                const color = statusInfo ? statusInfo.color : 'slate';

                switch(color) {
                    case 'orange': return "bg-orange-50 text-orange-800 border-orange-200";
                    case 'blue': return "bg-blue-50 text-blue-800 border-blue-200";
                    case 'yellow': return "bg-yellow-50 text-yellow-800 border-yellow-200";
                    case 'green': return "bg-green-50 text-green-800 border-green-200";
                    case 'red': return "bg-red-50 text-red-800 border-red-200";
                    case 'slate': default: return "bg-slate-100 text-slate-500 border-slate-200";
                }
            };
            
            // Logique de modification du statut via le Select
            const handleStatusChange = async (orderId, newStatus) => {
                try {
                    // Conservez la valeur "Generated" en arrière-plan si vous en avez besoin pour d'autres raisons (PDF ou autres)
                    // Mais dans l'interface, nous utilisons "Envoyé".
                    const finalStatus = newStatus === 'Envoyé' ? 'Envoyé' : newStatus;
                    
                    await updateDoc(doc(db, "orders", orderId), { status: finalStatus });
                } catch(e) {
                    console.error("Erreur mise à jour statut:", e);
                    alert("Erreur lors de la mise à jour du statut.");
                }
            };

            const submitDeleteRequest = async () => {
                if (!deleteModal.reason.trim()) return alert("Veuillez entrer un motif de suppression.");
                try {
                    await updateDoc(doc(db, "orders", deleteModal.id), {
                        status: 'RequestDelete',
                        deleteReason: deleteModal.reason,
                        deleteRequestDate: new Date()
                    });
                    setDeleteModal(null);
                    alert("Demande de suppression envoyée à l'administrateur.");
                } catch(e) {
                    console.error("Erreur demande suppression:", e);
                    alert("Erreur lors de l'envoi de la demande de suppression.");
                }
            };

            const handleEdit = (order) => {
                setCurrentOrder(order);
                setCurrentModule('generator');
            };
            
            const DeleteConfirmationModal = () => {
                if (!deleteModal) return null;
                return React.createElement('div', { className: "modal-overlay" },
                    React.createElement('div', { className: "modal-content" },
                        React.createElement('h3', { className: "text-xl font-bold text-red-600 mb-4" }, "Demande de Suppression"),
                        React.createElement('p', { className: "text-slate-600 mb-4" }, `Vous êtes sur le point de demander la suppression de la commande ${deleteModal.reference}. Cette action doit être approuvée par un administrateur.`),
                        React.createElement('label', { className: "block text-sm font-medium text-slate-700 mb-1" }, "Motif de la suppression (Obligatoire)"),
                        React.createElement('textarea', {
                            className: "w-full border border-slate-300 rounded-lg p-2 mb-6",
                            rows: 3,
                            value: deleteModal.reason,
                            onChange: (e) => setDeleteModal({...deleteModal, reason: e.target.value})
                        }),
                        React.createElement('div', { className: "flex justify-end gap-3" },
                            React.createElement('button', { onClick: () => setDeleteModal(null), className: "px-4 py-2 text-slate-600 bg-slate-100 rounded-lg hover:bg-slate-200 transition" }, "Annuler"),
                            React.createElement('button', { onClick: submitDeleteRequest, disabled: !deleteModal.reason.trim(), className: "px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 disabled:opacity-50 transition" }, "Envoyer la demande")
                        )
                    )
                );
            };

            if (loading) return React.createElement('div', { className: "text-center py-10" }, "Chargement des commandes...");

            return React.createElement('div', { className: "max-w-7xl mx-auto" },
                React.createElement('h1', { className: "text-2xl font-bold text-slate-800 mb-6" }, "Liste de mes demandes"),
                
                // --- CONTRÔLE DE FILTRAGE ADMIN ---
                isAdmin && allSalesReps && React.createElement('div', { className: "bg-white p-4 rounded-xl shadow-sm mb-6 flex items-center gap-4" },
                    React.createElement('label', { className: "text-sm font-medium text-slate-700" }, "Afficher les commandes de :"),
                    React.createElement('select', {
                        value: selectedRepId,
                        onChange: (e) => setSelectedRepId(e.target.value),
                        className: "border border-slate-300 rounded-lg px-3 py-2 text-sm bg-white font-medium"
                    },
                        React.createElement('option', { value: "Me" }, "Mes demandes"),
                        React.createElement('option', { value: "All" }, "Toutes les demandes"),
                        allSalesReps.filter(rep => rep.id !== user.uid).map(rep => (
                            React.createElement('option', { key: rep.id, value: rep.id }, rep.name)
                        ))
                    )
                ),
                // --- FIN CONTRÔLE DE FILTRAGE ADMIN ---

                orders.length === 0
                    ? React.createElement('p', { className: "text-slate-500 bg-white p-6 rounded-xl shadow-sm" }, "Aucune commande trouvée selon le filtre sélectionné.")
                    : React.createElement('div', { className: "bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden" },
                        React.createElement('div', { className: "overflow-x-auto" },
                            React.createElement('table', { className: "w-full text-left" },
                                React.createElement('thead', { className: "bg-slate-50 text-[10px] md:text-xs uppercase text-slate-500 font-bold tracking-wider" },
                                    React.createElement('tr', null,
                                        React.createElement('th', { className: "p-3" }, "Réf & Client"),
                                        React.createElement('th', { className: "p-3 hidden md:table-cell" }, "Commercial"),
                                        React.createElement('th', { className: "p-3" }, "Statut"),
                                        React.createElement('th', { className: "p-3 hidden md:table-cell" }, "Date Création"),
                                        React.createElement('th', { className: "p-3 text-right" }, "Actions")
                                    )
                                ),
                                React.createElement('tbody', { className: "text-xs md:text-sm divide-y divide-slate-100" },
                                    orders.map(o => React.createElement('tr', { key: o.id, className: "hover:bg-slate-50 transition-colors" },
                                        React.createElement('td', { className: "p-3" },
                                            React.createElement('div', { className: "font-mono font-bold text-blue-600" }, o.reference),
                                            React.createElement('div', { className: "text-slate-700 font-medium" }, o.companyName)
                                        ),
                                        
                                        // --- COLONNE COMMERCIAL ---
                                        React.createElement('td', { className: "p-3 hidden md:table-cell text-indigo-600 font-medium" },
                                            salesRepsMap[o.salesRepId] || o.salesRepName || 'N/A'
                                        ),
                                        
                                        // --- COLONNE STATUT AVEC SELECTEUR (Statuts simplifiés) ---
                                        React.createElement('td', { className: "p-3" },
                                            o.status === 'RequestDelete'
                                            ? React.createElement('span', { className: "bg-red-100 text-red-800 text-[10px] px-2 py-1 rounded-full font-bold border border-red-200" }, StatusMap[o.status].label)
                                            : React.createElement('select', {
                                                value: o.status === 'Generated' ? 'Envoyé' : o.status,
                                                onChange: (e) => handleStatusChange(o.id, e.target.value),
                                                className: `text-[11px] font-bold rounded-lg block p-1.5 border outline-none cursor-pointer transition ${getStatusColorClass(o.status === 'Generated' ? 'Envoyé' : o.status)}`
                                            },
                                                Object.keys(StatusMap).filter(k => k !== 'RequestDelete' && k !== 'Abandoned').map(key => (
                                                    React.createElement('option', { key: key, value: key }, StatusMap[key].label)
                                                )),
                                                React.createElement('option', { value: "Abandoned" }, StatusMap.Abandoned.label)
                                            )
                                        ),

                                        React.createElement('td', { className: "p-3 hidden md:table-cell whitespace-nowrap text-slate-500" },
                                            o.createdAt.seconds ? new Date(o.createdAt.seconds * 1000).toLocaleDateString() : '-'
                                        ),
                                        React.createElement('td', { className: "p-3 text-right" },
                                            React.createElement('div', { className: "flex justify-end gap-2 flex-wrap" },
                                                
                                                
                                                // 1. Télécharger
                                                React.createElement('button', { onClick: () => generateOrderPDF(o, globalSettings), className: "text-blue-600 bg-blue-50 hover:bg-blue-100 p-2 rounded-lg transition", title: "Télécharger PDF" }, React.createElement(Icon, { name: "download", size: 16 })),
                                                
                                                // 2. Modifier (possible uniquement si pas signé ni en suppression)
                                                o.status !== 'Signed' && o.status !== 'RequestDelete' && React.createElement('button', { onClick: () => handleEdit(o), className: "text-indigo-600 bg-indigo-50 hover:bg-indigo-100 p-2 rounded-lg transition", title: "Modifier le bon" }, React.createElement(Icon, { name: "edit", size: 16 })),
                                                
                                                // 3. Bouton Supprimer: Logique Admin vs Commercial
                                                o.status !== 'RequestDelete' && (
                                                    isAdmin
                                                    ? React.createElement('button', {
                                                        onClick: () => setConfirmDeleteModal({ id: o.id, ref: o.reference }),
                                                        className: "text-red-600 bg-red-50 hover:bg-red-100 p-2 rounded-lg transition",
                                                        title: "Suppression Immédiate (Admin)"
                                                      }, React.createElement(Icon, { name: "trash", size: 16 }))
                                                    : React.createElement('button', {
                                                        onClick: () => setDeleteModal({ id: o.id, reference: o.reference, reason: '' }),
                                                        className: "text-red-600 bg-red-50 hover:bg-red-100 p-2 rounded-lg transition",
                                                        title: "Demander Suppression (Motif requis)"
                                                      }, React.createElement(Icon, { name: "trash", size: 16 }))
                                                )
                                            )
                                        )
                                    ))
                                )
                            )
                        )
                    ),
                    DeleteConfirmationModal(),
                    AdminDeleteConfirmationModal()
            );
        }

        // --- MODULE GENERATEUR (Correction du statut après modification) ---

        function FormPanel({ user, userData, globalSettings, db, isAdmin, setCurrentModule, currentOrder, setCurrentOrder, setShowSuccessModal }) {
            const [loading, setLoading] = useState(false);
            const [isSiretPending, setIsSiretPending] = useState(false);
            const [isDifferentAddress, setIsDifferentAddress] = useState(false);
            const [addressSuggestions, setAddressSuggestions] = useState([]);
            const [error, setError] = useState('');
            
            const [civility, setCivility] = useState('M.');
            const [firstName, setFirstName] = useState('');
            const [lastName, setLastName] = useState('');

            const initialFormState = {
                siren: '',
                companyName: '',
                address: '',
                clientEmail: '',
                clientPhone: '',
                startDate: new Date().toISOString().split('T')[0],
                endDate: '',
                radiusKm: 20,
                maxKmPerVehicle: 100000,
                minVehicleYear: 2018,
                excludedVehicles: '',
                salesRepsCount: 0,
                maxRdvTotal: 0
            };
            
            const [form, setForm] = useState(initialFormState);
            const isEditing = !!currentOrder?.id;

            useEffect(() => {
                if (isEditing) {
                    setForm({
                        siren: currentOrder.siren === "EN COURS" ? '' : currentOrder.siren || '',
                        companyName: currentOrder.companyName || '',
                        address: currentOrder.address || '',
                        clientEmail: currentOrder.clientEmail || '',
                        clientPhone: formatPhoneNumber(currentOrder.clientPhone) || '',
                        startDate: currentOrder.startDate || new Date().toISOString().split('T')[0],
                        endDate: currentOrder.endDate || '',
                        radiusKm: parseInt(currentOrder.radiusKm) || 20,
                        maxKmPerVehicle: parseInt(currentOrder.maxKmPerVehicle) || 100000,
                        minVehicleYear: parseInt(currentOrder.minVehicleYear) || 2018,
                        excludedVehicles: currentOrder.excludedVehicles || '',
                        salesRepsCount: parseInt(currentOrder.salesRepsCount) || 0,
                        maxRdvTotal: parseInt(currentOrder.maxRdvTotal) || 0
                    });
                    
                    setIsSiretPending(currentOrder.siren === "EN COURS");
                    const isDefaultAddress = currentOrder.siren && currentOrder.siren !== "EN COURS" && currentOrder.address === currentOrder.companyAddressFromAPI;
                    setIsDifferentAddress(!isDefaultAddress || currentOrder.siren === "EN COURS");
                    
                    if (currentOrder.siren === "EN COURS" && currentOrder.companyName) {
                        const parts = currentOrder.companyName.split(' ');
                        setCivility(parts[0] || 'M.');
                        setFirstName(parts[1] || '');
                        setLastName(parts.slice(2).join(' ') || '');
                    }
                } else {
                    setForm(initialFormState);
                    setIsSiretPending(false);
                    setIsDifferentAddress(false);
                    setError('');
                }
            }, [isEditing, currentOrder]);


            useEffect(() => {
                if (!form.startDate) return;
                let date = new Date(form.startDate);
                date.setDate(date.getDate() + 7);
                setForm(prev => ({...prev, endDate: date.toISOString().split('T')[0]}));
            }, [form.startDate]);

            const searchSiren = async () => {
                if (form.siren.length < 9) return alert("Numéro SIREN incomplet");
                setLoading(true);
                setError('');
                try {
                    const response = await fetch(`https://recherche-entreprises.api.gouv.fr/search?q=${form.siren}`);
                    const data = await response.json();
                    if (data.results && data.results.length > 0) {
                        const company = data.results[0];
                        setForm(prev => ({
                            ...prev,
                            companyName: company.nom_complet,
                            address: company.siege.adresse,
                            companyAddressFromAPI: company.siege.adresse
                        }));
                        setIsDifferentAddress(false);
                    } else setError("Aucune entreprise trouvée avec ce SIREN.");
                } catch (error) { console.error(error); setError("Erreur lors de la recherche SIREN."); }
                setLoading(false);
            };

            const handleAddressSearch = async (query) => {
                setForm(prev => ({...prev, address: query}));
                if(query.length > 3) {
                    try {
                        const res = await fetch(`https://api-adresse.data.gouv.fr/search/?q=${query}&limit=5`);
                        const data = await res.json();
                        setAddressSuggestions(data.features || []);
                    } catch(e) {}
                } else setAddressSuggestions([]);
            };
            
            const handlePhoneChange = (e) => {
                const formatted = formatPhoneNumber(e.target.value);
                setForm(prev => ({...prev, clientPhone: formatted}));
            };
            
            const handleSave = async () => {
                setError('');
                
                let finalCompanyName = form.companyName;
                if (isSiretPending) {
                    if(!lastName || !firstName) return setError("Veuillez saisir le Prénom et le Nom pour un SIRET en cours.");
                    finalCompanyName = `${civility} ${firstName} ${lastName}`;
                }

                // 1. Validation Générale
                if (!finalCompanyName || !form.address) {
                    return setError("Veuillez compléter l'identification du client (Nom/Société et Adresse).");
                }
                
                // 2. Validation Téléphone
                const cleanPhone = form.clientPhone.replace(/\s/g, '');
                if (cleanPhone.length !== 10) {
                    return setError("Le numéro de téléphone doit contenir exactement 10 chiffres (format: 0X XX XX XX XX).");
                }
                
                // 3. Validation Plafond RDV
                if (!form.maxRdvTotal || parseInt(form.maxRdvTotal) <= 0) {
                    return setError("Le plafond de rendez-vous est obligatoire et doit être supérieur à zéro. Veuillez le définir dans la section 2.");
                }
                
                setLoading(true);
                try {
                    const settingsRef = doc(db, "settings", "global");
                    const settingsSnap = await getDoc(settingsRef);
                    let currentSeq = globalSettings.sequenceNumber || 367;

                    let refString = currentOrder?.reference;
                    let orderId = currentOrder?.id;
                    let isNewOrder = !isEditing;

                    if (isNewOrder) {
                        if (settingsSnap.exists()) {
                            currentSeq = settingsSnap.data().sequenceNumber || 367;
                        }
                        const today = new Date();
                        const year = today.getFullYear();
                        const month = (today.getMonth() + 1).toString().padStart(2, '0');
                        refString = `${year}${month}-${currentSeq}`;
                    }

                    const orderData = {
                        ...form,
                        companyName: finalCompanyName,
                        salesRepName: userData?.name || user.email,
                        salesRepId: user.uid,
                        ratePerAppointment: globalSettings.defaultRate,
                        siren: isSiretPending ? "EN COURS" : form.siren,
                        reference: refString,
                        clientPhone: cleanPhone,
                        // Correction: Conserve le createdAt de l'ancienne commande si édition
                        createdAt: isEditing ? currentOrder.createdAt : new Date(), 
                        // Correction: Conserve le statut existant si édition, sinon 'Pending' (En attente)
                        status: isEditing ? currentOrder.status : 'Pending', 
                        updatedAt: new Date()
                    };

                    if (isEditing) {
                        await updateDoc(doc(db, "orders", orderId), orderData);
                    } else {
                        orderId = (await addDoc(collection(db, "orders"), orderData)).id;
                        await updateDoc(settingsRef, { sequenceNumber: parseInt(currentSeq) + 1 });
                        globalSettings.sequenceNumber = parseInt(currentSeq) + 1;
                    }

                    // Téléchargement du PDF
                    generateOrderPDF({...orderData, id: orderId}, globalSettings);
                    
                    // Affichage de la modale de succès
                    setShowSuccessModal({ 
                        reference: refString, 
                        isEditing: isEditing // Passe le bon statut d'édition
                    });
                    
                    // Réinitialisation du formulaire et changement de vue
                    setForm(initialFormState);
                    setCurrentOrder(null);
                    setCurrentModule('myOrders');

                } catch (e) { 
                    console.error(e); 
                    setError("Erreur de sauvegarde: " + e.message); 
                }
                setLoading(false);
            };

            return React.createElement('div', { className: "max-w-5xl mx-auto" },
                isEditing && React.createElement('div', { className: "bg-indigo-100 border border-indigo-200 p-4 rounded-xl mb-6 flex justify-between items-center" },
                    React.createElement('p', { className: "font-bold text-indigo-800" }, `MODE ÉDITION : Commande ${currentOrder.reference}`),
                    React.createElement('button', { onClick: () => setCurrentOrder(null), className: "text-indigo-600 hover:text-indigo-800 font-medium" }, "Annuler Édition")
                ),
                error && React.createElement('div', { className: "error-popup mb-6 font-medium" }, React.createElement(Icon, { name: "x", size: 16, className: "inline mr-2" }), error),
                React.createElement('div', { className: "grid grid-cols-1 lg:grid-cols-3 gap-6" },
                    React.createElement('div', { className: "lg:col-span-2 space-y-6" },
                        // Section Client
                        React.createElement('div', { className: "bg-white rounded-xl shadow-sm border border-slate-100 p-6" },
                            React.createElement('div', { className: "flex justify-between items-center mb-4" },
                                React.createElement('h2', { className: "text-lg font-semibold text-slate-700 flex items-center gap-2" },
                                    React.createElement(Icon, { name: "search", className: "text-blue-600" }), "1. Identification Client"
                                ),
                                React.createElement('label', { className: "flex items-center gap-2 text-xs font-semibold text-slate-600 cursor-pointer bg-slate-100 px-3 py-1 rounded-full" },
                                    React.createElement('input', { type: "checkbox", checked: isSiretPending, onChange: (e) => { setIsSiretPending(e.target.checked); setForm(prev => ({...prev, companyName: '', address: '', siren: ''})); setIsDifferentAddress(false); }, disabled: isEditing }), "SIRET en cours"
                                )
                            ),
                            !isSiretPending ? (
                                React.createElement('div', { className: "flex gap-3 mb-4" },
                                    React.createElement('input', { type: "text", placeholder: "SIREN (9 chiffres)", value: form.siren, onChange: (e) => setForm({...form, siren: e.target.value.replace(/[^\d]/g, '').substring(0, 9)}), className: "flex-1 border border-slate-200 rounded-lg px-4 py-2" }),
                                    React.createElement('button', { onClick: searchSiren, disabled: loading || isEditing || form.siren.length !== 9, className: "bg-slate-800 text-white px-5 py-2 rounded-lg" }, loading ? "..." : "Rechercher")
                                )
                            ) : (
                                React.createElement('div', { className: "grid grid-cols-3 gap-3 mb-4" },
                                    React.createElement('select', { value: civility, onChange: (e) => setCivility(e.target.value), className: "border border-slate-200 rounded-lg px-2 py-2" },
                                        React.createElement('option', { value: "M." }, "M."),
                                        React.createElement('option', { value: "Mme" }, "Mme")
                                    ),
                                    React.createElement('input', { type: "text", placeholder: "Prénom*", required: true, value: firstName, onChange: (e) => setFirstName(e.target.value), className: "border border-slate-200 rounded-lg px-4 py-2" }),
                                    React.createElement('input', { type: "text", placeholder: "Nom*", required: true, value: lastName, onChange: (e) => setLastName(e.target.value), className: "border border-slate-200 rounded-lg px-4 py-2" })
                                )
                            ),
                            (!isSiretPending && form.companyName) && React.createElement('div', { className: "bg-blue-50 p-4 rounded-lg border border-blue-100 mb-4" },
                                React.createElement('p', { className: "font-bold text-blue-900" }, form.companyName),
                                !isDifferentAddress && React.createElement('p', { className: "text-blue-700 text-sm" }, form.address)
                            ),
                            React.createElement('div', { className: "mb-4" },
                                React.createElement('label', { className: "flex items-center gap-2 text-sm text-slate-600 cursor-pointer mb-2" },
                                    React.createElement('input', { type: "checkbox", checked: isDifferentAddress || isSiretPending, onChange: (e) => { setIsDifferentAddress(e.target.checked); if(e.target.checked) setForm(prev => ({...prev, address: ''})); }, disabled: isSiretPending }),
                                    "Adresse agence différente ?"
                                ),
                                (isDifferentAddress || isSiretPending) && React.createElement('div', { className: "relative" },
                                    React.createElement('div', { className: "flex items-center border border-slate-200 rounded-lg bg-slate-50" },
                                        React.createElement('div', { className: "pl-3 text-slate-400" }, React.createElement(Icon, { name: "mapPin", size: 16 })),
                                        React.createElement('input', { type: "text", placeholder: "Rechercher adresse...", value: form.address, onChange: (e) => handleAddressSearch(e.target.value), className: "w-full bg-transparent px-4 py-2 outline-none text-sm" })
                                    ),
                                    addressSuggestions.length > 0 && React.createElement('div', { className: "suggestions-list" },
                                        addressSuggestions.map((s, i) => React.createElement('div', { key: i, className: "suggestion-item", onClick: () => { setForm(prev => ({...prev, address: s.properties.label})); setAddressSuggestions([]); } }, s.properties.label))
                                    )
                                )
                            ),
                            React.createElement('div', { className: "grid grid-cols-2 gap-4 mt-4" },
                                React.createElement('div', null, React.createElement('label', { className: "block text-xs text-slate-500 mb-1" }, "Email Contact"), React.createElement('input', { type: "email", required: true, value: form.clientEmail, onChange: (e) => setForm({...form, clientEmail: e.target.value}), className: "w-full border border-slate-200 rounded-lg px-4 py-2" })),
                                React.createElement('div', null, React.createElement('label', { className: "block text-xs text-slate-500 mb-1" }, "Téléphone (10 chiffres)*"), React.createElement('input', {
                                    type: "tel",
                                    inputMode: "tel",
                                    required: true,
                                    maxLength: 14,
                                    value: form.clientPhone,
                                    onChange: handlePhoneChange,
                                    className: "w-full border border-slate-200 rounded-lg px-4 py-2 font-mono"
                                }))
                            )
                        ),
                        // Section Objectifs
                        React.createElement('div', { className: "bg-white rounded-xl shadow-sm border border-slate-100 p-6" },
                            React.createElement('h2', { className: "text-lg font-semibold text-slate-700 mb-4 flex items-center gap-2" }, React.createElement(Icon, { name: "users", className: "text-green-600" }), "2. Objectifs"),
                            React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-4" },
                                React.createElement('div', null, React.createElement('label', { className: "block text-xs font-medium text-slate-500 mb-1" }, "Nombre de Commerciaux"), React.createElement('input', { type: "number", min: 0, value: form.salesRepsCount, onChange: (e) => setForm({...form, salesRepsCount: parseInt(e.target.value)}), className: "w-full border border-slate-200 rounded-lg p-2" })),
                                React.createElement('div', null, React.createElement('label', { className: "block text-xs font-medium text-slate-500 mb-1" }, "Plafond RDV* (Obligatoire)"), React.createElement('input', { type: "number", min: 1, required: true, value: form.maxRdvTotal, onChange: (e) => setForm({...form, maxRdvTotal: parseInt(e.target.value)}), className: "w-full border border-slate-200 rounded-lg p-2" }))
                            )
                        ),
                        // Section Période
                        React.createElement('div', { className: "bg-white rounded-xl shadow-sm border border-slate-100 p-6" },
                            React.createElement('h2', { className: "text-lg font-semibold text-slate-700 mb-4 flex items-center gap-2" }, React.createElement(Icon, { name: "calendar", className: "text-orange-500" }), "3. Période & Tarif"),
                            React.createElement('div', { className: "grid grid-cols-2 gap-4 mb-4" },
                                React.createElement('div', null, React.createElement('label', { className: "block text-xs text-slate-500 mb-1" }, "Début"), React.createElement('input', { type: "date", value: form.startDate, onChange: (e) => setForm({...form, startDate: e.target.value}), className: "w-full border border-slate-200 rounded-lg p-2 font-bold text-blue-600" })),
                                React.createElement('div', null, React.createElement('label', { className: "block text-xs text-slate-500 mb-1" }, "Fin (J+7)"), React.createElement('input', { type: "date", value: form.endDate, disabled: true, className: "w-full border border-slate-200 bg-slate-50 rounded-lg p-2" }))
                            ),
                            React.createElement('div', null, React.createElement('label', { className: "block text-xs text-slate-500 mb-1" }, "Tarif / RDV"), React.createElement('div', { className: "w-full bg-slate-50 border border-slate-200 rounded-lg p-2 text-slate-500 font-mono" }, `${globalSettings.defaultRate} € ${globalSettings.taxType || 'HT'}`))
                        )
                    ),
                    // Colonne Droite
                    React.createElement('div', { className: "space-y-6" },
                        React.createElement('div', { className: "bg-white rounded-xl shadow-sm border border-slate-100 p-6" },
                            React.createElement('h2', { className: "text-lg font-semibold text-slate-700 mb-4 flex items-center gap-2" }, React.createElement(Icon, { name: "car", className: "text-purple-500" }), "4. Véhicule & Zone"),
                            React.createElement('div', { className: "space-y-4" },
                                React.createElement('div', null, React.createElement('label', { className: "block text-xs text-slate-500 mb-1" }, "Rayon (km)"), React.createElement('input', { type: "number", value: form.radiusKm, onChange: (e) => setForm({...form, radiusKm: parseInt(e.target.value)}), className: "w-full border border-slate-200 rounded-lg p-2" })),
                                React.createElement('div', null, React.createElement('label', { className: "block text-xs text-slate-500 mb-1" }, "Max Km"), React.createElement('input', { type: "number", value: form.maxKmPerVehicle, onChange: (e) => setForm({...form, maxKmPerVehicle: parseInt(e.target.value)}), className: "w-full border border-slate-200 rounded-lg p-2" })),
                                React.createElement('div', null, React.createElement('label', { className: "block text-xs text-slate-500 mb-1" }, "Année Min"), React.createElement('input', { type: "number", value: form.minVehicleYear, onChange: (e) => setForm({...form, minVehicleYear: parseInt(e.target.value)}), className: "w-full border border-slate-200 rounded-lg p-2" })),
                                React.createElement('div', { className: "pt-4 border-t border-slate-100" }, React.createElement('label', { className: "block text-xs font-bold text-red-500 mb-1" }, "Modèles Exclus (Facultatif)"), React.createElement('input', { type: "text", placeholder: "Ex: Twingo...", value: form.excludedVehicles, onChange: (e) => setForm({...form, excludedVehicles: e.target.value}), className: "w-full border border-red-200 bg-red-50 rounded-lg p-2 text-red-700" }))
                            )
                        ),
                        React.createElement('button', { onClick: handleSave, disabled: loading, className: `w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3 ${loading ? 'opacity-70' : ''}` },
                            loading ? React.createElement('div', { className: "loader h-6 w-6 rounded-full border-4 border-white" }) : React.createElement(Icon, { name: isEditing ? "refreshCw" : "save" }), isEditing ? "METTRE À JOUR & TÉLÉCHARGER PDF" : "GÉNÉRER PDF"
                        )
                    )
                )
            );
        }

        // --- MODULE DE PROFIL (Inchangé) ---
        function CommercialProfileModule({ user, userData, db }) {
            // ... (Inchangé)
            const [firstName, setFirstName] = useState(userData?.firstName || '');
            const [lastName, setLastName] = useState(userData?.lastName || '');
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState('');
            const [isEditing, setIsEditing] = useState(false);

            useEffect(() => {
                setFirstName(userData?.firstName || '');
                setLastName(userData?.lastName || '');
                setIsEditing(false);
            }, [userData?.firstName, userData?.lastName]);


            const handlePhoto = async (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onloadend = async () => {
                    await updateDoc(doc(db, "users", user.uid), { photoURL: reader.result });
                    setMessage("Photo de profil mise à jour !");
                };
                reader.readAsDataURL(file);
            };

            const handleSaveName = async (e) => {
                e.preventDefault();
                if (!firstName.trim() || !lastName.trim()) {
                    return setMessage("Le prénom et le nom sont obligatoires.");
                }

                setLoading(true);
                setMessage('');
                
                const newName = `${firstName.trim()} ${lastName.trim()}`;
                const oldName = userData?.name || 'Inconnu';

                try {
                    // 1. Mise à jour des informations utilisateur
                    const userRef = doc(db, "users", user.uid);
                    await updateDoc(userRef, {
                        firstName: firstName.trim(),
                        lastName: lastName.trim(),
                        name: newName,
                        lastUpdateName: new Date()
                    });

                    // 2. Création du Log d'Audit pour l'Admin
                    if (newName !== oldName) {
                         await addDoc(collection(db, "nameChanges"), {
                            userId: user.uid,
                            userEmail: user.email,
                            oldName: oldName,
                            newName: newName,
                            timestamp: new Date()
                        });
                        setMessage("Informations mises à jour ! L'administrateur a été notifié de ce changement.");
                    } else {
                        setMessage("Informations mises à jour ! (Pas de changement de nom détecté)");
                    }
                   
                    setLoading(false);
                    setIsEditing(false); // Revenir au mode lecture seule après sauvegarde
                } catch (error) {
                    console.error("Erreur de sauvegarde:", error);
                    setMessage("Erreur lors de la sauvegarde : " + error.message);
                    setLoading(false);
                }
            };


            return React.createElement('div', { className: "max-w-2xl mx-auto space-y-6" },
                // Carte Principale avec champs de modification
                React.createElement('div', { className: "bg-white rounded-xl shadow-sm border border-slate-200 p-8" },
                    React.createElement('div', { className: "flex items-center gap-6 mb-8" },
                        React.createElement('div', { className: "relative group" },
                            userData?.photoURL
                            ? React.createElement('img', { src: userData.photoURL, className: "h-20 w-20 rounded-full object-cover border-4 border-blue-50" })
                            : React.createElement('div', { className: "h-20 w-20 bg-blue-100 rounded-full flex items-center justify-center text-blue-600" }, React.createElement(Icon, { name: "users", size: 32 })),
                            
                            // Input Photo masqué sur le cercle
                            React.createElement('label', { className: "absolute inset-0 flex items-center justify-center bg-black/50 text-white rounded-full opacity-0 group-hover:opacity-100 cursor-pointer transition text-xs text-center p-2 font-bold" },
                                "Modifier",
                                React.createElement('input', { type: "file", accept: "image/*", className: "hidden", onChange: handlePhoto })
                            )
                        ),
                        React.createElement('div', null,
                            React.createElement('h2', { className: "text-2xl font-bold text-slate-800" }, userData?.name || "Nom/Prénom à jour"),
                            React.createElement('p', { className: "text-slate-500" }, user.email),
                            // NOUVEAU MESSAGE POUR L'ERGONOMIE
                            React.createElement('p', { className: "text-xs text-blue-600 mt-1" }, "👉 Cliquez sur le rond pour changer votre photo de profil si vous le souhaitez.")
                        )
                    ),
                    
                    React.createElement('h3', { className: "text-xl font-bold text-slate-700 mb-4 border-t border-slate-100 pt-4" }, "Mes informations commerciales"),

                    message && React.createElement('div', { className: `p-3 rounded-lg mb-4 text-sm font-medium ${message.includes('Erreur') ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}` }, message),

                    // Vue Lecture seule
                    !isEditing ? (
                        React.createElement('div', { className: "space-y-4" },
                            React.createElement('div', { className: "grid grid-cols-2 gap-4" },
                                React.createElement('div', { className: "p-3 bg-slate-50 rounded-lg border border-slate-100" },
                                    React.createElement('p', { className: "text-xs text-slate-500 uppercase font-bold mb-1" }, "Prénom"),
                                    React.createElement('p', { className: "font-medium text-slate-800" }, userData?.firstName || 'Non défini')
                                ),
                                React.createElement('div', { className: "p-3 bg-slate-50 rounded-lg border border-slate-100" },
                                    React.createElement('p', { className: "text-xs text-slate-500 uppercase font-bold mb-1" }, "Nom"),
                                    React.createElement('p', { className: "font-medium text-slate-800" }, userData?.lastName || 'Non défini')
                                )
                            ),
                            // Bouton "Modifier" qui active le mode édition
                            React.createElement('button', { onClick: () => setIsEditing(true), className: "w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition" }, "Modifier mes informations")
                        )
                    ) : (
                        // Vue Édition
                        React.createElement('form', { onSubmit: handleSaveName, className: "space-y-4" },
                            React.createElement('div', { className: "grid grid-cols-2 gap-4" },
                                React.createElement('div', null,
                                    React.createElement('label', { className: "block text-sm font-medium text-slate-700 mb-1" }, "Prénom"),
                                    React.createElement('input', { type: "text", required: true, value: firstName, onChange: e => setFirstName(e.target.value), className: "w-full border border-slate-300 rounded-lg px-4 py-2" })
                                ),
                                React.createElement('div', null,
                                    React.createElement('label', { className: "block text-sm font-medium text-slate-700 mb-1" }, "Nom"),
                                    React.createElement('input', { type: "text", required: true, value: lastName, onChange: e => setLastName(e.target.value), className: "w-full border border-slate-300 rounded-lg px-4 py-2" })
                                )
                            ),
                            React.createElement('div', { className: "flex gap-3" },
                                React.createElement('button', { type: "button", onClick: () => { setIsEditing(false); setFirstName(userData?.firstName || ''); setLastName(userData?.lastName || ''); }, className: "w-1/3 bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-3 rounded-lg transition" }, "Annuler"),
                                // Bouton "Enregistrer" qui effectue la sauvegarde
                                React.createElement('button', { type: "submit", disabled: loading, className: "w-2/3 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition" }, loading ? "Sauvegarde..." : "Enregistrer les informations")
                            )
                        )
                    )
                ),
                
                // Ancien module de profil (support)
                React.createElement(StaticProfileModule, { user, userData, db })
            );
        }

        // --- ANCIEN MODULE PROFIL (Inchangé) ---
        function StaticProfileModule({ user, userData, db }) {
            // ... (Inchangé)
            return React.createElement('div', { className: "space-y-6" },
                // Autres informations (rôle, ID)
                React.createElement('div', { className: "bg-white rounded-xl shadow-sm border border-slate-200 p-8" },
                    React.createElement('h3', { className: "text-xl font-bold text-slate-700 mb-4" }, "Informations du compte"),
                    React.createElement('div', { className: "space-y-4" },
                        React.createElement('div', { className: "p-4 bg-slate-50 rounded-lg border border-slate-100" },
                            React.createElement('p', { className: "text-xs text-slate-500 uppercase font-bold mb-1" }, "Rôle"),
                            React.createElement('p', { className: "font-medium" },
                                userData?.role === 'admin' ? "Administrateur" :
                                userData?.role === 'intern' ? "Stagiaire" : "Commercial Partenaire"
                            )
                        ),
                        React.createElement('div', { className: "p-4 bg-slate-50 rounded-lg border border-slate-100" },
                            React.createElement('p', { className: "text-xs text-slate-500 uppercase font-bold mb-1" }, "ID Utilisateur"),
                            React.createElement('p', { className: "font-mono text-sm text-slate-600" }, user.uid)
                        )
                    )
                ),

                // Carte Urgence / Contact
                React.createElement('div', { className: "bg-red-50 rounded-xl border border-red-100 p-6 flex flex-col items-center text-center" },
                    React.createElement('div', { className: "h-12 w-12 bg-red-100 rounded-full flex items-center justify-center text-red-600 mb-4" },
                        React.createElement(Icon, { name: "phone", size: 24 })
                    ),
                    React.createElement('h3', { className: "text-lg font-bold text-red-900 mb-1" }, "Urgence / Support"),
                    React.createElement('p', { className: "text-sm text-red-700 mb-4" }, "Une question urgente ou un problème technique ?"),
                    React.createElement('div', { className: "bg-white px-6 py-3 rounded-full shadow-sm border border-red-100" },
                        React.createElement('p', { className: "font-bold text-slate-800 text-sm mb-1" }, "C&N Solutions"),
                        React.createElement('a', { href: "tel:0985408925", className: "text-xl font-bold text-blue-600 hover:text-blue-800" }, "09 85 40 89 25")
                    )
                )
            );
        }

        // --- GESTIONNAIRE APP (Inchangé) ---
        function App() {
            const [user, setUser] = useState(null);
            const [userData, setUserData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('dashboard');
            const [currentOrder, setCurrentOrder] = useState(null);
            const [allSalesReps, setAllSalesReps] = useState(null);
            const [adminTab, setAdminTab] = useState('orders'); 

            const setViewAndTab = (newView, newTab = 'orders') => {
                setAdminTab(newTab);
                setView(newView);
            };
            
            const [globalSettings, setGlobalSettings] = useState({
                defaultRate: 50,
                taxType: 'HT',
                sequenceNumber: 367,
                myCompanyName: '',
                myAddress: '',
                mySiret: '',
                myEmail: ''
            });

            const isAdmin = (userData?.role === 'admin' || user?.email === 'contact@cetn-solutions.fr');

            // 1. Gestion de l'authentification et des données utilisateur
            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
                    if (currentUser) {
                        const userRef = doc(db, "users", currentUser.uid);
                        const unsubDoc = onSnapshot(userRef, (docSnap) => {
                            let data = {
                                firstName: '',
                                lastName: '',
                                name: 'Commercial',
                                role: 'sales'
                            };

                            if (docSnap.exists()) {
                                data = { ...data, ...docSnap.data() };
                            }

                            if (data.firstName && data.lastName) {
                                data.name = `${data.firstName} ${data.lastName}`;
                            } else if (data.name && data.name.includes(' ')) {
                                const parts = data.name.split(' ');
                                if(parts.length >= 2) {
                                    data.firstName = parts[0];
                                    data.lastName = parts.slice(1).join(' ');
                                }
                            }
                            
                            if (currentUser.email === "contact@cetn-solutions.fr" && data.role !== 'admin') {
                                data = { ...data, role: 'admin', name: data.name || 'Administrateur Principal', firstName: 'Administrateur', lastName: 'Principal' };
                            } else if (!data.role) {
                                data = { ...data, role: 'sales', name: data.name || 'Commercial', firstName: 'Commercial', lastName: 'Partenaire' };
                            }


                            if (data.isBlocked) {
                                signOut(auth);
                                alert("Votre accès a été suspendu. Contactez l'administrateur.");
                                setUser(null);
                                setUserData(null);
                            } else {
                                setUser(currentUser);
                                setUserData(data);
                            }
                            // Important: On passe loading à false seulement après avoir traité l'état d'auth et récupéré les données utilisateur.
                            setLoading(false);
                        });
                    } else {
                        setUser(null);
                        setUserData(null);
                        setLoading(false);
                    }
                });
                return () => unsubscribe();
            }, []);

            // 2. Récupération des paramètres globaux
            useEffect(() => {
                if(user) {
                    getDoc(doc(db, "settings", "global")).then(snap => {
                        if(snap.exists()) setGlobalSettings(prev => ({...prev, ...snap.data()}));
                    });
                }
            }, [user]);

            // 3. Récupération de tous les commerciaux pour le filtre Admin
            useEffect(() => {
                if (isAdmin) {
                    const qUsers = query(collection(db, "users"));
                    const unsubscribe = onSnapshot(qUsers, (snap) => {
                        const reps = snap.docs.map(d => ({id: d.id, ...d.data()}))
                                             .filter(r => r.role === 'sales' || r.role === 'intern' || r.role === 'admin');
                        setAllSalesReps(reps);
                    });
                    return () => unsubscribe();
                } else {
                    setAllSalesReps(null);
                }
            }, [isAdmin]);
            
            // 4. Suppression de la logique de compteur global.

            if (loading) return React.createElement('div', { className: "min-h-screen flex items-center justify-center" }, React.createElement('div', { className: "loader h-8 w-8 rounded-full border-4 border-slate-200" }));

            if (!user) return React.createElement(Login);


            if (view === 'admin' && isAdmin) {
                return React.createElement(AdminPanel, {
                    setView: () => setViewAndTab('dashboard', 'orders'),
                    globalSettings,
                    setGlobalSettings,
                    db,
                    currentUser: user,
                    defaultTab: adminTab,
                    setAdminTab: setAdminTab
                });
            }

            // Ici, on affiche le Dashboard Layout qui contient les modules
            return React.createElement(DashboardLayout, {
                user,
                userData,
                globalSettings,
                db,
                isAdmin,
                setView: setViewAndTab,
                currentOrder,
                setCurrentOrder,
                allSalesReps
            });
        }

        // --- ADMIN PANEL (Ajout de l'onglet Corbeille et affichage des demandes de suppression) ---
        function AdminPanel({ setView, globalSettings, setGlobalSettings, db, currentUser, defaultTab, setAdminTab }) {
            const [orders, setOrders] = useState([]);
            const [users, setUsers] = useState([]);
            const [nameLogs, setNameLogs] = useState([]);
            const [tab, setTab] = useState(defaultTab || 'orders');
            
            // État pour la modification
            const [editingId, setEditingId] = useState(null);
            const [newUser, setNewUser] = useState({ name: '', email: '', password: '', role: 'sales' });

            // Met à jour l'état local et global de l'onglet lors d'un clic
            const handleTabChange = (newTab) => {
                setTab(newTab);
                setAdminTab(newTab);
            }
            
            // Met à jour l'état local si defaultTab change (e.g. après un clic sur la corbeille)
            useEffect(() => {
                if (defaultTab && defaultTab !== tab) {
                    setTab(defaultTab);
                }
            }, [defaultTab]);


            useEffect(() => {
                // Charge toutes les commandes pour pouvoir filtrer localement les demandes de suppression
                const qOrders = query(collection(db, "orders"), orderBy("createdAt", "desc"), limit(100)); // Augmente la limite pour être sûr d'avoir les demandes récentes
                const unsubOrders = onSnapshot(qOrders, (snap) => setOrders(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                
                const qUsers = query(collection(db, "users"));
                const unsubUsers = onSnapshot(qUsers, (snap) => setUsers(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                
                const qNameLogs = query(collection(db, "nameChanges"), orderBy("timestamp", "desc"));
                const unsubNameLogs = onSnapshot(qNameLogs, (snap) => setNameLogs(snap.docs.map(d => ({id: d.id, ...d.data()}))));

                return () => { unsubOrders(); unsubUsers(); unsubNameLogs(); };
            }, []);

            // Commandes à afficher
            const allOrders = orders;
            const trashOrders = orders.filter(o => o.status === 'RequestDelete');
            
            const handleSaveUser = async (e) => {
                e.preventDefault();
                
                if (editingId) {
                    try {
                        const userRef = doc(db, "users", editingId);
                        const updateData = {
                            name: newUser.name,
                            firstName: newUser.name.split(' ')[0] || '',
                            lastName: newUser.name.split(' ').slice(1).join(' ') || '',
                            role: newUser.role
                        };
                        if (newUser.password && newUser.password.trim() !== "") {
                            updateData.password = newUser.password;
                        }

                        await updateDoc(userRef, updateData);
                        alert("Utilisateur mis à jour !");
                        setEditingId(null);
                        setNewUser({ name: '', email: '', password: '', role: 'sales' });
                    } catch (err) { alert("Erreur: " + err.message); }
                    return;
                }

                try {
                    const userCredential = await createUserWithEmailAndPassword(secondaryAuth, newUser.email, newUser.password);
                    await setDoc(doc(db, "users", userCredential.user.uid), {
                        name: newUser.name,
                        firstName: newUser.name.split(' ')[0] || '',
                        lastName: newUser.name.split(' ').slice(1).join(' ') || '',
                        email: newUser.email,
                        role: newUser.role,
                        password: newUser.password,
                        isBlocked: false,
                        createdAt: new Date()
                    });
                    setNewUser({ name: '', email: '', password: '', role: 'sales' });
                    signOut(secondaryAuth);
                    alert("Utilisateur créé avec succès !");
                } catch (err) { alert("Erreur: " + err.message); }
            };

            const startEdit = (u) => {
                setEditingId(u.id);
                setNewUser({ name: u.name || `${u.firstName || ''} ${u.lastName || ''}`.trim(), email: u.email, password: u.password || '', role: u.role });
                window.scrollTo(0,0);
            };

            const toggleBlockUser = async (userId, currentStatus) => {
                if (userId === currentUser.uid) return alert("Sécurité : Vous ne pouvez pas bloquer votre propre compte Administrateur.");
                await updateDoc(doc(db, "users", userId), { isBlocked: !currentStatus });
            };

            const deleteUserAcct = async (userId) => {
                if (userId === currentUser.uid) return alert("Sécurité : Vous ne pouvez pas supprimer votre propre compte.");
                if(confirm("Supprimer l'accès de ce membre ? (Irréversible)")) {
                    await deleteDoc(doc(db, "users", userId));
                }
            };
            
            // Supprimer un seul log (gardé ici, même si l'onglet est renommé)
            const deleteNameLog = async (logId) => {
                 if (!confirm("Êtes-vous sûr de vouloir supprimer ce log d'historique de nom ?")) return;
                 try {
                     await deleteDoc(doc(db, "nameChanges", logId));
                     alert("Log supprimé.");
                 } catch (e) {
                     console.error("Erreur de suppression du log:", e);
                     alert("Erreur lors de la suppression du log.");
                 }
            };

            const redownloadPDF = (o) => generateOrderPDF(o, globalSettings);
            
            // Logique de suppression d'une commande
            const deleteOrder = async (id) => {
                if(confirm("Supprimer la commande ? (Action irréversible)")) {
                    await deleteDoc(doc(db, "orders", id));
                    alert("Commande supprimée.");
                }
            };
            
            // Logique d'approbation/rejet de la demande de suppression
            const handleDeletionApproval = async (orderId, approve) => {
                if (approve) {
                    if (confirm("Voulez-vous vraiment APPROUVER la suppression de cette commande ?")) {
                        await deleteDoc(doc(db, "orders", orderId));
                        alert("Commande supprimée par l'administrateur.");
                    }
                } else {
                    if (confirm("Voulez-vous REJETER la demande de suppression et remettre le statut à 'Envoyé' ?")) {
                        await updateDoc(doc(db, "orders", orderId), { status: 'Envoyé', deleteReason: deleteOrder.deleteReason = null });
                        alert("Demande rejetée, statut remis à 'Envoyé'.");
                    }
                }
            };
            
            const handleImageUpload = (e, f) => { const r = new FileReader(); r.onloadend = () => setGlobalSettings(p => ({...p, [f]: r.result})); if(e.target.files[0]) r.readAsDataURL(e.target.files[0]); };
            const saveSettings = async () => { await setDoc(doc(db, "settings", "global"), globalSettings, { merge: true }); alert("Sauvegardé"); };

            const getUniqueClients = () => {
                const unique = {};
                allOrders.forEach(o => { if(!unique[o.siren] && o.companyName) unique[o.siren] = o; });
                return Object.values(unique);
            };
            
            // Utilise la Map StatusMap pour les labels
            const getStatusBadge = (status) => {
                const statusInfo = StatusMap[status];
                if (!statusInfo) return React.createElement('span', { className: "bg-slate-100 text-slate-600 text-[10px] px-2 py-1 rounded-full font-bold" }, "INCONNU");
                
                const colorClass = getStatusColorClass(status);

                return React.createElement('span', { className: `${colorClass.replace('-50', '-100')} text-[10px] px-2 py-1 rounded-full font-bold` }, statusInfo.label.toUpperCase());
            };
            
            // Utilise la Map StatusMap pour les couleurs
            const getStatusColorClass = (status) => {
                const statusInfo = StatusMap[status];
                const color = statusInfo ? statusInfo.color : 'slate';

                switch(color) {
                    case 'orange': return "bg-orange-50 text-orange-800 border-orange-200";
                    case 'blue': return "bg-blue-50 text-blue-800 border-blue-200";
                    case 'yellow': return "bg-yellow-50 text-yellow-800 border-yellow-200";
                    case 'green': return "bg-green-50 text-green-800 border-green-200";
                    case 'red': return "bg-red-50 text-red-800 border-red-200";
                    case 'slate': default: return "bg-slate-100 text-slate-500 border-slate-200";
                }
            };
            
            const deleteAllNameLogs = async () => {
                if (nameLogs.length === 0) return alert("Aucun log à supprimer.");
                if (!confirm(`Êtes-vous sûr de vouloir supprimer les ${nameLogs.length} logs d'historique de changement de nom ?`)) return;

                const batch = writeBatch(db);
                nameLogs.forEach(log => {
                    batch.delete(doc(db, "nameChanges", log.id));
                });

                try {
                    await batch.commit();
                    alert("Historique des logs de changement de nom supprimé avec succès.");
                } catch (e) {
                    console.error("Erreur lors de la suppression des logs:", e);
                    alert("Erreur lors de la suppression de l'historique.");
                }
            };

            return React.createElement('div', { className: "min-h-screen bg-slate-900 p-8" },
                React.createElement('div', { className: "max-w-7xl mx-auto" },
                    React.createElement('div', { className: "flex justify-between items-center mb-8" },
                        React.createElement('button', { onClick: () => setView('dashboard'), className: "text-slate-400 hover:text-white flex items-center gap-2" }, "← Retour App"),
                        React.createElement('div', { className: "flex bg-slate-800 rounded-lg p-1" },
                            ['orders', 'trash', 'history', 'team', 'clients', 'settings'].map(t =>
                                React.createElement('button', { 
                                    key: t, 
                                    onClick: () => handleTabChange(t), 
                                    className: `px-4 py-2 rounded text-sm ${tab === t ? 'bg-blue-600 text-white' : 'text-slate-400'}` 
                                },
                                    t === 'orders' ? 'Commandes' : t === 'team' ? 'Gestion Équipe' : t === 'clients' ? 'Clients' : t === 'trash' ? React.createElement('span', { className: "flex items-center gap-1" }, React.createElement(Icon, { name: "trash", size: 16 }), 'Corbeille') : t === 'history' ? React.createElement('span', { className: "flex items-center gap-1" }, React.createElement(Icon, { name: "bell", size: 16 }), 'Historique Nom') : 'Config')
                            )
                        )
                    ),

                    // TAB TEAM (Inchangé)
                    tab === 'team' && React.createElement('div', { className: "space-y-8" },
                        // ... (Contenu inchangé)
                        React.createElement('div', { className: `p-6 rounded-xl border ${editingId ? 'bg-blue-900 border-blue-700' : 'bg-slate-800 border-slate-700'}` },
                            React.createElement('div', { className: "flex justify-between items-center mb-4" },
                                React.createElement('h3', { className: "text-white font-bold flex items-center gap-2" },
                                    React.createElement(Icon, { name: "users" }),
                                    editingId ? "Modifier le Membre" : "Ajouter un Membre"
                                ),
                                editingId && React.createElement('button', { onClick: () => { setEditingId(null); setNewUser({ name: '', email: '', password: '', role: 'sales' }); }, className: "text-xs text-blue-300 hover:text-white" }, "Annuler")
                            ),
                            React.createElement('form', { onSubmit: handleSaveUser, className: "space-y-4" },
                                React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-4 gap-4" },
                                    React.createElement('input', { type: "text", placeholder: "Prénom Nom", required: true, value: newUser.name, onChange: e => setNewUser({...newUser, name: e.target.value}), className: "w-full p-2 rounded bg-slate-700 text-white border border-slate-600 outline-none focus:border-blue-500" }),
                                    
                                    React.createElement('input', { type: "email", placeholder: "Email", required: true, disabled: !!editingId, value: newUser.email, onChange: e => setNewUser({...newUser, email: e.target.value}), className: `w-full p-2 rounded text-white border border-slate-600 outline-none focus:border-blue-500 ${editingId ? 'bg-slate-800 text-slate-400' : 'bg-slate-700'}` }),
                                    
                                    React.createElement('input', { type: "text", placeholder: "Mot de passe", required: !editingId, value: newUser.password, onChange: e => setNewUser({...newUser, password: e.target.value}), className: "w-full p-2 rounded bg-slate-700 text-white border border-slate-600 outline-none focus:border-blue-500" }),
                                    
                                    React.createElement('select', {
                                        value: newUser.role,
                                        onChange: e => setNewUser({...newUser, role: e.target.value}),
                                        className: "w-full p-2 rounded bg-slate-700 text-white border border-slate-600 outline-none focus:border-blue-500"
                                    },
                                        React.createElement('option', { value: "sales" }, "Commercial"),
                                        React.createElement('option', { value: "intern" }, "Stagiaire"),
                                        React.createElement('option', { value: "admin" }, "Administrateur")
                                    )
                                ),
                                React.createElement('button', { type: "submit", className: `w-full md:w-auto font-bold py-2 px-6 rounded transition ${editingId ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-green-600 hover:bg-green-700 text-white'}` },
                                    editingId ? "Mettre à jour" : "Créer le compte"
                                )
                            )
                        ),
                        
                        // Liste des membres
                        React.createElement('div', { className: "bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden" },
                            React.createElement('div', { className: "p-4 border-b border-slate-100 bg-slate-50" },
                                React.createElement('h3', { className: "font-bold text-slate-800" }, "Membres de l'équipe")
                            ),
                            React.createElement('div', { className: "overflow-x-auto" },
                                React.createElement('table', { className: "w-full text-left" },
                                    React.createElement('thead', { className: "bg-slate-50 text-[10px] md:text-xs uppercase text-slate-500 font-bold tracking-wider" },
                                        React.createElement('tr', null,
                                            React.createElement('th', { className: "p-3" }, "Nom"),
                                            React.createElement('th', { className: "p-3 hidden md:table-cell" }, "Email"),
                                            React.createElement('th', { className: "p-3" }, "Mdp"),
                                            React.createElement('th', { className: "p-3" }, "Rôle"),
                                            React.createElement('th', { className: "p-3" }, "Statut"),
                                            React.createElement('th', { className: "p-3 text-right" }, "Actions")
                                        )
                                    ),
                                    React.createElement('tbody', { className: "text-sm divide-y divide-slate-100" },
                                        users.map(u => {
                                            const handleResetPwd = async () => {
                                                if(confirm(`Envoyer un email de réinitialisation de mot de passe à ${u.email} ?`)) {
                                                    try {
                                                        await sendPasswordResetEmail(auth, u.email);
                                                        alert("Email envoyé avec succès !");
                                                    } catch(err) { alert("Erreur: " + err.message); }
                                                }
                                            };

                                            return React.createElement('tr', { key: u.id, className: "hover:bg-slate-50 transition-colors" },
                                                React.createElement('td', { className: "p-3 font-medium text-slate-700" },
                                                    u.name,
                                                    React.createElement('div', { className: "md:hidden text-xs text-slate-400 font-normal" }, u.email)
                                                ),
                                                React.createElement('td', { className: "p-3 hidden md:table-cell text-slate-500" }, u.email),
                                                React.createElement('td', { className: "p-3 font-mono text-blue-600 font-bold" }, u.password || '***'),
                                                React.createElement('td', { className: "p-3 text-slate-500 capitalize" },
                                                    u.role === 'admin' ? 'Admin' :
                                                    u.role === 'intern' ? 'Stagiaire' : 'Commercial'
                                                ),
                                                React.createElement('td', { className: "p-3" },
                                                    u.isBlocked
                                                    ? React.createElement('span', { className: "bg-red-100 text-red-800 text-[10px] px-2 py-1 rounded-full font-bold border border-red-200" }, "BLOQUÉ")
                                                    : React.createElement('span', { className: "bg-green-100 text-green-800 text-[10px] px-2 py-1 rounded-full font-bold border border-green-200" }, "ACTIF")
                                                ),
                                                React.createElement('td', { className: "p-3 text-right flex justify-end gap-2" },
                                                    React.createElement('button', { onClick: () => startEdit(u), className: "p-2 rounded bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200 transition", title: "Modifier" },
                                                        React.createElement(Icon, { name: "edit", size: 16 })
                                                    ),
                                                    React.createElement('button', { onClick: handleResetPwd, className: "p-2 rounded bg-yellow-50 text-yellow-600 hover:bg-yellow-100 border border-yellow-200 transition", title: "Envoyer email nouveau mot de passe" },
                                                        React.createElement(Icon, { name: "key", size: 16 })
                                                    ),
                                                    React.createElement('button', { onClick: () => toggleBlockUser(u.id, u.isBlocked), className: `p-2 rounded border transition ${u.isBlocked ? 'bg-green-50 text-green-600 border-green-200' : 'bg-orange-50 text-orange-600 border-orange-200'}` },
                                                        u.isBlocked ? React.createElement(Icon, { name: "unlock", size: 16 }) : React.createElement(Icon, { name: "lock", size: 16 })
                                                    ),
                                                    React.createElement('button', { onClick: () => deleteUserAcct(u.id), className: "p-2 text-red-500 bg-red-50 hover:bg-red-100 border border-red-200 rounded transition" }, React.createElement(Icon, { name: "trash", size: 16 }))
                                                )
                                            );
                                        })
                                    )
                                )
                            )
                        )
                    ),

                    // TAB CORBEILLE (Demandes de suppression de commande)
                    tab === 'trash' && React.createElement('div', { className: "space-y-6" },
                        React.createElement('h2', { className: "text-2xl font-bold text-red-400 mb-4" }, "Corbeille (Demandes de suppression)"),
                        trashOrders.length === 0
                        ? React.createElement('p', { className: "text-slate-400 bg-slate-800 p-6 rounded-xl" }, "Aucune demande de suppression en attente.")
                        : React.createElement('div', { className: "bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden" },
                            React.createElement('div', { className: "overflow-x-auto" },
                                React.createElement('table', { className: "w-full text-left" },
                                    React.createElement('thead', { className: "bg-red-100 text-[10px] md:text-xs uppercase text-red-800 font-bold tracking-wider" },
                                        React.createElement('tr', null,
                                            React.createElement('th', { className: "p-3" }, "Réf"),
                                            React.createElement('th', { className: "p-3" }, "Client"),
                                            React.createElement('th', { className: "p-3" }, "Demandeur"),
                                            React.createElement('th', { className: "p-3 hidden lg:table-cell" }, "Motif"),
                                            React.createElement('th', { className: "p-3 text-right" }, "Actions")
                                        )
                                    ),
                                    React.createElement('tbody', { className: "text-xs md:text-sm divide-y divide-slate-100" },
                                        trashOrders.map(o => React.createElement('tr', { key: o.id, className: `hover:bg-red-50/50 transition-colors` },
                                            React.createElement('td', { className: "p-3 font-mono font-bold text-red-600 whitespace-nowrap" }, o.reference),
                                            React.createElement('td', { className: "p-3 font-medium text-slate-700 truncate max-w-[100px] md:max-w-xs" }, o.companyName),
                                            React.createElement('td', { className: "p-3 font-medium text-indigo-600" }, o.salesRepName),
                                            React.createElement('td', { className: "p-3 hidden lg:table-cell text-slate-500 text-xs italic" }, o.deleteReason || 'Aucun motif fourni.'),
                                            React.createElement('td', { className: "p-3 text-right" },
                                                React.createElement('div', { className: "flex justify-end gap-1 md:gap-2" },
                                                    React.createElement('button', { onClick: () => handleDeletionApproval(o.id, true), className: "text-white bg-green-600 hover:bg-green-700 p-1.5 md:p-2 rounded-lg transition", title: "Approuver Suppression" }, React.createElement(Icon, { name: "check", size: 16 })),
                                                    React.createElement('button', { onClick: () => handleDeletionApproval(o.id, false), className: "text-slate-600 bg-slate-100 hover:bg-slate-200 p-1.5 md:p-2 rounded-lg transition", title: "Rejeter la demande" }, React.createElement(Icon, { name: "x", size: 16 }))
                                                )
                                            )
                                        ))
                                    )
                                )
                            )
                        )
                    ),
                    
                    // TAB ORDERS (Inchangé, mais affichage de la section Log Nom retiré)
                    tab === 'orders' && React.createElement('div', { className: "space-y-8" },
                        React.createElement('div', { className: "bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden" },
                            React.createElement('div', { className: "p-4 border-b border-slate-100 bg-slate-50" },
                                React.createElement('h3', { className: "font-bold text-slate-800" }, "Toutes les commandes (100 dernières)")
                            ),
                            React.createElement('div', { className: "overflow-x-auto" },
                                React.createElement('table', { className: "w-full text-left" },
                                    React.createElement('thead', { className: "bg-slate-50 text-[10px] md:text-xs uppercase text-slate-500 font-bold tracking-wider" },
                                        React.createElement('tr', null,
                                            React.createElement('th', { className: "p-2 md:p-3" }, "Réf"),
                                            React.createElement('th', { className: "p-2 md:p-3" }, "Client"),
                                            React.createElement('th', { className: "p-2 md:p-3" }, "Statut"),
                                            React.createElement('th', { className: "p-2 md:p-3 hidden lg:table-cell" }, "Créé par"),
                                            React.createElement('th', { className: "p-2 md:p-3 text-right" }, "Actions")
                                        )
                                    ),
                                    React.createElement('tbody', { className: "text-xs md:text-sm divide-y divide-slate-100" },
                                        allOrders.map(o => React.createElement('tr', { key: o.id, className: `hover:bg-slate-50 transition-colors ${o.status === 'RequestDelete' ? 'bg-red-50/50 hover:bg-red-100/50' : ''}` },
                                            React.createElement('td', { className: "p-2 md:p-3 font-mono font-bold text-blue-600 whitespace-nowrap" },
                                                o.reference
                                            ),
                                            React.createElement('td', { className: "p-2 md:p-3 font-medium text-slate-700 truncate max-w-[100px] md:max-w-xs" },
                                                o.companyName
                                            ),
                                            React.createElement('td', { className: "p-2 md:p-3" },
                                                getStatusBadge(o.status === 'Generated' ? 'Envoyé' : o.status),
                                                o.status === 'RequestDelete' && React.createElement('div', { className: "text-[10px] text-red-600 truncate max-w-[100px] md:max-w-none mt-1" }, `Motif: ${o.deleteReason || 'N/A'}`)
                                            ),
                                            React.createElement('td', { className: "p-2 md:p-3 hidden lg:table-cell font-medium text-indigo-600 truncate max-w-[150px]" },
                                                o.salesRepName
                                            ),
                                            React.createElement('td', { className: "p-2 md:p-3 text-right" },
                                                o.status !== 'RequestDelete'
                                                ? React.createElement('div', { className: "flex justify-end gap-1 md:gap-2" },
                                                    React.createElement('button', { onClick: () => redownloadPDF(o), className: "text-blue-600 bg-blue-50 hover:bg-blue-100 p-1.5 md:p-2 rounded-lg transition", title: "Télécharger PDF" }, React.createElement(Icon, { name: "download", size: 16 })),
                                                    React.createElement('button', { onClick: () => deleteOrder(o.id), className: "text-red-600 bg-red-50 hover:bg-red-100 p-1.5 md:p-2 rounded-lg transition", title: "Suppression Immédiate" }, React.createElement(Icon, { name: "trash", size: 16 }))
                                                )
                                                : React.createElement('div', { className: "text-xs font-bold text-red-600" }, "En attente d'approbation")
                                            )
                                        ))
                                    )
                                )
                            )
                        ),
                        
                        // LOGS DE NOM (Maintenant dans un onglet séparé 'history')
                    ),

                    // NOUVEAU TAB HISTORIQUE NOM
                    tab === 'history' && React.createElement('div', { className: "space-y-6" },
                        React.createElement('h2', { className: "text-2xl font-bold text-slate-800 mb-4" }, "Historique des changements de nom"),
                        React.createElement('div', { className: "flex justify-between items-center bg-slate-800/80 p-4 rounded-xl border border-slate-700" },
                            React.createElement('p', { className: "text-white text-sm" }, `Total des logs : ${nameLogs.length}`),
                            React.createElement('button', { 
                                onClick: deleteAllNameLogs,
                                disabled: nameLogs.length === 0,
                                className: "flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white text-sm font-bold py-2 px-4 rounded-lg transition disabled:opacity-50"
                            }, React.createElement(Icon, { name: "trash", size: 16 }), "Supprimer tout l'historique"),
                        ),

                        React.createElement('div', { className: "bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden" },
                            React.createElement('div', { className: "p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center" },
                                React.createElement('h3', { className: "font-bold text-slate-800" }, "Logs individuels")
                            ),
                            React.createElement('div', { className: "overflow-x-auto" },
                                React.createElement('table', { className: "w-full text-left" },
                                    React.createElement('thead', { className: "bg-slate-50 text-[10px] md:text-xs uppercase text-slate-500 font-bold tracking-wider" },
                                        React.createElement('tr', null,
                                            React.createElement('th', { className: "p-3" }, "Date"),
                                            React.createElement('th', { className: "p-3" }, "Utilisateur"),
                                            React.createElement('th', { className: "p-3" }, "Ancien Nom"),
                                            React.createElement('th', { className: "p-3" }, "Nouveau Nom"),
                                            React.createElement('th', { className: "p-3 text-right" }, "Action")
                                        )
                                    ),
                                    React.createElement('tbody', { className: "text-xs md:text-sm divide-y divide-slate-100" },
                                        nameLogs.map(log => React.createElement('tr', { key: log.id, className: "hover:bg-slate-50 transition-colors" },
                                            React.createElement('td', { className: "p-3 whitespace-nowrap text-slate-500" }, log.timestamp.seconds ? new Date(log.timestamp.seconds * 1000).toLocaleString('fr-FR') : '-'),
                                            React.createElement('td', { className: "p-3 font-medium text-blue-600" }, log.userEmail),
                                            React.createElement('td', { className: "p-3 text-red-600 line-through" }, log.oldName),
                                            React.createElement('td', { className: "p-3 font-bold text-green-600" }, log.newName),
                                            React.createElement('td', { className: "p-3 text-right" }, 
                                                React.createElement('button', { 
                                                    onClick: () => deleteNameLog(log.id), 
                                                    className: "p-1.5 text-red-500 bg-red-50 hover:bg-red-100 border border-red-200 rounded transition",
                                                    title: "Supprimer ce log"
                                                }, React.createElement(Icon, { name: "trash", size: 16 }))
                                            )
                                        ))
                                    )
                                )
                            )
                        )
                    ),


                    // TAB CLIENTS (Inchangé)
                    tab === 'clients' && React.createElement('div', { className: "bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden" },
                        React.createElement('div', { className: "overflow-x-auto" },
                            React.createElement('table', { className: "w-full text-left" },
                                React.createElement('thead', { className: "bg-slate-50 text-[10px] md:text-xs uppercase text-slate-500 font-bold tracking-wider" },
                                    React.createElement('tr', null,
                                        React.createElement('th', { className: "p-2 md:p-3" }, "Société"),
                                        React.createElement('th', { className: "p-2 md:p-3 hidden md:table-cell" }, "SIRET"),
                                        React.createElement('th', { className: "p-2 md:p-3 hidden md:table-cell" }, "Email"),
                                        React.createElement('th', { className: "p-2 md:p-3" }, "Tel"),
                                        React.createElement('th', { className: "p-2 md:p-3 text-right" }, "Fiche")
                                    )
                                ),
                                React.createElement('tbody', { className: "text-xs md:text-sm divide-y divide-slate-100" },
                                    getUniqueClients().map((c, i) => React.createElement('tr', { key: i, className: "hover:bg-slate-50 transition-colors" },
                                        React.createElement('td', { className: "p-2 md:p-3 font-bold text-slate-700 truncate max-w-[110px] md:max-w-none" }, c.companyName),
                                        React.createElement('td', { className: "p-2 md:p-3 hidden md:table-cell font-mono text-slate-500" }, c.siren),
                                        React.createElement('td', { className: "p-2 md:p-3 hidden md:table-cell text-blue-600 truncate max-w-[150px]" }, c.clientEmail),
                                        React.createElement('td', { className: "p-2 md:p-3 whitespace-nowrap" },
                                            c.clientPhone ? React.createElement('a', { href: `tel:${c.clientPhone}`, className: "text-slate-600 hover:text-blue-600" }, formatPhoneNumber(c.clientPhone)) : '-'
                                        ),
                                        React.createElement('td', { className: "p-2 md:p-3 text-right" },
                                            (c.siren && c.siren !== "EN COURS")
                                            ? React.createElement('a', { href: `https://annuaire-entreprises.data.gouv.fr/entreprise/${c.siren.replace(/\s/g,'')}`, target:"_blank", className: "inline-flex items-center justify-center bg-blue-50 text-blue-700 px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wide hover:bg-blue-100 border border-blue-200" }, "Voir")
                                            : React.createElement('span', { className: "text-slate-300" }, "-")
                                        )
                                    ))
                                )
                            )
                        )
                    ),

                    // TAB SETTINGS (Inchangé)
                    tab === 'settings' && React.createElement('div', { className: "bg-slate-800 p-6 rounded-xl text-white" },
                        React.createElement('h3', { className: "font-bold mb-4" }, "🏢 Informations Société (Prestataire)"),
                        React.createElement('div', { className: "space-y-4 mb-6" },
                            React.createElement('input', { type: "text", placeholder: "Nom Société", value: globalSettings.myCompanyName, onChange: e => setGlobalSettings({...globalSettings, myCompanyName: e.target.value}), className: "w-full bg-slate-700 p-2 rounded text-white border border-slate-600" }),
                            React.createElement('input', { type: "text", placeholder: "Adresse Complète", value: globalSettings.myAddress, onChange: e => setGlobalSettings({...globalSettings, myAddress: e.target.value}), className: "w-full bg-slate-700 p-2 rounded text-white border border-slate-600" }),
                            React.createElement('div', { className: "grid grid-cols-2 gap-4" },
                                React.createElement('input', { type: "text", placeholder: "SIRET", value: globalSettings.mySiret, onChange: e => setGlobalSettings({...globalSettings, mySiret: e.target.value}), className: "w-full bg-slate-700 p-2 rounded text-white border border-slate-600" }),
                                React.createElement('input', { type: "email", placeholder: "Email Contact", value: globalSettings.myEmail, onChange: e => setGlobalSettings({...globalSettings, myEmail: e.target.value}), className: "w-full bg-slate-700 p-2 rounded text-white border border-slate-600" })
                            )
                        ),
                        
                        React.createElement('h3', { className: "font-bold mb-4 border-t border-slate-700 pt-4" }, "⚙️ Paramètres & Tarifs"),
                        React.createElement('div', { className: "mb-6" },
                            React.createElement('label', { className: "block text-sm text-yellow-400 mb-1 font-bold" }, "PROCHAIN NUMÉRO"),
                            React.createElement('div', { className: "flex items-center gap-2" },
                                React.createElement('span', { className: "text-slate-400 font-mono" }, new Date().getFullYear() + "" + (new Date().getMonth()+1).toString().padStart(2,'0') + "-"),
                                React.createElement('input', { type: "number", className: "w-24 bg-slate-900 border border-yellow-500 rounded p-2 text-white font-bold text-center", value: globalSettings.sequenceNumber, onChange: e => setGlobalSettings({...globalSettings, sequenceNumber: parseInt(e.target.value)}) })
                            )
                        ),
                        React.createElement('div', { className: "grid grid-cols-2 gap-4 mb-4" },
                            React.createElement('div', null,
                                React.createElement('label', { className: "block text-sm text-slate-300 mb-1" }, "Tarif Base (€)"),
                                React.createElement('input', { type: "number", className: "w-full bg-slate-700 border border-slate-600 rounded p-2 text-white", value: globalSettings.defaultRate, onChange: e => setGlobalSettings({...globalSettings, defaultRate: parseInt(e.target.value)}) })
                            ),
                            React.createElement('div', null,
                                React.createElement('label', { className: "block text-sm text-slate-300 mb-1" }, "Type Taxe"),
                                React.createElement('select', { className: "w-full bg-slate-700 border border-slate-600 rounded p-2 text-white", value: globalSettings.taxType, onChange: e => setGlobalSettings({...globalSettings, taxType: e.target.value}) },
                                    React.createElement('option', { value: "HT" }, "HT"),
                                    React.createElement('option', { value: "TTC" }, "TTC")
                                )
                            )
                        ),
                        React.createElement('div', { className: "grid grid-cols-2 gap-4 mt-4" },
                            React.createElement('div', null,
                                React.createElement('label', { className: "block text-xs text-slate-400 mb-1" }, "Logo"),
                                React.createElement('input', { type: "file", accept: "image/*", onChange: (e) => handleImageUpload(e, 'logo'), className: "text-xs text-slate-500" })
                            ),
                            React.createElement('div', null,
                                React.createElement('label', { className: "block text-xs text-slate-400 mb-1" }, "Cachet"),
                                React.createElement('input', { type: "file", accept: "image/*", onChange: (e) => handleImageUpload(e, 'stamp'), className: "text-xs text-slate-500" })
                            )
                        ),
                        React.createElement('button', { onClick: saveSettings, className: "mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition" }, "ENREGISTRER TOUS LES PARAMÈTRES")
                    )
                )
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
