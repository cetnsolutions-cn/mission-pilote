<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>RDV CRM - V30 Ultimate</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
        /* 1. RESET DE BASE OBLIGATOIRE */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            min-height: 100%;
            -webkit-tap-highlight-color: transparent;
            /* Enl√®ve la couleur de fond par d√©faut qui peut faire des flashs blancs */
            background-color: #667eea; 
        }

        /* 2. LE FOND MAGIQUE (FIX POUR MOBILE) */
        /* Au lieu de peindre le body, on cr√©e un calque virtuel derri√®re qui ne bouge jamais */
        body::before {
            content: "";
            position: fixed; /* Force l'√©l√©ment √† rester coll√© √† l'√©cran */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%; 
            height: 100dvh; /* Prend toute la hauteur dynamique (barre d'adresse incluse) */
            z-index: -1; /* Se place DERRI√àRE le contenu */
            
            /* Ton d√©grad√© original */
            background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #00f2fe 100%);
            background-size: 400% 400%;
            animation: gradient-shift 15s ease infinite;
        }

        /* 3. LE CONTENU (SCROLLABLE) */
        body {
            font-family: 'Segoe UI', sans-serif;
            overflow-x: hidden;
            /* Plus de background ici, c'est g√©r√© par ::before */
        }

        #app {
            position: relative;
            min-height: 100vh; 
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            /* Permet au contenu de scroller par-dessus le fond fixe */
        }

        /* --- RESTE DE TON CSS (ANIMATIONS & COMPOSANTS) --- */

        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Animations */
        @keyframes fadeIn { from {opacity:0; transform: translateY(10px);} to {opacity:1; transform: translateY(0);} }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        
        @keyframes popIn { 0%{transform: scale(0.9); opacity: 0;} 100%{transform: scale(1); opacity: 1;} }
        .pop-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        @keyframes slideUp { from {transform: translateY(20px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
        .slide-up { animation: slideUp 0.4s ease-out forwards; }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); } }
        .animate-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        
        /* Animations pour header moderne */
        @keyframes shimmer {
            0% { transform: translateX(-100%) skewX(-15deg); }
            100% { transform: translateX(200%) skewX(-15deg); }
        }
        .animate-shimmer { animation: shimmer 2s infinite; }
        
        @keyframes gradient-shift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        .animate-gradient-shift {
            background-size: 200% 200%;
            animation: gradient-shift 3s ease infinite;
        }
        
        @keyframes pulse-slow {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
        }
        .animate-pulse-slow { animation: pulse-slow 4s ease-in-out infinite; }
        
        @keyframes bounce-slow {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .animate-bounce-slow { animation: bounce-slow 2s ease-in-out infinite; }
        
        /* Animation shine pour effet de brillance */
        @keyframes shine {
            0% { transform: translateX(-100%) skewX(-12deg); }
            100% { transform: translateX(200%) skewX(-12deg); }
        }
        .animate-shine { animation: shine 3s infinite; }
        
        /* Animation fadeIn pour modale */
        .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
        
        /* Confetti */
        .confetti { position: fixed; width: 10px; height: 10px; background-color: #f00; animation: fall linear forwards; z-index: 1; pointer-events: none !important; }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }
        
        /* Animation pour notification toast */
        @keyframes slide-in-right {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .animate-slide-in-right {
            animation: slide-in-right 0.3s ease-out forwards;
        }
        
        /* Transition Vue pour toast */
        .toast-enter-active {
            transition: all 0.3s ease-out;
        }
        .toast-leave-active {
            transition: all 0.3s ease-in;
        }
        .toast-enter-from {
            transform: translateX(100%);
            opacity: 0;
        }
        .toast-leave-to {
            transform: translateX(100%);
            opacity: 0;
        }

        /* Scrollbar Masqu√©e */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        .logo-img { width: 20px; height: 20px; object-fit: contain; border-radius: 4px; }
        .badge-status { padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; }
        .custom-checkbox { width: 24px; height: 24px; cursor: pointer; accent-color: #2563EB; z-index: 50; position: relative; }

        /* Style sp√©cifique du Date Picker V22 */
        .date-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        .date-card-selected {
            border-color: #2563EB; 
            background-color: #2563EB;
            color: white;
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.5), 0 4px 6px -2px rgba(37, 99, 235, 0.5);
        }

        /* Masquer la fl√®che du datalist */
        input::-webkit-calendar-picker-indicator {
            display: none !important;
        }

        /* --- NOUVEAUX STYLES POUR RENDRE-VOUS EN COURS --- */
        @keyframes status-pulse {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); } 
            70% { box-shadow: 0 0 0 8px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        
        /* Animation BORDURE CARD (Demand√©e) */
        @keyframes border-pulse { 
            0% { border-color: rgba(34, 197, 94, 0.2); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); } 
            50% { border-color: rgba(34, 197, 94, 1); box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); } 
            100% { border-color: rgba(34, 197, 94, 0.2); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); } 
        }
        .live-animation { animation: border-pulse 2s infinite; border: 2px solid #22c55e !important; }

        .status-label-active {
            font-size: 10px; font-weight: 900; text-transform: uppercase; color: #22c55e;
            display: flex; align-items: center; padding: 4px 8px; border-radius: 6px;
            background-color: #f0fdf4; border: 1px solid #bbf7d0; letter-spacing: 0.5px;
            animation: fadeIn 0.4s ease-out forwards;
        }
        .status-label-active .live-dot {
            width: 8px; height: 8px; background-color: #22c55e; border-radius: 50%; margin-right: 6px;
            animation: status-pulse 1.5s infinite;
        }
       /* =========================================
           üéÖ TH√àME NO√ãL - ULTRA COMPLET üéÖ
           ========================================= */

        /* 1. CURSEUR SAPIN (Uniquement sur PC) */
        @media (min-width: 768px) {
            .theme-christmas, 
            .theme-christmas button, 
            .theme-christmas a, 
            .theme-christmas input {
                /* Remplace le curseur par un Sapin */
                cursor: url('https://img.icons8.com/color/32/christmas-tree.png'), auto !important;
            }
            /* Curseur "Main" devient un P√®re No√´l ou Cadeau */
            .theme-christmas .cursor-pointer {
                cursor: url('https://img.icons8.com/color/32/gift--v1.png'), pointer !important;
            }
        }

        /* 2. EFFET "GRELOT" (Les boutons tremblent au survol) */
        @keyframes jingle {
            0% { transform: rotate(0); }
            25% { transform: rotate(5deg); }
            50% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
            100% { transform: rotate(0); }
        }

        .theme-christmas button:hover,
        .theme-christmas .cursor-pointer:hover {
            animation: jingle 0.5s ease-in-out infinite; /* √áa grelotte ! */
            box-shadow: 0 0 15px rgba(220, 38, 38, 0.8) !important; /* Lueur rouge */
        }

        /* 3. NEIGE MAGIQUE (Tombe et ondule) */
        .snowflake {
            position: fixed; top: -5vh; color: #fff;
            text-shadow: 0 0 5px rgba(255,255,255,0.8);
            pointer-events: none !important; z-index: 1;
            animation: snowfall linear infinite;
        }
        @keyframes snowfall {
            0% { transform: translateY(0) translateX(0) rotate(0deg); opacity: 1; }
            25% { transform: translateY(25vh) translateX(15px) rotate(90deg); }
            50% { transform: translateY(50vh) translateX(-15px) rotate(180deg); }
            75% { transform: translateY(75vh) translateX(15px) rotate(270deg); }
            100% { transform: translateY(110vh) translateX(0) rotate(360deg); opacity: 0; }
        }

        /* 4. COULEURS & D√âGRAD√âS NO√ãL */
        .theme-christmas body { background-color: #fff1f2 !important; /* Fond ros√© hiver */ }

        /* Les boutons bleus deviennent ROUGE NO√ãL */
        .theme-christmas .bg-blue-600 { 
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%) !important; 
            border: 1px solid #fca5a5;
        }
        
        /* Les textes bleus deviennent VERT SAPIN */
        .theme-christmas .text-blue-600, 
        .theme-christmas .text-blue-500 { 
            color: #166534 !important; /* Vert fonc√© */
            font-weight: 800;
        }

        /* Fonds clairs (cartes) deviennent l√©g√®rement teint√©s */
        .theme-christmas .bg-blue-50 { background-color: #fef2f2 !important; border-color: #fecaca !important; }
        .theme-christmas .border-blue-200 { border-color: #fecaca !important; }

        /* 5. LOGO QUI RESPIRE (PULSE) */
        .theme-christmas .sidebar-logo {
            background: linear-gradient(135deg, #15803d 0%, #b91c1c 100%) !important;
            border: 2px solid #fbbf24; /* Bordure dor√©e */
            animation: christmas-pulse 3s infinite ease-in-out;
        }
        @keyframes christmas-pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); transform: scale(1); }
            50% { box-shadow: 0 0 20px 10px rgba(220, 38, 38, 0); transform: scale(1.1); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); transform: scale(1); }
        }

        /* 6. SUCRE D'ORGE (Barres de progression) */
        .theme-christmas .bg-blue-500, .theme-christmas .h-full.bg-black\/50 {
            background: repeating-linear-gradient(45deg, #dc2626, #dc2626 10px, #ffffff 10px, #ffffff 20px) !important;
            background-size: 28px 28px !important;
            animation: candy-stripe 1s linear infinite !important;
        }
        @keyframes candy-stripe { 0% { background-position: 0 0; } 100% { background-position: 28px 0; } }

        /* 7. ADAPTATION T√âL√âPHONE ("Typhons") */
        @media (max-width: 768px) {
            /* Sur mobile, le curseur redevient normal (pas de bug tactile) */
            .theme-christmas * { cursor: auto !important; }
            
            /* Les boutons importants respirent tout seuls (car pas de survol) */
            .theme-christmas button.bg-slate-900, /* Bouton Nouveau */
            .theme-christmas button.bg-blue-600 { /* Boutons actions */
                animation: heartbeat 2s infinite !important;
            }
            @keyframes heartbeat {
                0% { transform: scale(1); }
                10% { transform: scale(1.03); }
                20% { transform: scale(1); }
                100% { transform: scale(1); }
            }
        }

        /* --- AUTRES TH√àMES --- */
        .theme-summer .bg-blue-600 { background-color: #0ea5e9 !important; }
       /* =================================================================
           üéÉ HALLOWEEN : MODE "CYBER-WITCH" (Sombre & N√©on)
           ================================================================= */
        .theme-halloween body { 
            background: radial-gradient(circle at center, #2e1065 0%, #000000 100%) !important;
            color: #e4e4e7 !important;
        }
        
        /* Cartes "Verre Fum√©" */
        .theme-halloween .bg-white, .theme-halloween .bg-slate-50 { 
            background-color: rgba(20, 20, 20, 0.85) !important; 
            border: 1px solid rgba(139, 92, 246, 0.3); /* Bordure violette */
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            color: #fff !important;
        }

        /* Textes */
        .theme-halloween .text-slate-800, .theme-halloween .text-slate-700 { color: #fff !important; }
        .theme-halloween .text-slate-500 { color: #a1a1aa !important; }
        
        /* Boutons "Sortil√®ge" */
        .theme-halloween .bg-blue-600, .theme-halloween .bg-slate-900 { 
            background: linear-gradient(45deg, #f97316, #7c3aed) !important; 
            border: none;
            box-shadow: 0 0 15px #7c3aed;
            position: relative; overflow: hidden;
        }
        .theme-halloween .bg-blue-600:hover { box-shadow: 0 0 30px #f97316; transform: scale(1.02); }

        /* Cursors */
        @media (min-width: 768px) {
            .theme-halloween * { cursor: url('https://img.icons8.com/color/32/ghost.png'), auto !important; }
            .theme-halloween .cursor-pointer { cursor: url('https://img.icons8.com/color/32/halloween-pumpkin.png'), pointer !important; }
        }

        /* =================================================================
           ‚ù§Ô∏è TH√àME SAINT-VALENTIN : MODE "CALME & CHIC" (100% Fixe)
           ================================================================= */
        .theme-love body { 
            background: linear-gradient(to bottom, #fff1f2, #ffe4e6) !important; 
            color: #881337 !important;
        }

        /* Cartes fixes et propres */
        .theme-love .bg-white, .theme-love .bg-slate-50 { 
            background-color: #fff !important;
            border: 1px solid #fecdd3 !important;
            box-shadow: 0 4px 6px -1px rgba(225, 29, 72, 0.1); /* Ombre l√©g√®re rose */
            color: #4c0519 !important;
        }

        /* Textes */
        .theme-love .text-slate-800 { color: #881337 !important; }
        .theme-love .text-slate-500 { color: #9f1239 !important; }
        
        /* Boutons fixes (Pas de battement de coeur) */
        .theme-love .bg-blue-600, .theme-love .bg-slate-900 { 
            background: linear-gradient(135deg, #be123c 0%, #e11d48 100%) !important; 
            border: none;
            box-shadow: 0 4px 6px rgba(190, 18, 60, 0.2);
        }
        
        /* Survol simple (Juste un changement de couleur, pas de mouvement) */
        .theme-love .bg-blue-600:hover { 
            background: linear-gradient(135deg, #e11d48 0%, #be123c 100%) !important; 
        }

        /* Accents */
        .theme-love .text-blue-600 { color: #db2777 !important; }
        .theme-love .bg-blue-50 { background-color: #fff1f2 !important; border-color: #fda4af !important; }

        /* Logo fixe */
        .theme-love .sidebar-logo {
            background: linear-gradient(to bottom right, #fb7185, #be123c) !important;
            box-shadow: 0 0 0 2px rgba(251, 113, 133, 0.2);
        }

        /* Curseur standard (pour √©viter la fatigue visuelle) */
        @media (min-width: 768px) {
            .theme-love * { cursor: auto !important; }
            .theme-love .cursor-pointer { cursor: pointer !important; }
        }

        /* =================================================================
           üéÜ 14 JUILLET : MODE "R√âPUBLIQUE" (√âl√©gance Tricolore)
           ================================================================= */
        .theme-bastille body { background-color: #f1f5f9 !important; }

        /* Boutons Patriotiques (D√©grad√© Bleu Blanc Rouge subtil) */
        .theme-bastille .bg-blue-600, .theme-bastille .bg-slate-900 { 
            background: linear-gradient(90deg, #1e3a8a 0%, #1d4ed8 50%, #dc2626 100%) !important; 
            background-size: 200% auto;
            transition: 0.5s;
            border: 1px solid #fff;
            box-shadow: 0 4px 10px rgba(30, 58, 138, 0.3);
        }
        .theme-bastille .bg-blue-600:hover { background-position: right center !important; }

        /* Titres en Bleu Roi */
        .theme-bastille .text-slate-800 { color: #1e3a8a !important; }
        
        /* Logo qui √©tincelle */
        .theme-bastille .sidebar-logo {
            background: #dc2626 !important;
            animation: fireworks-flash 2s infinite;
        }
        @keyframes fireworks-flash {
            0%, 100% { box-shadow: 0 0 5px #1e3a8a; }
            50% { box-shadow: 0 0 20px #dc2626, 0 0 40px #fff; }
        }

        /* Cursors */
        @media (min-width: 768px) {
            .theme-bastille * { cursor: url('https://img.icons8.com/color/32/france.png'), auto !important; }
            .theme-bastille .cursor-pointer { cursor: url('https://img.icons8.com/color/32/firework.png'), pointer !important; }
        }

        /* =================================================================
           ‚òÄÔ∏è √âT√â / VACANCES : MODE "LAGON" (Fra√Æcheur & Soleil)
           ================================================================= */
        .theme-summer body { background-color: #ecfeff !important; } /* Cyan tr√®s p√¢le */

        /* Boutons "Mojito" (D√©grad√© Cyan/Jaune) */
        .theme-summer .bg-blue-600 { 
            background: linear-gradient(135deg, #06b6d4 0%, #f59e0b 100%) !important; 
            box-shadow: 0 4px 15px rgba(6, 182, 212, 0.4);
        }
        .theme-summer .bg-blue-600:hover { transform: rotate(-2deg) scale(1.05); }

        /* Cartes lumineuses */
        .theme-summer .bg-white { border-bottom: 4px solid #f59e0b !important; }

        /* Textes "Mer des Cara√Øbes" */
        .theme-summer .text-blue-600 { color: #0891b2 !important; }
        
        /* Logo Soleil qui tourne */
        .theme-summer .sidebar-logo {
            background: linear-gradient(to bottom, #f59e0b, #ea580c) !important;
            animation: spin-slow 20s linear infinite;
        }

        /* Cursors */
        @media (min-width: 768px) {
            .theme-summer * { cursor: url('https://img.icons8.com/color/32/sun--v1.png'), auto !important; }
            .theme-summer .cursor-pointer { cursor: url('https://img.icons8.com/color/32/melting-ice-cream.png'), pointer !important; }
        }

        /* =================================================================
           ‚ú® TH√àME MODERNE CHIC : MODE "LUXURY PREMIUM" (√âl√©gance & Sophistication)
           ================================================================= */
        
        /* Application du th√®me moderne par d√©faut */
        .theme-modern,
        body:not(.theme-christmas):not(.theme-halloween):not(.theme-love):not(.theme-bastille):not(.theme-summer):not(.theme-newyear) {
            /* Tous les styles modernes s'appliquent */
        }

        /* Effet Glassmorphism pour les cartes */
        .bg-white, .bg-slate-50 { 
            background: rgba(255, 255, 255, 0.95) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            box-shadow: 0 8px 32px 0 rgba(102, 126, 234, 0.15), 
                        0 4px 16px 0 rgba(118, 75, 162, 0.1) !important;
        }

        /* Header avec effet verre */
        header.bg-white\/80 {
            background: rgba(255, 255, 255, 0.9) !important;
            border-color: rgba(102, 126, 234, 0.2) !important;
        }

        /* Sidebar √©l√©gante */
        aside.bg-white {
            background: rgba(255, 255, 255, 0.95) !important;
            border-right: 1px solid rgba(102, 126, 234, 0.2) !important;
            box-shadow: 4px 0 24px rgba(102, 126, 234, 0.1) !important;
        }

        /* Boutons avec d√©grad√© premium */
        .bg-blue-600, .bg-slate-900 { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%) !important;
            border: none !important;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4),
                        0 4px 15px rgba(118, 75, 162, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2) !important;
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }
        .bg-blue-600:hover, .bg-slate-900:hover {
            transform: translateY(-2px) scale(1.02) !important;
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.5),
                        0 6px 20px rgba(118, 75, 162, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3) !important;
        }
        .bg-blue-600:active, .bg-slate-900:active {
            transform: translateY(0) scale(0.98) !important;
        }

        /* Effet brillant sur les boutons */
        .bg-blue-600::before, .bg-slate-900::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }
        .bg-blue-600:hover::before, .bg-slate-900:hover::before {
            left: 100%;
        }

        /* Textes avec couleurs sophistiqu√©es */
        .text-slate-800, .text-slate-700 { 
            color: #1e1b4b !important; /* Indigo tr√®s fonc√© */
        }
        .text-slate-500 { 
            color: #6366f1 !important; /* Indigo moyen */
        }
        .text-blue-600, .text-blue-500 { 
            color: #667eea !important; /* Violet-bleu */
            font-weight: 600;
        }

        /* Zones actives avec fond d√©grad√© subtil */
        .bg-blue-50 { 
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%) !important;
            border-color: rgba(102, 126, 234, 0.3) !important;
        }
        .border-blue-200 { 
            border-color: rgba(102, 126, 234, 0.4) !important;
        }

        /* Logo avec effet premium */
        .sidebar-logo {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%) !important;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3) !important;
            animation: logo-glow 3s ease-in-out infinite !important;
        }
        @keyframes logo-glow {
            0%, 100% { 
                box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4),
                            inset 0 1px 0 rgba(255, 255, 255, 0.3);
            }
            50% { 
                box-shadow: 0 12px 32px rgba(118, 75, 162, 0.6),
                            inset 0 1px 0 rgba(255, 255, 255, 0.4);
            }
        }

        /* Cartes avec effet hover √©l√©gant */
        .rounded-2xl, .rounded-3xl, .rounded-xl {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }
        .rounded-2xl:hover, .rounded-3xl:hover {
            transform: translateY(-4px) !important;
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.2),
                        0 6px 20px rgba(118, 75, 162, 0.15) !important;
        }

        /* Scrollbar √©l√©gante */
        ::-webkit-scrollbar { 
            width: 8px; 
            height: 8px; 
        }
        ::-webkit-scrollbar-track { 
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: padding-box;
        }
        ::-webkit-scrollbar-thumb:hover { 
            background: linear-gradient(135deg, #764ba2 0%, #f093fb 100%);
        }

        /* Inputs avec style moderne */
        input, textarea, select {
            background: rgba(255, 255, 255, 0.9) !important;
            border-color: rgba(102, 126, 234, 0.3) !important;
            transition: all 0.3s !important;
        }
        input:focus, textarea:focus, select:focus {
            border-color: #667eea !important;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1) !important;
            background: rgba(255, 255, 255, 1) !important;
        }

        /* Badges avec d√©grad√© */
        .badge-status {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%) !important;
            border: 1px solid rgba(102, 126, 234, 0.3) !important;
        }

        /* Styles pour le calendrier semaine */
        .calendar-week-container {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: white;
        }
        .calendar-week-grid {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
            min-height: 600px;
        }
        .calendar-time-column {
            border-right: 2px solid #e2e8f0;
            background: #f8fafc;
        }
        .calendar-time-header {
            height: 60px;
            border-bottom: 2px solid #e2e8f0;
        }
        .calendar-time-cell {
            height: 60px;
            border-bottom: 1px solid #f1f5f9;
            padding: 4px 8px;
            font-size: 11px;
            color: #64748b;
            font-weight: 600;
            display: flex;
            align-items: flex-start;
            padding-top: 8px;
        }
        .calendar-day-column {
            border-right: 1px solid #e2e8f0;
            position: relative;
        }
        .calendar-day-column.today-column {
            background: #f0f9ff;
        }
        .calendar-day-header {
            min-height: 100px;
            border-bottom: 2px solid #e2e8f0;
            padding: 12px 8px;
            text-align: center;
            background: white;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .calendar-day-header.today-header {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }
        .calendar-day-header.today-header .text-xs {
            color: rgba(255, 255, 255, 0.9);
        }
        .calendar-day-column.closed-day {
            opacity: 0.5;
            background: #f8fafc;
        }
        .calendar-day-column.closed-day .calendar-time-slot {
            cursor: not-allowed;
        }
        .calendar-time-slots {
            position: relative;
        }
        .calendar-time-slot {
            height: 60px;
            border-bottom: 1px solid #f1f5f9;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
        }
        .calendar-time-slot:hover {
            background: #f8fafc;
        }
        .calendar-time-slot.current-time {
            background: #fef3c7;
        }
        .calendar-time-slot.closed-slot {
            background: #f8fafc;
            cursor: not-allowed;
            opacity: 0.4;
        }
        .calendar-time-slot.available-slot:hover {
            background: #f0f9ff;
            border-left: 3px solid #3b82f6;
        }
        .calendar-opening-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: #22c55e;
            z-index: 15;
            pointer-events: none;
        }
        .opening-line-label {
            position: absolute;
            left: 4px;
            top: -12px;
            background: #22c55e;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: bold;
            white-space: nowrap;
        }
        .calendar-event-block {
            position: absolute;
            left: 4px;
            right: 4px;
            padding: 6px 8px;
            border-radius: 6px;
            font-size: 11px;
            color: white;
            cursor: pointer;
            overflow: hidden;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
            transition: all 0.2s;
            border-left: 3px solid rgba(255, 255, 255, 0.5);
        }
        .calendar-event-block:hover {
            transform: translateX(2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.25);
            z-index: 20;
            border-left-width: 4px;
        }
        .event-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .event-time-badge {
            font-size: 9px;
            font-weight: 800;
            opacity: 0.95;
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 4px;
            border-radius: 3px;
            display: inline-block;
            width: fit-content;
        }
        .event-title-text {
            font-size: 11px;
            font-weight: 700;
            line-height: 1.3;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        /* Date picker avec style premium */
        .date-card-selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            border-color: #667eea !important;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4) !important;
        }

        /* Statut actif avec animation √©l√©gante */
        .status-label-active {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(34, 197, 94, 0.1) 100%) !important;
            border-color: rgba(34, 197, 94, 0.4) !important;
        }

       

        /* Boutons de navigation avec style moderne */
        button.text-gray-500:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%) !important;
            color: #667eea !important;
        }

        /* Statistiques avec fond d√©grad√© subtil */
        .bg-white.border {
            background: rgba(255, 255, 255, 0.95) !important;
        }
    </style>
</head>
<body>

<div id="app" :class="currentTheme.classes" class="h-screen flex flex-col overflow-hidden text-slate-800 transition-colors duration-500">
   <div class="pointer-events-none fixed inset-0 z-[1] overflow-hidden">
        
        <div v-if="currentTheme.name === 'christmas'">
            <div v-for="n in 50" :key="n" class="snowflake pointer-events-none" :style="{ left: Math.random()*100 + 'vw', animationDuration: (Math.random()*5+5)+'s', animationDelay: '-'+Math.random()*5+'s', fontSize: (Math.random()*10+10)+'px' }">‚ùÑ</div>
            <div class="absolute bottom-[-20px] right-[-10px] opacity-20 text-9xl transform rotate-12 pointer-events-none">üéÑ</div>
        </div>

        <div v-if="currentTheme.name === 'halloween'">
            
            <div class="absolute top-[-20px] right-[-20px] opacity-20 text-[150px] pointer-events-none text-slate-500 rotate-12">üï∏Ô∏è</div>
            
            <div v-for="n in 6" :key="n" class="absolute text-3xl opacity-30 pointer-events-none" 
                 :style="{ 
                     left: Math.random()*100 + 'vw', 
                     top: Math.random()*60 + 'vh', 
                     animation: 'float-ghost ' + (Math.random()*5+5) + 's ease-in-out infinite',
                     fontSize: (Math.random()*20+20)+'px'
                 }">
                 ü¶á
            </div>
            <div v-if="currentTheme.name === 'bastille'">
            <div v-for="n in 5" :key="n" class="absolute w-2 h-2 rounded-full animate-ping pointer-events-none" 
                 :style="{ 
                    left: Math.random()*100 + 'vw', 
                    top: Math.random()*50 + 'vh', 
                    backgroundColor: ['#1e3a8a', '#dc2626', '#ffffff'][Math.floor(Math.random()*3)],
                    animationDuration: '1s', 
                    animationDelay: Math.random()+'s' 
                 }"></div>
             <div class="absolute bottom-4 right-4 opacity-20 text-8xl pointer-events-none">üá´üá∑</div>
        </div>
        

            <div class="absolute bottom-0 left-0 w-full h-32 bg-gradient-to-t from-purple-900/20 to-transparent pointer-events-none"></div>
        </div>

       <div v-if="currentTheme.name === 'love'">
            <div class="absolute bottom-[-30px] right-[-20px] opacity-10 text-[180px] pointer-events-none grayscale-[0.2] rotate-[-15deg]">üåπ</div>
        </div>

        <div v-if="currentTheme.name === 'summer'">
            <div class="sun-ray pointer-events-none"></div> <div class="absolute top-[-50px] right-[-50px] text-9xl text-yellow-400 opacity-20 animate-spin-slow pointer-events-none" style="animation-duration: 20s;">‚òÄÔ∏è</div>
            <div class="absolute bottom-10 left-10 text-6xl opacity-10 pointer-events-none">üç¶</div>
        </div>

        <div v-if="currentTheme.name === 'newyear'">
            <div v-for="n in 40" :key="n" class="confetti pointer-events-none" :style="{ left: Math.random()*100 + 'vw', top: '-10px', backgroundColor: ['#FFD700', '#C0C0C0', '#000'][Math.floor(Math.random()*3)], animationDuration: (Math.random()*3+2)+'s' }"></div>
        </div>

    </div>
    <div v-if="!user.logged" class="fixed inset-0 bg-slate-900 z-[200] flex items-center justify-center p-4">
        
        <div v-if="!loginAdminSelection" class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center fade-in relative overflow-hidden">
            
            <div class="w-16 h-16 bg-blue-600 rounded-lg flex items-center justify-center text-white mx-auto mb-6 shadow-lg shadow-blue-500/30 relative z-10 overflow-hidden">
                <img v-if="globalSettings.appLogoUrl" :src="globalSettings.appLogoUrl" class="w-full h-full object-cover">
                <i v-else class="fa-solid fa-address-book text-3xl"></i>
            </div>
            
            <h1 class="text-2xl font-bold mb-6 relative z-10">Connexion CRM</h1>
            
            <div class="space-y-4 relative z-10">
                <input type="text" v-model="loginEmail" @keyup.enter="login" placeholder="Identifiant / Email" autocomplete="username" class="w-full p-4 border-2 border-gray-200 rounded-xl text-center text-lg mb-2 outline-none focus:border-blue-600 transition">
                <input type="password" v-model="loginPass" @keyup.enter="login" placeholder="Mot de passe" autocomplete="current-password" class="w-full p-4 border-2 border-gray-200 rounded-xl text-center text-lg tracking-widest outline-none focus:border-blue-600 transition">
            </div>

            <button @click="login" class="relative z-10 w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition transform active:scale-95 mt-6 mb-2">Se connecter</button>
            <div class="mt-4 text-xs text-gray-400 relative z-10">Acc√®s s√©curis√©</div>
        </div>

        <div v-else class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center pop-in">
            <h2 class="text-xl font-bold mb-6 text-slate-700">Qui se connecte ?</h2>
            <div class="grid grid-cols-2 gap-3 mb-4">
                <button v-for="name in adminNamesList" :key="name" @click="finalizeAdminLogin(name)" class="p-4 bg-slate-100 hover:bg-blue-100 border-2 border-transparent hover:border-blue-500 rounded-xl font-bold text-slate-700 hover:text-blue-700 transition flex flex-col items-center gap-2">
                    <i class="fa-solid fa-user-tie text-2xl"></i>
                    {{ name }}
                </button>
            </div>
            <button @click="loginAdminSelection=false" class="text-gray-400 hover:text-gray-600 underline text-sm">Retour</button>
        </div>
    </div>

    <div v-else class="flex flex-1 h-full relative">
        
        <div v-if="mobileMenuOpen" @click="mobileMenuOpen=false" class="fixed inset-0 bg-black/50 z-30 md:hidden"></div>

        <aside :class="mobileMenuOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'" class="fixed md:relative w-64 bg-white shadow-xl flex flex-col z-40 h-full transition-transform duration-300 ease-in-out">
            <div class="p-6 border-b flex items-center gap-3">
            <div class="sidebar-logo w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold flex-shrink-0 transition-all duration-500 overflow-hidden relative">
    <img v-if="globalSettings.appLogoUrl" :src="globalSettings.appLogoUrl" class="w-full h-full object-cover">
    
    <div v-else class="flex items-center justify-center w-full h-full">
        <i v-if="currentTheme.name === 'modern'" class="fa-solid fa-sparkles text-lg"></i>
        <i v-else-if="currentTheme.name === 'christmas'" class="fa-solid fa-tree text-lg"></i>
        <i v-else-if="currentTheme.name === 'love'" class="fa-solid fa-heart text-xl text-white"></i>
        <i v-else-if="currentTheme.name === 'halloween'" class="fa-solid fa-hat-wizard text-lg"></i>
        <i v-else-if="currentTheme.name === 'bastille'" class="fa-solid fa-flag-usa text-lg"></i>
        <i v-else-if="currentTheme.name === 'newyear'" class="fa-solid fa-champagne-glasses text-lg"></i>
        <i v-else-if="currentTheme.name === 'summer'" class="fa-solid fa-sun text-lg"></i>
        <i v-else class="fa-solid fa-calendar-check"></i>
    </div>
</div>
                <div class="min-w-0">
                    <h1 class="font-bold text-lg leading-tight truncate">RDV Manager</h1>
                    <span class="text-[10px] bg-slate-100 px-2 py-0.5 rounded text-slate-500 uppercase font-bold truncate block">{{ user.name }}</span>
                </div>
                <button @click="mobileMenuOpen=false" class="ml-auto md:hidden text-gray-400"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>

            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <button @click="changeView('dashboard'); mobileMenuOpen=false" :class="view==='dashboard'?'bg-blue-50 text-blue-600 font-bold border-blue-200':'text-gray-500 hover:bg-gray-50 border-transparent'" class="w-full text-left p-3 rounded-xl flex items-center gap-3 border transition"><i class="fa-solid fa-chart-line w-5 text-center"></i> Tableau de bord</button>
                <button @click="changeView('list'); mobileMenuOpen=false" :class="view==='list'?'bg-blue-50 text-blue-600 font-bold border-blue-200':'text-gray-500 hover:bg-gray-50 border-transparent'" class="w-full text-left p-3 rounded-xl flex items-center gap-3 border transition"><i class="fa-solid fa-address-book w-5 text-center"></i> Tous les RDV</button>
                <button @click="changeView('portefeuille'); mobileMenuOpen=false" :class="view==='portefeuille'?'bg-blue-50 text-blue-600 font-bold border-blue-200':'text-gray-500 hover:bg-gray-50 border-transparent'" class="w-full text-left p-3 rounded-xl flex items-center gap-3 border transition"><i class="fa-solid fa-wallet w-5 text-center"></i> Portefeuille</button>
                <button @click="changeView('rappels'); mobileMenuOpen=false" :class="{'border-red-300 bg-red-50 text-red-600': rappelCount > 0}" class="w-full text-left p-3 rounded-xl flex items-center gap-3 border border-transparent hover:bg-gray-50 transition mt-4"><i class="fa-solid fa-bell w-5 text-center"></i> Rappels <span v-if="rappelCount>0" class="ml-auto bg-red-600 text-white text-xs px-2 py-1 rounded-full font-bold">{{ rappelCount }}</span></button>
                <button v-if="pendingStatusCount > 0" @click="changeView('pending_status'); mobileMenuOpen=false" class="w-full text-left p-3 rounded-2xl flex items-center gap-3 bg-purple-100 border border-purple-300 text-purple-700 mt-2 font-bold animate-pulse"><i class="fa-solid fa-clipboard-question w-5 text-center"></i> Statuts √† d√©finir <span class="ml-auto bg-purple-600 text-white text-xs px-2 py-1 rounded-full">{{ pendingStatusCount }}</span></button>
                <button v-if="confirmCount > 0" @click="changeView('confirmations'); mobileMenuOpen=false" class="w-full text-left p-3 rounded-2xl flex items-center gap-3 bg-orange-100 border border-orange-300 text-orange-700 mt-2 font-bold animate-pulse"><i class="fa-solid fa-circle-exclamation w-5 text-center"></i> √Ä Confirmer <span class="ml-auto bg-orange-600 text-white text-xs px-2 py-1 rounded-full">{{ confirmCount }}</span></button>
            </nav>

            <div class="p-4 border-t space-y-2">
                <button @click="changeView('trash'); mobileMenuOpen=false" :class="view==='trash'?'bg-gray-100 text-gray-800 font-bold':'text-gray-400 hover:text-gray-600 hover:bg-gray-50'" class="w-full text-left p-3 rounded-xl flex items-center gap-3 transition"><i class="fa-solid fa-trash-can w-5 text-center"></i> Corbeille <span v-if="trashCount > 0" class="ml-auto bg-gray-200 text-gray-600 text-xs px-2 py-1 rounded-full font-bold">{{ trashCount }}</span></button>
            </div>

            <div class="p-4 border-t space-y-2">
                <button v-if="user.role==='admin'" @click="openSettings(); mobileMenuOpen=false" class="w-full text-left p-3 rounded-xl flex items-center gap-3 text-slate-600 hover:bg-slate-100 transition font-bold"><i class="fa-solid fa-gear w-5 text-center"></i> R√©glages</button>
                <button @click="logout" class="w-full text-left p-3 rounded-xl flex items-center gap-3 text-red-400 hover:text-red-600 hover:bg-red-50 transition font-bold"><i class="fa-solid fa-power-off w-5 text-center"></i> D√©connexion</button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col bg-[#f8fafc] relative overflow-hidden h-full w-full fixed inset-0">
          <header class="p-4 md:p-6 z-10 flex items-center gap-3 relative">
            
            <button @click="mobileMenuOpen = !mobileMenuOpen" class="md:hidden w-12 h-12 bg-white border border-slate-200 rounded-2xl text-slate-700 shadow-sm flex items-center justify-center hover:bg-slate-50 transition active:scale-95">
                <i class="fa-solid fa-bars text-xl"></i>
            </button>


            <button @click="startWizard" class="bg-slate-900 hover:bg-slate-800 text-white px-6 py-3.5 rounded-2xl font-bold shadow-xl shadow-slate-300/50 flex items-center gap-3 transform active:scale-95 transition text-sm md:text-base">
                <div class="bg-white/20 w-6 h-6 rounded-full flex items-center justify-center">
                    <i class="fa-solid fa-plus text-xs"></i>
                </div>
                <span>Nouveau RDV</span>
            </button>

        </header>

            <div class="flex-1 overflow-y-auto p-4 md:p-6 pb-20 md:pb-6">
                <div v-if="view==='dashboard'" class="space-y-6 fade-in">
                    <div class="flex flex-col md:flex-row gap-6 mb-6 items-stretch">
                        <div class="flex-1 flex flex-col md:flex-row md:items-center gap-3">
                            <h2 class="text-2xl md:text-3xl font-bold text-slate-800 uppercase tracking-tight">{{ currentFullDateLabel }}</h2>
                            
                            <!-- Indicateur de statut Google Calendar Admin -->
                            <button v-if="user.role === 'admin'" 
                                    @click="googleCalendarConnected && googleCalendarTokenValid ? googleCalendarInfoModal.open = true : (googleCalendarConnected && !googleCalendarTokenValid ? connectGoogleCalendar() : connectGoogleCalendar())"
                                    :class="[
                                        googleCalendarConnected && googleCalendarTokenValid ? 'bg-green-50 border-green-300 text-green-700 cursor-pointer hover:bg-green-100' : 
                                        googleCalendarConnected && !googleCalendarTokenValid ? 'bg-orange-50 border-orange-300 text-orange-700 hover:bg-orange-100 cursor-pointer' : 
                                        'bg-red-50 border-red-300 text-red-700 cursor-pointer hover:bg-red-100'
                                    ]"
                                    class="flex items-center gap-2 px-4 py-2 rounded-xl border-2 transition-all">
                                <i :class="[
                                    googleCalendarConnected && googleCalendarTokenValid ? 'fa-brands fa-google text-green-600' : 
                                    googleCalendarConnected && !googleCalendarTokenValid ? 'fa-solid fa-exclamation-triangle text-orange-600' : 
                                    'fa-solid fa-exclamation-triangle text-red-600'
                                ]" class="text-lg"></i>
                                <span class="text-xs font-bold">
                                    <span v-if="googleCalendarConnected && googleCalendarTokenValid">
                                        Google Calendar connect√©
                                        <span v-if="tokenTimeRemaining" class="ml-2 text-[10px] opacity-75">
                                            ({{ tokenTimeRemaining.minutes }}min {{ tokenTimeRemaining.seconds }}s)
                                        </span>
                                    </span>
                                    <span v-else-if="googleCalendarConnected && !googleCalendarTokenValid">Se reconnecter</span>
                                    <span v-else>Cliquez ici pour connecter Google Calendar</span>
                                </span>
                            </button>
                            
                            <!-- Indicateur de statut Google Calendar Prospecteur -->
                            <button v-if="user.role !== 'admin' && user.logged" 
                                    @click="(prospecteurGoogleCalendarConnected && prospecteurGoogleCalendarTokenValid) || (googleCalendarConnected && googleCalendarTokenValid) ? googleCalendarInfoModal.open = true : ((prospecteurGoogleCalendarConnected && !prospecteurGoogleCalendarTokenValid) || (!prospecteurGoogleCalendarConnected && !googleCalendarConnected) || (googleCalendarConnected && !googleCalendarTokenValid) ? handleProspecteurGoogleCalendar() : null)"
                                    :class="[
                                        (prospecteurGoogleCalendarConnected && prospecteurGoogleCalendarTokenValid) || (googleCalendarConnected && googleCalendarTokenValid) ? 'bg-green-50 border-green-300 text-green-700 cursor-pointer hover:bg-green-100' : 
                                        (prospecteurGoogleCalendarConnected && !prospecteurGoogleCalendarTokenValid) || (googleCalendarConnected && !googleCalendarTokenValid) ? 'bg-orange-50 border-orange-300 text-orange-700 hover:bg-orange-100 cursor-pointer' : 
                                        'bg-red-50 border-red-300 text-red-700 cursor-pointer hover:bg-red-100'
                                    ]"
                                    class="flex items-center gap-2 px-4 py-2 rounded-xl border-2 transition-all">
                                <i :class="[
                                    (prospecteurGoogleCalendarConnected && prospecteurGoogleCalendarTokenValid) || (googleCalendarConnected && googleCalendarTokenValid) ? 'fa-brands fa-google text-green-600' : 
                                    (prospecteurGoogleCalendarConnected && !prospecteurGoogleCalendarTokenValid) || (googleCalendarConnected && !googleCalendarTokenValid) ? 'fa-solid fa-exclamation-triangle text-orange-600' : 
                                    'fa-solid fa-exclamation-triangle text-red-600'
                                ]" class="text-lg"></i>
                                <span class="text-xs font-bold">
                                    <span v-if="(prospecteurGoogleCalendarConnected && prospecteurGoogleCalendarTokenValid) || (googleCalendarConnected && googleCalendarTokenValid)">
                                        Google Calendar connect√©
                                        <span v-if="prospecteurTokenTimeRemaining || tokenTimeRemaining" class="ml-2 text-[10px] opacity-75">
                                            ({{ (prospecteurTokenTimeRemaining || tokenTimeRemaining)?.minutes }}min {{ (prospecteurTokenTimeRemaining || tokenTimeRemaining)?.seconds }}s)
                                        </span>
                                    </span>
                                    <span v-else-if="(prospecteurGoogleCalendarConnected && !prospecteurGoogleCalendarTokenValid) || (googleCalendarConnected && !googleCalendarTokenValid)">Cliquez ici pour reconnecter Google agenda</span>
                                    <span v-else>Cliquez ici pour reconnecter Google agenda</span>
                                </span>
                            </button>
                           
                        </div>
                        <div class="flex flex-col md:flex-row gap-4">
                            <div @click="openStatsModal" class="cursor-pointer hover:scale-[1.02] transition-transform bg-white rounded-2xl shadow-sm border border-slate-100 p-4 flex items-center gap-4 min-w-[300px] relative overflow-hidden" :class="conversionRateColor"><div class="absolute inset-0 bg-white opacity-80 z-0"></div><div class="z-10 text-5xl emoji-bounce filter drop-shadow-md">{{ conversionEmoji }}</div><div class="z-10 flex-1"><p class="text-xs font-bold uppercase tracking-widest opacity-60">Taux de conversion</p><div class="flex items-baseline gap-2"><span class="text-4xl font-black">{{ conversionRate }}%</span><span class="text-xs font-medium opacity-70">Honor√©s / Total</span></div><div class="w-full bg-black/10 h-1.5 rounded-full mt-1 overflow-hidden"><div class="h-full bg-black/50 transition-all duration-1000" :style="{width: conversionRate + '%'}"></div></div></div></div>
                        </div>
                    </div>
                   <!-- 4 COLONNES POUR AJOUTER LES ANNUL√âS -->
                   <div class="grid grid-cols-1 md:grid-cols-4 gap-4 md:gap-6">
                        <div @click="showUpcoming" class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 hover:shadow-md hover:border-blue-300 cursor-pointer transition group">
                            <div class="flex justify-between items-start">
                                <div><p class="text-slate-400 text-xs font-bold uppercase tracking-wider group-hover:text-blue-500">√Ä venir</p><p class="text-4xl font-extrabold text-slate-800 mt-1">{{ stats.upcoming }}</p></div>
                                <div class="w-12 h-12 bg-blue-50 rounded-2xl flex items-center justify-center text-blue-600 text-xl group-hover:bg-blue-600 group-hover:text-white transition"><i class="fa-solid fa-calendar-days"></i></div>
                            </div>
                        </div>
                        <div @click="showHonored" class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 hover:shadow-md hover:border-green-300 cursor-pointer transition group">
                            <div class="flex justify-between items-start">
                                <div><p class="text-slate-400 text-xs font-bold uppercase tracking-wider group-hover:text-green-600">Honor√©s</p><p class="text-4xl font-extrabold text-slate-800 mt-1">{{ stats.honored }}</p></div>
                                <div class="w-12 h-12 bg-green-50 rounded-2xl flex items-center justify-center text-green-600 text-xl group-hover:bg-green-600 group-hover:text-white transition"><i class="fa-solid fa-check"></i></div>
                            </div>
                        </div>
                        <div @click="showNoShow" class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 hover:shadow-md hover:border-red-300 cursor-pointer transition group">
                            <div class="flex justify-between items-start">
                                <div><p class="text-slate-400 text-xs font-bold uppercase tracking-wider group-hover:text-red-600">Pas Venus</p><p class="text-4xl font-extrabold text-slate-800 mt-1">{{ stats.noshow }}</p></div>
                                <div class="w-12 h-12 bg-red-50 rounded-2xl flex items-center justify-center text-red-600 text-xl group-hover:bg-red-600 group-hover:text-white transition"><i class="fa-solid fa-user-xmark"></i></div>
                            </div>
                        </div>
                        <!-- NOUVELLE CARTE ANNUL√âS -->
                        <div @click="showCancelled" class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 hover:shadow-md hover:border-gray-400 cursor-pointer transition group">
                            <div class="flex justify-between items-start">
                                <div><p class="text-slate-400 text-xs font-bold uppercase tracking-wider group-hover:text-gray-600">Annul√©s</p><p class="text-4xl font-extrabold text-slate-800 mt-1">{{ stats.cancelled }}</p></div>
                                <div class="w-12 h-12 bg-gray-100 rounded-2xl flex items-center justify-center text-gray-500 text-xl group-hover:bg-gray-500 group-hover:text-white transition"><i class="fa-solid fa-ban"></i></div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-3xl shadow-sm border border-slate-100 p-4 md:p-8">
<div class="flex flex-col xl:flex-row justify-between items-start xl:items-center mb-6 gap-4">
                          <h2 class="text-xl font-bold flex items-center gap-3 text-slate-800 flex-wrap">
    <i class="fa-regular fa-clock text-blue-500"></i>
    
    <span>{{ isTimelineTomorrow ? 'Rendez-vous Demain' : 'Rendez-vous Aujourd\'hui' }}</span>

    <button @click="showTimelineTomorrow" 
            :class="isTimelineTomorrow ? 'bg-blue-600 text-white shadow-blue-200 shadow-md border-blue-600' : 'bg-white text-slate-600 border-slate-200'"
            class="px-3 py-1.5 rounded-lg text-xs font-bold transition flex items-center gap-1.5 border hover:bg-blue-50 hover:border-blue-300 hover:text-blue-600">
        <i class="fa-solid fa-calendar-day text-xs"></i>
        <span>Demain</span>
    </button>

    <span class="text-xs md:text-sm font-semibold text-slate-600 bg-slate-100 px-2.5 py-1 rounded-full border border-slate-200 flex items-center gap-1">
        <i class="fa-solid fa-calendar-day text-slate-400"></i>
        {{ rdvTodayCount }} RDV
    </span>
</h2>
                            
                            <div class="flex flex-wrap gap-2 w-full xl:w-auto">
                                <select v-model="dashboardFilters.agencyId" class="bg-white border border-slate-200 text-slate-700 text-xs font-bold rounded-lg px-3 py-2 outline-none focus:border-blue-500 shadow-sm">
                                    <option value="">Toutes les agences</option>
                                    <option v-for="ag in visibleAgencies" :key="ag.id" :value="ag.id">{{ ag.nom }}</option>
                                </select>

                                <select v-if="user.role === 'admin'" v-model="dashboardFilters.userId" class="bg-white border border-slate-200 text-slate-700 text-xs font-bold rounded-lg px-3 py-2 outline-none focus:border-blue-500 shadow-sm">
                                    <option value="">Toute l'√©quipe</option>
                                    <option v-for="u in allProspectors" :key="u" :value="u">{{ u }}</option>
                                </select>

                              <button @click="dashboardFilters.onlyLive = !dashboardFilters.onlyLive" 
                                        :class="dashboardFilters.onlyLive ? 'bg-green-500 text-white shadow-green-200 shadow-md' : (activeRdvCount > 0 ? 'bg-green-50 text-green-600 border-green-200' : 'bg-white text-slate-400 border-slate-200')"
                                        class="px-4 py-2 rounded-lg text-xs font-bold transition flex items-center gap-2 border">
                                    <span :class="activeRdvCount > 0 ? 'bg-green-500 animate-pulse' : 'bg-slate-300'" class="w-2 h-2 rounded-full block"></span>
                                    {{ activeRdvCount }} En cours
                                </button>
                            </div>
                        </div>                        <div class="space-y-4 relative"><div class="absolute left-[35px] top-4 bottom-4 w-0.5 bg-slate-100 z-0"></div>
                          <div v-for="rdv in sortedDaily" :key="rdv.id" @click="openRdvFiche(rdv)" 
     :class="[rdvMenuOpen === rdv.id ? 'z-[500] !transform-none !transition-none' : (isEnCours(rdv) ? 'live-animation' : 'z-10 overflow-hidden')]" 
     class="relative flex flex-col md:flex-row md:items-center p-4 bg-slate-50 rounded-2xl border border-slate-100 hover:bg-white hover:border-blue-200 hover:shadow-lg cursor-pointer transition group gap-2 md:gap-0">    
                                <div class="flex items-center w-full md:w-auto relative z-10">
                                    <div class="w-16 md:w-20 font-bold text-lg text-slate-500 group-hover:text-blue-600 transition text-center bg-white rounded-xl py-2 mr-4 shadow-sm border border-slate-100 flex-shrink-0">{{ rdv.heure }}</div>
                                    <div class="font-bold text-slate-800 text-lg flex items-center gap-2 md:hidden">{{ rdv.civilite }} {{ rdv.nom }} <i v-if="isEnCours(rdv)" class="fa-solid fa-circle text-[10px] text-green-500 animate-pulse"></i><span v-if="rdv.tag === 'OK M'" class="ml-2 bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded font-bold uppercase shadow-sm">OK M</span><span v-if="isNewRdvFromOther(rdv)" class="ml-1 bg-purple-500 text-white text-[8px] px-1.5 py-0.5 rounded-full font-bold animate-pulse">Nouveau</span><span v-if="isRdvApproaching(rdv)" class="ml-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full font-bold animate-pulse">Bient√¥t</span><span v-if="needsRappel(rdv)" class="ml-1 bg-red-500 text-white text-[8px] px-1.5 py-0.5 rounded-full font-bold animate-pulse">Rappel</span></div>
                                </div>
                                <div class="flex-1 min-w-0 md:ml-4 relative z-10">
                                    <div class="font-bold text-slate-800 text-lg hidden md:flex items-center gap-2">
                                        {{ rdv.civilite }} {{ rdv.nom }} 
                                        <i v-if="isEnCours(rdv)" class="fa-solid fa-circle text-[10px] text-green-500 animate-pulse"></i>
                                        <span v-if="rdv.tag === 'OK M'" class="ml-2 bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded font-bold uppercase shadow-sm">OK M</span>
                                        <span v-if="isNewRdvFromOther(rdv)" class="ml-2 bg-purple-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold animate-pulse" title="Nouveau RDV cr√©√© par un autre utilisateur">
                                            <i class="fa-solid fa-user-plus text-[8px]"></i> Nouveau
                                        </span>
                                        <span v-if="isRdvApproaching(rdv)" class="ml-2 bg-orange-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold animate-pulse" title="RDV dans moins de 15 minutes">
                                            <i class="fa-solid fa-clock text-[8px]"></i> Bient√¥t
                                        </span>
                                        <span v-if="needsRappel(rdv)" class="ml-2 bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold animate-pulse" title="Rappel √† faire">
                                            <i class="fa-solid fa-bell text-[8px]"></i> Rappel
                                        </span>
                                        <span v-if="rdv.rappelFait" class="ml-2 text-green-600" title="Rappel envoy√©">
                                            <i class="fa-solid fa-bell text-sm"></i>
                                        </span>
                                        <span v-if="rdv.geste_commercial && user.role === 'admin'" class="ml-2 text-red-500 text-xl animate-bounce-slow" title="Geste Commercial appliqu√©">üéÅ</span>
                                        <span v-if="rdv.geste_commercial" class="ml-2 bg-red-100 text-red-600 text-xs px-2 py-0.5 rounded-full border border-red-200 font-bold animate-fadeIn">
                                            -{{ rdv.geste_commercial }}‚Ç¨
                                        </span>
                                    </div>
                                    <div v-if="isEnCours(rdv)" class="w-full max-w-xs h-1.5 bg-gray-200 rounded-full mt-2 overflow-hidden shadow-inner">
                                        <div class="h-full bg-green-500 transition-all duration-1000 ease-linear shadow-[0_0_10px_rgba(34,197,94,0.6)]" :style="{width: getProgressPercent(rdv) + '%'}"></div>
                                    </div>
                                    <div class="text-sm text-slate-500 flex flex-wrap items-center gap-2 md:gap-3 mt-1 font-medium">
                                       <span class="bg-white px-2 py-0.5 rounded border border-slate-200 text-slate-600">
    <i class="fa-solid fa-car text-slate-400"></i> {{ rdv.modele }}
</span>

<span class="flex items-center gap-1 text-xs opacity-70">
    <img :src="getLogo(rdv.source)" class="w-4 h-4 rounded-sm">
    {{ rdv.source }}
</span>

<span
    v-if="getRelativeRdvLabel(rdv)"
    class="text-[11px] font-bold text-orange-500 uppercase"
>
    {{ getRelativeRdvLabel(rdv) }}
</span>

<div class="w-full mt-1 flex flex-wrap gap-2">
                                            <span class="text-[10px] font-bold text-blue-600 uppercase bg-blue-50 px-2 py-0.5 rounded border border-blue-100">
                                                <i class="fa-solid fa-building"></i> {{ getAgenceName(rdv.agenceId) }}
                                            </span>
                                            <span class="text-[10px] font-bold text-slate-500 uppercase bg-slate-100 px-2 py-0.5 rounded border border-slate-200">
                                                <i class="fa-solid fa-user-tag"></i> {{ rdv.createdBy || 'Syst√®me' }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between md:justify-end mt-2 md:mt-0 relative z-10 gap-2">
                                    <div v-if="rdv.dansAgenda" class="px-2 py-1 rounded-lg text-[10px] font-bold bg-green-100 text-green-700 border border-green-300 flex items-center gap-1" title="Plac√© dans l'agenda">
                                        <i class="fa-solid fa-calendar-check text-[10px]"></i> <span>Dans l'agenda</span>
                                    </div>
                                    <div v-if="isEnCours(rdv)" class="status-label-active mr-4"><span class="live-dot"></span>Rendez-vous en cours</div>
                                    <div v-else-if="isLateAndNoStatus(rdv)" class="mr-4 bg-purple-100 text-purple-600 px-3 py-1 rounded-full font-bold text-xs animate-pulse border border-purple-200 shadow-sm"><i class="fa-solid fa-clipboard-question"></i> STATUT ?</div>
                                    <span v-else :class="statusClass(rdv.statut)" class="badge-status shadow-sm">{{ displayStatus(rdv) }}</span>
                                    <div class="ml-4 text-slate-300 group-hover:text-blue-500 transition"><i class="fa-solid fa-chevron-right"></i></div>
                                </div>
                            </div>
                           <div v-if="filteredDaily.length > dashboardLimit" class="text-center pt-4 border-t mt-2">
                            <button @click="dashboardLimit += 15" class="bg-white border border-slate-200 text-slate-500 px-6 py-2 rounded-full text-sm font-bold hover:bg-slate-50 hover:text-blue-600 hover:border-blue-200 transition shadow-sm">
                                üëá Voir la suite ({{ filteredDaily.length - dashboardLimit }} de plus)
                            </button>
                        </div>
                        </div>
                    </div>
                </div>

               <div v-if="view==='list'" class="bg-white rounded-[32px] shadow-sm border border-slate-100 h-full flex flex-col overflow-hidden fade-in relative transition-all duration-500 font-sans">
    
    <div class="bg-white border-b border-slate-100 z-20 px-6 py-4 flex flex-col md:flex-row items-center justify-between gap-4 shadow-[0_4px_20px_-10px_rgba(0,0,0,0.05)]">
        
        <div class="flex-1 w-full md:w-auto flex items-center gap-4">
            <!-- BOUTON RETOUR INTELLIGENT -->
            <button v-if="currentFilter !== 'all' || listFilters.agenceId || listFilters.date || listFilters.prospecteur || fromDashboard" @click="goBackFromList" class="bg-slate-100 text-slate-500 hover:bg-blue-50 hover:text-blue-600 w-10 h-10 rounded-full flex items-center justify-center transition-all group" title="Retour">
                <i class="fa-solid fa-arrow-left group-hover:-translate-x-1 transition"></i>
            </button>
            
            <div class="relative flex-1 max-w-md group">
                <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-lg group-focus-within:text-blue-500 transition"></i>
                <input 
                    v-model="search" 
                    placeholder="Rechercher client, v√©hicule, t√©l..." 
                    class="w-full pl-12 pr-10 py-3 bg-slate-50 border border-slate-200 rounded-2xl font-bold text-slate-700 outline-none focus:border-blue-500 focus:bg-white focus:shadow-md transition-all"
                >
                <button v-if="search" @click="search=''" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-300 hover:text-red-500 transition">
                    <i class="fa-solid fa-circle-xmark text-xl"></i>
                </button>
            </div>
        </div>

        <div class="flex flex-wrap items-center gap-2 w-full md:w-auto justify-center md:justify-end">
            
            <button @click="currentFilter = (currentFilter==='upcoming'?'all':'upcoming')" :class="currentFilter==='upcoming' ? 'bg-blue-600 text-white shadow-blue-200 shadow-md' : 'bg-slate-100 text-slate-600 border border-slate-200 hover:bg-blue-50 hover:border-blue-200 hover:text-blue-600'" class="px-4 py-2 rounded-full text-sm font-bold transition flex items-center gap-2 active:scale-95">
                <i class="fa-solid fa-clock"></i> √Ä venir
            </button>

            <button @click="currentFilter = (currentFilter==='live'?'all':'live')" :class="currentFilter==='live' ? 'bg-green-500 text-white shadow-green-200 shadow-md' : 'bg-slate-100 text-slate-600 border border-slate-200 hover:bg-green-50 hover:border-green-200 hover:text-green-600'" class="px-4 py-2 rounded-full text-sm font-bold transition flex items-center gap-2 active:scale-95 group">
                <i class="fa-solid fa-clock fa-spin" style="animation-duration: 3s;"></i> 
                En cours ({{ activeRdvCount }})
            </button>

            <div class="relative">
                <select v-model="listFilters.agenceId" class="appearance-none bg-slate-100 border border-slate-200 hover:bg-slate-200 text-slate-700 font-bold text-sm rounded-full pl-4 pr-8 py-2 outline-none cursor-pointer transition focus:border-blue-500">
                    <option value="">üè¢ Toutes agences</option>
                    <option v-for="ag in visibleAgencies" :key="ag.id" :value="ag.id">{{ ag.nom }}</option>
                </select>
                <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-xs text-gray-400 pointer-events-none"></i>
            </div>

             <input type="date" v-model="listFilters.date" class="appearance-none bg-slate-100 border border-slate-200 hover:bg-slate-200 text-slate-700 font-bold text-sm rounded-full px-4 py-2 outline-none cursor-pointer transition focus:border-blue-500" title="Filtrer par date">

             <button v-if="listFilters.agenceId || listFilters.date || listFilters.prospecteur || currentFilter !== 'all'" @click="resetListFilters" class="w-8 h-8 flex items-center justify-center bg-red-50 text-red-500 rounded-full hover:bg-red-100 transition" title="Effacer tous les filtres">
                <i class="fa-solid fa-xmark"></i>
             </button>
        </div>
    </div>

    <div class="flex-1 overflow-y-auto p-6 bg-slate-50 relative">
        
        <div v-if="filteredList.length === 0" class="flex flex-col items-center justify-center h-full fade-in pb-20">
            <div v-if="!search && currentFilter === 'all' && !listFilters.agenceId && !listFilters.date" class="text-center max-w-md">
                <div class="mb-6 p-8 bg-white rounded-[3rem] shadow-xl shadow-blue-50 inline-block animate-bounce-slow relative">
                    <div class="absolute inset-0 bg-blue-500 opacity-10  rounded-full"></div>
                    <i class="fa-solid fa-magnifying-glass-location text-6xl text-blue-500 relative z-10"></i>
                </div>
                <h2 class="text-3xl font-black text-slate-800 mb-3">Explorez vos RDV</h2>
                <p class="text-slate-500 font-medium text-lg leading-relaxed mb-8">Utilisez la recherche ou les filtres rapides ci-dessus.</p>
                <button @click="showUpcoming" class="bg-blue-600 text-white px-8 py-4 rounded-2xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 hover:scale-105 transition-all transform flex items-center gap-3 mx-auto">
                    <i class="fa-regular fa-calendar-check text-xl"></i>
                    Voir les prochains RDV
                </button>
            </div>
            <div v-else class="text-center text-slate-400 opacity-70">
                 <i class="fa-regular fa-face-frown-open text-6xl mb-4"></i>
                 <p class="font-bold text-xl">Aucun rendez-vous trouv√©.</p>
            </div>
        </div>

        <div v-else>
            <div class="flex justify-between items-center mb-4 px-2">
                 <h3 class="font-bold text-slate-700 text-lg">R√©sultats</h3>
                 <span class="text-xs font-black text-slate-400 uppercase tracking-widest bg-white px-3 py-1 rounded-full shadow-sm border border-slate-100">{{ filteredList.length }} RDV trouv√©(s)</span>
            </div>

            <!-- MODIFICATION DESIGN : AFFICHAGE EN LIGNE COMME LE DASHBOARD -->
            <div class="space-y-4 pb-24 md:pb-0">
                <div v-for="rdv in displayedList" :key="rdv.id" @click="openRdvFiche(rdv)" :class="isEnCours(rdv) ? 'live-animation' : ''" class="relative z-10 flex flex-col md:flex-row md:items-center p-4 bg-white rounded-2xl border border-slate-100 hover:border-blue-200 hover:shadow-lg cursor-pointer transition group gap-2 md:gap-0 overflow-hidden">
                    
                    <!-- Selection Checkbox -->
                    <div v-if="user.role==='admin'" class="absolute top-2 right-2 md:top-auto md:bottom-auto md:left-2 md:right-auto md:relative md:mr-4 z-50" @click.stop>
                         <input type="checkbox" class="custom-checkbox w-5 h-5 shadow-sm border-2 border-slate-300 rounded" :checked="selectedIds.includes(rdv.id)" @change="toggleSelection(rdv.id)">
                    </div>

                    <div class="flex items-center w-full md:w-auto relative z-10">
                        <!-- Affichage Date & Heure Group√© -->
                        <div class="flex flex-col items-center bg-slate-50 rounded-xl py-2 px-3 mr-4 shadow-sm border border-slate-100 flex-shrink-0 min-w-[80px]">
                            <span class="text-[10px] font-bold text-slate-400 uppercase">{{ formatDateShort(rdv.date) }}</span>
                            <span class="font-black text-lg text-slate-600 group-hover:text-blue-600 transition">{{ rdv.heure }}</span>
                        </div>
                        
                        <div class="font-bold text-slate-800 text-lg flex items-center gap-2 md:hidden">{{ rdv.civilite }} {{ rdv.nom }} <i v-if="isEnCours(rdv)" class="fa-solid fa-circle text-[10px] text-green-500 animate-pulse"></i><span v-if="rdv.tag === 'OK M'" class="ml-2 bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded font-bold uppercase shadow-sm">OK M</span><span v-if="isNewRdvFromOther(rdv)" class="ml-1 bg-purple-500 text-white text-[8px] px-1.5 py-0.5 rounded-full font-bold animate-pulse">Nouveau</span><span v-if="isRdvApproaching(rdv)" class="ml-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full font-bold animate-pulse">Bient√¥t</span><span v-if="needsRappel(rdv)" class="ml-1 bg-red-500 text-white text-[8px] px-1.5 py-0.5 rounded-full font-bold animate-pulse">Rappel</span></div>
                    </div>

                    <div class="flex-1 min-w-0 md:ml-4 relative z-10">
                        <div class="font-bold text-slate-800 text-lg hidden md:flex items-center gap-2">
                            {{ rdv.civilite }} {{ rdv.nom }} 
                            <i v-if="isEnCours(rdv)" class="fa-solid fa-circle text-[10px] text-green-500 animate-pulse"></i>
                            <span v-if="rdv.tag === 'OK M'" class="ml-2 bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded font-bold uppercase shadow-sm">OK M</span>
                            <span v-if="isNewRdvFromOther(rdv)" class="ml-2 bg-purple-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold animate-pulse" title="Nouveau RDV cr√©√© par un autre utilisateur">
                                <i class="fa-solid fa-user-plus text-[8px]"></i> Nouveau
                            </span>
                            <span v-if="isRdvApproaching(rdv)" class="ml-2 bg-orange-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold animate-pulse" title="RDV dans moins de 15 minutes">
                                <i class="fa-solid fa-clock text-[8px]"></i> Bient√¥t
                            </span>
                            <span v-if="needsRappel(rdv)" class="ml-2 bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold animate-pulse" title="Rappel √† faire">
                                <i class="fa-solid fa-bell text-[8px]"></i> Rappel
                            </span>
                            <span v-if="rdv.rappelFait" class="ml-2 text-green-600" title="Rappel envoy√©">
                                <i class="fa-solid fa-bell text-sm"></i>
                            </span>
                            <span v-if="rdv.geste_commercial && user.role === 'admin'" class="ml-2 text-red-500 text-xl animate-bounce-slow" title="Geste Commercial appliqu√©">üéÅ</span>
                            <span v-if="rdv.geste_commercial" class="ml-2 bg-red-100 text-red-600 text-xs px-2 py-0.5 rounded-full border border-red-200 font-bold animate-fadeIn">
                                -{{ rdv.geste_commercial }}‚Ç¨
                            </span>
                        </div>
                        
                        <div v-if="isEnCours(rdv)" class="w-full max-w-xs h-1.5 bg-gray-200 rounded-full mt-2 overflow-hidden shadow-inner">
                            <div class="h-full bg-green-500 transition-all duration-1000 ease-linear shadow-[0_0_10px_rgba(34,197,94,0.6)]" :style="{width: getProgressPercent(rdv) + '%'}"></div>
                        </div>

                        <div class="text-sm text-slate-500 flex flex-wrap items-center gap-2 md:gap-3 mt-1 font-medium">
                           <span class="bg-white px-2 py-0.5 rounded border border-slate-200 text-slate-600">
                                <i class="fa-solid fa-car text-slate-400"></i> {{ rdv.modele }}
                            </span>
                            <span class="flex items-center gap-1 text-xs opacity-70">
                                <i class="fa-solid fa-phone text-[10px]"></i> {{ rdv.telephone }}
                            </span>
                            <span class="flex items-center gap-1 text-xs opacity-70">
                                <img :src="getLogo(rdv.source)" class="w-4 h-4 rounded-sm"> {{ rdv.source }}
                            </span>
                            <span v-if="getRelativeRdvLabel(rdv)" class="text-[11px] font-bold text-orange-500 uppercase">
                                {{ getRelativeRdvLabel(rdv) }}
                            </span>
                            
                            <div class="w-full mt-1 flex flex-wrap gap-2">
                                <span class="text-[10px] font-bold text-blue-600 uppercase bg-blue-50 px-2 py-0.5 rounded border border-blue-100">
                                    <i class="fa-solid fa-building"></i> {{ getAgenceName(rdv.agenceId) }}
                                </span>
                                <span class="text-[10px] font-bold text-slate-500 uppercase bg-slate-100 px-2 py-0.5 rounded border border-slate-200">
                                    <i class="fa-solid fa-user-tag"></i> {{ rdv.createdBy || 'Syst√®me' }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center justify-between md:justify-end mt-2 md:mt-0 relative z-10 gap-2">
                        <div v-if="rdv.dansAgenda" class="px-2 py-1 rounded-lg text-[10px] font-bold bg-green-100 text-green-700 border border-green-300 flex items-center gap-1" title="Plac√© dans l'agenda">
                            <i class="fa-solid fa-calendar-check text-[10px]"></i> <span>Dans l'agenda</span>
                        </div>
                        <div v-if="isEnCours(rdv)" class="status-label-active mr-4"><span class="live-dot"></span>Rendez-vous en cours</div>
                        <div v-else-if="isLateAndNoStatus(rdv)" class="mr-4 bg-purple-100 text-purple-600 px-3 py-1 rounded-full font-bold text-xs animate-pulse border border-purple-200 shadow-sm"><i class="fa-solid fa-clipboard-question"></i> STATUT ?</div>
                        <span v-else :class="statusClass(rdv.statut)" class="badge-status shadow-sm">{{ displayStatus(rdv) }}</span>
                        <div class="ml-4 text-slate-300 group-hover:text-blue-500 transition"><i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                </div>
            </div>

            <div v-if="displayedList.length < filteredList.length" class="p-8 text-center">
                 <button @click="displayLimit += 20" class="bg-white border-2 border-slate-200 text-slate-500 px-8 py-3 rounded-full font-bold hover:bg-slate-50 hover:border-blue-300 hover:text-blue-600 transition shadow-sm active:scale-95">üëá Charger les suivants</button>
            </div>
        </div>
    </div>

    <div v-if="selectedIds.length > 0" class="absolute bottom-6 left-4 right-4 md:left-auto md:right-6 md:w-auto bg-slate-900 text-white p-4 rounded-full shadow-2xl flex items-center justify-between gap-6 slide-up z-[60] border border-slate-800">
        <div class="font-bold pl-2 flex items-center gap-2"><span class="bg-blue-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">{{ selectedIds.length }}</span> <span class="hidden md:inline">s√©lectionn√©s</span></div>
        <div class="flex gap-2">
            <button @click="openBulkConfirm('soft_delete', 'Mettre √† la corbeille ?')" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-full font-bold text-sm transition flex items-center gap-2 shadow-lg shadow-red-500/30 active:scale-95">
                <i class="fa-solid fa-trash-can"></i> <span class="hidden md:inline">Corbeille</span>
            </button>
            <button @click="selectedIds=[]" class="text-slate-400 hover:text-white w-10 h-10 flex items-center justify-center rounded-full hover:bg-slate-800 transition" title="Annuler la s√©lection">‚úï</button>
        </div>
    </div>
</div>

    <!-- üîª le reste de la liste (table + mobile) NE BOUGE PAS -->


 <div v-if="view==='trash'" class="bg-white rounded-3xl shadow-sm border border-slate-100 h-full flex flex-col overflow-hidden fade-in relative">
                    
                    <div class="p-6 border-b bg-slate-50 flex justify-between items-center">
                        <h2 class="text-xl md:text-2xl font-bold text-gray-700"><i class="fa-solid fa-trash-can"></i> Corbeille</h2>
                        <div class="flex items-center gap-3">
                            <span class="text-sm text-gray-500">{{ trashList.length }} √©l√©ments</span>
                            <button v-if="trashList.length > 0 && user.role==='admin'" @click="openBulkConfirm('empty_trash', 'Vider TOUTE la corbeille ?')" class="bg-red-100 text-red-600 px-4 py-2 rounded-xl text-xs font-bold hover:bg-red-200 transition">Tout Vider</button>
                        </div>
                    </div>

                    <div class="overflow-auto flex-1 p-0 pb-20 hidden md:block">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-slate-50 text-slate-500 text-xs uppercase sticky top-0 z-10 shadow-sm font-bold">
                                <tr>
                                    <th class="p-4 w-10"><input type="checkbox" class="custom-checkbox" @change="selectAll($event)" :checked="isAllSelected && trashList.length > 0"></th>
                                    <th class="p-4">Date</th>
                                    <th class="p-4">Client</th>
                                    <th class="p-4 hidden md:table-cell">Supprim√© par</th>
                                    <th class="p-4 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="text-sm">
                                <tr v-for="rdv in trashList" :key="rdv.id" class="border-b hover:bg-red-50 transition" :class="{'bg-red-50': selectedIds.includes(rdv.id)}">
                                    <td class="p-4 text-center"><input type="checkbox" class="custom-checkbox" :checked="selectedIds.includes(rdv.id)" @change="toggleSelection(rdv.id)"></td>
                                    <td class="p-4 text-gray-400"><div class="font-bold line-through">{{ formatDateShort(rdv.date) }}</div></td>
                                    <td class="p-4 opacity-50"><div class="font-bold">{{ rdv.nom }}</div><div>{{ rdv.modele }}</div></td>
                                    <td class="p-4 text-xs font-bold text-gray-400 uppercase hidden md:table-cell">Utilisateur</td>
                                    <td class="p-4 text-right flex justify-end gap-2">
                                        <button @click="restoreRdv(rdv)" class="bg-green-100 text-green-700 px-3 py-1.5 rounded-lg font-bold text-xs hover:bg-green-200 transition" title="Restaurer"><i class="fa-solid fa-rotate-left"></i></button>
                                        <button v-if="user.role==='admin'" @click="hardDeleteRdv(rdv)" class="bg-red-100 text-red-700 px-3 py-1.5 rounded-lg font-bold text-xs hover:bg-red-200 transition" title="Supprimer d√©finitivement"><i class="fa-solid fa-ban"></i></button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="md:hidden flex-1 overflow-y-auto p-4 space-y-3 pb-24 bg-slate-100">
                        <div v-for="rdv in trashList" :key="rdv.id" 
                             class="p-4 rounded-2xl shadow-sm border relative transition-all duration-200"
                             :class="selectedIds.includes(rdv.id) ? 'bg-red-50 border-red-300 ring-1 ring-red-200' : 'bg-white border-red-100'">
                            
                            <div class="absolute top-4 right-4 z-10">
                                <input type="checkbox" class="custom-checkbox w-6 h-6" :checked="selectedIds.includes(rdv.id)" @change="toggleSelection(rdv.id)">
                            </div>

                            <div class="flex justify-between items-start mb-2 pr-8 opacity-60">
                                <div>
                                    <div class="text-xs font-bold text-slate-400 uppercase flex items-center gap-1 line-through"><i class="fa-regular fa-calendar"></i> {{ formatDateShort(rdv.date) }}</div>
                                    <div class="text-lg font-bold text-slate-800">{{ rdv.nom }}</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 mb-3 text-sm text-slate-600 font-medium opacity-60"><i class="fa-solid fa-car"></i> {{ rdv.modele }}</div>
                            
                            <div class="flex gap-2 justify-end mt-2 pt-2 border-t border-slate-100">
                                <button @click="restoreRdv(rdv)" class="bg-green-100 text-green-700 px-3 py-1.5 rounded-lg font-bold text-xs hover:bg-green-200 transition">Restaurer</button>
                                <button v-if="user.role==='admin'" @click="hardDeleteRdv(rdv)" class="bg-red-100 text-red-700 px-3 py-1.5 rounded-lg font-bold text-xs hover:bg-red-200 transition">Supprimer</button>
                            </div>
                        </div>
                        
                        <div v-if="trashList.length === 0" class="text-center text-gray-400 py-10 italic">La corbeille est vide.</div>
                    </div>

                    <div v-if="selectedIds.length > 0" class="absolute bottom-6 left-4 right-4 md:left-6 md:right-6 bg-slate-900 text-white p-4 rounded-2xl shadow-2xl flex flex-col md:flex-row items-center justify-between slide-up z-50 gap-3">
                        <div class="font-bold pl-2"><span class="text-blue-400 text-xl">{{ selectedIds.length }}</span> s√©lectionn√©s</div>
                        <div class="flex gap-2 w-full md:w-auto justify-end">
                            <button @click="openBulkConfirm('restore_trash', 'Restaurer la s√©lection ?')" class="bg-green-600 hover:bg-green-500 px-3 md:px-4 py-2 rounded-lg font-bold text-xs md:text-sm transition flex-1 md:flex-none">Restaurer</button>
                            <button v-if="user.role==='admin'" @click="openBulkConfirm('delete_trash', 'Supprimer D√âFINITIVEMENT ?')" class="bg-red-600 hover:bg-red-500 px-3 md:px-4 py-2 rounded-lg font-bold text-xs md:text-sm transition flex-1 md:flex-none">Supprimer</button>
                            <button @click="selectedIds=[]" class="ml-2 text-gray-400 hover:text-white px-2">‚úï</button>
                        </div>
                    </div>
                </div>
                
                <div v-if="view==='pending_status'" class="max-w-3xl mx-auto space-y-4 fade-in"><h2 class="text-xl md:text-2xl font-bold mb-6 text-purple-700"><i class="fa-solid fa-clipboard-question"></i> Statuts √† d√©finir</h2><div v-if="pendingStatusList.length===0" class="bg-white p-10 rounded-2xl text-center text-gray-400 border border-slate-100 shadow-sm"><i class="fa-solid fa-check-circle text-4xl mb-2 text-green-500"></i><br>Tous les statuts sont √† jour !</div><div v-for="r in pendingStatusList" :key="r.id" class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border-l-4 border-purple-500 flex flex-col md:flex-row justify-between items-start md:items-center hover:shadow-md transition group" @click="openRdvFiche(r)"><div class="cursor-pointer flex-1"><div class="font-bold text-lg flex items-center gap-2">{{ r.civilite }} {{ r.nom }} <span class="text-xs bg-gray-100 text-gray-500 px-2 rounded">Termin√©</span></div><div class="text-slate-500">{{ formatDateFr(r.date) }} √† {{ r.heure }} ‚Ä¢ {{ r.modele }}</div><div class="text-sm font-bold text-blue-600 mt-1">{{ getAgenceName(r.agenceId) }}</div></div><div class="flex gap-2 w-full md:w-auto"><button @click.stop="updateStatus(r, 'honor_fact')" class="flex-1 md:flex-none bg-green-100 text-green-700 px-4 py-2 rounded-xl font-bold hover:bg-green-200 border border-green-200 text-sm"><i class="fa-solid fa-check"></i> Honor√©</button><button @click.stop="updateStatus(r, 'noshow')" class="flex-1 md:flex-none bg-red-100 text-red-700 px-4 py-2 rounded-xl font-bold hover:bg-red-200 border border-red-200 text-sm"><i class="fa-solid fa-user-xmark"></i> Lapin</button></div></div></div>
                <div v-if="view==='portefeuille'" class="max-w-7xl mx-auto space-y-6 fade-in">
                    <!-- VUE ADMIN -->
                    <div v-if="user.role==='admin'" class="space-y-6">
                        <!-- STATS ADMIN ULTRA MODERNES -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Solde du Jour -->
                            <div class="group relative transform transition-all duration-300 hover:scale-105">
                                <div class="absolute -inset-1 bg-gradient-to-r from-blue-400 via-cyan-400 to-blue-500 rounded-3xl opacity-60 group-hover:opacity-100 transition duration-300"></div>
                                <div class="relative bg-white rounded-3xl shadow-2xl p-8 overflow-hidden border border-blue-200">
                                    <!-- Grille de fond anim√©e -->
                                    <div class="absolute inset-0 opacity-5">
                                        <div class="absolute inset-0" style="background-image: linear-gradient(rgba(102,126,234,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(102,126,234,0.1) 1px, transparent 1px); background-size: 20px 20px;"></div>
                                    </div>
                                    <!-- Particules flottantes -->
                                    <div class="absolute top-4 right-4 w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
                                    <div class="absolute bottom-8 left-8 w-1 h-1 bg-cyan-500 rounded-full animate-pulse" style="animation-delay: 0.5s;"></div>
                                <div class="relative z-10">
                                        <div class="flex items-center justify-between mb-6">
                                            <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-500/50">
                                                <i class="fa-solid fa-calendar-day text-3xl text-white"></i>
                                </div>
                                            <div class="px-3 py-1 bg-blue-100 rounded-full border border-blue-300">
                                                <span class="text-blue-700 text-xs font-bold uppercase tracking-wider">Aujourd'hui</span>
                            </div>
                                        </div>
                                        <p class="text-blue-600 text-xs font-bold uppercase mb-3 tracking-widest">Solde du Jour</p>
                                        <p class="text-5xl font-black mb-2 text-blue-600">{{ formatPrice(adminStats.caDaily) }}</p>
                                        <div class="flex items-center gap-2 mt-4">
                                            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                            <p class="text-slate-600 text-sm font-medium">CA brut en temps r√©el</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Solde du Mois Brut -->
                            <div class="group relative transform transition-all duration-300 hover:scale-105">
                                <div class="absolute -inset-1 bg-gradient-to-r from-emerald-400 via-green-400 to-emerald-500 rounded-3xl opacity-60 group-hover:opacity-100 transition duration-300"></div>
                                <div class="relative bg-white rounded-3xl shadow-2xl p-8 overflow-hidden border border-emerald-200">
                                    <!-- Grille de fond anim√©e -->
                                    <div class="absolute inset-0 opacity-5">
                                        <div class="absolute inset-0" style="background-image: linear-gradient(rgba(16,185,129,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(16,185,129,0.1) 1px, transparent 1px); background-size: 20px 20px;"></div>
                                    </div>
                                    <!-- Particules flottantes -->
                                    <div class="absolute top-4 right-4 w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
                                    <div class="absolute bottom-8 left-8 w-1 h-1 bg-green-500 rounded-full animate-pulse" style="animation-delay: 0.5s;"></div>
                                <div class="relative z-10">
                                        <div class="flex items-center justify-between mb-6">
                                            <div class="w-16 h-16 bg-gradient-to-br from-emerald-500 to-green-500 rounded-2xl flex items-center justify-center shadow-lg shadow-emerald-500/50">
                                                <i class="fa-solid fa-chart-line text-3xl text-white"></i>
                                </div>
                                            <div class="px-3 py-1 bg-emerald-100 rounded-full border border-emerald-300">
                                                <span class="text-emerald-700 text-xs font-bold uppercase tracking-wider">Ce mois</span>
                            </div>
                                        </div>
                                        <p class="text-emerald-600 text-xs font-bold uppercase mb-3 tracking-widest">Solde Brut</p>
                                        <p class="text-5xl font-black mb-2 text-emerald-600">{{ formatPrice(adminStats.caMonthly) }}</p>
                                        <div class="flex items-center gap-2 mt-4">
                                            <div class="w-2 h-2 bg-yellow-500 rounded-full animate-pulse"></div>
                                            <p class="text-slate-600 text-sm font-medium">Avant commissions</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Solde du Mois Net -->
                            <div class="group relative transform transition-all duration-300 hover:scale-105">
                                <div class="absolute -inset-1 bg-gradient-to-r from-purple-400 via-pink-400 to-purple-500 rounded-3xl opacity-60 group-hover:opacity-100 transition duration-300"></div>
                                <div class="relative bg-white rounded-3xl shadow-2xl p-8 overflow-hidden border border-purple-200">
                                    <!-- Grille de fond anim√©e -->
                                    <div class="absolute inset-0 opacity-5">
                                        <div class="absolute inset-0" style="background-image: linear-gradient(rgba(168,85,247,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(168,85,247,0.1) 1px, transparent 1px); background-size: 20px 20px;"></div>
                                    </div>
                                    <!-- Particules flottantes -->
                                    <div class="absolute top-4 right-4 w-2 h-2 bg-purple-500 rounded-full animate-pulse"></div>
                                    <div class="absolute bottom-8 left-8 w-1 h-1 bg-pink-500 rounded-full animate-pulse" style="animation-delay: 0.5s;"></div>
                                <div class="relative z-10">
                                        <div class="flex items-center justify-between mb-6">
                                            <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-pink-500 rounded-2xl flex items-center justify-center shadow-lg shadow-purple-500/50">
                                                <i class="fa-solid fa-wallet text-3xl text-white"></i>
                                            </div>
                                            <div class="px-3 py-1 bg-purple-100 rounded-full border border-purple-300">
                                                <span class="text-purple-700 text-xs font-bold uppercase tracking-wider">Net</span>
                                            </div>
                                        </div>
                                        <p class="text-purple-600 text-xs font-bold uppercase mb-3 tracking-widest">Solde Net</p>
                                        <p class="text-5xl font-black mb-2 text-purple-600">{{ formatPrice(adminStats.netMonthly) }}</p>
                                        <div class="flex items-center gap-2 mt-4">
                                            <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
                                            <p class="text-slate-600 text-sm font-medium">Apr√®s commissions</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- BARRE DE RECHERCHE -->
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-4">
                            <div class="relative">
                                <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                <input 
                                    v-model="portefeuilleSearch" 
                                    @input="filterProspectors"
                                    type="text" 
                                    placeholder="Rechercher un prospecteur..." 
                                    class="w-full pl-12 pr-4 py-3 border-2 border-slate-200 rounded-xl font-medium text-slate-800 outline-none focus:border-blue-500 transition"
                                />
                            </div>
                        </div>

                        <!-- LISTE DES PROSPECTEURS EN CARTES -->
                        <div v-if="!selectedProspecteur">
                            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                                <i class="fa-solid fa-users text-blue-500"></i>
                                Tous les prospecteurs ({{ onlyProspectors.length }})
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div 
                                    v-for="prosp in displayedProspectors" 
                                    :key="prosp.name"
                                    @click="selectProspecteur(prosp.name)"
                                    class="bg-white rounded-2xl shadow-sm border border-slate-200 hover:border-blue-400 hover:shadow-lg p-6 cursor-pointer transition-all group"
                                >
                                    <div class="flex items-start justify-between mb-4">
                                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center text-white text-xl font-black group-hover:scale-110 transition-transform">
                                            {{ prosp.name.charAt(0).toUpperCase() }}
                                        </div>
                                        <i class="fa-solid fa-chevron-right text-slate-300 group-hover:text-blue-500 transition"></i>
                                    </div>
                                    <h4 class="font-bold text-lg text-slate-800 mb-2">{{ prosp.name }}</h4>
                                    <div class="space-y-2">
                                        <div class="flex justify-between items-center">
                                            <span class="text-xs text-slate-500">CA ce mois</span>
                                            <span class="text-sm font-bold text-green-600">{{ formatPrice(prosp.ca) }}</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-xs text-slate-500">RDV Honor√©s</span>
                                            <span class="text-sm font-bold text-blue-600">{{ prosp.honoredCount }}</span>
                                        </div>
                                        <div class="pt-2 border-t border-slate-100">
                                            <div class="flex justify-between items-center">
                                                <span class="text-xs text-slate-500">Reste net</span>
                                                <span class="text-sm font-black" :class="prosp.net >= 0 ? 'text-green-600' : 'text-red-600'">
                                                    {{ formatPrice(prosp.net) }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div v-if="displayedProspectors.length === 0" class="text-center py-12 bg-white rounded-2xl border border-slate-100">
                                <i class="fa-solid fa-search text-4xl text-slate-300 mb-3"></i>
                                <p class="text-slate-400 font-medium">Aucun prospecteur trouv√©</p>
                            </div>
                        </div>

                        <!-- Vue Transactions du prospecteur s√©lectionn√© -->
                        <div v-if="selectedProspecteur" class="space-y-6">
                            <!-- En-t√™te avec bouton retour -->
                            <div class="flex items-center justify-between mb-4">
                                <button @click="selectedProspecteur = null; portefeuilleSearch = ''" class="flex items-center gap-2 text-slate-600 hover:text-blue-600 font-medium transition">
                                    <i class="fa-solid fa-arrow-left"></i>
                                    <span>Retour √† la liste</span>
                                </button>
                            </div>
                            
                            <!-- Carte d'identit√© du prospecteur -->
                            <div class="bg-white rounded-3xl shadow-2xl p-6 border border-blue-200 relative overflow-hidden">
                                <div class="absolute top-0 right-0 w-64 h-64 bg-blue-100/30 rounded-full -mr-32 -mt-32"></div>
                                <div class="absolute bottom-0 left-0 w-48 h-48 bg-blue-100/30 rounded-full -ml-24 -mb-24"></div>
                                <div class="relative z-10 flex items-center justify-between">
                                    <div>
                                        <p class="text-blue-600 text-sm font-bold uppercase mb-1">Prospecteur</p>
                                        <h2 class="text-3xl font-black text-slate-800">{{ selectedProspecteur ? selectedProspecteur.split(' ')[0] : '' }}</h2>
                                    </div>
                                    <button @click="selectedProspecteur = null; portefeuilleSearch = ''" class="bg-blue-100 hover:bg-blue-200 text-blue-700 p-3 rounded-xl transition">
                                        <i class="fa-solid fa-arrow-left"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Transactions en premier -->
                            <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-6">
                                <div class="flex items-center justify-between mb-6">
                                    <h3 class="text-xl font-bold text-slate-800 flex items-center gap-3">
                                        <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center">
                                            <i class="fa-solid fa-list text-white"></i>
                                        </div>
                                        Transactions
                                    </h3>
                                    <span class="text-sm text-slate-500 font-medium bg-slate-100 px-3 py-1 rounded-full">{{ allTransactions.length }} transaction(s)</span>
                                </div>
                                <div class="space-y-3 max-h-[600px] overflow-y-auto pr-2">
                                    <div 
                                        v-for="trans in allTransactions" 
                                        :key="trans.id"
                                        @click="trans.rdvId && openRdvFiche(getRdvFromTransaction(trans))"
                                        class="p-5 bg-gradient-to-br from-white to-slate-50 hover:from-blue-50 hover:to-blue-100 rounded-2xl border-2 border-slate-200 hover:border-blue-400 hover:shadow-lg transition-all group cursor-pointer"
                                        :class="trans.hidden ? 'opacity-50' : ''"
                                    >
                                        <div class="flex items-start gap-4">
                                            <div class="w-14 h-14 rounded-2xl flex items-center justify-center flex-shrink-0 shadow-md" 
                                                 :class="trans.type === 'bonus' ? 'bg-gradient-to-br from-yellow-400 to-orange-500' : (trans.amount >= 0 ? 'bg-gradient-to-br from-green-400 to-emerald-500' : 'bg-gradient-to-br from-red-400 to-rose-500')">
                                                <i :class="getTransactionIcon(trans.type)" class="text-white text-xl"></i>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center gap-2 mb-2">
                                                    <span class="font-bold text-lg text-slate-800">{{ trans.label }}</span>
                                                    <span v-if="trans.hidden" class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded-full font-bold">Masqu√©e</span>
                                                    <span v-if="trans.type === 'bonus'" class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full font-bold animate-pulse">
                                                        <i class="fa-solid fa-star mr-1"></i>Bonus
                                                    </span>
                                                </div>
                                                <div class="text-sm text-slate-500 mb-3 font-medium">
                                                    <i class="fa-solid fa-clock mr-1"></i>{{ formatDateFr(trans.date) }}
                                                </div>
                                                <!-- D√©tails du RDV si disponible -->
                                                <div v-if="getRdvFromTransaction(trans)" class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3 p-3 bg-white/60 rounded-xl border border-slate-200">
                                                    <div v-if="getRdvFromTransaction(trans).agenceId" class="flex items-center gap-2 text-blue-700 font-medium">
                                                        <i class="fa-solid fa-building text-blue-500"></i>
                                                        <span>{{ getAgenceName(getRdvFromTransaction(trans).agenceId) }}</span>
                                                    </div>
                                                    <div v-if="getRdvFromTransaction(trans).civilite && getRdvFromTransaction(trans).nom" class="flex items-center gap-2 text-slate-700 font-medium">
                                                        <i class="fa-solid fa-user text-slate-500"></i>
                                                        <span>{{ getRdvFromTransaction(trans).civilite }} {{ getRdvFromTransaction(trans).nom }}</span>
                                                    </div>
                                                    <div v-if="getRdvFromTransaction(trans).date && getRdvFromTransaction(trans).heure" class="flex items-center gap-2 text-slate-600">
                                                        <i class="fa-solid fa-calendar text-slate-400"></i>
                                                        <span>{{ formatDateShort(getRdvFromTransaction(trans).date) }} √† {{ getRdvFromTransaction(trans).heure }}</span>
                                                    </div>
                                                    <div v-if="getRdvFromTransaction(trans).modele" class="flex items-center gap-2 text-slate-600">
                                                        <i class="fa-solid fa-car text-slate-400"></i>
                                                        <span>{{ getRdvFromTransaction(trans).modele }}</span>
                                                    </div>
                                                    <div v-if="getRdvFromTransaction(trans).telephone" class="flex items-center gap-2 text-slate-600">
                                                        <i class="fa-solid fa-phone text-slate-400"></i>
                                                        <span>{{ getRdvFromTransaction(trans).telephone }}</span>
                                                    </div>
                                                    <div v-if="trans.rdvId" class="flex items-center gap-2 text-blue-600 font-medium">
                                                        <i class="fa-solid fa-eye text-blue-500"></i>
                                                        <span>Cliquer pour voir le r√©capitulatif</span>
                                                    </div>
                                                </div>
                                                <!-- D√©tails bonus si c'est un bonus -->
                                                <div v-if="trans.type === 'bonus' && trans.bonusCount" class="mt-3 p-3 bg-yellow-50 rounded-xl border border-yellow-200">
                                                    <div class="text-sm text-yellow-800 font-medium">
                                                        <i class="fa-solid fa-trophy mr-2"></i>
                                                        Palier atteint : {{ trans.bonusCount }} RDV honor√©s
                                                    </div>
                                                </div>
                                                <!-- Note si disponible -->
                                                <div v-if="trans.note" class="mt-3 text-sm text-slate-600 italic bg-slate-100 p-3 rounded-xl border border-slate-200">
                                                    <i class="fa-solid fa-sticky-note mr-2 text-slate-400"></i>{{ trans.note }}
                                                </div>
                                            </div>
                                            <div class="flex flex-col items-end gap-2 flex-shrink-0">
                                                <span class="text-2xl font-black whitespace-nowrap" :class="trans.amount >= 0 ? 'text-green-600' : 'text-red-600'">
                                                    {{ trans.amount >= 0 ? '+' : '' }}{{ formatPrice(trans.amount) }}
                                                </span>
                                                <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition">
                                                    <button 
                                                        v-if="!trans.hidden"
                                                        @click.stop="hideTransaction(trans.id)" 
                                                        class="bg-red-100 text-red-600 p-2 rounded-lg hover:bg-red-200 transition shadow-sm"
                                                        title="Masquer cette transaction"
                                                    >
                                                        <i class="fa-solid fa-eye-slash text-xs"></i>
                                                    </button>
                                                    <button 
                                                        v-else
                                                        @click.stop="showTransaction(trans.id)" 
                                                        class="bg-green-100 text-green-600 p-2 rounded-lg hover:bg-green-200 transition shadow-sm"
                                                        title="Afficher cette transaction"
                                                    >
                                                        <i class="fa-solid fa-eye text-xs"></i>
                                                    </button>
                                                    <button 
                                                        @click.stop="deleteTransaction(trans.id)" 
                                                        class="bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition shadow-sm"
                                                        title="Supprimer cette transaction"
                                                    >
                                                        <i class="fa-solid fa-trash text-xs"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div v-if="allTransactions.length === 0" class="text-center text-slate-400 py-12">
                                        <i class="fa-solid fa-inbox text-5xl mb-3"></i>
                                        <p class="text-lg font-medium">Aucune transaction</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Performance & Finances -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-gradient-to-br from-green-50 to-white rounded-2xl shadow-lg border-2 border-green-100 p-6 relative overflow-hidden">
                                    <div class="absolute top-0 right-0 w-24 h-24 bg-green-200/30 rounded-full -mr-12 -mt-12"></div>
                                    <div class="relative z-10">
                                        <h3 class="text-lg font-bold mb-6 text-slate-800 flex items-center gap-2">
                                            <div class="w-10 h-10 bg-green-500 rounded-xl flex items-center justify-center">
                                                <i class="fa-solid fa-chart-line text-white"></i>
                                            </div>
                                            Performance
                                        </h3>
                                        <div class="space-y-4">
                                            <div class="bg-white/80 rounded-xl p-4 border border-green-100">
                                                <div class="flex justify-between items-center">
                                                    <span class="text-slate-600 font-medium">Chiffre d'affaires</span>
                                                    <span class="text-2xl font-black text-green-600">{{ formatPrice(prospecteurStats.ca) }}</span>
                                                </div>
                                            </div>
                                            <div class="bg-white/80 rounded-xl p-4 border border-blue-100">
                                                <div class="flex justify-between items-center">
                                                    <span class="text-slate-600 font-medium">RDV Honor√©s</span>
                                                    <span class="text-xl font-bold text-blue-600">{{ prospecteurStats.honoredCount }}</span>
                                                </div>
                                            </div>
                                            <div class="pt-3 border-t border-slate-200">
                                                <span class="text-xs font-bold text-slate-500 uppercase mb-3 block">Paliers atteints</span>
                                                <div class="space-y-2">
                                                    <div v-for="tier in prospecteurStats.tiers" :key="tier.level" class="flex items-center gap-3 p-2 rounded-lg" :class="tier.reached ? 'bg-green-50' : 'bg-slate-50'">
                                                        <i :class="tier.reached ? 'fa-solid fa-check-circle text-green-500 text-lg' : 'fa-regular fa-circle text-gray-300'"></i>
                                                        <span class="text-sm font-medium" :class="tier.reached ? 'font-bold text-green-700' : 'text-gray-400'">
                                                            Palier {{ tier.level }}: {{ tier.count }} RDV
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Finances -->
                                <div class="bg-gradient-to-br from-purple-50 to-white rounded-2xl shadow-lg border-2 border-purple-100 p-6 relative overflow-hidden">
                                    <div class="absolute top-0 right-0 w-24 h-24 bg-purple-200/30 rounded-full -mr-12 -mt-12"></div>
                                    <div class="relative z-10">
                                        <h3 class="text-lg font-bold mb-6 text-slate-800 flex items-center gap-2">
                                            <div class="w-10 h-10 bg-purple-500 rounded-xl flex items-center justify-center">
                                                <i class="fa-solid fa-calculator text-white"></i>
                                            </div>
                                            Finances
                                        </h3>
                                        <div class="space-y-3">
                                            <div class="bg-white/80 rounded-xl p-3 border border-green-100">
                                                <div class="flex justify-between items-center">
                                                    <span class="text-slate-600 text-sm font-medium">CA g√©n√©r√©</span>
                                                    <span class="text-lg font-bold text-green-600">+{{ formatPrice(prospecteurStats.ca) }}</span>
                                                </div>
                                            </div>
                                            <div class="bg-white/80 rounded-xl p-3 border border-red-100">
                                                <div class="flex justify-between items-center">
                                                    <span class="text-slate-600 text-sm font-medium">Primes</span>
                                                    <span class="text-lg font-bold text-red-600">-{{ formatPrice(prospecteurStats.commissions) }}</span>
                                                </div>
                                            </div>
                                            <div class="bg-white/80 rounded-xl p-3 border border-red-100">
                                                <div class="flex justify-between items-center">
                                                    <span class="text-slate-600 text-sm font-medium">Pourboires</span>
                                                    <span class="text-lg font-bold text-red-600">-{{ formatPrice(prospecteurStats.tips) }}</span>
                                                </div>
                                            </div>
                                            <div class="pt-4 mt-4 border-t-2 border-slate-300 bg-gradient-to-r from-slate-50 to-white rounded-xl p-4">
                                                <div class="flex justify-between items-center">
                                                    <span class="text-lg font-bold text-slate-800">Reste net</span>
                                                    <span class="text-3xl font-black" :class="prospecteurStats.net >= 0 ? 'text-green-600' : 'text-red-600'">
                                                        {{ formatPrice(prospecteurStats.net) }}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Gestion Pourboires -->
                            <div class="bg-gradient-to-br from-orange-50 to-white rounded-2xl shadow-lg border-2 border-orange-100 p-6">
                                <h3 class="text-lg font-bold mb-6 text-slate-800 flex items-center gap-2">
                                    <div class="w-10 h-10 bg-orange-500 rounded-xl flex items-center justify-center">
                                        <i class="fa-solid fa-hand-holding-dollar text-white"></i>
                                    </div>
                                    Gestion Pourboires
                                </h3>
                                <div class="flex justify-center">
                                    <button @click="openTipModal" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-8 py-4 rounded-2xl font-bold hover:from-purple-700 hover:to-pink-700 transition shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center gap-3 text-lg">
                                        <i class="fa-solid fa-hand-holding-dollar text-2xl"></i>
                                        G√©rer les Pourboires
                                            </button>
                                        </div>
                                    </div>
                                        </div>
                                    </div>

                    <!-- VUE PROSPECTEUR -->
                    <div v-else class="space-y-6">
                        <!-- Carte Bancaire R√©aliste -->
                        <div class="flex justify-center">
                            <div class="w-full max-w-md">
                                <div class="bg-white rounded-2xl shadow-2xl p-6 border-2 border-blue-200 relative overflow-hidden transform hover:scale-[1.01] transition-all duration-300" style="aspect-ratio: 1.586;">
                                    <!-- Effets de lumi√®re subtils -->
                                    <div class="absolute top-0 right-0 w-64 h-64 bg-blue-100/30 rounded-full -mr-32 -mt-32"></div>
                                    <div class="absolute bottom-0 left-0 w-48 h-48 bg-blue-100/30 rounded-full -ml-24 -mb-24"></div>
                                    
                                    <!-- Motif de fond discret -->
                                    <div class="absolute inset-0 opacity-5">
                                        <div class="absolute inset-0" style="background-image: radial-gradient(circle at 20% 50%, #667eea 1px, transparent 1px); background-size: 20px 20px;"></div>
                            </div>

                                    <!-- Contenu de la carte -->
                                    <div class="relative z-10 h-full flex flex-col justify-between">
                                        <!-- En-t√™te avec logo -->
                                <div class="flex items-center justify-between mb-4">
                                            <div class="text-slate-800 font-bold text-lg tracking-wide">C&N Solutions</div>
                                            <div class="flex items-center gap-2">
                                                <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                                                    <i class="fa-solid fa-credit-card text-sm text-blue-600"></i>
                                </div>
                                            </div>
                                                </div>
                                        
                                        <!-- Chip de carte -->
                                        <div class="absolute top-12 right-6 w-12 h-9 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-md shadow-lg flex items-center justify-center">
                                            <div class="w-full h-full bg-gradient-to-br from-transparent via-white/30 to-transparent rounded-md relative">
                                                <div class="absolute inset-0 flex items-center justify-center">
                                                    <div class="w-3 h-3 bg-white/40 rounded-sm"></div>
                                            </div>
                                        </div>
                                        </div>
                                        
                                        <!-- Num√©ro de carte masqu√© -->
                                        <div class="flex-1 flex items-center">
                                            <div class="w-full">
                                                <p class="text-blue-600 text-xs font-medium uppercase mb-3 tracking-widest">Num√©ro de compte</p>
                                                <div class="flex items-center gap-2 mb-6">
                                                    <span class="text-2xl font-mono font-bold tracking-widest text-slate-400">**** **** ****</span>
                                                    <span class="text-2xl font-mono font-bold tracking-widest text-slate-800">{{ String(Math.abs(userPortefeuille.total)).slice(-4).padStart(4, '0') }}</span>
                                    </div>
                                                
                                                <!-- Solde disponible -->
                                                <div class="mb-4">
                                                    <p class="text-blue-600 text-xs font-medium uppercase mb-1 tracking-widest">Solde disponible</p>
                                                    <p class="text-3xl font-black text-slate-800">{{ formatPrice(userPortefeuille.total) }}</p>
                                    </div>
                                </div>
                            </div>
                                        
                                        <!-- Bas de carte avec nom -->
                                        <div class="flex items-end justify-between pt-4 border-t border-slate-200">
                                            <div class="flex-1">
                                                <p class="text-blue-600 text-xs font-medium uppercase mb-1 tracking-widest">Titulaire</p>
                                                <p class="text-slate-800 text-lg font-bold uppercase tracking-wide truncate">{{ user.name }}</p>
                        </div>
                                            <div class="text-right">
                                                <div class="w-12 h-8 bg-blue-100 rounded flex items-center justify-center mb-1">
                                                    <div class="w-8 h-5 bg-gradient-to-br from-blue-400 to-blue-600 rounded-sm"></div>
                    </div>
                                                <p class="text-blue-600 text-[8px] font-medium uppercase">VISA</p>
                                    </div>
                                    </div>
                                </div>
                                </div>
                            </div>
                        </div>

                        <!-- Historique des Transactions -->
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                                <i class="fa-solid fa-history text-blue-500"></i>
                                Historique des transactions
                            </h3>
                                <button @click="loadUserTransactions()" class="bg-blue-100 text-blue-600 p-2 rounded-lg hover:bg-blue-200 transition" title="Actualiser">
                                    <i class="fa-solid fa-sync-alt"></i>
                                </button>
                            </div>
                            <div class="space-y-3">
                                <div 
                                    v-for="trans in visibleTransactions" 
                                    :key="trans.id"
                                    @click="trans.rdvId && openRdvFiche(getRdvFromTransaction(trans))"
                                    class="p-5 bg-gradient-to-br from-white to-slate-50 hover:from-blue-50 hover:to-blue-100 rounded-2xl border-2 transition-all cursor-pointer shadow-sm hover:shadow-md"
                                    :class="trans.hidden ? 'opacity-60 border-slate-300' : (trans.amount >= 0 ? 'border-green-200 hover:border-green-400' : 'border-red-200 hover:border-red-400')"
                                >
                                    <div class="flex items-start gap-4">
                                        <div class="w-14 h-14 rounded-2xl flex items-center justify-center flex-shrink-0 shadow-md" 
                                             :class="trans.type === 'bonus' ? 'bg-gradient-to-br from-yellow-400 to-orange-500' : (trans.amount >= 0 ? 'bg-gradient-to-br from-green-400 to-emerald-500' : 'bg-gradient-to-br from-red-400 to-rose-500')">
                                            <i :class="getTransactionIcon(trans.type)" class="text-white text-xl"></i>
                                            </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center gap-2 mb-2">
                                                <span class="font-bold text-lg text-slate-800">{{ trans.label }}</span>
                                                <span v-if="trans.type === 'bonus'" class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full font-bold animate-pulse">
                                                    <i class="fa-solid fa-star mr-1"></i>Bonus
                                                </span>
                                            </div>
                                            <div class="text-sm text-slate-500 mb-3 font-medium">
                                                <i class="fa-solid fa-clock mr-1"></i>{{ formatDateFr(trans.date) }}
                                        </div>
                                            <!-- D√©tails du RDV si disponible -->
                                            <div v-if="getRdvFromTransaction(trans)" class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3 p-3 bg-white/60 rounded-xl border border-slate-200">
                                                <div v-if="getRdvFromTransaction(trans).agenceId" class="flex items-center gap-2 text-blue-700 font-medium">
                                                    <i class="fa-solid fa-building text-blue-500"></i>
                                                    <span>{{ getAgenceName(getRdvFromTransaction(trans).agenceId) }}</span>
                                                </div>
                                                <div v-if="getRdvFromTransaction(trans).civilite && getRdvFromTransaction(trans).nom" class="flex items-center gap-2 text-slate-700 font-medium">
                                                    <i class="fa-solid fa-user text-slate-500"></i>
                                                    <span>{{ getRdvFromTransaction(trans).civilite }} {{ getRdvFromTransaction(trans).nom }}</span>
                                                </div>
                                                <div v-if="getRdvFromTransaction(trans).date && getRdvFromTransaction(trans).heure" class="flex items-center gap-2 text-slate-600">
                                                    <i class="fa-solid fa-calendar text-slate-400"></i>
                                                    <span>{{ formatDateShort(getRdvFromTransaction(trans).date) }} √† {{ getRdvFromTransaction(trans).heure }}</span>
                                                </div>
                                                <div v-if="getRdvFromTransaction(trans).modele" class="flex items-center gap-2 text-slate-600">
                                                    <i class="fa-solid fa-car text-slate-400"></i>
                                                    <span>{{ getRdvFromTransaction(trans).modele }}</span>
                                                </div>
                                                <div v-if="trans.rdvId" class="flex items-center gap-2 text-blue-600 font-medium">
                                                    <i class="fa-solid fa-eye text-blue-500"></i>
                                                    <span>Cliquer pour voir le r√©capitulatif</span>
                                                </div>
                                            </div>
                                            <!-- D√©tails bonus si c'est un bonus -->
                                            <div v-if="trans.type === 'bonus' && trans.bonusCount" class="mt-3 p-3 bg-yellow-50 rounded-xl border border-yellow-200">
                                                <div class="text-sm text-yellow-800 font-medium">
                                                    <i class="fa-solid fa-trophy mr-2"></i>
                                                    Palier atteint : {{ trans.bonusCount }} RDV honor√©s
                                                </div>
                                            </div>
                                            <!-- Note si disponible -->
                                            <div v-if="trans.note" class="mt-3 text-sm text-slate-600 italic bg-slate-100 p-3 rounded-xl border border-slate-200">
                                                <i class="fa-solid fa-sticky-note mr-2 text-slate-400"></i>{{ trans.note }}
                                            </div>
                                        </div>
                                        <div class="flex flex-col items-end gap-2 flex-shrink-0">
                                            <span class="text-2xl font-black whitespace-nowrap" :class="trans.amount >= 0 ? 'text-green-600' : 'text-red-600'">
                                                {{ trans.amount >= 0 ? '+' : '' }}{{ formatPrice(trans.amount) }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div v-if="visibleTransactions.length === 0" class="text-center text-slate-400 py-8">
                                    <i class="fa-solid fa-inbox text-4xl mb-2"></i>
                                    <p>Aucune transaction visible</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="view==='rappels' || view==='confirmations'" class="max-w-3xl mx-auto space-y-4 fade-in">
    <h2
        class="text-xl md:text-2xl font-bold mb-6"
        :class="view==='rappels' ? 'text-red-600' : 'text-orange-600'"
    >
        {{ view==='rappels' ? 'Rappels √† effectuer' : 'Rendez-vous √† confirmer' }}
    </h2>

    <!-- üî¥ Filtres internes uniquement pour l'onglet Rappels -->
    <div v-if="view==='rappels'" class="bg-white rounded-2xl border border-red-100 p-4 mb-2 shadow-sm space-y-3">
        <!-- Onglets Aujourd'hui / Demain (Veille) -->
        <div class="flex gap-2">
            <button
                @click="rappelFilters.day = 'today'"
                class="flex-1 px-3 py-2 rounded-full text-xs font-bold uppercase tracking-wide border transition"
                :class="rappelFilters.day === 'today'
                    ? 'bg-red-600 text-white border-red-600 shadow'
                    : 'bg-red-50 text-red-600 border-red-200 hover:bg-red-100'"
            >
                Rappels Aujourd'hui <span v-if="rappelsJourCount > 0" class="ml-1 bg-white text-red-600 px-1.5 rounded-full text-[10px] shadow-sm">{{ rappelsJourCount }}</span>
            </button>
            <button
                @click="rappelFilters.day = 'tomorrow'"
                class="flex-1 px-3 py-2 rounded-full text-xs font-bold uppercase tracking-wide border transition"
                :class="rappelFilters.day === 'tomorrow'
                    ? 'bg-red-600 text-white border-red-600 shadow'
                    : 'bg-red-50 text-red-600 border-red-200 hover:bg-red-100'"
            >
                Rappels Demain (Veille) <span v-if="rappelsVeilleCount > 0" class="ml-1 bg-white text-red-600 px-1.5 rounded-full text-[10px] shadow-sm">{{ rappelsVeilleCount }}</span>
            </button>
        </div>

        <!-- Filtres Agence / Cr√©√© par -->
        <div class="flex flex-wrap gap-2 items-center">
            <div class="relative">
                <select
                    v-model="rappelFilters.agenceId"
                    class="appearance-none bg-white border px-3 py-2 pr-8 rounded-lg text-xs font-bold text-slate-700 outline-none focus:border-red-500 shadow-sm"
                >
                    <option value="">Toutes les agences</option>
                    <option v-for="ag in visibleAgencies" :key="ag.id" :value="ag.id">
                        {{ ag.nom }}
                    </option>
                </select>
                <i class="fa-solid fa-chevron-down absolute right-3 top-2.5 text-[10px] text-gray-400 pointer-events-none"></i>
            </div>

            <div class="relative">
                <select v-if="user.role === 'admin'"
                    v-model="rappelFilters.userId"
                    class="appearance-none bg-white border px-3 py-2 pr-8 rounded-lg text-xs font-bold text-slate-700 outline-none focus:border-red-500 shadow-sm"
                >
                    <option value="">Tous les utilisateurs</option>
                    <option v-for="u in allProspectors" :key="u" :value="u">
                        {{ u }}
                    </option>
                </select>
                <i v-if="user.role === 'admin'" class="fa-solid fa-chevron-down absolute right-3 top-2.5 text-[10px] text-gray-400 pointer-events-none"></i>
            </div>

            <button
                v-if="rappelFilters.day !== 'today' || rappelFilters.agenceId || rappelFilters.userId"
                @click="rappelFilters.day = 'today'; rappelFilters.agenceId=''; rappelFilters.userId='';"
                class="px-3 py-2 rounded-lg text-xs font-bold text-red-500 border border-red-200 bg-red-50 hover:bg-red-100 ml-auto"
            >
                R√©initialiser
            </button>
        </div>
    </div>

    <!-- Message "Tout est √† jour" -->
    <div
        v-if="(view==='rappels' && rappelsDisplay.length === 0) ||
               (view==='confirmations' && confirmList.length === 0)"
        class="bg-white p-10 rounded-2xl text-center text-gray-400 border border-slate-100 shadow-sm"
    >
        <i class="fa-solid fa-check-circle text-4xl mb-2 text-green-500"></i><br>
        Tout est √† jour !
    </div>

    <!-- Liste des rappels / confirmations -->
    <!-- AJOUT CLICK SUR LIGNE ET CLICK STOP SUR BOUTONS -->
    <div
        v-for="r in (view==='rappels' ? rappelsDisplay : confirmList)"
        :key="r.id"
        @click="openRdvFiche(r)"
        class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border-l-4 flex flex-col md:flex-row justify-between items-start md:items-center hover:shadow-md transition gap-4 cursor-pointer"
        :class="view==='rappels' ? 'border-red-500' : 'border-orange-500'"
    >
        <div>
            <div class="font-bold text-lg">
                {{ r.civilite }} {{ r.nom }}
            </div>
            <div class="text-slate-500">
                {{ formatDateFr(r.date) }} √† {{ r.heure }} ‚Ä¢ {{ r.modele }}
            </div>
            <div class="text-sm font-bold text-blue-600 mt-1">
                {{ getAgenceName(r.agenceId) }}
            </div>
        </div>

        <div class="flex flex-wrap gap-2 w-full md:w-auto" @click.stop>
            <a
                :href="generateMsgLink(r, view==='rappels' ? getRappelType(r) : 'confirm')"
                target="_blank"
                class="flex-1 md:flex-none justify-center bg-slate-800 text-white px-4 py-2 rounded-xl font-bold hover:bg-slate-900 flex items-center gap-2 shadow-lg shadow-slate-200"
            >
                <i class="fa-solid fa-comment-sms"></i>
                {{ view==='rappels' ? getRappelLabel(r) : 'Envoyer la confirmation du rendez-vous' }}
            </a>

            <button
                v-if="view==='confirmations' && !r.dansAgenda"
                @click.stop="handleAddToAgendaClick(r)"
                class="bg-blue-500 text-white px-4 py-2 rounded-xl font-bold hover:bg-blue-600 shadow flex items-center gap-2 transition transform active:scale-95"
                title="Ajouter √† l'agenda"
            >
                <i class="fa-solid fa-calendar-plus"></i>
                <span class="hidden md:inline">Agenda</span>
            </button>

            <button
                @click="validateAction(r, view)"
                class="bg-green-500 text-white px-4 py-2 rounded-xl font-bold hover:bg-green-600 shadow"
            >
                <i class="fa-solid fa-check"></i>
            </button>

            <button
                v-if="view==='confirmations'"
                @click="quickCancel(r)"
                class="bg-white text-red-500 border border-red-200 px-4 py-2 rounded-xl font-bold hover:bg-red-50"
            >
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
    </div>
</div>
    
    <!-- FIX Z-INDEX MODALE CLIENT -->
    <!-- FICHE RENDEZ-VOUS SIMPLIFI√âE -->
    <div v-if="clientModal.open" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[300] flex items-center justify-center p-0 md:p-4 animate-fadeIn">
        <div class="bg-white w-full h-full md:w-full md:max-w-2xl md:h-[90vh] md:rounded-3xl shadow-2xl overflow-hidden flex flex-col relative">
            
            <!-- BANDEAU STATUT -->
            <div v-if="getRdvTimeStatus(clientModal.rdv) === 'en_cours'" class="absolute top-3 left-3 z-20 bg-gradient-to-r from-emerald-500 to-green-600 text-white px-2 py-1 rounded-lg font-bold text-xs flex items-center gap-1">
                <i class="fa-solid fa-circle-dot animate-pulse"></i>
            </div>
            <div v-else-if="getRdvTimeStatus(clientModal.rdv) === 'bientot'" class="absolute top-3 left-3 z-20 bg-gradient-to-r from-amber-500 to-orange-500 text-white px-2 py-1 rounded-lg font-bold text-xs flex items-center gap-1">
                <i class="fa-solid fa-clock"></i>
            </div>
            <!-- HEADER -->
            <div class="relative bg-gradient-to-br from-blue-600 via-indigo-600 to-purple-600 text-white">
                <div class="absolute top-3 right-3 flex gap-2 z-20">
                    <button @click="openEdit(clientModal.rdv)" class="w-8 h-8 bg-white/20 hover:bg-white/30 backdrop-blur-md rounded-lg flex items-center justify-center transition-all" title="Modifier">
                        <i class="fa-solid fa-pencil text-xs"></i>
                    </button>
                    <button @click="softDeleteRdv(clientModal.rdv)" class="w-8 h-8 bg-red-500/90 hover:bg-red-600 backdrop-blur-md rounded-lg flex items-center justify-center transition-all" title="Supprimer">
                        <i class="fa-solid fa-trash-can text-xs"></i>
                    </button>
                    <button @click="clientModal.open=false" class="w-8 h-8 bg-white/20 hover:bg-white/30 backdrop-blur-md rounded-lg flex items-center justify-center transition-all">
                        <i class="fa-solid fa-times text-sm"></i>
                    </button>
                </div>

                <div class="relative z-10 p-5">
                    <div class="flex items-center gap-3">
                        <div class="relative flex-shrink-0">
                            <div :class="{'ring-2 ring-emerald-400 animate-pulse': getRdvTimeStatus(clientModal.rdv)==='en_cours'}" class="w-16 h-16 bg-white/20 backdrop-blur-xl border-2 border-white/40 rounded-xl flex items-center justify-center text-2xl font-black">
                                {{ clientModal.rdv.civilite === 'M.' ? 'M' : 'F' }}
                            </div>
                            <div v-if="clientModal.rdv.rappelFait" class="absolute -top-1 -right-1 w-5 h-5 bg-emerald-500 rounded-full flex items-center justify-center border-2 border-white">
                                <i class="fa-solid fa-bell text-white text-[8px]"></i>
                            </div>
                        </div>
                        
                        <div class="flex-1 min-w-0">
                            <h1 class="text-xl md:text-2xl font-black text-white mb-1.5">
                                {{ clientModal.rdv.nom }}
                            </h1>
                            
                            <div class="flex items-center gap-1.5 mb-2 flex-wrap">
                                <span :class="statusClass(clientModal.rdv.statut)" class="px-2 py-0.5 rounded-full text-[10px] font-bold uppercase">
                                    {{ displayStatus(clientModal.rdv) }}
                                </span>
                                <span v-if="clientModal.rdv.tag === 'OK M'" class="bg-blue-500 text-white px-2 py-0.5 rounded-full text-[10px] font-bold">
                                    OK M
                                </span>
                                <span v-if="clientModal.rdv.rappelFait" class="bg-emerald-500 text-white px-2 py-0.5 rounded-full text-[10px] font-bold">
                                    <i class="fa-solid fa-bell text-[8px]"></i>
                                </span>
                            </div>

                            <div class="flex items-center gap-2 flex-wrap">
                                <a :href="'tel:' + normalizePhone(clientModal.rdv.telephone)" class="bg-white/20 hover:bg-white/30 backdrop-blur-md text-white px-3 py-1.5 rounded-lg font-bold text-xs transition-all flex items-center gap-1.5">
                                    <i class="fa-solid fa-phone text-xs"></i>
                                    <span class="font-mono text-xs">{{ clientModal.rdv.telephone }}</span>
                                </a>
                                <a :href="generateMsgLink(clientModal.rdv, 'confirm')" target="_blank" class="bg-white/15 hover:bg-white/25 backdrop-blur-md text-white/90 px-2 py-0.5 rounded-md font-normal text-[9px] transition-all flex items-center gap-1 opacity-80 hover:opacity-100" title="Renvoyer la confirmation au client s'il ne l'a pas re√ßue">
                                    <i class="fa-solid fa-message text-[9px]"></i>
                                    <span class="hidden sm:inline">Renvoyer la confirmation au client</span>
                                    <span class="sm:hidden">Renvoyer</span>
                                </a>
                                <div v-if="clientModal.rdv?.dansAgenda" class="bg-green-500 text-white px-2 py-1 rounded-lg font-bold text-[10px] flex items-center gap-1 shadow-md">
                                    <i class="fa-solid fa-calendar-check text-[8px]"></i>
                                    <span>Agenda</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CONTENU PRINCIPAL -->
            <div v-if="clientModal.view === 'main'" class="flex-1 overflow-y-auto p-5 bg-slate-50">
                <!-- INFORMATIONS PRINCIPALES -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-4">
                    <h3 class="text-xs font-bold text-slate-600 uppercase mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-info-circle text-blue-500"></i>
                        Informations
                    </h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <div class="text-[10px] font-semibold text-slate-500 uppercase mb-1">V√©hicule</div>
                            <div class="text-sm font-bold text-slate-800">{{ clientModal.rdv.modele || 'Non sp√©cifi√©' }}</div>
                        </div>
                        <div>
                            <div class="text-[10px] font-semibold text-slate-500 uppercase mb-1">Source</div>
                            <div class="flex items-center gap-1.5">
                                <img v-if="clientModal.rdv.source" :src="getLogo(clientModal.rdv.source)" class="w-4 h-4 rounded">
                                <span class="text-sm font-bold text-slate-800">{{ clientModal.rdv.source || 'Non sp√©cifi√©' }}</span>
                            </div>
                        </div>
                        <div v-if="clientModal.rdv.motif">
                            <div class="text-[10px] font-semibold text-slate-500 uppercase mb-1">Motif</div>
                            <div class="text-sm font-bold text-slate-800 flex items-center gap-1.5">
                                <i class="fa-solid fa-tag text-orange-500 text-xs"></i>
                                {{ clientModal.rdv.motif }}
                            </div>
                        </div>
                        <div>
                            <div class="text-[10px] font-semibold text-slate-500 uppercase mb-1">Agence</div>
                            <div class="text-sm font-bold text-slate-800 flex items-center gap-1.5">
                                <i class="fa-solid fa-building text-blue-500 text-xs"></i>
                                {{ getAgenceName(clientModal.rdv.agenceId) || 'Non sp√©cifi√©e' }}
                            </div>
                        </div>
                        <div>
                            <div class="text-[10px] font-semibold text-slate-500 uppercase mb-1">Date & Heure</div>
                            <div class="text-sm font-bold text-slate-800 flex items-center gap-1.5">
                                <i class="fa-solid fa-calendar text-purple-500 text-xs"></i>
                                {{ formatDateFr(clientModal.rdv.date) }} √† {{ clientModal.rdv.heure }}
                            </div>
                        </div>
                    </div>
                    <button @click="openRescheduleModal(clientModal.rdv)" class="w-full mt-3 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-bold text-xs transition-all flex items-center justify-center gap-1.5">
                        <i class="fa-solid fa-calendar-days text-xs"></i>
                        Reporter
                    </button>
                </div>

                <!-- BOUTON HISTORIQUE -->
                <button @click="clientModal.view='history'" class="w-full bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-4 hover:bg-slate-50 transition-all flex items-center justify-between group">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center group-hover:bg-blue-200 transition">
                            <i class="fa-solid fa-clock-rotate-left text-blue-600"></i>
                        </div>
                        <div class="text-left">
                            <div class="text-sm font-bold text-slate-800">Historique & Notes</div>
                            <div class="text-xs text-slate-500">
                                {{ (clientModal.rdv.notes || []).length }} note{{ (clientModal.rdv.notes || []).length > 1 ? 's' : '' }}
                            </div>
                        </div>
                    </div>
                    <i class="fa-solid fa-chevron-right text-slate-400 group-hover:text-blue-600 transition"></i>
                </button>

                <!-- ACTIONS RAPIDES COMPACTES -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
                    <h3 class="text-xs font-bold text-slate-600 uppercase mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-bolt text-yellow-500"></i>
                        Actions
                    </h3>
                    <div class="flex items-center gap-2 flex-wrap">
                        <button @click="openHonorCheck(clientModal.rdv)" class="bg-emerald-500 hover:bg-emerald-600 text-white p-1.5 rounded-lg transition-all flex items-center justify-center">
                            <i class="fa-solid fa-check-circle text-xs"></i>
                        </button>
                        <button @click="updateStatus(clientModal.rdv, 'noshow')" class="bg-red-500 hover:bg-red-600 text-white p-1.5 rounded-lg transition-all flex items-center justify-center">
                            <i class="fa-solid fa-user-xmark text-xs"></i>
                        </button>
                        <button v-if="['honore','pas_venu','annule'].includes(clientModal.rdv.statut)" @click="updateStatus(clientModal.rdv, 'reset')" class="bg-slate-200 hover:bg-slate-300 text-slate-700 p-1.5 rounded-lg font-bold text-xs transition-all flex items-center justify-center gap-1.5">
                            <i class="fa-solid fa-rotate-left text-xs"></i>
                            Reset
                        </button>
                        <button @click="openCancelChoice(clientModal.rdv)" class="bg-red-500 hover:bg-red-600 text-white p-1.5 rounded-lg transition-all flex items-center justify-center">
                            <i class="fa-solid fa-ban text-xs"></i>
                        </button>
                    </div>
                    
                    <!-- BOUTONS AGENDA GOOGLE (toujours visibles) -->
                    <div class="mt-3 pt-3 border-t border-slate-100">
                        <div class="text-[10px] font-bold text-slate-500 uppercase mb-2 flex items-center gap-1">
                            <i class="fa-brands fa-google text-purple-500"></i>
                            Google Calendar
                        </div>
                        <div class="flex gap-2">
                            <button 
                                v-if="!clientModal.rdv.dansAgenda" 
                                @click="handleAddToAgendaClick(clientModal.rdv)" 
                                class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg font-bold text-xs transition-all flex items-center justify-center gap-2 shadow-sm">
                                <i class="fa-solid fa-plus"></i>
                                Ajouter √† l'agenda
                            </button>
                            <button 
                                v-else 
                                @click="handleRemoveFromAgendaClick(clientModal.rdv)" 
                                :disabled="clientModal.removingFromAgenda"
                                :class="clientModal.removingFromAgenda ? 'opacity-50 cursor-not-allowed' : 'hover:bg-red-600'"
                                class="flex-1 bg-red-500 text-white py-2 rounded-lg font-bold text-xs transition-all flex items-center justify-center gap-2 shadow-sm">
                                <i v-if="clientModal.removingFromAgenda" class="fa-solid fa-spinner fa-spin"></i>
                                <i v-else class="fa-solid fa-minus"></i>
                                {{ clientModal.removingFromAgenda ? 'Suppression...' : 'Retirer de l\'agenda' }}
                            </button>
                        </div>
                    </div>
                    <div v-if="clientModal.rdv.geste_commercial && user.role==='admin'" class="mt-2 bg-red-50 border border-red-200 p-2 rounded-lg text-center">
                        <div class="text-xs font-bold text-red-600">
                            -{{ clientModal.rdv.geste_commercial }}‚Ç¨ ({{ clientModal.rdv.motif_geste }})
                        </div>
                        <button @click="removeDiscount" class="mt-1 text-[10px] text-red-400 hover:text-red-600 underline">Supprimer</button>
                    </div>
                </div>
            </div>

            <!-- VUE HISTORIQUE -->
            <div v-if="clientModal.view === 'history'" class="flex-1 overflow-y-auto p-5 bg-slate-50 flex flex-col">
                <div class="mb-4 flex items-center gap-3">
                    <button @click="clientModal.view='main'" class="w-8 h-8 bg-white rounded-lg flex items-center justify-center hover:bg-slate-100 transition border border-slate-200">
                        <i class="fa-solid fa-arrow-left text-slate-600 text-xs"></i>
                    </button>
                    <h3 class="text-sm font-bold text-slate-800 flex items-center gap-2">
                        <i class="fa-solid fa-clock-rotate-left text-blue-500"></i>
                        Historique & Notes
                    </h3>
                </div>

                <div class="flex-1 space-y-3 mb-4 overflow-y-auto">
                    <div v-if="clientModal.rdv.note && (!clientModal.rdv.notes || clientModal.rdv.notes.length === 0)" class="bg-amber-50 border-l-4 border-amber-400 p-3 rounded-lg">
                        <div class="text-xs font-semibold text-amber-700 mb-1">Ancienne note</div>
                        <div class="text-sm text-amber-900">{{ clientModal.rdv.note }}</div>
                    </div>
                    <div v-if="!clientModal.rdv.notes || clientModal.rdv.notes.length === 0" class="text-center text-slate-400 py-8">
                        <i class="fa-solid fa-inbox text-3xl mb-2 block"></i>
                        <p class="text-sm font-medium">Aucun historique</p>
                    </div>
                    <div v-for="(n, idx) in (clientModal.rdv.notes || [])" :key="idx" :class="n.type === 'rappel' ? 'bg-emerald-50 border-l-4 border-emerald-500' : 'bg-blue-50 border-l-4 border-blue-500'" class="p-3 rounded-lg">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <i v-if="n.type === 'rappel'" class="fa-solid fa-bell text-emerald-600 text-xs"></i>
                                <i v-else class="fa-solid fa-note-sticky text-blue-600 text-xs"></i>
                                <span :class="n.type === 'rappel' ? 'text-emerald-800' : 'text-blue-800'" class="font-bold text-xs">{{ n.author || 'Syst√®me' }}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] text-slate-500">{{ n.date ? (new Date(n.date).toLocaleDateString('fr-FR', {day:'2-digit', month:'short'}) + ' ' + new Date(n.date).toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'})) : '' }}</span>
                                <button @click="deleteNote(clientModal.rdv, idx)" class="text-red-400 hover:text-red-600 transition" title="Supprimer">
                                    <i class="fa-solid fa-trash-can text-xs"></i>
                                </button>
                            </div>
                        </div>
                        <div :class="n.type === 'rappel' ? 'text-emerald-700' : 'text-slate-700'" class="text-sm font-medium">{{ n.text }}</div>
                    </div>
                </div>

                <div class="flex gap-2 pt-4 border-t border-slate-200">
                    <input v-model="newNoteText" @keyup.enter="addNote" placeholder="Ajouter une note..." class="flex-1 bg-white border border-slate-300 focus:border-blue-500 p-2.5 rounded-lg text-sm outline-none transition-all">
                    <button @click="addNote" class="bg-blue-500 hover:bg-blue-600 text-white w-10 h-10 rounded-lg flex items-center justify-center transition-all">
                        <i class="fa-solid fa-paper-plane text-xs"></i>
                    </button>
                </div>
                <button v-if="clientModal.rdv.rappelFait" @click="resendReminder(clientModal.rdv)" class="mt-2 w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-bold text-xs transition-all flex items-center justify-center gap-1.5">
                    <i class="fa-solid fa-bell text-xs"></i>
                    Renvoyer rappel
                </button>
            </div>

            <!-- FOOTER -->
            <div class="bg-slate-50 border-t border-slate-200 p-3 safe-area-bottom">
                <div class="text-[10px] text-slate-500 space-y-0.5 mb-2">
                    <div v-if="clientModal.rdv && getCreatedDate(clientModal.rdv)" class="flex items-center gap-1.5">
                        <i class="fa-solid fa-calendar-plus text-slate-400 text-[9px]"></i>
                        <span>Cr√©√© le {{ formatDateFr(getCreatedDate(clientModal.rdv)) }} √† {{ getCreatedTime(clientModal.rdv) }}</span>
                    </div>
                    <div v-if="clientModal.rdv && clientModal.rdv.createdBy" class="flex items-center gap-1.5">
                        <i class="fa-solid fa-user text-slate-400 text-[9px]"></i>
                        <span>Par {{ clientModal.rdv.createdBy }}</span>
                    </div>
                </div>
                <button @click="updateRdv(clientModal.rdv)" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-lg font-bold text-sm transition-all flex items-center justify-center gap-2">
                    <i class="fa-solid fa-floppy-disk text-xs"></i>
                    Enregistrer
                </button>
            </div>

        </div>
    </div>

    <!-- MODALE GESTE COMMERCIAL Z-INDEX FIX -->
    <div v-if="discountModal.open" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4 ">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm pop-in border border-slate-200 relative">
             <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl shadow-lg">
                <i class="fa-solid fa-gift"></i>
            </div>
            <h3 class="font-bold text-2xl mb-6 text-slate-800 text-center">Geste Commercial</h3>
            
            <div class="space-y-4">
                <div>
                     <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">Montant (‚Ç¨)</label>
                     <input type="number" v-model.number="discountModal.amount" class="w-full p-4 border-2 border-red-100 rounded-xl font-black text-red-600 text-center text-2xl outline-none focus:border-red-400" placeholder="0">
                </div>
                <div>
                     <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">Motif</label>
                     <div class="grid grid-cols-1 gap-2 mb-2">
                         <button v-for="r in ['V√©hicule KO', 'Client pensait voir l\'acheteur', 'Autre']" 
                                 @click="discountModal.reason = r"
                                 :class="discountModal.reason === r ? 'bg-red-500 text-white shadow-md' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'"
                                 class="py-2 px-3 rounded-lg text-xs font-bold transition">
                             {{ r }}
                         </button>
                     </div>
                     <input v-if="discountModal.reason === 'Autre'" v-model="discountModal.customReason" placeholder="Pr√©cisez..." class="w-full p-3 border-2 border-slate-200 rounded-xl text-sm font-bold text-slate-700 outline-none focus:border-red-400">
                </div>
                <!-- Message d'erreur int√©gr√© -->
                <p v-if="discountModal.error" class="text-red-500 text-xs font-bold text-center animate-shake">{{ discountModal.error }}</p>
            </div>

            <div class="flex gap-3 mt-8">
                 <button @click="discountModal.open=false" class="flex-1 bg-gray-100 text-gray-500 py-3 rounded-xl font-bold hover:bg-gray-200">Annuler</button>
                 <button @click="saveDiscount" class="flex-1 bg-red-500 text-white py-3 rounded-xl font-bold hover:bg-red-600 shadow-lg transform active:scale-95">Valider</button>
            </div>
        </div>
    </div>

    <!-- MODAL POURBOIRE MODERNE -->
    <div v-if="tipModal.open" class="fixed inset-0 bg-slate-900/80 z-[400] flex items-center justify-center p-4 ">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden fade-in">
            <div class="bg-gradient-to-r from-purple-600 to-pink-600 p-6 text-white">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-white/20  rounded-xl flex items-center justify-center">
                            <i class="fa-solid fa-hand-holding-dollar text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-xl">Gestion Pourboire</h3>
                            <p class="text-purple-100 text-sm">{{ selectedProspecteur || user.name }}</p>
                        </div>
                    </div>
                    <button @click="tipModal.open=false" class="w-8 h-8 rounded-full hover:bg-white/20 flex items-center justify-center transition">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6 space-y-6">
                <!-- Type d'op√©ration -->
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase mb-3 block">Type d'op√©ration</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button 
                            @click="tipModal.operation = 'add'"
                            :class="tipModal.operation === 'add' ? 'bg-green-500 text-white shadow-lg' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'"
                            class="p-4 rounded-xl font-bold transition transform active:scale-95 flex items-center justify-center gap-2"
                        >
                            <i class="fa-solid fa-plus-circle"></i>
                            Ajouter
                        </button>
                        <button 
                            @click="tipModal.operation = 'remove'"
                            :class="tipModal.operation === 'remove' ? 'bg-red-500 text-white shadow-lg' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'"
                            class="p-4 rounded-xl font-bold transition transform active:scale-95 flex items-center justify-center gap-2"
                        >
                            <i class="fa-solid fa-minus-circle"></i>
                            Retirer
                        </button>
                    </div>
                </div>

                <!-- Montant -->
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Montant (‚Ç¨)</label>
                    <input 
                        type="number" 
                        v-model.number="tipModal.amount" 
                        placeholder="0.00"
                        step="0.01"
                        min="0"
                        class="w-full p-4 border-2 border-slate-200 rounded-xl font-bold text-slate-800 text-lg outline-none focus:border-purple-500 transition"
                    />
                </div>

                <!-- Motif -->
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Motif</label>
                    <select 
                        v-model="tipModal.reason" 
                        class="w-full p-4 border-2 border-slate-200 rounded-xl font-bold text-slate-800 outline-none focus:border-purple-500 bg-white"
                    >
                        <option value="">S√©lectionner un motif</option>
                        <option value="Client satisfait">Client satisfait</option>
                        <option value="Performance exceptionnelle">Performance exceptionnelle</option>
                        <option value="Bonus mensuel">Bonus mensuel</option>
                        <option value="Remboursement">Remboursement</option>
                        <option value="Ajustement">Ajustement</option>
                        <option value="Autre">Autre</option>
                    </select>
                    <input 
                        v-if="tipModal.reason === 'Autre'"
                        v-model="tipModal.customReason"
                        placeholder="Pr√©cisez le motif..."
                        class="w-full mt-3 p-3 border-2 border-slate-200 rounded-xl font-medium text-slate-700 outline-none focus:border-purple-500"
                    />
                </div>

                <!-- Note -->
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Note (optionnel)</label>
                    <textarea 
                        v-model="tipModal.note"
                        placeholder="Ajoutez une note ou un commentaire..."
                        rows="3"
                        class="w-full p-3 border-2 border-slate-200 rounded-xl font-medium text-slate-700 outline-none focus:border-purple-500 resize-none"
                    ></textarea>
                </div>

                <!-- Message d'erreur -->
                <p v-if="tipModal.error" class="text-red-500 text-sm font-bold text-center animate-shake bg-red-50 p-3 rounded-xl">
                    {{ tipModal.error }}
                </p>
            </div>

            <div class="bg-slate-50 p-6 flex gap-3 border-t border-slate-200">
                <button 
                    @click="tipModal.open=false" 
                    class="flex-1 bg-white text-slate-600 border-2 border-slate-200 py-3 rounded-xl font-bold hover:bg-slate-50 transition"
                >
                    Annuler
                </button>
                <button 
                    @click="saveTipTransaction" 
                    :class="tipModal.operation === 'add' ? 'bg-green-500 hover:bg-green-600' : 'bg-red-500 hover:bg-red-600'"
                    class="flex-1 text-white py-3 rounded-xl font-bold shadow-lg transform active:scale-95 transition"
                >
                    <i :class="tipModal.operation === 'add' ? 'fa-solid fa-plus' : 'fa-solid fa-minus'" class="mr-2"></i>
                    {{ tipModal.operation === 'add' ? 'Ajouter' : 'Retirer' }}
                </button>
            </div>
        </div>
    </div>

    <!-- MODALE STATUTS MANQUANTS (NOUVELLE) -->
    <div v-if="pendingStatusModal.open" class="fixed inset-0 bg-slate-900/90 z-[450] flex items-center justify-center p-4 ">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm text-center pop-in border-4 border-purple-100">
            <div class="w-16 h-16 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl shadow-lg animate-pulse">
                <i class="fa-solid fa-clipboard-question"></i>
            </div>
            <h3 class="font-bold text-2xl mb-2 text-slate-800">Statuts manquants</h3>
            <p class="text-slate-500 font-medium mb-6">
                Vous avez <strong class="text-purple-600">{{ pendingStatusCount }} rendez-vous</strong> pass√©s dont le statut n'est pas √† jour.
            </p>
            
            <div class="space-y-3">
                <button @click="pendingStatusModal.open=false; changeView('pending_status')" class="w-full bg-purple-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-purple-200 hover:bg-purple-700 transition transform active:scale-95">
                    Voir les statuts
                </button>
                <button @click="pendingStatusModal.open=false" class="w-full bg-white text-slate-400 border-2 border-slate-100 py-3 rounded-xl font-bold hover:bg-slate-50 hover:text-slate-600 transition">
                   Ignorer
                </button>
            </div>
        </div>
    </div>

    <!-- NOUVELLE MODALE ALERTE RAPPELS CONNEXION (LOGIQUE CORRIG√âE) Z-INDEX FIX -->
    <div v-if="reminderAlertModal.open" class="fixed inset-0 bg-slate-900/90 z-[400] flex items-center justify-center p-4 ">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm text-center pop-in border-4 border-red-100">
             <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl shadow-lg animate-pulse">
                <i class="fa-solid fa-bell"></i>
            </div>
            <h3 class="font-bold text-2xl mb-2 text-slate-800">Rappels en attente</h3>
            <p class="text-slate-500 font-medium mb-6">
                Vous avez <strong class="text-red-500" v-if="rappelsVeilleCount>0">{{ rappelsVeilleCount }} pour Demain</strong>
                <span v-if="rappelsVeilleCount>0 && rappelsJourCount>0"> et </span>
                <strong class="text-red-500" v-if="rappelsJourCount>0">{{ rappelsJourCount }} pour Aujourd'hui</strong>.
            </p>
            
            <div class="space-y-3">
                <button @click="reminderAlertModal.open=false; changeView('rappels')" class="w-full bg-red-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-red-200 hover:bg-red-700 transition transform active:scale-95">
                    Voir les rappels
                </button>
                <button @click="reminderAlertModal.open=false" class="w-full bg-white text-slate-400 border-2 border-slate-100 py-3 rounded-xl font-bold hover:bg-slate-50 hover:text-slate-600 transition">
                   Ignorer
                </button>
            </div>
        </div>
    </div>
    
    <!-- MODALE STATS DETAILL√âES Z-INDEX FIX -->
    <div v-if="statsModal.open" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4 ">
        <div class="bg-white rounded-3xl shadow-2xl overflow-hidden w-full max-w-4xl max-h-[90vh] flex flex-col pop-in">
             <div class="bg-slate-100 p-6 flex justify-between items-center border-b">
                 <h3 class="font-bold text-xl text-slate-800">üìä Statistiques D√©taill√©es</h3>
                 <button @click="statsModal.open=false" class="w-8 h-8 rounded-full bg-white hover:bg-red-50 hover:text-red-500 flex items-center justify-center transition">‚úï</button>
             </div>
             
             <!-- FILTRES STATS -->
             <div class="p-6 bg-white border-b border-slate-100 grid grid-cols-1 md:grid-cols-2 gap-4">
                 <div>
                    <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">Filtrer par Agence</label>
                    <select v-model="statsFilterAgency" class="w-full p-2 border border-slate-200 rounded-xl font-bold text-slate-700">
                        <option value="">Toutes les agences</option>
                        <option v-for="ag in visibleAgencies" :key="ag.id" :value="ag.id">{{ ag.nom }}</option>
                    </select>
                 </div>
                 <!-- RESTRICTION UTILISATEUR ICI -->
                 <div v-if="user.role === 'admin'">
                    <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">Filtrer par Commercial</label>
                    <select v-model="statsFilterUser" class="w-full p-2 border border-slate-200 rounded-xl font-bold text-slate-700">
                        <option value="">Toute l'√©quipe</option>
                        <option v-for="u in allProspectors" :key="u" :value="u">{{ u }}</option>
                    </select>
                 </div>
             </div>

             <div class="flex-1 overflow-y-auto p-6 bg-slate-50">
                 
                 <!-- CHIFFRES CLES FILTR√âS -->
                 <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                     <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 text-center">
                         <p class="text-xs font-bold text-slate-400 uppercase">Total Plac√©</p>
                         <p class="text-3xl font-black text-slate-800">{{ detailedStats.total }}</p>
                     </div>
                     <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 text-center">
                         <p class="text-xs font-bold text-green-400 uppercase">Honor√©s</p>
                         <p class="text-3xl font-black text-green-600">{{ detailedStats.honored }}</p>
                     </div>
                     <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 text-center">
                         <p class="text-xs font-bold text-red-400 uppercase">Pas Venu</p>
                         <p class="text-3xl font-black text-red-600">{{ detailedStats.noshow }}</p>
                     </div>
                     <div class="bg-blue-600 text-white p-4 rounded-2xl shadow-lg shadow-blue-200 text-center flex flex-col justify-center">
                         <p class="text-xs font-bold opacity-80 uppercase">Taux Transfo.</p>
                         <p class="text-3xl font-black">{{ detailedStats.rate }}%</p>
                     </div>
                 </div>

                 <p class="text-center text-xs text-gray-400 font-bold uppercase tracking-widest mb-6">Donn√©es pour le mois en cours</p>

                 <!-- STATISTIQUES MANDATS PAR AGENCE -->
                 <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
                     <h4 class="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2">
                         <i class="fa-solid fa-building text-blue-600"></i>
                         Mandats sign√©s par Agence
                     </h4>
                     <div class="space-y-3">
                         <div v-for="stat in mandatsParAgence" :key="stat.agenceId" class="bg-slate-50 rounded-xl p-4 border border-slate-200">
                             <div class="flex items-center justify-between mb-2">
                                 <div class="font-bold text-slate-800 text-base">{{ stat.nom || 'Sans agence' }}</div>
                                 <div class="text-xs text-slate-500 font-medium">
                                     {{ stat.mandatsSignes > 0 ? Math.round((stat.mandatsSignes / stat.total) * 100) : 0 }}% de mandats
                                 </div>
                             </div>
                             <div class="grid grid-cols-2 gap-3">
                                 <div class="bg-white rounded-lg p-3 border border-slate-200">
                                     <div class="text-xs font-bold text-slate-500 uppercase mb-1">Total RDV</div>
                                     <div class="text-2xl font-black text-slate-800">{{ stat.total }}</div>
                                 </div>
                                 <div class="bg-blue-50 rounded-lg p-3 border border-blue-200">
                                     <div class="text-xs font-bold text-blue-600 uppercase mb-1">Mandats sign√©s</div>
                                     <div class="text-2xl font-black text-blue-600">{{ stat.mandatsSignes }}</div>
                                 </div>
                             </div>
                             <div v-if="stat.total > 0" class="mt-3 w-full bg-slate-200 h-2 rounded-full overflow-hidden">
                                 <div class="h-full bg-blue-600 transition-all duration-500" :style="{width: (stat.mandatsSignes / stat.total * 100) + '%'}"></div>
                             </div>
                         </div>
                         <div v-if="mandatsParAgence.length === 0" class="text-center text-slate-400 py-8">
                             <i class="fa-solid fa-inbox text-3xl mb-2 block"></i>
                             <p class="text-sm font-medium">Aucune donn√©e pour ce mois</p>
                         </div>
                     </div>
                 </div>

             </div>
        </div>
    </div>
    
    <!-- MODALE EDITION EQUIPE Z-INDEX FIX -->
    <div v-if="teamEditModal.open" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4 ">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm pop-in max-h-[90vh] overflow-y-auto">
            <h3 class="font-bold text-lg mb-4">Modifier Membre</h3>
            <div class="space-y-3">
                <input v-model="teamEditModal.name" placeholder="Nom" class="w-full p-3 border rounded-xl outline-none focus:border-blue-500">
                <input v-model="teamEditModal.email" placeholder="Email / Identifiant" class="w-full p-3 border rounded-xl outline-none focus:border-blue-500">
                <input v-model="teamEditModal.password" placeholder="Nouveau mot de passe (optionnel)" class="w-full p-3 border rounded-xl outline-none focus:border-blue-500" autocomplete="new-password">
            </div>
            
            <div class="mt-4 border-t pt-4">
                <h4 class="font-bold text-xs uppercase text-gray-500 mb-2">Agences Attribu√©es</h4>
                <div class="max-h-40 overflow-y-auto space-y-2 border rounded-xl p-2 bg-slate-50">
                    <div v-for="ag in agences" :key="ag.id" class="flex items-center gap-2">
                        <input type="checkbox" :id="'edit-ag-'+ag.id" :value="ag.id" v-model="teamEditModal.assignedAgencies" class="custom-checkbox w-4 h-4">
                        <label :for="'edit-ag-'+ag.id" class="text-sm font-medium text-slate-700 cursor-pointer select-none">{{ ag.nom }}</label>
                    </div>
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button @click="teamEditModal.open=false" class="flex-1 bg-gray-100 text-gray-500 py-2 rounded-xl font-bold">Annuler</button>
                <button @click="saveTeamMemberEdit" class="flex-1 bg-blue-600 text-white py-2 rounded-xl font-bold">Sauvegarder</button>
            </div>
        </div>
    </div>
    
    <!-- MODALE CONFIRMATION UNIVERSELLE Z-INDEX FIX -->
    <div v-if="customConfirmModal.open" class="fixed inset-0 bg-slate-900/80 z-[400] flex items-center justify-center p-4 ">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm text-center pop-in border border-slate-200">
             <div class="w-16 h-16 bg-slate-100 text-slate-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                <i class="fa-solid fa-circle-question"></i>
            </div>
            <h3 class="font-bold text-xl mb-2 text-slate-800">{{ customConfirmModal.title }}</h3>
            <p class="text-slate-500 mb-6">{{ customConfirmModal.message }}</p>
            <div class="grid grid-cols-2 gap-4">
                <button @click="customConfirmModal.open=false" class="bg-slate-100 text-slate-600 py-3 rounded-xl font-bold hover:bg-slate-200 transition text-sm">Non</button>
                <button @click="customConfirmModal.onConfirm" class="bg-slate-800 text-white py-3 rounded-xl font-bold hover:bg-slate-900 transition shadow-lg text-sm">Oui</button>
            </div>
        </div>
    </div>

    <!-- SETTINGS Z-INDEX FIX -->
    <div v-if="settingsModal.open" class="fixed inset-0 bg-slate-900/80 z-[300] flex md:items-center md:justify-center p-0 md:p-4">
        <div class="bg-white w-full h-full md:w-full md:max-w-4xl md:h-[90vh] md:rounded-3xl shadow-2xl overflow-hidden flex flex-col fade-in">
            <!-- Header avec titre et bouton fermer - Optimis√© mobile -->
            <div class="bg-gradient-to-r from-slate-800 to-slate-900 p-4 md:p-6 text-white flex items-center justify-between border-b border-slate-700 sticky top-0 z-10">
                <h2 class="text-lg md:text-2xl font-bold flex items-center gap-2">
                    <i class="fa-solid fa-gear text-lg md:text-xl"></i> 
                    <span class="hidden sm:inline">R√©glages</span>
                    <span class="sm:hidden">Param√®tres</span>
                </h2>
                <button @click="settingsModal.open=false" class="w-10 h-10 flex items-center justify-center text-white hover:bg-white/20 rounded-full transition active:scale-95">
                    <i class="fa-solid fa-times text-lg md:text-xl"></i>
                </button>
            </div>
            
            <!-- Onglets - Mobile: grille am√©lior√©e, Desktop: horizontal -->
            <div class="bg-slate-100 p-2 md:p-3 border-b border-slate-200 sticky top-[60px] md:top-[72px] z-10">
                <div class="grid grid-cols-4 md:flex gap-1.5 md:gap-2 overflow-x-auto hide-scrollbar pb-1">
                    <button @click="settingsModal.tab='Tarification'" :class="settingsModal.tab==='Tarification'?'bg-white shadow-md text-blue-600 border-blue-200':'text-gray-600 hover:bg-white/70 border-transparent'" class="px-2 md:px-4 py-2.5 md:py-2.5 rounded-lg font-bold text-xs md:text-sm transition flex-shrink-0 border-2 flex flex-col md:flex-row items-center justify-center gap-1 active:scale-95">
                        <span class="text-base md:text-sm">üí∂</span>
                        <span class="text-[10px] md:text-sm md:inline">Tarif</span>
                    </button>
                    <button @click="settingsModal.tab='Agences'" :class="settingsModal.tab==='Agences'?'bg-white shadow-md text-blue-600 border-blue-200':'text-gray-600 hover:bg-white/70 border-transparent'" class="px-2 md:px-4 py-2.5 md:py-2.5 rounded-lg font-bold text-xs md:text-sm transition flex-shrink-0 border-2 flex flex-col md:flex-row items-center justify-center gap-1 active:scale-95">
                        <span class="text-base md:text-sm">üè¢</span>
                        <span class="text-[10px] md:text-sm md:inline">Agences</span>
                    </button>
                    <button @click="settingsModal.tab='Equipe'" :class="settingsModal.tab==='Equipe'?'bg-white shadow-md text-blue-600 border-blue-200':'text-gray-600 hover:bg-white/70 border-transparent'" class="px-2 md:px-4 py-2.5 md:py-2.5 rounded-lg font-bold text-xs md:text-sm transition flex-shrink-0 border-2 flex flex-col md:flex-row items-center justify-center gap-1 active:scale-95">
                        <span class="text-base md:text-sm">üë•</span>
                        <span class="text-[10px] md:text-sm md:inline">√âquipe</span>
                    </button>
                    <button @click="settingsModal.tab='Admins'" :class="settingsModal.tab==='Admins'?'bg-white shadow-md text-blue-600 border-blue-200':'text-gray-600 hover:bg-white/70 border-transparent'" class="px-2 md:px-4 py-2.5 md:py-2.5 rounded-lg font-bold text-xs md:text-sm transition flex-shrink-0 border-2 flex flex-col md:flex-row items-center justify-center gap-1 active:scale-95">
                        <span class="text-base md:text-sm">üëë</span>
                        <span class="text-[10px] md:text-sm md:inline">Admins</span>
                    </button>
                    <button @click="settingsModal.tab='Messages'" :class="settingsModal.tab==='Messages'?'bg-white shadow-md text-blue-600 border-blue-200':'text-gray-600 hover:bg-white/70 border-transparent'" class="px-2 md:px-4 py-2.5 md:py-2.5 rounded-lg font-bold text-xs md:text-sm transition flex-shrink-0 border-2 flex flex-col md:flex-row items-center justify-center gap-1 active:scale-95">
                        <span class="text-base md:text-sm">üí¨</span>
                        <span class="text-[10px] md:text-sm md:inline">SMS</span>
                    </button>
                    <button @click="settingsModal.tab='Sources'" :class="settingsModal.tab==='Sources'?'bg-white shadow-md text-blue-600 border-blue-200':'text-gray-600 hover:bg-white/70 border-transparent'" class="px-2 md:px-4 py-2.5 md:py-2.5 rounded-lg font-bold text-xs md:text-sm transition flex-shrink-0 border-2 flex flex-col md:flex-row items-center justify-center gap-1 active:scale-95">
                        <span class="text-base md:text-sm">üîó</span>
                        <span class="text-[10px] md:text-sm md:inline">Sources</span>
                    </button>
                    <button @click="settingsModal.tab='Motifs'" :class="settingsModal.tab==='Motifs'?'bg-white shadow-md text-blue-600 border-blue-200':'text-gray-600 hover:bg-white/70 border-transparent'" class="px-2 md:px-4 py-2.5 md:py-2.5 rounded-lg font-bold text-xs md:text-sm transition flex-shrink-0 border-2 flex flex-col md:flex-row items-center justify-center gap-1 active:scale-95">
                        <span class="text-base md:text-sm">üè∑Ô∏è</span>
                        <span class="text-[10px] md:text-sm md:inline">Motifs</span>
                    </button>
                    <button v-if="user.role==='admin'" @click="settingsModal.tab='GoogleCalendar'" :class="settingsModal.tab==='GoogleCalendar'?'bg-white shadow-md text-blue-600 border-blue-200':'text-gray-600 hover:bg-white/70 border-transparent'" class="px-2 md:px-4 py-2.5 md:py-2.5 rounded-lg font-bold text-xs md:text-sm transition flex-shrink-0 border-2 flex flex-col md:flex-row items-center justify-center gap-1 active:scale-95">
                        <i class="fa-brands fa-google text-base md:text-sm"></i>
                        <span class="text-[10px] md:text-sm md:inline">Google</span>
                    </button>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4 md:p-6 bg-white pb-24 md:pb-6">
                
                <!-- ONGLET TARIFICATION (GLOBAL) -->
                <div v-if="settingsModal.tab==='Tarification'" class="space-y-4 md:space-y-6">
                    <div class="bg-gradient-to-br from-slate-50 to-blue-50 p-4 md:p-6 rounded-xl md:rounded-2xl border-2 border-slate-200 shadow-sm">
                        <h3 class="font-bold text-base md:text-lg mb-4 text-slate-700 flex items-center gap-2">
                            <i class="fa-solid fa-sack-dollar text-blue-600"></i> 
                            <span class="text-sm md:text-base">Salaire & Bonus</span>
                        </h3>
                        
                        <div class="space-y-4 mb-4">
                            <div>
                                <label class="text-xs font-bold text-slate-600 block mb-2">Salaire de Base par RDV (‚Ç¨)</label>
                                <input type="number" v-model.number="globalCommission.base" class="w-full p-3 border-2 border-slate-300 rounded-lg font-bold text-blue-600 text-base md:text-lg focus:border-blue-500 outline-none">
                            </div>
                        </div>

                        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                            <h4 class="font-bold text-xs uppercase text-yellow-700 mb-3">Logique Palier R√©current</h4>
                            <div class="space-y-3">
                                <div class="flex flex-col md:flex-row md:flex-wrap md:items-center gap-2 text-sm font-bold text-slate-700">
                                    <span class="text-xs md:text-sm">√Ä partir de</span>
                                    <input type="number" v-model.number="globalCommission.threshold" class="w-full md:w-20 p-2 rounded-lg border-2 border-slate-300 text-center focus:border-blue-500 outline-none">
                                    <span class="text-xs md:text-sm">RDV, ajouter</span>
                                    <input type="number" v-model.number="globalCommission.amount" class="w-full md:w-24 p-2 rounded-lg border-2 border-slate-300 text-center text-green-600 font-bold focus:border-green-500 outline-none">
                                    <span class="text-xs md:text-sm">‚Ç¨ tous les</span>
                                    <input type="number" v-model.number="globalCommission.step" class="w-full md:w-20 p-2 rounded-lg border-2 border-slate-300 text-center focus:border-blue-500 outline-none">
                                    <span class="text-xs md:text-sm">RDV suivants.</span>
                            </div>
                            </div>
                            <p class="text-[10px] text-slate-500 mt-3 leading-relaxed">Exemple: √Ä partir de 21 RDV, tous les 10 RDV = 100‚Ç¨. 21 RDV = +100‚Ç¨, 31 RDV = +200‚Ç¨, 41 RDV = +300‚Ç¨...</p>
                        </div>
                        
                        <button @click="saveGlobalSettings" class="w-full md:w-auto mt-4 bg-slate-800 text-white px-6 py-3 rounded-lg font-bold hover:bg-slate-900 transition shadow-md">
                            Sauvegarder
                        </button>
                    </div>

                </div>

                <div v-if="settingsModal.tab==='Equipe'" class="space-y-4 md:space-y-6">
                    <div class="bg-gradient-to-br from-slate-50 to-blue-50 p-4 md:p-6 rounded-xl md:rounded-2xl border-2 border-slate-200 shadow-sm">
                        <h3 class="font-bold text-base md:text-lg mb-4 text-slate-700 flex items-center gap-2">
                            <i class="fa-solid fa-user-plus text-blue-600"></i>
                            <span>Ajouter un Prospecteur</span>
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4 mb-4">
                            <input v-model="newMember.name" placeholder="Nom / Pr√©nom" class="p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50">
                            <input v-model="newMember.email" placeholder="Identifiant / Email" class="p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50">
                            <input v-model="newMember.password" placeholder="Mot de passe" class="p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50">
                            <button @click="addTeamMember" :disabled="!newMember.name || !newMember.email || !newMember.password" class="bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 disabled:opacity-50 transition">Ajouter</button>
                        </div>
                        
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                            <h4 class="font-bold text-xs uppercase text-gray-500 mb-2">Agences Attribu√©es (pour le nouveau membre)</h4>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-2 max-h-32 overflow-y-auto">
                                <div v-for="ag in agences" :key="ag.id" class="flex items-center gap-2">
                                    <input type="checkbox" :id="'new-ag-'+ag.id" :value="ag.id" v-model="newMember.assignedAgencies" class="custom-checkbox w-4 h-4">
                                    <label :for="'new-ag-'+ag.id" class="text-sm font-medium text-slate-700 cursor-pointer select-none">{{ ag.nom }}</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-100 text-slate-500 text-xs uppercase font-bold"><tr><th class="p-4">Nom</th><th class="p-4">Identifiant</th><th class="p-4">Agences</th><th class="p-4 hidden md:table-cell">Statut</th><th class="p-4 text-right">Actions</th></tr></thead>
                            <tbody class="divide-y"><tr v-for="member in teamList" :key="member.id" class="hover:bg-slate-50 transition"><td class="p-4 font-bold flex items-center gap-2">{{ member.name }} <button @click="openTeamEdit(member)" class="text-slate-300 hover:text-blue-500 transition"><i class="fa-solid fa-pencil text-xs"></i></button></td><td class="p-4 text-blue-600 font-medium text-xs md:text-sm">{{ member.email }}</td><td class="p-4 text-xs text-gray-500 font-bold">{{ (member.assignedAgencies || []).length }} acc√®s</td><td class="p-4 hidden md:table-cell"><span v-if="member.blocked" class="bg-red-100 text-red-600 px-3 py-1 rounded-full text-xs font-bold uppercase">Bloqu√©</span><span v-else class="bg-green-100 text-green-600 px-3 py-1 rounded-full text-xs font-bold uppercase">Actif</span></td><td class="p-4 text-right space-x-2"><button @click="toggleBlockTeamMember(member)" :class="member.blocked ? 'bg-green-100 text-green-600 hover:bg-green-200' : 'bg-orange-100 text-orange-600 hover:bg-orange-200'" class="px-3 py-1.5 rounded-lg font-bold text-xs transition">{{ member.blocked ? 'D√©bloquer' : 'Bloquer' }}</button><button @click="deleteTeamMember(member)" class="bg-red-100 text-red-600 hover:bg-red-200 px-3 py-1.5 rounded-lg font-bold text-xs transition"><i class="fa-solid fa-trash"></i></button></td></tr></tbody>
                        </table>
                    </div>
                </div>

                <div v-if="settingsModal.tab==='Agences'" class="space-y-4 md:space-y-6">
                    <div class="bg-gradient-to-br from-blue-50 to-purple-50 p-4 rounded-xl border-2 border-blue-200 mb-4 shadow-sm">
                        <h3 class="font-bold text-base md:text-lg text-slate-700 flex items-center gap-2 mb-2">
                            <i class="fa-solid fa-building text-blue-600"></i>
                            <span>Gestion des Agences</span>
                        </h3>
                        <p class="text-xs text-slate-600">Ajoutez, modifiez ou supprimez vos agences</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4">
                        <div @click="openAgencyEdit(null)" class="border-2 border-dashed border-gray-300 rounded-2xl flex flex-col items-center justify-center p-6 text-gray-400 hover:border-blue-500 hover:text-blue-500 hover:bg-blue-50 cursor-pointer transition min-h-[150px]"><i class="fa-solid fa-plus text-4xl mb-2"></i><span class="font-bold">Ajouter Agence</span></div>
                        <div v-for="ag in agences" :key="ag.id" class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 hover:border-blue-400 transition relative group">
                            <div class="flex justify-between items-start mb-2"><h3 class="font-bold text-xl">{{ ag.nom }}</h3><div class="flex gap-2 opacity-100 md:opacity-0 group-hover:opacity-100 transition"><button @click.stop="openAgencyEdit(ag)" class="w-8 h-8 rounded-lg bg-blue-100 text-blue-600 hover:bg-blue-200"><i class="fa-solid fa-pen"></i></button><button @click.stop="deleteAgency(ag.id)" class="w-8 h-8 rounded-lg bg-red-100 text-red-600 hover:bg-red-200"><i class="fa-solid fa-trash"></i></button></div></div>
                            <p class="text-sm text-gray-500 mb-4 h-10 overflow-hidden">{{ ag.adresse }}</p>
                            <div class="flex justify-between items-center mt-auto pt-4 border-t"><span class="font-bold text-lg text-slate-700">{{ formatPrice(ag.prix) }} <span class="text-[10px] text-gray-400 uppercase">{{ ag.tva ? 'TTC' : 'HT' }}</span></span><span :class="ag.statut_activite==='pause'?'bg-red-100 text-red-600':'bg-green-100 text-green-600'" class="px-2 py-1 rounded text-xs font-bold uppercase">{{ ag.statut_activite === 'pause' ? 'Pause' : 'Actif' }}</span></div>
                        </div>
                    </div>
                </div>

                <div v-if="settingsModal.tab==='Admins'" class="space-y-4 md:space-y-6">
                    <div class="bg-gradient-to-br from-slate-50 to-purple-50 p-4 md:p-6 rounded-xl md:rounded-2xl border-2 border-slate-200 shadow-sm">
                        <h3 class="font-bold text-base md:text-lg mb-4 text-slate-700 flex items-center gap-2">
                            <i class="fa-solid fa-crown text-purple-600"></i>
                            <span>Configuration Globale</span>
                        </h3>
                       <div class="mb-6 border p-4 rounded-xl bg-slate-50 flex items-center gap-4">
    <div class="w-16 h-16 bg-white border-2 border-slate-200 rounded-xl flex items-center justify-center overflow-hidden flex-shrink-0 shadow-sm">
        <img v-if="globalSettings.appLogoUrl" :src="globalSettings.appLogoUrl" class="w-full h-full object-cover">
        <i v-else class="fa-solid fa-image text-slate-300 text-2xl"></i>
    </div>
    
    <div class="flex-1">
        <label class="text-xs font-bold text-gray-500 uppercase block mb-1">Lien du Logo (URL)</label>
        <div class="flex gap-2">
            <input v-model="globalSettings.appLogoUrl" placeholder="https://..." class="flex-1 p-2 border rounded-lg font-bold text-slate-700 outline-none focus:border-blue-500 bg-white transition">
            <button @click="saveGlobalSettings" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-xs hover:bg-blue-700 transition shadow-md flex items-center gap-2 flex-shrink-0 active:scale-95">
                <i class="fa-solid fa-floppy-disk"></i> Sauvegarder
            </button>
        </div>
        <p class="text-[10px] text-gray-400 mt-1">Collez l'adresse de votre image (clic droit > copier l'adresse de l'image) et validez.</p>
    </div>
</div>
                        <!-- CONFIG NOTIF HEURE -->
                        <div class="mb-6 flex flex-col gap-4 border p-4 rounded-xl bg-slate-50">
                            <!-- RAPPEL JOUR J -->
                            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                <div>
                                    <label class="text-xs font-bold text-gray-500 uppercase block mb-1">Heure d√©but notifications Rappels (Jour J)</label>
                                    <p class="text-xs text-gray-400">Avant cette heure, pas d'alerte pour les RDV d'aujourd'hui.</p>
                                </div>
                                <input type="time" v-model="globalSettings.reminderStartTime" class="p-2 border rounded-lg font-bold text-slate-700 bg-white shadow-sm w-32">
                            </div>
                            
                            <!-- RAPPEL VEILLE (NOUVEAU) -->
                            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 border-t border-slate-200 pt-4">
                                <div>
                                    <label class="text-xs font-bold text-gray-500 uppercase block mb-1">Heure d√©but notifications Rappels (Veille)</label>
                                    <p class="text-xs text-gray-400">Avant cette heure, pas d'alerte pour les RDV de demain.</p>
                                </div>
                                <input type="time" v-model="globalSettings.reminderEveTime" class="p-2 border rounded-lg font-bold text-slate-700 bg-white shadow-sm w-32">
                            </div>

                            <button @click="saveGlobalSettings" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-xs hover:bg-blue-700 transition self-end mt-2">Sauvegarder</button>
                        </div>

                        <h3 class="font-bold text-lg mb-4 text-slate-700">G√©rer les Noms d'Administrateurs</h3>
                        <div class="flex gap-2 mb-6">
                            <input v-model="newAdminName" placeholder="Nouveau pr√©nom (ex: Charl√®ne)" class="flex-1 p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50">
                            <button @click="addAdminName" class="bg-blue-600 text-white px-6 rounded-xl font-bold hover:bg-blue-700">Ajouter</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div v-for="name in adminNamesList" :key="name" class="flex items-center justify-between p-3 border rounded-xl bg-white hover:border-blue-300 transition group">
                                <span class="font-bold text-slate-700 ml-2">{{ name }}</span>
                                <button @click="removeAdminName(name)" class="text-gray-300 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div v-if="settingsModal.tab==='Messages'" class="flex flex-col lg:grid lg:grid-cols-3 gap-4 md:gap-6">
                    <div class="lg:col-span-1 border-r lg:pr-6 space-y-4 overflow-y-auto max-h-[200px] lg:max-h-full">
                        <h3 class="font-bold text-gray-500 uppercase text-xs tracking-wider mb-2">1. Choisir l'Agence</h3>
                        <div class="space-y-2"><button v-for="ag in agences" @click="editingMsgAgence = ag" :class="editingMsgAgence?.id === ag.id ? 'bg-blue-600 text-white shadow-md' : 'bg-white hover:bg-slate-100 text-slate-700'" class="w-full text-left px-4 py-3 rounded-xl font-bold transition text-sm flex items-center justify-between"><span>{{ ag.nom }}</span><i v-if="editingMsgAgence?.id === ag.id" class="fa-solid fa-chevron-right"></i></button></div>
                        <h3 class="font-bold text-gray-500 uppercase text-xs tracking-wider mt-6 mb-2">2. Type de Message</h3>
                        <div class="space-y-2"><button v-for="(label, key) in msgLabels" :key="key" @click="editingMsgType = key" :class="editingMsgType === key ? 'bg-slate-800 text-white shadow-md' : 'bg-white border hover:bg-slate-50 text-slate-600'" class="w-full text-left px-4 py-2 rounded-lg font-bold transition text-xs flex justify-between"><span>{{ label }}</span></button></div>
                    </div>
                    <div class="lg:col-span-2 flex flex-col h-full overflow-y-auto">
                        <div v-if="editingMsgAgence" class="flex-1 flex flex-col">
                            <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg text-blue-900 leading-tight">√âditer : {{ msgLabels[editingMsgType] }} <span class="text-gray-400 text-sm font-normal block md:inline">({{ editingMsgAgence.nom }})</span></h3><button @click="saveAgency(editingMsgAgence)" class="bg-green-500 hover:bg-green-600 text-white px-4 md:px-6 py-2 rounded-lg font-bold transition shadow-md text-sm">Enregistrer</button></div>
                            <div class="flex flex-wrap gap-2 mb-2 p-3 bg-slate-100 rounded-xl border border-slate-200"><button v-for="tag in ['{{NOM}}','{{DATE_LONG}}','{{HEURE}}','{{AGENCE}}','{{ADRESSE}}','{{PRIX}}','{{PLAN}}']" @click="insertTag(tag)" class="bg-white border border-slate-300 text-slate-600 px-2 py-1 rounded text-[10px] font-bold hover:bg-blue-50 hover:border-blue-300 transition">{{ tag }}</button></div>
                            <textarea :value="editingMsgAgence.templates?.[editingMsgType] || getDefaultTemplate(editingMsgType)" @input="e => { if(!editingMsgAgence.templates) editingMsgAgence.templates={}; editingMsgAgence.templates[editingMsgType] = e.target.value }" class="w-full flex-1 p-4 border-2 border-slate-200 rounded-2xl outline-none focus:border-blue-500 font-medium text-slate-700 leading-relaxed resize-none bg-slate-50 focus:bg-white transition min-h-[200px]"></textarea>
                        </div>
                        <div v-else class="flex-1 flex items-center justify-center text-center text-gray-400 border-2 border-dashed border-gray-200 rounded-2xl p-8">S√©lectionnez une agence.</div>
                    </div>
                </div>

                <div v-if="settingsModal.tab==='Sources'" class="space-y-4 md:space-y-6">
                    <div class="bg-slate-50 p-4 md:p-6 rounded-xl md:rounded-2xl border border-slate-200">
                        <h3 class="font-bold text-base md:text-lg mb-4 text-slate-700">G√©rer les Sources</h3>
                        <div class="flex gap-2 mb-6"><input v-model="newSource" placeholder="Nouvelle source..." class="flex-1 p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50"><button @click="addSource" class="bg-blue-600 text-white px-6 rounded-xl font-bold hover:bg-blue-700">Ajouter</button></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div v-for="src in sourcesList" :key="src" class="flex items-center justify-between p-3 border rounded-xl bg-white hover:border-blue-300 transition group"><div class="flex items-center gap-3"><img :src="getLogo(src)" class="w-6 h-6 rounded bg-gray-50 object-contain cursor-pointer hover:opacity-80" @click="changeSourceLogo(src)" title="Changer le logo"><span class="font-bold text-slate-700">{{ src }}</span></div><button @click="removeSource(src)" class="text-gray-300 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button></div>
                        </div>
                    </div>
                </div>

                <div v-if="settingsModal.tab==='Motifs'" class="space-y-4 md:space-y-6">
                    <div class="bg-slate-50 p-4 md:p-6 rounded-xl md:rounded-2xl border border-slate-200">
                        <h3 class="font-bold text-base md:text-lg mb-4 text-slate-700 flex items-center gap-2">
                            <i class="fa-solid fa-tag text-blue-600"></i>
                            G√©rer les Motifs de Rendez-vous
                        </h3>
                        <p class="text-xs text-slate-500 mb-4">Ces motifs appara√Ætront dans la liste d√©roulante lors de la cr√©ation d'un rendez-vous. Les utilisateurs peuvent √©galement saisir un motif personnalis√©.</p>
                        <div class="flex gap-2 mb-6">
                            <input v-model="newMotif" placeholder="Nouveau motif (ex: Essai, Achat, R√©vision...)" class="flex-1 p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50">
                            <button @click="addMotif" class="bg-blue-600 text-white px-6 rounded-xl font-bold hover:bg-blue-700">Ajouter</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div v-for="motif in motifsList" :key="motif" class="flex items-center justify-between p-3 border rounded-xl bg-white hover:border-blue-300 transition group">
                                <div class="flex items-center gap-3">
                                    <i class="fa-solid fa-tag text-blue-500"></i>
                                    <span class="font-bold text-slate-700">{{ motif }}</span>
                                </div>
                                <button @click="removeMotif(motif)" class="text-gray-300 hover:text-red-500 transition">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ONGLET GOOGLE CALENDAR (ADMIN UNIQUEMENT) -->
                <div v-if="settingsModal.tab==='GoogleCalendar' && user.role==='admin'" class="space-y-4 md:space-y-6">
                    <div class="bg-gradient-to-br from-purple-50 to-blue-50 rounded-2xl p-6 md:p-8 border-2 border-purple-200">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-4">
                                <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-lg">
                                    <i class="fa-brands fa-google text-4xl text-purple-600"></i>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold text-slate-800">Connexion Google Calendar</h3>
                                    <p class="text-sm text-slate-600">Connectez-vous pour synchroniser automatiquement les rendez-vous</p>
                                </div>
                            </div>
                        </div>

                        <!-- Param√®tre de connexion obligatoire (toujours affich√©) -->
                        <div class="bg-white rounded-xl p-6 border-2 border-blue-200 mb-4">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <h4 class="font-bold text-slate-800 mb-1 flex items-center gap-2">
                                        <i class="fa-solid fa-lock text-blue-500"></i>
                                        Connexion obligatoire pour cr√©er un rendez-vous
                                    </h4>
                                    <p class="text-sm text-slate-600">
                                        Si activ√©, les utilisateurs devront se connecter √† Google Calendar avant de pouvoir cr√©er un rendez-vous.
                                    </p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer ml-4">
                                    <input type="checkbox" v-model="googleCalendarRequired" @change="saveGoogleCalendarRequired" class="sr-only peer">
                                    <div class="w-14 h-7 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                        </div>

                        <!-- V√©rification en cours -->
                        <div v-if="googleCalendarConnected && checkingToken" class="bg-white rounded-xl p-6 border-2 border-blue-300">
                            <div class="flex items-center justify-center gap-3 py-4">
                                <i class="fa-solid fa-spinner fa-spin text-blue-500 text-xl"></i>
                                <p class="text-sm text-slate-600 font-medium">V√©rification du token en cours...</p>
                            </div>
                        </div>

                        <!-- √âtat connect√© avec token valide -->
                        <div v-else-if="googleCalendarConnected && googleCalendarTokenValid" class="bg-white rounded-xl p-6 border-2 border-green-300">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center shadow-lg flex-shrink-0">
                                        <i class="fa-solid fa-check text-xl text-white"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-slate-800 text-base flex items-center gap-2">
                                            Connect√© √† Google Calendar
                                            <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full font-bold">Token valide</span>
                                        </h4>
                                        <p class="text-sm text-slate-600">{{ googleCalendarUserEmail }}</p>
                                    </div>
                                </div>
                                <button @click="disconnectGoogleCalendar" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-xl font-bold transition shadow-lg flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-sign-out-alt"></i>
                                    <span>Se d√©connecter</span>
                                </button>
                            </div>
                            <div class="bg-green-50 rounded-lg p-4 border border-green-200 mt-4">
                                <p class="text-sm text-green-700 font-medium mb-2">
                                    <i class="fa-solid fa-check-circle mr-2"></i>
                                    Les rendez-vous sont automatiquement ajout√©s √† Google Calendar lors de leur validation.
                                </p>
                                <p v-if="tokenTimeRemaining" class="text-xs text-green-600 font-bold flex items-center gap-2">
                                    <i class="fa-solid fa-clock"></i>
                                    Token valide encore : {{ tokenTimeRemaining.minutes }}min {{ tokenTimeRemaining.seconds }}s
                                </p>
                            </div>
                        </div>

                        <!-- √âtat connect√© mais token invalide/expir√© -->
                        <div v-else-if="googleCalendarConnected && !googleCalendarTokenValid" class="bg-white rounded-xl p-6 border-2 border-orange-300">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 bg-orange-500 rounded-full flex items-center justify-center shadow-lg flex-shrink-0">
                                        <i class="fa-solid fa-exclamation-triangle text-xl text-white"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-slate-800 text-base flex items-center gap-2">
                                            Connect√© mais token invalide
                                            <span class="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded-full font-bold animate-pulse">Expir√©</span>
                                        </h4>
                                        <p class="text-sm text-slate-600">{{ googleCalendarUserEmail }}</p>
                                    </div>
                                </div>
                                <button @click="disconnectGoogleCalendar" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-xl font-bold transition shadow-lg flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-sign-out-alt"></i>
                                    <span>Se d√©connecter</span>
                                </button>
                            </div>
                            <div class="bg-orange-50 rounded-lg p-4 border border-orange-200 mb-4">
                                <p class="text-sm text-orange-800 font-bold mb-2 flex items-center gap-2">
                                    <i class="fa-solid fa-exclamation-triangle"></i>
                                    Attention : Votre session a expir√©
                                </p>
                                <p class="text-sm text-orange-700">
                                    Le token d'authentification n'est plus valide. Vous devez vous reconnecter pour que les rendez-vous soient ajout√©s √† l'agenda.
                                </p>
                            </div>
                            <button @click="connectGoogleCalendar" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-xl font-bold transition shadow-lg flex items-center justify-center gap-2">
                                <i class="fa-brands fa-google"></i>
                                <span>Se reconnecter √† Google Calendar</span>
                            </button>
                            <p v-if="tokenTimeRemaining" class="text-xs text-orange-600 font-bold text-center mt-2 flex items-center justify-center gap-2">
                                <i class="fa-solid fa-clock"></i>
                                Expiration dans : {{ tokenTimeRemaining.minutes }}min {{ tokenTimeRemaining.seconds }}s
                            </p>
                        </div>
                        
                        <!-- √âtat non connect√© -->
                        <div v-else-if="!googleCalendarConnected" class="bg-white rounded-xl p-6 border border-slate-200">
                            <div class="text-center py-4">
                                <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fa-brands fa-google text-3xl text-slate-400"></i>
                                </div>
                                <h4 class="text-lg font-bold text-slate-800 mb-2">Non connect√©</h4>
                                <p class="text-sm text-slate-600 mb-6">Connectez-vous pour synchroniser automatiquement les rendez-vous avec Google Calendar</p>
                                <button @click="connectGoogleCalendar" class="bg-blue-500 hover:bg-blue-600 text-white px-8 py-3 rounded-xl font-bold transition shadow-lg flex items-center justify-center gap-2 mx-auto">
                                    <i class="fa-brands fa-google"></i>
                                    <span>Se connecter</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            
        </div>
    </div>
    
    <!-- BULK MODAL Z-INDEX FIX -->
    <div v-if="bulkModal.open" class="fixed inset-0 bg-slate-900/60 z-[400] flex items-center justify-center p-4 ">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm text-center pop-in border border-slate-200">
            <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl" 
                 :class="bulkModal.action.includes('delete') || bulkModal.action.includes('trash') ? 'bg-red-100 text-red-500' : 'bg-blue-100 text-blue-600'">
                <i class="fa-solid text-3xl" :class="bulkModal.action.includes('delete') || bulkModal.action.includes('trash') ? 'fa-trash-can' : 'fa-circle-question'"></i>
            </div>
            <h3 class="font-bold text-2xl mb-3 text-slate-800">√ätes-vous s√ªr ?</h3>
            <p class="text-slate-600 mb-8 font-medium text-lg leading-relaxed">{{ bulkModal.label }}</p>
            <div class="grid grid-cols-2 gap-4">
                <button @click="bulkModal.open=false" class="bg-slate-100 text-slate-600 py-3 rounded-xl font-bold hover:bg-slate-200 transition text-sm">Non, annuler</button>
                <button @click="executeBulkAction" 
                        :class="bulkModal.action.includes('delete') || bulkModal.action.includes('trash') ? 'bg-red-600 hover:bg-red-700 shadow-red-200' : 'bg-blue-600 hover:bg-blue-700 shadow-blue-200'"
                        class="text-white py-3 rounded-xl font-bold transition shadow-lg transform active:scale-95 text-sm">
                    Oui, confirmer
                </button>
            </div>
        </div>
    </div>
    
    <!-- EDITING AGENCY Z-INDEX FIX -->
    <div v-if="editingAgency" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4 "><div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl p-6 fade-in max-h-[90vh] overflow-y-auto"><h3 class="font-bold text-xl mb-6 text-slate-800">{{ editingAgency.id ? 'Modifier' : 'Nouvelle' }} Agence</h3><div class="space-y-4"><div><label class="text-xs font-bold text-gray-500 uppercase">Nom</label><input v-model="editingAgency.nom" class="w-full p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50 font-bold"></div><div><label class="text-xs font-bold text-gray-500 uppercase">Adresse Postale</label><input v-model="editingAgency.adresse" class="w-full p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50"></div><div><label class="text-xs font-bold text-gray-500 uppercase">Lien Google Maps (Short)</label><input v-model="editingAgency.maps" class="w-full p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50 text-blue-600"></div><div><label class="text-xs font-bold text-gray-500 uppercase">Phrase d'accroche (SMS)</label><input v-model="editingAgency.tagline" placeholder="Ex: votre expert rachat" class="w-full p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50"></div><div><label class="text-xs font-bold text-gray-500 uppercase">Agenda Google (Email)</label><input v-model="editingAgency.agendaEmail" type="email" placeholder="exemple@gmail.com" class="w-full p-3 border rounded-xl outline-none focus:border-purple-500 bg-slate-50 font-mono text-sm"><p class="text-[10px] text-gray-400 mt-1">Entrez l'adresse email de la personne qui partage son agenda Google avec vous. Si vide, l'agenda principal sera utilis√© par d√©faut.</p></div><div><label class="text-xs font-bold text-gray-500 uppercase mb-2 block">Couleur de l'√©v√©nement</label><div class="grid grid-cols-6 gap-2"><div v-for="(color, id) in {1:'Lavande',2:'Sauge',3:'Raisin',4:'Flamant',5:'Banane',6:'Mandarine',7:'Paon',8:'Graphite',9:'Myrtille',10:'Basilic',11:'Tomate'}" :key="id" @click="editingAgency.agendaColor = String(id)" :class="String(editingAgency.agendaColor) === String(id) ? 'ring-2 ring-purple-500 ring-offset-2' : ''" class="cursor-pointer rounded-lg p-2 border-2 transition hover:scale-110" :style="{backgroundColor: getCalendarColor(Number(id))}"><div class="w-full h-8 rounded" :style="{backgroundColor: getCalendarColor(Number(id))}"></div><p class="text-[8px] text-center mt-1 font-bold text-slate-600">{{ color }}</p></div></div><p class="text-[10px] text-gray-400 mt-2">Choisissez la couleur des √©v√©nements dans Google Calendar</p></div><div class="pt-4 border-t"><label class="text-xs font-bold text-gray-500 uppercase mb-2 block">Horaires d'ouverture</label><div class="grid grid-cols-2 gap-3"><div><label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Heure d'ouverture</label><input type="time" v-model="editingAgency.heureOuverture" class="w-full p-2 border border-slate-200 rounded-lg bg-white text-sm font-bold"></div><div><label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Heure de fermeture</label><input type="time" v-model="editingAgency.heureFermeture" class="w-full p-2 border border-slate-200 rounded-lg bg-white text-sm font-bold"></div></div><p class="text-[10px] text-gray-400 mt-2">Horaires par d√©faut pour toute la semaine</p></div><div v-if="user.role==='admin'" class="pt-4 border-t"><div class="mb-4"><label class="flex items-center gap-2 font-bold text-slate-700 cursor-pointer"><input type="checkbox" v-model="editingAgency.horairesIdentiques" class="custom-checkbox" @change="applyHorairesToAllDays"> <span>M√™me horaire pour tous les jours</span></label></div><div class="mb-4"><label class="flex items-center gap-2 font-bold text-slate-700 cursor-pointer"><input type="checkbox" v-model="editingAgency.dimancheFerme" class="custom-checkbox"> <span>Dimanche ferm√©</span></label></div><label class="text-xs font-bold text-gray-500 uppercase mb-3 block">Horaires par jour (optionnel)</label><p class="text-[10px] text-gray-400 mb-3">Laissez vide pour utiliser les horaires par d√©faut</p><div class="space-y-2"><div v-for="(dayName, dayIndex) in ['Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi','Dimanche']" :key="dayIndex" :class="{'opacity-50': dayIndex === 6 && editingAgency.dimancheFerme}" class="grid grid-cols-4 gap-2 items-center p-2 rounded-lg" :style="dayIndex === 6 && editingAgency.dimancheFerme ? 'background: #fee2e2;' : ''"><div class="text-xs font-bold text-slate-600 col-span-1">{{ dayName }}</div><div class="col-span-3 grid grid-cols-2 gap-2"><input type="time" :v-model="`editingAgency.horaires_${dayIndex}_ouverture`" @input="editingAgency[`horaires_${dayIndex}_ouverture`] = $event.target.value" :value="editingAgency[`horaires_${dayIndex}_ouverture`] || ''" :disabled="dayIndex === 6 && editingAgency.dimancheFerme" placeholder="Ouverture" class="w-full p-2 border border-slate-200 rounded-lg bg-white text-xs font-bold"><input type="time" :v-model="`editingAgency.horaires_${dayIndex}_fermeture`" @input="editingAgency[`horaires_${dayIndex}_fermeture`] = $event.target.value" :value="editingAgency[`horaires_${dayIndex}_fermeture`] || ''" :disabled="dayIndex === 6 && editingAgency.dimancheFerme" placeholder="Fermeture" class="w-full p-2 border border-slate-200 rounded-lg bg-white text-xs font-bold"></div></div></div></div><div v-if="editingAgency.heureOuverture && editingAgency.heureFermeture" class="pt-2"><label class="text-xs font-bold text-gray-500 uppercase mb-2 block">Pause d√©jeuner (optionnel)</label><div class="grid grid-cols-2 gap-3"><div><label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">D√©but pause</label><input type="time" v-model="editingAgency.heurePauseDebut" class="w-full p-2 border border-slate-200 rounded-lg bg-white text-sm font-bold"></div><div><label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Fin pause</label><input type="time" v-model="editingAgency.heurePauseFin" class="w-full p-2 border border-slate-200 rounded-lg bg-white text-sm font-bold"></div></div></div><div class="grid grid-cols-2 gap-4"><div><label class="text-xs font-bold text-gray-500 uppercase">Prix HT (‚Ç¨)</label><input type="number" v-model="editingAgency.prix_ht" @input="calculateTTC" class="w-full p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50"></div><div><label class="text-xs font-bold text-gray-500 uppercase">TVA (%)</label><input type="number" v-model="editingAgency.tva_taux" @input="calculateTTC" placeholder="20" class="w-full p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50"></div></div><div class="flex items-center justify-between p-3 bg-slate-100 rounded-xl"><span class="font-bold text-slate-700">Prix Affich√© (TTC)</span><span class="text-xl font-black text-blue-600">{{ formatPrice(editingAgency.prix) }}</span></div><div><label class="flex items-center gap-2 font-bold text-slate-700 cursor-pointer"><input type="checkbox" v-model="editingAgency.tva" class="custom-checkbox"> <span>Afficher "TTC" dans les SMS</span></label></div><div class="pt-4 border-t"><label class="text-xs font-bold text-gray-500 uppercase mb-2 block">√âtat de l'agence</label><div class="flex gap-2"><button @click="editingAgency.statut_activite='actif'" :class="editingAgency.statut_activite==='actif' ? 'bg-green-500 text-white shadow-md' : 'bg-slate-100 text-slate-500'" class="flex-1 py-2 rounded-xl font-bold transition">Actif</button><button @click="editingAgency.statut_activite='pause'" :class="editingAgency.statut_activite==='pause' ? 'bg-red-500 text-white shadow-md' : 'bg-slate-100 text-slate-500'" class="flex-1 py-2 rounded-xl font-bold transition">En Pause</button></div></div><div v-if="editingAgency.statut_activite==='pause'" class="space-y-3 bg-red-50 p-4 rounded-xl border border-red-100 animate-fadeIn"><div><label class="text-xs font-bold text-red-500 uppercase">Motif de la pause</label><select v-model="pauseReasonSelect" @change="updatePauseReason" class="w-full p-2 border border-red-200 rounded-lg outline-none bg-white font-bold text-slate-700 mt-1"><option value="Vacances">Vacances</option><option value="Complet">Complet / Surcharg√©</option><option value="Travaux">Travaux</option><option value="Autre">Autre (personnalis√©)</option></select><input v-if="pauseReasonSelect==='Autre'" v-model="editingAgency.motif_pause" placeholder="Pr√©cisez le motif..." class="w-full mt-2 p-2 border border-red-200 rounded-lg outline-none bg-white"></div><div v-if="pauseReasonSelect==='Vacances'" class="grid grid-cols-2 gap-2"><div><label class="text-[10px] font-bold text-red-400 uppercase">D√©but</label><input type="date" v-model="editingAgency.date_pause_debut" class="w-full p-2 border border-red-200 rounded-lg bg-white text-sm"></div><div><label class="text-[10px] font-bold text-red-400 uppercase">Fin (inclus)</label><input type="date" v-model="editingAgency.date_pause_fin" class="w-full p-2 border border-red-200 rounded-lg bg-white text-sm"></div></div></div></div><div class="flex gap-4 mt-6"><button @click="editingAgency=null" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-300">Annuler</button><button @click="saveEditingAgency" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700">Enregistrer</button></div></div></div>
    <!-- WIZARD Z-INDEX FIX -->
    <div v-if="wizard.open" class="fixed inset-0 bg-slate-100 z-[500] flex flex-col h-screen overflow-hidden">
        
        <div class="bg-white p-4 shadow-sm border-b border-slate-200 sticky top-0 z-[510] flex justify-between items-center flex-shrink-0">
            <h3 class="font-bold text-xl text-slate-800 flex items-center gap-3">
                <span class="bg-blue-600 text-white w-8 h-8 rounded-lg flex items-center justify-center text-sm font-black">{{ wizard.step }} / 6</span>
                <span>Nouveau RDV</span>
            </h3>
            <button @click="wizard.open=false" class="bg-slate-50 hover:bg-red-50 text-slate-500 hover:text-red-500 font-bold px-4 py-2 rounded-xl transition flex items-center gap-2 border border-slate-200">
                <i class="fa-solid fa-xmark"></i> <span class="hidden md:inline">Fermer</span>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 flex items-start justify-center">
            <div class="w-full max-w-lg bg-white rounded-3xl shadow-xl border border-slate-200 overflow-hidden fade-in my-auto">
                
                <div class="p-6 md:p-10 space-y-6">

                    <div v-if="wizard.step===1">
                        <h4 class="text-center font-black text-2xl mb-2 text-slate-800">Choisir l'Agence</h4>
                        <p class="text-center text-slate-400 text-sm mb-6">O√π aura lieu le rendez-vous ?</p>
                        
                        <div class="relative mb-4">
                            <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <input v-model="agencySearch" placeholder="Rechercher..." class="w-full pl-12 p-4 border-2 border-slate-200 rounded-2xl font-bold outline-none focus:border-blue-500 transition">
                        </div>

                        <div class="space-y-3 max-h-[50vh] overflow-y-auto pr-1">
                            <button v-for="ag in filteredAgences" :key="ag.id" @click="checkAgenceAndProceed(ag)" :class="ag.statut_activite==='pause' ? 'border-red-200 bg-red-50 opacity-80' : 'border-slate-200 hover:border-blue-500 hover:bg-blue-50'" class="w-full p-5 border-2 rounded-2xl text-left transition group relative flex flex-col justify-center">
                                <div class="font-bold text-lg text-slate-800 group-hover:text-blue-600 mb-1">{{ ag.nom }}</div>
                                <div class="text-xs text-gray-500 truncate">{{ ag.adresse }}</div>
                                <div v-if="ag.statut_activite==='pause'" class="absolute top-1/2 -translate-y-1/2 right-4 text-red-500 font-black text-xs border border-red-200 bg-white px-2 py-1 rounded">PAUSE</div>
                                <i v-else class="fa-solid fa-chevron-right absolute top-1/2 -translate-y-1/2 right-4 text-slate-300 group-hover:text-blue-500"></i>
                            </button>
                            <div v-if="filteredAgences.length === 0" class="text-center text-gray-400 py-4 italic">Aucune agence trouv√©e.</div>
                        </div>
                    </div>

                    <div v-if="wizard.step===2">
                        <h4 class="text-center font-black text-2xl mb-8 text-slate-800">Informations Client</h4>
                        
                        <div class="flex gap-4 mb-6">
                            <button @click="form.civilite='M.'" :class="form.civilite==='M.'?'bg-blue-600 text-white shadow-lg scale-105':'bg-slate-100 text-slate-500 hover:bg-slate-200'" class="flex-1 py-3 rounded-xl font-bold transition transform">Monsieur</button>
                            <button @click="form.civilite='Mme'" :class="form.civilite==='Mme'?'bg-pink-500 text-white shadow-lg scale-105':'bg-slate-100 text-slate-500 hover:bg-slate-200'" class="flex-1 py-3 rounded-xl font-bold transition transform">Madame</button>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-1 ml-1">Nom Complet</label>
                                <input v-model="form.nom" placeholder="Ex: Dupont Jean" class="w-full text-lg font-bold border-2 border-slate-200 rounded-2xl p-4 outline-none focus:border-blue-500 bg-slate-50 focus:bg-white transition">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-1 ml-1">T√©l√©phone</label>
                                <div class="relative">
                                    <input type="tel" :value="form.telephone" @input="onWizardPhoneInput" :disabled="form.pasDeNumero" placeholder="06 12 34 56 78" class="w-full text-lg font-mono font-bold border-2 border-slate-200 rounded-2xl p-4 outline-none focus:border-blue-500 tracking-widest bg-slate-50 focus:bg-white transition text-center disabled:opacity-50 disabled:cursor-not-allowed">
                                    <button @click="pastePhoneNumber" :disabled="form.pasDeNumero" class="absolute right-3 top-1/2 -translate-y-1/2 text-blue-600 hover:text-blue-800 bg-blue-100 p-2 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed" title="Coller"><i class="fa-solid fa-paste"></i></button>
                                </div>
                                <label class="flex items-center gap-2 mt-3 cursor-pointer">
                                    <input type="checkbox" v-model="form.pasDeNumero" class="w-4 h-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500">
                                    <span class="text-sm text-slate-600 font-medium">Cette personne n'a pas de num√©ro de t√©l√©phone</span>
                                </label>
                            </div>
                        </div>

                        <p v-if="clientExists" class="text-green-600 text-sm text-center mt-4 font-bold animate-pulse bg-green-50 p-2 rounded-xl border border-green-100">‚ú® Client existant d√©tect√© !</p>

                        <div class="flex gap-3 mt-8 pt-4 border-t border-slate-100">
                            <button @click="wizard.step--" class="px-6 bg-slate-100 text-slate-500 rounded-xl font-bold hover:bg-slate-200">Retour</button>
                            <button @click="wizard.step++" :disabled="!form.nom || (!form.pasDeNumero && normalizePhone(form.telephone).length<10)" class="flex-1 bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-blue-700 disabled:opacity-50 disabled:shadow-none transition transform active:scale-95">Suivant</button>
                        </div>
                    </div>

                    <div v-if="wizard.step===3">
                        <h4 class="text-center font-black text-2xl mb-8 text-slate-800">Date & Heure</h4>
                        
                        <div class="mb-8">
                            <div class="flex items-center justify-between mb-4">
                                <label class="text-xs font-bold text-slate-400 uppercase tracking-widest ml-1">Le Jour</label>
                                <input type="date" v-model="form.date" @change="form.heure=null" class="bg-slate-50 border-none rounded-lg text-sm font-bold text-slate-600 outline-none focus:text-blue-600 cursor-pointer">
                            </div>
                            
                            <div class="flex overflow-x-auto gap-3 pb-2 snap-x hide-scrollbar">
                                <button v-for="d in dateOptions" :key="d.val" @click="form.date=d.val; form.heure=null" 
                                    :class="form.date===d.val ? 'bg-slate-800 text-white shadow-lg scale-105' : 'bg-white border border-slate-200 text-slate-500 hover:border-slate-400'" 
                                    class="flex-shrink-0 w-16 h-20 rounded-2xl flex flex-col items-center justify-center transition-all duration-300 snap-center group">
                                    <span class="text-[10px] font-bold uppercase mb-1 opacity-70">{{ d.dayName }}</span>
                                    <span class="text-2xl font-black leading-none">{{ d.dayNum }}</span>
                                    <span v-if="d.isToday" class="mt-1 w-1 h-1 rounded-full bg-blue-500"></span>
                                </button>
                            </div>
                        </div>

                        <div v-if="form.date" class="animate-fadeIn">
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-widest ml-1 mb-3 block">L'Heure</label>
                            
                            <div class="flex flex-wrap gap-2 justify-center">
                                <button v-for="h in timeSlots" :key="h" 
                                    @click="form.heure=h; wizard.step++" 
                                    class="px-4 py-2 rounded-full border border-slate-200 text-slate-600 font-bold text-sm hover:bg-slate-800 hover:text-white hover:border-slate-800 hover:shadow-lg transition transform active:scale-95">
                                    {{ h }}
                                </button>
                            </div>

                            <div class="mt-8 flex justify-center border-t border-slate-100 pt-6">
                                <div class="relative group">
                                    <input type="time" v-model="form.heure" class="pl-10 pr-4 py-2 bg-slate-50 rounded-xl text-sm font-bold text-slate-500 border border-transparent hover:bg-white hover:border-slate-200 focus:bg-white focus:border-blue-500 focus:text-blue-600 outline-none transition text-center shadow-inner">
                                    <i class="fa-regular fa-clock absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div v-else class="text-center p-8 text-slate-300 text-sm italic font-medium bg-slate-50 rounded-2xl border border-dashed border-slate-200">
                            üëÜ S√©lectionnez une date ci-dessus
                        </div>

                        <div class="flex gap-3 mt-8 pt-6 border-t border-slate-100">
                            <button @click="wizard.step--" class="px-6 bg-white border border-slate-200 text-slate-500 rounded-xl font-bold hover:bg-slate-50 transition text-sm">Retour</button>
                            <button v-if="form.heure" @click="wizard.step++" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition text-sm">Suivant <i class="fa-solid fa-arrow-right ml-2"></i></button>
                        </div>
                    </div>

                    <div v-if="wizard.step===4">
                        <h4 class="text-center font-black text-2xl mb-8 text-slate-800">V√©hicule</h4>
                        
                        <div class="w-full relative group mb-4">
                            <i class="fa-solid fa-car absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-xl group-focus-within:text-blue-500 transition"></i>
                            <input v-model="form.modele" placeholder="Marque, Mod√®le, Finition..." class="w-full pl-12 p-5 text-lg border-2 border-slate-200 rounded-2xl outline-none focus:border-blue-600 transition bg-slate-50 focus:bg-white font-bold text-slate-700 shadow-sm">
                        </div>
                        <p class="text-center text-xs text-slate-400 mb-4">Saisissez le v√©hicule manuellement.</p>

                        <div class="w-full relative group mb-4">
                            <i class="fa-solid fa-link absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-lg group-focus-within:text-blue-500 transition"></i>
                            <input v-model="form.lienAnnonce" type="url" placeholder="Lien de l'annonce (facultatif)" class="w-full pl-12 p-4 text-sm border-2 border-slate-200 rounded-2xl outline-none focus:border-blue-600 transition bg-slate-50 focus:bg-white font-medium text-slate-700 shadow-sm">
                        </div>
                        <p class="text-center text-xs text-slate-400 mb-4">Vous pouvez coller le lien de l'annonce du v√©hicule</p>

                        <div class="w-full relative group mb-2">
                            <i class="fa-solid fa-tag absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-lg group-focus-within:text-blue-500 transition z-10"></i>
                            <select v-model="form.motif" class="w-full pl-12 pr-10 p-4 text-sm border-2 border-slate-200 rounded-2xl outline-none focus:border-blue-600 transition bg-slate-50 focus:bg-white font-medium text-slate-700 shadow-sm appearance-none">
                                <option value="">S√©lectionner un motif (facultatif)</option>
                                <option v-for="motif in motifsList" :key="motif" :value="motif">{{ motif }}</option>
                                <option value="__CUSTOM__">Autre (saisie libre)</option>
                            </select>
                            <i class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                        </div>
                        <div v-if="form.motif === '__CUSTOM__'" class="w-full relative group mb-2">
                            <i class="fa-solid fa-pen absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-lg group-focus-within:text-blue-500 transition"></i>
                            <input v-model="form.motifCustom" placeholder="Pr√©cisez le motif..." class="w-full pl-12 p-4 text-sm border-2 border-slate-200 rounded-2xl outline-none focus:border-blue-600 transition bg-slate-50 focus:bg-white font-medium text-slate-700 shadow-sm">
                        </div>

                        <div class="flex gap-3 mt-12 pt-4 border-t border-slate-100">
                            <button @click="wizard.step--" class="px-6 bg-slate-100 text-slate-500 rounded-xl font-bold hover:bg-slate-200">Retour</button>
                            <button @click="wizard.step++" :disabled="!form.modele" class="flex-1 bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-blue-700 disabled:opacity-50 disabled:shadow-none transition transform active:scale-95">Suivant</button>
                        </div>
                    </div>

                    <div v-if="wizard.step===5">
                        <h4 class="text-center font-black text-2xl mb-8 text-slate-800">Source du RDV</h4>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <button v-for="src in sourcesList" @click="selectSource(src)" :class="form.source === src ? 'border-blue-500 bg-blue-50 ring-2 ring-blue-200 shadow-md' : 'border-slate-200 bg-white hover:border-blue-300 hover:bg-slate-50'" class="p-6 rounded-2xl border-2 flex flex-col items-center gap-3 transition transform active:scale-95">
                                <img :src="getLogo(src)" class="w-10 h-10 rounded-lg object-contain">
                                <span class="font-bold text-slate-700 text-sm">{{ src }}</span>
                            </button>
                        </div>

                        <div class="flex gap-3 mt-8 pt-4 border-t border-slate-100">
                            <button @click="wizard.step--" class="w-full bg-slate-100 text-slate-500 py-3 rounded-xl font-bold hover:bg-slate-200">Retour</button>
                        </div>
                    </div>

                    <div v-if="wizard.step===6">
                        <h4 class="text-center font-black text-2xl mb-6 text-blue-900">R√©capitulatif</h4>
                        
                        <div class="bg-slate-50 p-6 rounded-2xl space-y-3 text-sm border border-slate-200">
                            <div class="flex justify-between border-b border-slate-200 pb-2">
                                <span class="text-slate-500">Agence</span>
                                <b class="text-slate-800">{{ form.agence.nom }}</b>
                            </div>
                            <div class="flex justify-between border-b border-slate-200 pb-2">
                                <span class="text-slate-500">Client</span>
                                <b class="text-slate-800">{{ form.civilite }} {{ form.nom }}</b>
                            </div>
                            <div class="flex justify-between border-b border-slate-200 pb-2">
                                <span class="text-slate-500">T√©l√©phone</span>
                                <b class="font-mono text-slate-800">{{ form.telephone }}</b>
                            </div>
                            <div class="flex justify-between border-b border-slate-200 pb-2">
                                <span class="text-slate-500">V√©hicule</span>
                                <b class="text-slate-800">{{ form.modele }}</b>
                            </div>
                            <div class="flex justify-between border-b border-slate-200 pb-2">
                                <span class="text-slate-500">Date</span>
                                <b class="text-blue-600">{{ formatDateFr(form.date) }} √† {{ form.heure }}</b>
                            </div>
                            <div class="flex justify-between border-b border-slate-200 pb-2">
                                <span class="text-slate-500">Source</span>
                                <div class="flex items-center gap-2">
                                    <img :src="getLogo(form.source)" class="w-4 h-4 rounded">
                                    <b>{{ form.source }}</b>
                                </div>
                            </div>
                            <div v-if="form.lienAnnonce" class="flex justify-between border-b border-slate-200 pb-2">
                                <span class="text-slate-500">Lien de l'annonce</span>
                                <a :href="form.lienAnnonce" target="_blank" class="text-blue-600 hover:text-blue-800 font-medium flex items-center gap-2 underline">
                                    <i class="fa-solid fa-external-link text-xs"></i>
                                    Voir l'annonce
                                </a>
                            </div>
                            <div v-if="form.motif || form.motifCustom" class="flex justify-between">
                                <span class="text-slate-500">Motif</span>
                                <b class="text-slate-800">{{ form.motif === '__CUSTOM__' ? form.motifCustom : form.motif }}</b>
                            </div>
                        </div>

                        <div class="mt-8 space-y-3">
                            <button v-if="!wizard.loading" @click="validateAndSendSMS" class="block w-full bg-green-500 text-white py-4 rounded-2xl font-bold text-center shadow-xl hover:bg-green-600 hover:shadow-2xl flex items-center justify-center gap-3 transform active:scale-95 transition text-lg">
                                <i class="fa-solid fa-paper-plane"></i> 
                                Valider & SMS
                            </button>
                            <button v-else disabled class="w-full bg-green-500 text-white py-4 rounded-2xl font-bold text-center shadow-xl opacity-50 cursor-not-allowed flex items-center justify-center gap-3">
                                <i class="fa-solid fa-spinner fa-spin"></i>
                                Cr√©ation en cours...
                            </button>
                            
                            <button @click="finalizeRdv('confirme')" :disabled="wizard.loading" :class="wizard.loading ? 'opacity-50 cursor-not-allowed' : 'hover:bg-blue-600'" class="w-full bg-blue-500 text-white py-3 rounded-xl font-bold transition flex items-center justify-center gap-2">
                                <i v-if="wizard.loading" class="fa-solid fa-spinner fa-spin"></i>
                                <i v-else class="fa-solid fa-check"></i> 
                                {{ wizard.loading ? 'Cr√©ation en cours...' : 'Confirmer sans SMS' }}
                            </button>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <button @click="wizard.step--" :disabled="wizard.loading" :class="wizard.loading ? 'opacity-50 cursor-not-allowed' : 'hover:bg-slate-200'" class="bg-slate-100 text-slate-500 py-3 rounded-xl font-bold transition">Retour</button>
                                <button @click="finalizeRdv('a_confirmer')" :disabled="wizard.loading" :class="wizard.loading ? 'opacity-50 cursor-not-allowed' : 'hover:bg-orange-500 hover:text-white hover:shadow-lg'" class="bg-orange-50 text-orange-600 border-2 border-orange-300 py-3 rounded-xl font-bold transition transform active:scale-95 flex items-center justify-center gap-2 shadow-sm">
                                    <i v-if="wizard.loading" class="fa-solid fa-spinner fa-spin"></i>
                                    <i v-else class="fa-solid fa-clock"></i>
                                    {{ wizard.loading ? 'Cr√©ation...' : 'Confirmer + Tard' }}
                                </button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL INFO GOOGLE CALENDAR -->
    <div v-if="googleCalendarInfoModal.open" class="fixed inset-0 bg-slate-900/80 z-[600] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md text-center animate-fadeIn border-2 border-blue-100 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-32 h-32 bg-blue-50 rounded-full -mr-16 -mt-16 opacity-50"></div>
            <div class="relative z-10">
                <div class="w-20 h-20 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl">
                    <i class="fa-brands fa-google text-4xl"></i>
                </div>
                <h3 class="font-black text-2xl mb-3 text-slate-800">Google Calendar connect√©</h3>
                <p class="text-slate-600 mb-6 font-medium leading-relaxed">
                    Si vous n'√™tes plus connect√© √† Google, il faudra appuyer sur ce bouton pour vous reconnecter afin que vos rendez-vous se placent bien dans l'agenda.
                </p>
                <button @click="googleCalendarInfoModal.open=false" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-check"></i>
                    Compris
                </button>
            </div>
        </div>
    </div>
    
    <!-- MODAL CONFIRMATION AGENDA -->
    <div v-if="confirmAgendaModal.open" class="fixed inset-0 bg-slate-900/80 z-[600] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md text-center animate-fadeIn border-2 border-blue-100 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-32 h-32 bg-blue-50 rounded-full -mr-16 -mt-16 opacity-50"></div>
            <div class="relative z-10">
                <div class="w-20 h-20 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl">
                    <i class="fa-solid fa-calendar-check text-4xl"></i>
                </div>
                <h3 class="font-black text-2xl mb-3 text-slate-800">V√©rification Agenda</h3>
                <p class="text-slate-600 mb-6 font-medium leading-relaxed">
                    Ce rendez-vous n'est pas encore dans l'agenda.
                </p>
                <p class="text-slate-700 mb-8 font-bold text-lg">
                    Avez-vous bien plac√© ce rendez-vous dans l'agenda avant de valider ?
                </p>
                <div class="flex gap-3">
                    <button @click="confirmAgendaModal.open=false; if(confirmAgendaModal.onConfirm) confirmAgendaModal.onConfirm(false)" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 py-4 rounded-xl font-bold shadow-md transition transform active:scale-95 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-times"></i>
                        Non
                    </button>
                    <button @click="confirmAgendaModal.open=false; if(confirmAgendaModal.onConfirm) confirmAgendaModal.onConfirm(true)" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-4 rounded-xl font-bold shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-check"></i>
                        Oui
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL RECONNEXION POUR AGENDA -->
    <div v-if="reconnectAgendaModal.open" class="fixed inset-0 bg-slate-900/80 z-[600] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md text-center animate-fadeIn border-2 border-orange-100 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-32 h-32 bg-orange-50 rounded-full -mr-16 -mt-16 opacity-50"></div>
            <div class="relative z-10">
                <div class="w-20 h-20 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl animate-pulse">
                    <i class="fa-brands fa-google text-4xl"></i>
                </div>
                <h3 class="font-black text-2xl mb-3 text-slate-800">Connexion requise</h3>
                <p class="text-slate-600 mb-6 font-medium leading-relaxed">
                    Appuyez sur ce bouton pour vous reconnecter et pouvoir ajouter ce rendez-vous dans l'agenda.
                </p>
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                    <p class="text-sm font-bold text-blue-800">
                        <i class="fa-solid fa-info-circle mr-2"></i>
                        D√®s que vous serez reconnect√©, le rendez-vous sera automatiquement ajout√© √† l'agenda.
                    </p>
                </div>
                <div class="flex gap-3">
                    <button @click="reconnectAgendaModal.open=false" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 py-4 rounded-xl font-bold shadow-md transition transform active:scale-95 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-times"></i>
                        Annuler
                    </button>
                    <button @click="handleReconnectForAgenda(reconnectAgendaModal.rdv)" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2">
                        <i class="fa-brands fa-google"></i>
                        Se reconnecter
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- GOOGLE CALENDAR DISCONNECTED MODAL -->
    <div v-if="googleCalendarDisconnectedModal.open" class="fixed inset-0 bg-slate-900/80 z-[600] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md text-center animate-fadeIn border-2 border-orange-100 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-32 h-32 bg-orange-50 rounded-full -mr-16 -mt-16 opacity-50"></div>
            <div class="relative z-10">
                <div class="w-20 h-20 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl animate-pulse">
                    <i class="fa-brands fa-google text-4xl"></i>
                </div>
                <h3 class="font-black text-2xl mb-3 text-slate-800">Connexion Google Agenda requise</h3>
                <p class="text-slate-600 mb-6 font-medium leading-relaxed">
                    Votre session a expir√© ou le token a expir√©.
                </p>
                <div class="bg-slate-50 rounded-2xl p-5 mb-6 border border-slate-200 text-left">
                    <p class="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-list-check text-orange-500"></i>
                        Pour ajouter ce rendez-vous √† l'agenda :
                    </p>
                    <ol class="space-y-2 text-sm text-slate-600">
                        <li class="flex items-start gap-2">
                            <span class="font-bold text-orange-500">1.</span>
                            <span>Cliquez sur "Se connecter" ci-dessous</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="font-bold text-orange-500">2.</span>
                            <span>Autorisez l'acc√®s √† Google Calendar</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="font-bold text-orange-500">3.</span>
                            <span>Revenez sur ce rendez-vous pour le valider</span>
                        </li>
                    </ol>
                </div>
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                    <p class="text-sm font-bold text-blue-800">
                        <i class="fa-solid fa-info-circle mr-2"></i>
                        Le rendez-vous a √©t√© cr√©√© avec le statut "Confirmer + Tard" et sera ajout√© √† l'agenda une fois reconnect√©.
                    </p>
                </div>
                <div class="flex gap-3">
                    <button @click="handleCloseDisconnectedModal()" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 py-4 rounded-xl font-bold shadow-md transition transform active:scale-95 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-times"></i>
                        {{ googleCalendarDisconnectedModal.fromWizard && googleCalendarRequired ? 'Ignorer' : 'Fermer' }}
                    </button>
                    <button @click="connectGoogleCalendar()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2">
                        <i class="fa-brands fa-google"></i>
                        Se connecter
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- CANCEL MODAL Z-INDEX FIX -->
    <div v-if="cancelModal.open" class="fixed inset-0 bg-slate-900/60 z-[350] flex items-center justify-center p-4 "><div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm text-center"><h3 class="font-bold text-lg mb-4">Qui a annul√© ?</h3><div class="space-y-3"><a :href="generateLink(cancelModal.rdv, 'cancel_clt')" target="_blank" @click="confirmCancel(cancelModal.rdv, 'client')" class="block w-full bg-slate-100 hover:bg-slate-200 py-3 rounded-xl font-bold text-slate-700 transition">Le Client</a><a :href="generateLink(cancelModal.rdv, 'cancel_ag')" target="_blank" @click="confirmCancel(cancelModal.rdv, 'agence')" class="block w-full bg-slate-100 hover:bg-slate-200 py-3 rounded-xl font-bold text-slate-700 transition">L'Agence</a><button @click="cancelModal.open=false" class="block w-full mt-4 text-gray-400 hover:text-gray-600 text-sm font-bold">Retour</button></div></div></div>
    
    <!-- PAUSED AGENCY Z-INDEX FIX (Z-INDEX 500 pour √™tre devant Wizard) -->
    <div v-if="pausedAgencyModal.open" class="fixed inset-0 bg-slate-900/60 z-[500] flex items-center justify-center p-4 "><div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-sm text-center animate-shake border-4 border-red-100"><div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl"><i class="fa-solid fa-ban"></i></div><h3 class="font-bold text-xl mb-2 text-slate-800">Agence Indisponible</h3><p class="text-slate-600 mb-6 font-medium">{{ getPauseMessage(pausedAgencyModal.agency) }}</p><button @click="pausedAgencyModal.open=false" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold hover:bg-slate-900 transition">Compris</button></div></div>
    
    <!-- RESCHEDULE Z-INDEX FIX -->
    <div v-if="rescheduleModal.open" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4 "><div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh] fade-in"><div class="bg-slate-50 p-4 flex justify-between items-center border-b"><h3 class="font-bold text-lg text-slate-800">üìÖ Reporter Rendez-Vous</h3><button @click="rescheduleModal.open=false" class="w-8 h-8 rounded-full hover:bg-slate-200">‚úï</button></div><div v-if="rescheduleModal.step===1" class="p-6 overflow-y-auto space-y-4"><p class="text-sm font-bold text-blue-600 text-center mb-4">RDV Actuel: {{ formatDateFr(rescheduleModal.rdv.date) }} √† {{ rescheduleModal.rdv.heure }}</p><div class="mb-4"><div class="flex items-center justify-between mb-2"><h5 class="text-xs font-black uppercase text-slate-500 tracking-wider"><i class="fa-solid fa-calendar-alt text-blue-500"></i> Choisir le Nouveau Jour :</h5><input type="date" v-model="rescheduleModal.date" @change="rescheduleModal.heure=null" class="p-1 border border-slate-200 rounded-lg text-xs font-bold text-slate-700 outline-none focus:border-blue-500 shadow-sm cursor-pointer hover:bg-blue-50"></div><div class="overflow-x-auto pb-2 hide-scrollbar snap-x flex space-x-2"><button v-for="d in dateOptions" :key="d.val" @click="rescheduleModal.date=d.val; rescheduleModal.heure=null;" :class="[rescheduleModal.date===d.val ? 'bg-blue-600 text-white shadow-lg transform scale-[1.05] date-card-selected' : 'bg-white border-gray-200 text-gray-600 hover:border-blue-400', d.isToday ? 'border-2 border-green-500 shadow-md' : '']" class="flex-shrink-0 w-16 h-20 rounded-lg flex flex-col items-center justify-center text-sm transition-all duration-300 snap-center date-card p-1"><span :class="rescheduleModal.date===d.val ? 'text-blue-200' : 'text-slate-400'" class="text-[9px] font-bold uppercase mb-0 transition-colors">{{ d.dayName }}</span><span class="text-2xl font-black leading-none">{{ d.dayNum }}</span><span class="text-[9px] font-medium opacity-80 mt-1">{{ d.month }}</span></button></div></div><div v-if="rescheduleModal.date" class="overflow-y-auto hide-scrollbar p-2 border border-slate-100 rounded-lg bg-white shadow-inner animate-fadeIn max-h-[300px]"><h5 class="text-xs font-black uppercase text-slate-500 tracking-wider mb-2"><i class="fa-solid fa-clock text-green-500"></i> Choisir la Nouvelle Heure (09:00 - 19:00) :</h5><div class="space-y-3"><div class="grid grid-cols-4 gap-2"><button v-for="h in timeSlots" :key="h" @click="rescheduleModal.heure=h" :class="rescheduleModal.heure===h ? 'bg-green-500 text-white shadow-md' : 'bg-slate-50 text-slate-600 hover:bg-green-50'" class="py-1.5 rounded-md text-xs font-bold transition-all duration-200">{{ h }}</button></div><div class="pt-2 flex justify-center border-t border-slate-100"><input type="time" v-model="rescheduleModal.heure" class="border-2 border-blue-100 rounded-lg p-2 font-bold text-blue-900 text-center text-sm outline-none focus:border-blue-500 bg-blue-50 w-32"></div></div></div><div v-else class="flex-1 flex items-center justify-center text-center text-gray-400 border border-dashed border-gray-200 rounded-2xl"><p class="text-sm font-medium p-8">üìÖ Veuillez d'abord s√©lectionner une date ci-dessus.</p></div><div v-if="rescheduleModal.date && rescheduleModal.heure" class="mt-4"><label class="text-xs font-bold text-slate-500 uppercase mb-2 block"><i class="fa-solid fa-note-sticky text-blue-500"></i> Motif du d√©placement (facultatif)</label><input v-model="rescheduleModal.motif" placeholder="Ex: Client indisponible, V√©hicule en r√©paration..." class="w-full p-3 border-2 border-slate-200 rounded-xl text-sm font-medium text-slate-700 outline-none focus:border-blue-500 bg-white"></div><div class="flex gap-2 mt-4"><button @click="rescheduleModal.open=false" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-300">Annuler</button><button @click="confirmRescheduleStep1" :disabled="!rescheduleModal.date || !rescheduleModal.heure || (rescheduleModal.date === rescheduleModal.rdv.date && rescheduleModal.heure === rescheduleModal.rdv.heure)" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold shadow-md flex items-center justify-center gap-2 transition transform active:scale-95 disabled:opacity-50">Confirmer Report <i class="fa-solid fa-arrow-right"></i></button></div></div><div v-if="rescheduleModal.step===2" class="p-8 text-center animate-fadeIn flex flex-col items-center justify-center h-full"><div class="w-20 h-20 bg-green-100 text-green-500 text-4xl rounded-full flex items-center justify-center mb-6 shadow-lg shadow-green-200/50 animate-bounce"><i class="fa-solid fa-check"></i></div><h4 class="text-2xl font-black text-slate-800 mb-2">Report valid√© !</h4><p class="text-slate-600 font-medium mb-8 max-w-xs mx-auto">Le rendez-vous a bien √©t√© d√©plac√© au <br><strong class="text-blue-600">{{ formatDateLong(rescheduleModal.rdv.date) }} √† {{ rescheduleModal.rdv.heure }}</strong>.</p><div class="bg-slate-50 p-6 rounded-2xl border border-slate-100 w-full"><p class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-4">Voulez-vous pr√©venir le client ?</p><div class="grid grid-cols-1 gap-3"><button @click="sendRescheduleSMS" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition transform active:scale-95 flex items-center justify-center gap-3"><i class="fa-solid fa-comment-sms text-xl"></i> OUI, envoyer le SMS</button><button @click="rescheduleModal.open=false; clientModal.open=false; rescheduleModal.step=1" class="w-full bg-white text-slate-400 border-2 border-slate-100 py-3 rounded-xl font-bold hover:bg-slate-50 hover:text-slate-600 transition">Non, revenir au RDV</button></div></div></div></div></div>

    <!-- HONOR MODAL Z-INDEX FIX -->
    <div v-if="honorModal.open" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4 ">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm text-center pop-in border border-slate-200 relative overflow-hidden">
            <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl animate-pulse">
                <i class="fa-solid fa-file-signature text-3xl"></i>
            </div>
            <h3 class="font-bold text-2xl mb-2 text-slate-800">Rendez-vous honor√© ?</h3>
            <p class="text-slate-500 font-medium mb-8">Le client a-t-il sign√© un Mandat (OK M) ?</p>
            
            <div class="space-y-3">
                <button @click="finalizeHonor(true)" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 transition transform active:scale-95 flex items-center justify-center gap-3">
                    <i class="fa-solid fa-check-double text-xl"></i> ‚úÖ Oui, avec Mandat (OK M)
                </button>
                <button @click="finalizeHonor(false)" class="w-full bg-green-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-green-200 hover:bg-green-700 transition transform active:scale-95 flex items-center justify-center gap-3">
                    <i class="fa-solid fa-check-circle text-xl"></i> Oui, honor√© (sans mandat)
                </button>
                <button @click="honorModal.open=false" class="w-full bg-white text-slate-600 border-2 border-slate-200 py-3 rounded-xl font-bold hover:bg-slate-50 hover:text-slate-800 transition">
                   Annuler
                </button>
            </div>
        </div>
    </div>

    <!-- NOTIFICATION TOAST MODERNE -->
    <transition name="toast">
        <div v-if="notificationToast.open" class="fixed top-4 right-4 z-[400] max-w-md">
            <div class="bg-white rounded-2xl shadow-2xl border-2 overflow-hidden flex items-center gap-4 p-4 animate-slide-in-right" 
                 :class="notificationToast.type === 'success' ? 'border-green-300' : notificationToast.type === 'warning' ? 'border-orange-300' : 'border-blue-300'">
                <div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center text-xl"
                     :class="notificationToast.type === 'success' ? 'bg-green-100 text-green-600' : notificationToast.type === 'warning' ? 'bg-orange-100 text-orange-600' : 'bg-blue-100 text-blue-600'">
                    <i :class="'fa-solid ' + notificationToast.icon"></i>
                </div>
                <div class="flex-1">
                    <p class="font-bold text-slate-800 text-sm leading-tight">{{ notificationToast.message }}</p>
                </div>
                <button @click="notificationToast.open = false" class="flex-shrink-0 text-slate-400 hover:text-slate-600 transition">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
        </div>
    </transition>

    <!-- NOUVELLE MODALE √âDITION CLIENT Z-INDEX FIX -->
    <div v-if="editModal.open" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4 ">
        <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl overflow-hidden flex flex-col pop-in">
            <div class="bg-slate-800 p-4 text-white flex justify-between items-center">
                <h3 class="font-bold text-lg"><i class="fa-solid fa-pencil mr-2"></i> Modifier Infos Client</h3>
                <button @click="editModal.open=false" class="w-8 h-8 rounded-full hover:bg-white/20 flex items-center justify-center transition">‚úï</button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">Civilit√©</label>
                    <div class="flex gap-3">
                        <button @click="editModal.form.civilite='M.'" :class="editModal.form.civilite==='M.'?'bg-blue-600 text-white shadow-lg scale-105':'bg-slate-100 text-slate-500 hover:bg-slate-200'" class="flex-1 py-3 rounded-xl font-bold transition transform">Monsieur</button>
                        <button @click="editModal.form.civilite='Mme'" :class="editModal.form.civilite==='Mme'?'bg-pink-500 text-white shadow-lg scale-105':'bg-slate-100 text-slate-500 hover:bg-slate-200'" class="flex-1 py-3 rounded-xl font-bold transition transform">Madame</button>
                    </div>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">Nom Client</label>
                    <input v-model="editModal.form.nom" class="w-full p-3 border-2 border-slate-200 rounded-xl font-bold text-slate-800 outline-none focus:border-blue-500">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">T√©l√©phone</label>
                    <input v-model="editModal.form.telephone" class="w-full p-3 border-2 border-slate-200 rounded-xl font-bold text-slate-800 outline-none focus:border-blue-500">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">Mod√®le V√©hicule</label>
                    <input v-model="editModal.form.modele" class="w-full p-3 border-2 border-slate-200 rounded-xl font-bold text-slate-800 outline-none focus:border-blue-500">
                </div>
                 <div>
                    <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">Agence</label>
                    <select v-model="editModal.form.agenceId" class="w-full p-3 border-2 border-slate-200 rounded-xl font-bold text-slate-800 outline-none focus:border-blue-500 bg-white">
                        <option v-for="ag in visibleAgencies" :key="ag.id" :value="ag.id">{{ ag.nom }}</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">Source</label>
                    <div class="flex flex-wrap gap-2">
                        <button v-for="src in sourcesList" :key="src" @click="editModal.form.source=src" :class="editModal.form.source===src ? 'bg-blue-600 text-white shadow-md' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'" class="px-3 py-1.5 rounded-lg text-xs font-bold transition">
                            {{ src }}
                        </button>
                    </div>
                </div>
                <button @click="saveEdit" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg mt-2 transform active:scale-95 transition">Sauvegarder</button>
            </div>
        </div>
    </div>

  
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDi3NFvmg_acIxicfShqhEd4uQEDMDcizM",
        authDomain: "bon-de-commande-b05f6.firebaseapp.com",
        projectId: "bon-de-commande-b05f6",
        storageBucket: "bon-de-commande-b05f6.firebasestorage.app",
        messagingSenderId: "884603881750",
        appId: "1:884603881750:web:816da99e2502225779a837"
    };
    firebase.initializeApp(firebaseConfig);
    // --- PERSISTANCE INSTANTAN√âE ---
    firebase.firestore().enablePersistence()
        .catch((err) => {
            if (err.code == 'failed-precondition') {
                console.warn("Persistance non active (onglet multiple).");
            } else if (err.code == 'unimplemented') {
                console.warn("Persistance non support√©e par le navigateur.");
            }
        });
    const db = firebase.firestore();

    const { createApp, ref, reactive, computed, onMounted, watch } = Vue;

    createApp({
        setup() {
            
            const user = reactive({ logged:false, role:'', name:'' });
            const loginEmail = ref('');
            const loginPass = ref('');
            const loginAdminSelection = ref(false); 
            
            const view = ref('dashboard');
            const currentFilter = ref('all'); 
            const listFilters = reactive({ agenceId: '', date: '', prospecteur: '' }); 
            const fromDashboard = ref(false);
            const rdvMenuOpen = ref(null);

            const dashboardFilters = reactive({ agencyId: '', userId: '', onlyLive: false });
            const dashboardLimit = ref(15);
            const displayLimit = ref(20); 

            const now = ref(new Date()); 
            const rdvList = ref([]);
            let rdvListener = null;
            
            // Google Calendar API
            const googleCalendarConnected = ref(false);
            const googleCalendarUserEmail = ref('');
            const googleAccessToken = ref('');
            let googleTokenClient = null;
            
            // Google Calendar API pour les prospecteurs
            const prospecteurGoogleCalendarConnected = ref(false);
            const prospecteurGoogleCalendarToken = ref('');
            const prospecteurGoogleCalendarTokenExpired = ref(false);
            const prospecteurTokenExpirationTime = ref(null); // Timestamp d'expiration du token prospecteur
            const prospecteurTokenTimerTick = ref(Date.now()); // Pour le compteur en temps r√©el
            let prospecteurGoogleTokenClient = null;
            let prospecteurTokenRefreshInterval = null;
            
            // Mettre √† jour le temps toutes les secondes pour les prospecteurs
            setInterval(() => {
                if (prospecteurTokenExpirationTime.value && prospecteurGoogleCalendarConnected.value && !prospecteurGoogleCalendarTokenExpired.value) {
                    prospecteurTokenTimerTick.value = Date.now();
                }
            }, 1000);
            
            // Calcul du temps restant avant expiration pour les prospecteurs
            const prospecteurTokenTimeRemaining = computed(() => {
                if (!prospecteurTokenExpirationTime.value || !prospecteurGoogleCalendarConnected.value || prospecteurGoogleCalendarTokenExpired.value) {
                    return null;
                }
                const remaining = prospecteurTokenExpirationTime.value - prospecteurTokenTimerTick.value;
                if (remaining <= 0) return null;
                
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                return { minutes, seconds };
            });

            const agences = ref([]);
            const sourcesList = ref(['Leboncoin', 'La Centrale', 'Facebook', 'Google', 'Instagram']);
            const sourceLogos = ref({}); 
            const adminNamesList = ref(['Nathana√´l', 'Charl√®ne', 'Admin']);
            const motifsList = ref(['Essai', 'Achat', 'R√©vision', 'R√©paration', 'Vente']);
            // Cherchez cette ligne et remplacez-la par :
const globalSettings = ref({ reminderStartTime: '08:00', reminderEveTime: '16:00', appLogoUrl: '' });
            
            // GLOBAL COMMISSION SETTINGS
            const globalCommission = reactive({ base: 10, threshold: 21, step: 10, amount: 100 });
            const tips = reactive({}); // { memberId: currentMonthTipAmount }
            
            // R√©glages de synchronisation
            const syncSettings = reactive({
                syncAfterRdvTime: false, // Synchroniser seulement apr√®s l'heure du rendez-vous
                syncInterval: 30 // Intervalle de synchronisation en secondes
            });

            const selectedIds = ref([]);
            const bulkModal = reactive({ open: false, action: '', label: '' });
            const agencySearch = ref('');

            const wizard = reactive({ open:false, step:1, loading:false });
            const form = reactive({});
            const clientModal = reactive({ open:false, rdv:null, removingFromAgenda: false });
            const historyModal = reactive({ open:false, rdv:null });
            const settingsModal = reactive({ open:false, tab:'Agences' });
            const cancelModal = reactive({ open:false, rdv:null });
            const rescheduleModal = reactive({ open:false, step:1, date:'', heure:'', rdv:null, oldDate:null, oldHeure:null, motif:'' });
            const pausedAgencyModal = reactive({ open:false, agency:null });
            
            const honorModal = reactive({ open: false, rdv: null });
            const editModal = reactive({ open: false, rdv: null, form: {} });
            const discountModal = reactive({ open: false, amount: null, reason: '', customReason: '', error: '' });
            const reminderAlertModal = reactive({ open: false });
            const pendingStatusModal = reactive({ open: false });
            const teamEditModal = reactive({ open: false, member: null, name: '', email: '', password: '', assignedAgencies: [] });
            const customConfirmModal = reactive({ open: false, title: '', message: '', onConfirm: null });
            const statsModal = reactive({ open: false });
            const tipModal = reactive({ open: false, operation: 'add', amount: null, reason: '', customReason: '', note: '', error: '' });
            const googleCalendarDisconnectedModal = reactive({ open: false, fromWizard: false });
            const googleCalendarRequired = ref(false); // Param√®tre pour rendre la connexion obligatoire
            const googleCalendarInfoModal = reactive({ open: false });
            const confirmAgendaModal = reactive({ open: false, rdv: null, onConfirm: null });
            const reconnectAgendaModal = reactive({ open: false, rdv: null });
            const notificationToast = reactive({ open: false, message: '', type: 'success', icon: '' });

            // Fonction pour afficher une notification moderne
            const showNotification = (message, type = 'success', icon = '') => {
                notificationToast.message = message;
                notificationToast.type = type;
                notificationToast.icon = icon || (type === 'success' ? 'fa-check-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle');
                notificationToast.open = true;
                setTimeout(() => {
                    notificationToast.open = false;
                }, 4000);
            };

            // PORTAFEUILLE
            const portefeuilleSearch = ref('');
            const selectedProspecteur = ref(null);
            const filteredProspectors = ref([]);
            const transactions = ref([]);
            const prospecteurEdit = reactive({ tips: 0 });
            let transactionListener = null;
            let adminTransactionListener = null;

            // Flag de session pour les v√©rifications au d√©marrage
            const checksDone = ref(false);
            const startupTimer = ref(null);

            const statsFilterAgency = ref('');
            const statsFilterUser = ref('');

            const newSource = ref('');
            const newMotif = ref('');
            const newAdminName = ref('');
            const showDiscountInput = ref(false);
            const newNoteText = ref('');

            const editingAgency = ref(null);
            const editingMsgAgence = ref(null);
            const editingMsgType = ref('confirm');
            const clientExists = ref(false);
            const pauseReasonSelect = ref('Vacances');
            const showCustomTime = ref(false);
            const mobileMenuOpen = ref(false);
            
            const currentTheme = computed(() => {
                // Th√®me moderne chic toujours actif
                return { name: 'modern', label: 'Mode Premium', icon: '‚ú®', classes: 'theme-modern' };
                
                // Th√®mes saisonniers d√©sactiv√©s - d√©commenter pour les r√©activer
                // const d = new Date();
                // const month = d.getMonth() + 1; 
                // const day = d.getDate();
                // if (month === 12) return { name: 'christmas', label: 'Joyeuses F√™tes', icon: 'üéÖ', classes: 'theme-christmas' };
                // if (month === 1 && day <= 15) return { name: 'newyear', label: 'Bonne Ann√©e', icon: 'ü•Ç', classes: 'theme-newyear' };
                // if (month === 2 && day >= 10 && day <= 15) return { name: 'love', label: 'Love is in the air', icon: '‚ù§Ô∏è', classes: 'theme-love' };
                // if (month === 10 && day >= 15) return { name: 'halloween', label: 'Bouuh !', icon: 'üéÉ', classes: 'theme-halloween' };
                // if (month >= 6 && month <= 8) return { name: 'summer', label: 'Mode √ât√©', icon: 'üòé', classes: 'theme-summer' };
                // if (month === 7 && day >= 13 && day <= 15) return { name: 'bastille', label: 'F√™te Nationale', icon: 'üéÜ', classes: 'theme-bastille' };
                // return { name: 'default', label: '', icon: '', classes: '' };
            });

            const welcomeModal = reactive({ open: false, title: '', message: '', icon: '' });
            const teamList = ref([]);
            const newMember = reactive({ name:'', email:'', password:'', assignedAgencies: [] });

            const msgLabels = { 'confirm': 'Confirmation', 'rappel': 'Rappel Veille', 'rappel_today': 'Rappel Jour J', 'reschedule': 'Report', 'cancel_ag': 'Annulation Agence', 'cancel_clt': 'Annulation Client', 'noshow': 'Lapin', 'noshow_today': 'Lapin (Jour J)' };
            const filters = reactive({ date: new Date().toISOString().split('T')[0] });
            const timelineShowTomorrow = ref(false); // √âtat pour savoir si on affiche "demain" ou "aujourd'hui"
            const search = ref('');
            const normalizePhone = (value) => (value || '').replace(/\D/g, '');
            const formatPhone = (digits) => digits.replace(/(\d{2})(?=\d)/g, '$1 ').trim();

 onMounted(() => {

                // 1. Initialisation de l'outil Google
                const initGoogle = () => {
                    if (typeof google !== 'undefined' && google.accounts) {
                        initGoogleCalendar();
                    } else {
                        setTimeout(initGoogle, 100);
                    }
                };
                initGoogle();

                // 2. Restauration de la session utilisateur
                const savedUser = localStorage.getItem('crm_user');

                if (savedUser) {
                    const parsed = JSON.parse(savedUser);
                    user.logged = true;
                    user.role = parsed.role;
                    user.name = parsed.name;
                    loadRdvData();
                    
                    // Initialiser Google Calendar pour les prospecteurs apr√®s chargement de l'utilisateur
                    if (user.role !== 'admin' && typeof google !== 'undefined' && google.accounts) {
                        initProspecteurGoogleCalendar();
                    }
                }

                // --- FIX : RESTAURATION DE LA SESSION GOOGLE (ADMIN SEULEMENT) ---
                // On v√©rifie le localStorage maintenant que l'utilisateur est charg√©
                if (user.role === 'admin') {
                    const savedToken = localStorage.getItem('google_calendar_token');
                    const savedEmail = localStorage.getItem('google_calendar_email');

                    if (savedToken && savedEmail) {
                        // On teste si le token est encore valide
                        fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                            headers: { 'Authorization': `Bearer ${savedToken}` }
                        })
                        .then(async (res) => {
                            if (res.ok) {
                                // Le token est bon, on r√©tablit la connexion
                                googleAccessToken.value = savedToken;
                                googleCalendarUserEmail.value = savedEmail;
                                googleCalendarConnected.value = true;
                                console.log("‚úÖ Session Google Agenda restaur√©e");
                                // On recharge la liste des agendas pour que le menu soit √† jour
                                await fetchGoogleCalendarList();
                            } else {
                                // Le token est expir√©, on nettoie
                                console.warn("‚ö†Ô∏è Token Google expir√©, d√©connexion forc√©e");
                                localStorage.removeItem('google_calendar_token');
                                localStorage.removeItem('google_calendar_email');
                                googleCalendarConnected.value = false;
                            }
                        })
                        .catch(() => {
                            googleCalendarConnected.value = false;
                        });
                    }
                }
                // ------------------------------------------------------------------

                // 3. Fermeture des menus au clic ext√©rieur
                document.addEventListener('click', (e) => {
                    if (rdvMenuOpen.value) {
                        const clickedMenu = e.target.closest('div[style*="z-index: 9999"]');
                        const clickedButton = e.target.closest('button[title="Options"]');
                        const clickedGear = e.target.closest('.fa-gear') || e.target.closest('button[title="Options"]');

                        if (!clickedMenu && !clickedButton && !clickedGear) {
                            rdvMenuOpen.value = null;
                        }
                    }
                });

                // 4. Chargement des donn√©es Firebase (Agences, Settings, Users)
                db.collection('agences').onSnapshot(snap => agences.value = snap.docs.map(d => ({
                    id: d.id,
                    templates: {},
                    ...d.data()
                })));

                db.collection('settings').doc('global').onSnapshot(snap => {
                    if (snap.exists) {
                        const data = snap.data();
                        if (data.sources) sourcesList.value = data.sources;
                        if (data.motifs) motifsList.value = data.motifs;
                        if (data.reminderStartTime) globalSettings.value.reminderStartTime = data.reminderStartTime;
                        if (data.reminderEveTime) globalSettings.value.reminderEveTime = data.reminderEveTime;
                        if (data.appLogoUrl) globalSettings.value.appLogoUrl = data.appLogoUrl;
                        if (data.logos) sourceLogos.value = data.logos;
                        if (data.adminNames) adminNamesList.value = data.adminNames;
                    }
                });
                
                // Charger le param√®tre de connexion obligatoire
                db.collection('settings').doc('google_calendar_required').onSnapshot(snap => {
                    if (snap.exists) {
                        const data = snap.data();
                        googleCalendarRequired.value = data.required || false;
                        if (data.commission) Object.assign(globalCommission, data.commission);
                    }
                });

                db.collection('users').onSnapshot(snap => {
                    teamList.value = snap.docs.map(d => {
                        const data = d.data();
                        const currentMonthKey = `${new Date().getMonth()}-${new Date().getFullYear()}`;
                        if (data.tips && data.tips[currentMonthKey]) {
                            tips[d.id] = data.tips[currentMonthKey];
                        } else {
                            tips[d.id] = 0;
                        }
                        return {
                            id: d.id,
                            assignedAgencies: [],
                            ...data
                        };
                    });
                });

                // 5. --- SYNCHRONISATION GOOGLE CALENDAR CLOUD ---
                // C'est ici que la magie op√®re pour connecter tout le monde
                db.collection('settings').doc('google_token').onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        if (data && data.token) {
                            // On applique le token √† tout le monde
                            googleAccessToken.value = data.token;
                            googleCalendarUserEmail.value = data.email || '';
                            googleCalendarConnected.value = true;
                            
                            // V√©rifier imm√©diatement la validit√© du token
                            setTimeout(() => {
                                checkAndUpdateTokenStatus();
                            }, 500);

                            // Si c'est l'admin, on garde une copie locale au cas o√π
                            if (user.role === 'admin') {
                                localStorage.setItem('google_calendar_token', data.token);
                            }
                            
                            // Si l'admin est connect√©, les prospecteurs sont automatiquement connect√©s
                            if (user.role !== 'admin') {
                                prospecteurGoogleCalendarConnected.value = true;
                                prospecteurGoogleCalendarToken.value = data.token;
                                prospecteurGoogleCalendarTokenExpired.value = false;
                                // Utiliser le token admin, donc pas d'expiration pour le prospecteur
                                prospecteurTokenExpirationTime.value = null;
                                // Arr√™ter le rafra√Æchissement local si l'admin est connect√©
                                if (prospecteurTokenRefreshInterval) {
                                    clearInterval(prospecteurTokenRefreshInterval);
                                    prospecteurTokenRefreshInterval = null;
                                }
                            }
                        } else {
                            // Token vide dans Firestore = d√©connexion
                            googleAccessToken.value = '';
                            googleCalendarUserEmail.value = '';
                            googleCalendarConnected.value = false;
                            googleCalendarTokenValid.value = false;
                            if (user.role !== 'admin') {
                                prospecteurGoogleCalendarConnected.value = false;
                                prospecteurGoogleCalendarToken.value = '';
                                prospecteurGoogleCalendarTokenExpired.value = true;
                                prospecteurTokenExpirationTime.value = null;
                            }
                        }
                    } else {
                        // Si supprim√© de la base, on d√©connecte tout le monde
                        googleAccessToken.value = '';
                        googleCalendarUserEmail.value = '';
                        googleCalendarConnected.value = false;
                        googleCalendarTokenValid.value = false;
                        
                        // Si l'admin se d√©connecte, les prospecteurs peuvent toujours utiliser leur propre connexion
                        if (user.role !== 'admin' && !prospecteurGoogleCalendarToken.value) {
                            prospecteurGoogleCalendarConnected.value = false;
                        }
                    }
                });

                // 6. Horloge
                setInterval(() => {
                    now.value = new Date();
                    // Mettre √† jour filters.date pour la coh√©rence (mais on utilise timelineShowTomorrow pour la logique)
                    const todayStr = new Date().toISOString().split('T')[0];
                    if (!timelineShowTomorrow.value) {
                        // Si on est en mode "aujourd'hui", s'assurer que filters.date est √† jour
                        if (filters.date !== todayStr) {
                            filters.date = todayStr;
                        }
                    }
                }, 1000); // V√©rifier toutes les secondes pour d√©tecter le changement de jour rapidement
            });
            // --- ANTI-DECONNEXION (Toutes les 45min) ---
                setInterval(() => {
                    if (user.role === 'admin' && googleCalendarConnected.value && googleTokenClient) {
                        console.log("üîÑ Refresh token Google auto...");
                        googleTokenClient.requestAccessToken({ prompt: 'none' });
                    }
                }, 45 * 60 * 1000);
                
            // --- V√âRIFICATION P√âRIODIQUE DU TOKEN (Toutes les 30 secondes pour d√©tection en temps r√©el) ---
                setInterval(() => {
                    if (user.role === 'admin' && googleCalendarConnected.value && googleAccessToken.value) {
                        checkAndUpdateTokenStatus();
                    }
                    // V√©rifier aussi le token prospecteur
                    if (user.role !== 'admin' && (prospecteurGoogleCalendarConnected.value || googleCalendarConnected.value)) {
                        checkAndUpdateProspecteurTokenStatus();
                    }
                }, 30000); // V√©rifier toutes les 30 secondes
                
            // --- V√âRIFICATION EXPIRATION TOKEN PROSPECTEURS (Toutes les 5 minutes) ---
                if (user.role !== 'admin') {
                    // V√©rifier imm√©diatement
                    setTimeout(() => {
                        checkProspecteurTokenExpiration();
                    }, 5000);
                    
                    // Puis v√©rifier toutes les 5 minutes
                    setInterval(() => {
                        checkProspecteurTokenExpiration();
                    }, 5 * 60 * 1000);
                }
            // Charger les r√©glages de synchronisation
            db.collection('settings').doc('calendar_sync').onSnapshot((snap) => {
                if (snap.exists) {
                    const data = snap.data();
                    if (data.syncAfterRdvTime !== undefined) {
                        syncSettings.syncAfterRdvTime = data.syncAfterRdvTime;
                    }
                    if (data.syncInterval) {
                        syncSettings.syncInterval = data.syncInterval;
                    }
                } else {
                    // Valeurs par d√©faut
                    syncSettings.syncAfterRdvTime = false;
                    syncSettings.syncInterval = 30;
                }
            });

            // Fonction pour d√©marrer/red√©marrer la synchronisation p√©riodique
            const startPeriodicSync = () => {
                // Arr√™ter l'ancien intervalle si existe
                if (window.calendarSyncInterval) {
                    clearInterval(window.calendarSyncInterval);
                    window.calendarSyncInterval = null;
                }

                if (googleCalendarConnected.value && googleAccessToken.value) {
                    const intervalMs = syncSettings.syncInterval * 1000;
                    console.log(`üîÑ D√©marrage synchronisation automatique toutes les ${syncSettings.syncInterval} secondes`);
                    
                    window.calendarSyncInterval = setInterval(async () => {
                        if (googleCalendarConnected.value && googleAccessToken.value) {
                            try {
                                const now = new Date();
                                const startDate = new Date(now);
                                startDate.setDate(startDate.getDate() - 7);
                                startDate.setHours(0, 0, 0, 0);
                                const endDate = new Date(now);
                                endDate.setDate(endDate.getDate() + 7);
                                endDate.setHours(23, 59, 59, 999);
                                
                                const timeMin = startDate.toISOString();
                                const timeMax = endDate.toISOString();
                                
                                const calendarIds = ['primary'];
                                agences.value.forEach(agence => {
                                    if (agence.agendaEmail && agence.agendaEmail.trim()) {
                                        calendarIds.push(agence.agendaEmail.trim());
                                    }
                                });
                                
                                const allGoogleEvents = [];
                                for (const calendarId of calendarIds) {
                                    try {
                                        const encodedId = encodeURIComponent(calendarId);
                                        const url = `https://www.googleapis.com/calendar/v3/calendars/${encodedId}/events?timeMin=${timeMin}&timeMax=${timeMax}&singleEvents=true&orderBy=startTime`;
                                        
                                        const response = await fetch(url, {
                                            headers: {
                                                'Authorization': `Bearer ${googleAccessToken.value}`
                                            }
                                        });
                                        
                                        if (response.ok) {
                                            const data = await response.json();
                                            if (data.items) {
                                                allGoogleEvents.push(...data.items);
                                            }
                                        }
                                    } catch (err) {
                                        console.warn(`Erreur synchronisation calendrier ${calendarId}:`, err);
                                    }
                                }
                                
                                console.log('‚úÖ Synchronisation automatique Google Calendar effectu√©e');
                            } catch (err) {
                                console.error('Erreur synchronisation automatique:', err);
                            }
                        }
                    }, intervalMs);
                }
            };

            // Synchronisation p√©riodique Google Calendar (s√©par√©e du onMounted)
            watch([googleCalendarConnected, googleAccessToken], ([connected, token]) => {
                if (connected && token) {
                    startPeriodicSync();
                } else {
                    // Arr√™ter la synchronisation si d√©connect√©
                    if (window.calendarSyncInterval) {
                        clearInterval(window.calendarSyncInterval);
                        window.calendarSyncInterval = null;
                    }
                }
            });

            // Red√©marrer la synchronisation si les r√©glages changent
            watch([() => syncSettings.syncInterval], () => {
                if (googleCalendarConnected.value && googleAccessToken.value) {
                    startPeriodicSync();
                }
            });

            const visibleAgencies = computed(() => {
                if (user.role === 'admin') return agences.value;
                const currentUserObj = teamList.value.find(u => u.name === user.name);
                const allowedIds = currentUserObj?.assignedAgencies || [];
                return agences.value.filter(a => allowedIds.includes(a.id));
            });

            const loadRdvData = () => {
                if(rdvListener) rdvListener();
                let query = db.collection('rendezvous');
                if(user.role !== 'admin') {
                    query = query.where('createdBy', '==', user.name);
                }
                rdvListener = query.onSnapshot(snap => {
                    const newRdvs = snap.docs.map(d => {
                        const data = d.data();
                        const created = data.created && data.created.toDate ? data.created.toDate() : (data.created ? new Date(data.created) : null);
                        return {id:d.id, ...data, created};
                    });
                    
                    // D√©tecter les changements de statut pour supprimer les transactions
                    // Note: On ne cr√©e PAS les transactions ici car elles sont cr√©√©es manuellement dans finalizeHonor/updateStatus
                    // Cela √©vite les doublons
                    if (rdvList.value.length > 0) {
                        for (const newRdv of newRdvs) {
                            const oldRdv = rdvList.value.find(r => r.id === newRdv.id);
                            if (oldRdv) {
                                // Si le RDV √©tait honor√© et ne l'est plus, supprimer les transactions
                                if (oldRdv.statut === 'honore' && newRdv.statut !== 'honore') {
                                    deleteTransactionsForRdv(newRdv.id);
                                }
                                // On ne cr√©e PAS les transactions ici pour √©viter les doublons
                                // Elles sont cr√©√©es dans finalizeHonor() et updateStatus()
                            }
                        }
                    }
                    
                    rdvList.value = newRdvs;

                    // Charger les transactions si on est connect√© et dans le portefeuille
                    if (user.logged && user.role !== 'admin' && user.name && view.value === 'portefeuille') {
                        loadUserTransactions();
                    }

                    // V√âRIFICATION D√âMARRAGE (Debounce pour attendre chargement complet)
                    if (user.logged && !checksDone.value) {
                        if (startupTimer.value) clearTimeout(startupTimer.value);
                        startupTimer.value = setTimeout(() => {
                            performStartupChecks();
                        }, 1000); 
                    }
                });
            };

            const performStartupChecks = () => {
                if (checksDone.value) return; 
                
                // 1. STATUTS MANQUANTS (Priorit√© Absolue)
                const pendingCount = rdvList.value.filter(r => { 
                    if(!['confirme', 'a_confirmer'].includes(r.statut)) return false; 
                    if(!r.date || !r.heure) return false; 
                    const end = new Date(r.date+'T'+r.heure).getTime() + 3600000; 
                    return new Date().getTime() > end; 
                }).length;

                if (pendingCount > 0) {
                    pendingStatusModal.open = true;
                    checksDone.value = true;
                    return; // Bloque les autres alertes
                }

                // 2. RAPPELS
                const currentHour = new Date().getHours();
                const startHour = parseInt(globalSettings.value.reminderStartTime.split(':')[0] || "8");
                const canShowToday = currentHour >= startHour;
                const eveStartHour = parseInt(globalSettings.value.reminderEveTime.split(':')[0] || "16");
                const canShowVeille = currentHour >= eveStartHour;

                const hasVeille = rappelsVeilleCount.value > 0;
                const hasJour = rappelsJourCount.value > 0;

                if ((hasVeille && canShowVeille) || (hasJour && canShowToday)) {
                    reminderAlertModal.open = true;
                }
                
                checksDone.value = true;
            };

            const checkAndShowWelcome = (email, name) => {
                const today = new Date().toISOString().split('T')[0];
                const lastLoginKey = 'lastWelcome_' + email;
                const lastLoginDate = localStorage.getItem(lastLoginKey);
                if (lastLoginDate !== today) {
                    const hour = new Date().getHours();
                    const isMorning = hour < 13;
                    welcomeModal.title = isMorning ? `Bonjour ${name} !` : `Re-bonjour ${name} !`;
                    welcomeModal.message = isMorning ? "J'esp√®re que vous allez bien ! Passez une excellente matin√©e ! üí™" : "J'esp√®re que votre matin√©e s'est bien pass√©e. Bonne fin de journ√©e ! üöÄ";
                    welcomeModal.icon = isMorning ? '‚òÄÔ∏è' : 'üëã';
                    welcomeModal.open = true;
                    launchFireworks();
                    localStorage.setItem(lastLoginKey, today);
                }
            };

            const saveGlobalSettings = async () => {
                await db.collection('settings').doc('global').set({
                    reminderStartTime: globalSettings.value.reminderStartTime,
                    reminderEveTime: globalSettings.value.reminderEveTime,
                    appLogoUrl: globalSettings.value.appLogoUrl || '',
                    commission: globalCommission
                }, { merge: true });
                alert("Param√®tres sauvegard√©s !");
            };
            
            const saveTip = async (memberId) => {
                const amount = tips[memberId];
                if (amount === undefined || amount === null) return;
                const currentMonthKey = `${new Date().getMonth()}-${new Date().getFullYear()}`;
                
                // Get existing tips map or create new
                const memberRef = db.collection('users').doc(memberId);
                const doc = await memberRef.get();
                let existingTips = doc.data().tips || {};
                
                existingTips[currentMonthKey] = amount;
                
                await memberRef.update({ tips: existingTips });
                alert("Pourboire enregistr√© !");
            };

            const openTipModal = () => {
                tipModal.open = true;
                tipModal.operation = 'add';
                tipModal.amount = null;
                tipModal.reason = '';
                tipModal.customReason = '';
                tipModal.note = '';
                tipModal.error = '';
            };

            const saveTipTransaction = async () => {
                tipModal.error = '';
                
                // Validation
                if (!tipModal.amount || tipModal.amount <= 0) {
                    tipModal.error = "Veuillez entrer un montant valide.";
                    return;
                }
                
                if (!tipModal.reason) {
                    tipModal.error = "Veuillez s√©lectionner un motif.";
                    return;
                }
                
                if (tipModal.reason === 'Autre' && !tipModal.customReason) {
                    tipModal.error = "Veuillez pr√©ciser le motif.";
                    return;
                }
                
                const targetUser = selectedProspecteur.value || user.name;
                if (!targetUser) {
                    tipModal.error = "Utilisateur non trouv√©.";
                    return;
                }
                
                try {
                    const finalReason = tipModal.reason === 'Autre' ? tipModal.customReason : tipModal.reason;
                    const amount = tipModal.operation === 'add' ? tipModal.amount : -tipModal.amount;
                    
                    // Cr√©er la transaction
                    const transactionData = {
                        userId: targetUser,
                        type: 'pourboire',
                        amount: amount,
                        label: `Pourboire ${tipModal.operation === 'add' ? 'ajout√©' : 'retir√©'} - ${finalReason}`,
                        date: new Date(),
                        reason: finalReason,
                        note: tipModal.note || '',
                        hidden: false,
                        createdAt: new Date()
                    };
                    
                    await db.collection('transactions').add(transactionData);
                    
                    // Mettre √† jour le total des pourboires du mois dans le profil utilisateur
                    const member = teamList.value.find(m => m.name === targetUser);
                    if (member) {
                        const currentMonth = new Date().getMonth() + 1;
                        const currentYear = new Date().getFullYear();
                        const currentMonthKey = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
                        
                        const memberRef = db.collection('users').doc(member.id);
                        const doc = await memberRef.get();
                        let existingTips = doc.data().tips || {};
                        const currentTips = (existingTips[currentMonthKey] || 0) + amount;
                        existingTips[currentMonthKey] = Math.max(0, currentTips); // Ne pas aller en n√©gatif
                        
                        await memberRef.update({ tips: existingTips });
                    }
                    
                    // Recharger les transactions imm√©diatement
                    if (user.role === 'admin' && selectedProspecteur.value) {
                        await loadProspecteurData(selectedProspecteur.value);
                    } else if (user.role !== 'admin') {
                        // Forcer le rechargement des transactions
                        await loadUserTransactions();
                    }
                    
                    tipModal.open = false;
                    
                    // Attendre un peu pour que Firestore se synchronise
                    setTimeout(async () => {
                        if (user.role !== 'admin') {
                            await loadUserTransactions();
                        }
                    }, 500);
                } catch (err) {
                    console.error('Erreur sauvegarde pourboire:', err);
                    tipModal.error = "Erreur lors de la sauvegarde. Veuillez r√©essayer.";
                }
            };

            // PORTAFEUILLE FUNCTIONS
            const filterProspectors = () => {
                // La recherche est g√©r√©e par displayedProspectors computed
            };

            const selectProspecteur = async (name) => {
                selectedProspecteur.value = name;
                portefeuilleSearch.value = '';
                filteredProspectors.value = [];
                
                // Charger les donn√©es du prospecteur
                await loadProspecteurData(name);
            };

            const loadProspecteurData = async (name) => {
                // D√©truire l'ancien listener s'il existe
                if (adminTransactionListener) {
                    adminTransactionListener();
                    adminTransactionListener = null;
                }
                
                // Charger d'abord les transactions une fois pour avoir les donn√©es imm√©diatement
                try {
                    const transSnapshot = await db.collection('transactions')
                        .where('userId', '==', name)
                        .get();
                    
                    transactions.value = transSnapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data,
                            date: data.date && data.date.toDate ? data.date.toDate() : (data.date ? new Date(data.date) : new Date())
                        };
                    });
                    
                    // Trier par date d√©croissante
                    transactions.value.sort((a, b) => {
                        const dateA = a.date instanceof Date ? a.date.getTime() : new Date(a.date).getTime();
                        const dateB = b.date instanceof Date ? b.date.getTime() : new Date(b.date).getTime();
                        return dateB - dateA;
                    });
                } catch (err) {
                    console.error('Erreur chargement transactions:', err);
                    transactions.value = [];
                }
                
                // Cr√©er un listener en temps r√©el pour les transactions (admin)
                const query = db.collection('transactions')
                    .where('userId', '==', name);
                
                adminTransactionListener = query.onSnapshot(snap => {
                    const newTransactions = snap.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data,
                            date: data.date && data.date.toDate ? data.date.toDate() : (data.date ? new Date(data.date) : new Date())
                        };
                    });
                    
                    // Trier par date d√©croissante
                    newTransactions.sort((a, b) => {
                        const dateA = a.date instanceof Date ? a.date.getTime() : new Date(a.date).getTime();
                        const dateB = b.date instanceof Date ? b.date.getTime() : new Date(b.date).getTime();
                        return dateB - dateA;
                    });
                    
                    transactions.value = newTransactions;
                }, err => {
                    console.error('Erreur listener transactions admin:', err);
                    // En cas d'erreur, recharger une fois
                    db.collection('transactions')
                        .where('userId', '==', name)
                        .get()
                        .then(transSnapshot => {
                            transactions.value = transSnapshot.docs.map(doc => {
                                const data = doc.data();
                                return {
                                    id: doc.id,
                                    ...data,
                                    date: data.date && data.date.toDate ? data.date.toDate() : (data.date ? new Date(data.date) : new Date())
                                };
                            });
                            transactions.value.sort((a, b) => {
                                const dateA = a.date instanceof Date ? a.date.getTime() : new Date(a.date).getTime();
                                const dateB = b.date instanceof Date ? b.date.getTime() : new Date(b.date).getTime();
                                return dateB - dateA;
                            });
                        });
                });

                // Charger les param√®tres du prospecteur
                const member = teamList.value.find(m => m.name === name);
                if (member) {
                    const currentMonth = new Date().getMonth() + 1;
                    const currentYear = new Date().getFullYear();
                    const currentMonthKey = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
                    
                    prospecteurEdit.tips = (member.tips && member.tips[currentMonthKey]) || 0;
                }
            };

            const saveProspecteurSettings = async () => {
                // Cette fonction n'est plus utilis√©e car on utilise maintenant le modal pourboire
                // Conserv√©e pour compatibilit√© mais ne fait plus rien
            };

            const hideTransaction = async (transId) => {
                await db.collection('transactions').doc(transId).update({ hidden: true });
                const trans = transactions.value.find(t => t.id === transId);
                if (trans) trans.hidden = true;
            };

            const showTransaction = async (transId) => {
                await db.collection('transactions').doc(transId).update({ hidden: false });
                const trans = transactions.value.find(t => t.id === transId);
                if (trans) trans.hidden = false;
            };

            const deleteTransaction = async (transId) => {
                openCustomConfirm("Supprimer la transaction", "Voulez-vous vraiment supprimer cette transaction ? Cette action est irr√©versible.", async () => {
                    await db.collection('transactions').doc(transId).delete();
                    customConfirmModal.open = false;
                });
            };

            // Obtenir les d√©tails du RDV depuis une transaction
            const getRdvFromTransaction = (trans) => {
                if (trans.rdvId) {
                    return rdvList.value.find(r => r.id === trans.rdvId);
                }
                return null;
            };

            const getTransactionIcon = (type) => {
                const icons = {
                    'salaire': 'fa-solid fa-money-bill-wave',
                    'prime': 'fa-solid fa-trophy',
                    'pourboire': 'fa-solid fa-hand-holding-dollar',
                    'virement': 'fa-solid fa-exchange-alt',
                    'ca': 'fa-solid fa-euro-sign',
                    'rdv_honore': 'fa-solid fa-check-circle',
                    'bonus': 'fa-solid fa-star'
                };
                return icons[type] || 'fa-solid fa-circle';
            };

            // Cr√©er une transaction automatiquement quand un RDV est honor√© (10‚Ç¨ par RDV)
            const createTransactionForRdv = async (rdv) => {
                if (!rdv || !rdv.createdBy) return;
                
                // Ne pas cr√©er de transaction si c'est un admin qui a cr√©√© le RDV
                const userObj = teamList.value.find(u => u.name === rdv.createdBy);
                const isRoleAdmin = userObj && userObj.role === 'admin';
                const isNameInAdminList = adminNamesList.value.includes(rdv.createdBy);
                
                if (isNameInAdminList || isRoleAdmin) {
                    // C'est un admin, on ne cr√©e pas de transaction (l'admin garde tout le CA)
                    return;
                }
                
                try {
                    const basePrice = parseFloat(globalCommission.base) || 10;
                    
                    // V√©rifier si une transaction existe d√©j√† pour ce RDV (v√©rification renforc√©e)
                    const existingTrans = await db.collection('transactions')
                        .where('rdvId', '==', rdv.id)
                        .where('type', '==', 'rdv_honore')
                        .get();
                    
                    if (!existingTrans.empty) {
                        // Transaction d√©j√† cr√©√©e, ne pas en cr√©er une nouvelle
                        console.log('Transaction d√©j√† existante pour RDV:', rdv.id);
                        return;
                    }
                    
                    // Double v√©rification : v√©rifier aussi dans les transactions locales
                    const localExisting = transactions.value.find(t => t.rdvId === rdv.id && t.type === 'rdv_honore');
                    if (localExisting) {
                        console.log('Transaction d√©j√† existante localement pour RDV:', rdv.id);
                        return;
                    }
                    
                    const transactionData = {
                        userId: rdv.createdBy,
                        type: 'rdv_honore',
                        amount: basePrice,
                        label: `RDV honor√© - ${rdv.civilite} ${rdv.nom}${rdv.tag === 'OK M' ? ' (OK M)' : ''}`,
                        date: rdv.date ? new Date(rdv.date) : new Date(),
                        rdvId: rdv.id,
                        agenceId: rdv.agenceId || null,
                        hidden: false,
                        createdAt: new Date()
                    };
                    
                    await db.collection('transactions').add(transactionData);
                    console.log('Transaction cr√©√©e pour RDV:', rdv.id, 'Montant:', basePrice, '‚Ç¨ (m√™me avec ou sans mandat)');
                    
                    // V√©rifier et cr√©er les transactions de bonus si n√©cessaire
                    await checkAndCreateBonusTransactions(rdv.createdBy);
                } catch (err) {
                    console.error('Erreur cr√©ation transaction RDV:', err);
                }
            };

            // Supprimer les transactions associ√©es √† un RDV quand le statut "honor√©" est retir√©
            const deleteTransactionsForRdv = async (rdvId) => {
                try {
                    // R√©cup√©rer toutes les transactions associ√©es √† ce RDV
                    const transactions = await db.collection('transactions')
                        .where('rdvId', '==', rdvId)
                        .get();
                    
                    // Supprimer toutes les transactions trouv√©es
                    const batch = db.batch();
                    transactions.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    
                    if (transactions.docs.length > 0) {
                        await batch.commit();
                        
                        // V√©rifier et recalculer les bonus apr√®s suppression
                        const rdv = rdvList.value.find(r => r.id === rdvId);
                        if (rdv && rdv.createdBy) {
                            await checkAndCreateBonusTransactions(rdv.createdBy);
                        }
                    }
                } catch (err) {
                    console.error('Erreur suppression transactions RDV:', err);
                }
            };

            // V√©rifier et cr√©er les transactions de bonus quand les paliers sont atteints
            const checkAndCreateBonusTransactions = async (userId) => {
                try {
                    const basePrice = parseFloat(globalCommission.base) || 10;
                    const bonusThreshold = parseInt(globalCommission.threshold) || 21;
                    const bonusStep = parseInt(globalCommission.step) || 10;
                    const bonusAmount = parseFloat(globalCommission.amount) || 100;

                    const now = new Date();
                    const currentMonth = now.getMonth();
                    const currentYear = now.getFullYear();

                    // R√©cup√©rer tous les RDV honor√©s de ce mois
                    const honoredRdvs = rdvList.value.filter(r => {
                        if (r.statut !== 'honore' || r.createdBy !== userId || !r.date) return false;
                        const d = new Date(r.date);
                        return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                    });

                    const count = honoredRdvs.length;

                    if (count < bonusThreshold) return; // Pas encore de bonus

                    // Calculer le nombre de paliers atteints
                    const tiersReached = Math.floor((count - bonusThreshold) / bonusStep) + 1;

                    // R√©cup√©rer les transactions de bonus existantes pour ce mois
                    const existingBonus = await db.collection('transactions')
                        .where('userId', '==', userId)
                        .where('type', '==', 'bonus')
                        .get();

                    const existingTiers = new Set();
                    existingBonus.docs.forEach(doc => {
                        const data = doc.data();
                        if (data.bonusTier) {
                            existingTiers.add(data.bonusTier);
                        }
                    });

                    // Cr√©er les transactions de bonus manquantes
                    for (let tier = 1; tier <= tiersReached; tier++) {
                        if (existingTiers.has(tier)) continue; // Bonus d√©j√† cr√©√© pour ce palier

                        const transactionData = {
                            userId: userId,
                            type: 'bonus',
                            amount: bonusAmount,
                            label: `Bonus Palier ${tier} - ${count} RDV honor√©s`,
                            date: new Date(),
                            bonusTier: tier,
                            bonusCount: bonusThreshold + (tier - 1) * bonusStep,
                            hidden: false,
                            createdAt: new Date()
                        };

                        await db.collection('transactions').add(transactionData);
                    }
                } catch (err) {
                    console.error('Erreur cr√©ation transactions bonus:', err);
                }
            };

            const currentFullDateLabel = computed(() => new Date().toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }));
            const conversionRate = computed(() => { const honored = rdvList.value.filter(r => r.statut === 'honore').length; const noshow = rdvList.value.filter(r => r.statut === 'pas_venu').length; const totalFinished = honored + noshow; if (totalFinished === 0) return 0; return Math.round((honored / totalFinished) * 100); });
            const conversionRateColor = computed(() => { const rate = conversionRate.value; if (rate < 50) return 'bg-red-50 border-red-200 text-red-700'; if (rate < 80) return 'bg-orange-50 border-orange-200 text-orange-700'; return 'bg-green-50 border-green-200 text-green-700'; });
            // V√©rification de l'√©tat de connexion Google Calendar
            const isGoogleCalendarConnected = computed(() => {
                // Pour l'admin, utiliser le token admin
                if (user.role === 'admin') {
                    return googleCalendarConnected.value && googleAccessToken.value && googleAccessToken.value.trim() !== '';
                }
                // Pour les prospecteurs, v√©rifier si l'admin est connect√© OU si le prospecteur est connect√©
                return (googleCalendarConnected.value && googleAccessToken.value && googleAccessToken.value.trim() !== '') ||
                       (prospecteurGoogleCalendarConnected.value && prospecteurGoogleCalendarToken.value && prospecteurGoogleCalendarToken.value.trim() !== '' && !prospecteurGoogleCalendarTokenExpired.value);
            });
            
            // Fonction pour obtenir le token actif (admin ou prospecteur)
            const getActiveGoogleToken = () => {
                // Si l'admin est connect√©, utiliser son token
                if (googleCalendarConnected.value && googleAccessToken.value) {
                    return googleAccessToken.value;
                }
                // Sinon, utiliser le token du prospecteur s'il est connect√© et non expir√©
                if (prospecteurGoogleCalendarConnected.value && prospecteurGoogleCalendarToken.value && !prospecteurGoogleCalendarTokenExpired.value) {
                    return prospecteurGoogleCalendarToken.value;
                }
                return null;
            };
            
            // Variable computed pour le token actif
            const activeGoogleToken = computed(() => getActiveGoogleToken());
            
            // √âtat r√©el de la validit√© du token (mis √† jour dynamiquement)
            const googleCalendarTokenValid = ref(false);
            const checkingToken = ref(false);
            const tokenExpirationTime = ref(null); // Timestamp d'expiration du token
            const lastTokenValue = ref(null); // Pour d√©tecter si le token a chang√©
            
            // √âtat r√©el de la validit√© du token prospecteur
            const prospecteurGoogleCalendarTokenValid = ref(false);
            const checkingProspecteurToken = ref(false);
            
            // Fonction pour v√©rifier et mettre √† jour l'√©tat r√©el du token
            const checkAndUpdateTokenStatus = async () => {
                if (checkingToken.value) return; // √âviter les v√©rifications multiples simultan√©es
                checkingToken.value = true;
                
                if (!googleCalendarConnected.value || !googleAccessToken.value) {
                    googleCalendarTokenValid.value = false;
                    tokenExpirationTime.value = null;
                    lastTokenValue.value = null;
                    checkingToken.value = false;
                    return;
                }
                
                try {
                    const isValid = await checkGoogleCalendarTokenValid();
                    const currentToken = googleAccessToken.value;
                    const tokenChanged = currentToken !== lastTokenValue.value;
                    
                    googleCalendarTokenValid.value = isValid;
                    
                    // Les tokens Google expirent g√©n√©ralement apr√®s 1 heure
                    // Ne r√©initialiser le timer que si c'est une nouvelle connexion (token chang√©) ou si le token n'√©tait pas valide avant
                    if (isValid) {
                        // Si le token a chang√© ou si on n'a pas encore de timestamp, r√©initialiser le timer
                        if (tokenChanged || !tokenExpirationTime.value) {
                            tokenExpirationTime.value = Date.now() + (55 * 60 * 1000);
                            lastTokenValue.value = currentToken;
                        }
                        // Sinon, on garde le tokenExpirationTime existant pour que le compteur continue de diminuer
                    } else {
                        tokenExpirationTime.value = null;
                        lastTokenValue.value = null;
                    }
                } catch (err) {
                    console.error('Erreur v√©rification token:', err);
                    googleCalendarTokenValid.value = false;
                    tokenExpirationTime.value = null;
                } finally {
                    checkingToken.value = false;
                }
            };
            
            // Fonction pour v√©rifier et mettre √† jour l'√©tat r√©el du token prospecteur
            const checkAndUpdateProspecteurTokenStatus = async () => {
                if (checkingProspecteurToken.value) return;
                checkingProspecteurToken.value = true;
                
                // Si l'admin est connect√©, utiliser son token
                if (googleCalendarConnected.value && googleAccessToken.value) {
                    const isTokenValid = await checkGoogleCalendarTokenValid();
                    prospecteurGoogleCalendarTokenValid.value = isTokenValid;
                    checkingProspecteurToken.value = false;
                    return;
                }
                
                if (!prospecteurGoogleCalendarConnected.value || !prospecteurGoogleCalendarToken.value) {
                    prospecteurGoogleCalendarTokenValid.value = false;
                    checkingProspecteurToken.value = false;
                    return;
                }
                
                try {
                    // Tester le token en faisant une requ√™te simple √† l'API Google Calendar
                    const response = await fetch('https://www.googleapis.com/calendar/v3/users/me/calendarList?maxResults=1', {
                        headers: {
                            'Authorization': `Bearer ${prospecteurGoogleCalendarToken.value}`
                        }
                    });
                    
                    // Si 401 ou 403, le token est invalide ou expir√©
                    if (response.status === 401 || response.status === 403) {
                        prospecteurGoogleCalendarTokenValid.value = false;
                        prospecteurGoogleCalendarTokenExpired.value = true;
                        prospecteurTokenExpirationTime.value = null;
                    } else {
                        prospecteurGoogleCalendarTokenValid.value = response.ok;
                        if (response.ok) {
                            prospecteurGoogleCalendarTokenExpired.value = false;
                            const currentProspecteurToken = prospecteurGoogleCalendarToken.value;
                            const prospecteurTokenChanged = currentProspecteurToken !== lastProspecteurTokenValue.value;
                            
                            // Ne r√©initialiser le timer que si le token a chang√© ou si on n'a pas encore de timestamp
                            if (prospecteurTokenChanged || !prospecteurTokenExpirationTime.value) {
                                prospecteurTokenExpirationTime.value = Date.now() + (55 * 60 * 1000);
                                lastProspecteurTokenValue.value = currentProspecteurToken;
                            }
                        }
                    }
                } catch (err) {
                    console.error('Erreur v√©rification token prospecteur:', err);
                    prospecteurGoogleCalendarTokenValid.value = false;
                    prospecteurGoogleCalendarTokenExpired.value = true;
                    prospecteurTokenExpirationTime.value = null;
                } finally {
                    checkingProspecteurToken.value = false;
                }
            };
            
            // Variable r√©active pour forcer la mise √† jour du compteur en temps r√©el
            const tokenTimerTick = ref(Date.now());
            
            // Mettre √† jour le temps toutes les secondes pour que le compteur diminue en temps r√©el
            setInterval(() => {
                if (tokenExpirationTime.value && googleCalendarTokenValid.value) {
                    // Forcer la mise √† jour en cr√©ant une nouvelle valeur
                    tokenTimerTick.value = Date.now();
                }
                // Mettre √† jour aussi pour les prospecteurs
                if (prospecteurTokenExpirationTime.value && prospecteurGoogleCalendarTokenValid.value) {
                    // Forcer la mise √† jour en cr√©ant une nouvelle valeur
                    prospecteurTokenTimerTick.value = Date.now();
                }
            }, 1000);
            
            // Mettre √† jour aussi toutes les 100ms pour un affichage plus fluide des secondes
            setInterval(() => {
                if (tokenExpirationTime.value && googleCalendarTokenValid.value) {
                    tokenTimerTick.value = Date.now();
                }
                if (prospecteurTokenExpirationTime.value && prospecteurGoogleCalendarTokenValid.value) {
                    prospecteurTokenTimerTick.value = Date.now();
                }
            }, 100);
            
            // Calcul du temps restant avant expiration (mis √† jour en temps r√©el)
            const tokenTimeRemaining = computed(() => {
                if (!tokenExpirationTime.value || !googleCalendarTokenValid.value) {
                    return null;
                }
                const remaining = tokenExpirationTime.value - tokenTimerTick.value;
                if (remaining <= 0) {
                    // Si le temps est √©coul√©, v√©rifier √† nouveau le token
                    setTimeout(() => {
                        checkAndUpdateTokenStatus();
                    }, 1000);
                    return null;
                }
                
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                return { minutes, seconds };
            });
            
            // V√©rifier le token quand on ouvre les param√®tres Google Calendar
            watch(() => settingsModal.tab, (newTab) => {
                if (newTab === 'GoogleCalendar' && user.role === 'admin') {
                    checkAndUpdateTokenStatus();
                }
            });
            
            const conversionEmoji = computed(() => { const rate = conversionRate.value; if (rate < 50) return 'üò≠'; if (rate < 80) return 'ü§®'; return 'ü§©'; });

            const login = () => { 
                if(loginEmail.value === 'contact@cetn-solutions.fr' && loginPass.value === '130724') {
                    loginAdminSelection.value = true;
                    return;
                }
                const match = teamList.value.find(u => u.email === loginEmail.value && u.password === loginPass.value);
                if(match) {
                    if(match.blocked) { alert("Acc√®s bloqu√©. Contactez l'administrateur."); return; }
                    setUserSession('prospecteur', match.name);
                    checkAndShowWelcome(match.email, match.name);
                } else {
                    alert('Identifiants incorrects');
                }
            };

            const finalizeAdminLogin = (name) => {
                setUserSession('admin', name);
                checkAndShowWelcome(loginEmail.value, name);
                loginAdminSelection.value = false;
            };

            const setUserSession = (role, name) => {
                user.logged = true; user.role = role; user.name = name;
                localStorage.setItem('crm_user', JSON.stringify({ role, name }));
                loadRdvData();
                
                // Initialiser Google Calendar pour les prospecteurs apr√®s connexion
                if (role !== 'admin' && typeof google !== 'undefined' && google.accounts) {
                    setTimeout(() => {
                        initProspecteurGoogleCalendar();
                    }, 500);
                }
            };

            const logout = () => { 
                user.logged=false; loginPass.value=''; loginEmail.value=''; rdvList.value = [];
                checksDone.value = false; 
                localStorage.removeItem('crm_user'); 
                if(rdvListener) rdvListener();
                if(transactionListener) {
                    transactionListener();
                    transactionListener = null;
                }
                if(adminTransactionListener) {
                    adminTransactionListener();
                    adminTransactionListener = null;
                }
            };

            const addTeamMember = async () => { if(!newMember.name || !newMember.email || !newMember.password) return; await db.collection('users').add({ ...newMember, role: 'prospecteur', blocked: false, created: new Date() }); newMember.name = ''; newMember.email = ''; newMember.password = ''; newMember.assignedAgencies = []; };
            const toggleBlockTeamMember = async (member) => { await db.collection('users').doc(member.id).update({ blocked: !member.blocked }); };
            const deleteTeamMember = async (member) => { 
                openCustomConfirm("Supprimer un membre", "Voulez-vous vraiment supprimer l'acc√®s de " + member.name + " ?", async () => {
                    await db.collection('users').doc(member.id).delete();
                    customConfirmModal.open = false;
                });
            };
            
            const openTeamEdit = (member) => {
                teamEditModal.member = member;
                teamEditModal.name = member.name;
                teamEditModal.email = member.email;
                teamEditModal.password = ''; 
                teamEditModal.assignedAgencies = member.assignedAgencies || [];
                teamEditModal.open = true;
            };

            const saveTeamMemberEdit = async () => {
                if (!teamEditModal.member) return;
                const updateData = { 
                    name: teamEditModal.name, 
                    email: teamEditModal.email, 
                    assignedAgencies: teamEditModal.assignedAgencies
                };
                if(teamEditModal.password && teamEditModal.password.trim() !== '') { updateData.password = teamEditModal.password; }
                await db.collection('users').doc(teamEditModal.member.id).update(updateData);
                teamEditModal.open = false;
            };

            const addAdminName = async () => { if(!newAdminName.value) return; const updated = [...adminNamesList.value, newAdminName.value]; await db.collection('settings').doc('global').set({adminNames: updated}, {merge:true}); newAdminName.value = ''; };
            const removeAdminName = async (name) => { const updated = adminNamesList.value.filter(n => n !== name); await db.collection('settings').doc('global').set({adminNames: updated}, {merge:true}); };

            const addNote = async () => {
                if(!newNoteText.value.trim() || !clientModal.rdv) return;
                const noteObj = { text: newNoteText.value, author: user.name, date: new Date().toISOString() };
                if(!clientModal.rdv.notes) clientModal.rdv.notes = [];
                clientModal.rdv.notes.push(noteObj);
                await db.collection('rendezvous').doc(clientModal.rdv.id).update({ notes: clientModal.rdv.notes });
                newNoteText.value = '';
            };
            const deleteNote = async (rdv, index) => {
                openCustomConfirm("Supprimer la note", "Voulez-vous supprimer cette note ?", async () => {
                    rdv.notes.splice(index, 1);
                    await db.collection('rendezvous').doc(rdv.id).update({ notes: rdv.notes });
                    customConfirmModal.open = false;
                });
            };

            const onWizardPhoneInput = (e) => { const digits = normalizePhone(e.target.value).slice(0, 10); form.telephone = formatPhone(digits); if (digits.length === 10) { const exist = rdvList.value.find(r => normalizePhone(r.telephone) === digits); if (exist) { form.nom = exist.nom; form.civilite = exist.civilite; form.modele = exist.modele; clientExists.value = true; } else { clientExists.value = false; } } else { clientExists.value = false; } };
            const onModalPhoneInput = (e) => { const digits = normalizePhone(e.target.value).slice(0, 10); if (!clientModal.rdv) return; clientModal.rdv.telephone = formatPhone(digits); };
            const startWizard = async (skipSteps = false) => { 
                Object.assign(form, { agence:null, civilite:'M.', nom:'', telephone:'', date:'', heure:'', modele:'', source:'', pasDeNumero: false, lienAnnonce:'', motif:'', motifCustom:'' }); 
                clientExists.value = false; 
                wizard.step = skipSteps && form.agence && form.date && form.heure ? 2 : 1; 
                wizard.open = true; 
                wizard.loading = false; 
                agencySearch.value = ''; 
                showCustomTime.value = false;
                
                // V√©rifier la connexion Google Calendar au d√©marrage
                const isTokenValid = await checkGoogleCalendarTokenValid();
                const isConnected = isGoogleCalendarConnected.value && isTokenValid;
                
                if (!isConnected) {
                    // Afficher le modal de connexion si pas connect√©
                    googleCalendarDisconnectedModal.fromWizard = true;
                    googleCalendarDisconnectedModal.open = true;
                }
            };
            
            // G√©rer la fermeture du modal de connexion
            const handleCloseDisconnectedModal = () => {
                googleCalendarDisconnectedModal.open = false;
                
                // Si le modal vient du wizard et que la connexion est obligatoire, fermer le wizard
                if (googleCalendarDisconnectedModal.fromWizard && googleCalendarRequired.value) {
                    wizard.open = false;
                }
                // Si pas obligatoire, le wizard reste ouvert et on peut continuer
                
                googleCalendarDisconnectedModal.fromWizard = false;
            };
            
            // Sauvegarder le param√®tre de connexion obligatoire
            const saveGoogleCalendarRequired = async () => {
                try {
                    await db.collection('settings').doc('google_calendar_required').set({
                        required: googleCalendarRequired.value
                    });
                } catch (err) {
                    console.error('Erreur sauvegarde param√®tre:', err);
                }
            };
            const checkAgenceAndProceed = async (ag) => { if(ag.statut_activite === 'pause' && ag.motif_pause === 'Vacances' && ag.date_pause_fin) { const today = new Date().toISOString().split('T')[0]; if (today > ag.date_pause_fin) { await db.collection('agences').doc(ag.id).update({ statut_activite: 'actif', motif_pause: '', date_pause_debut: '', date_pause_fin: '' }); ag.statut_activite = 'actif'; } } if(ag.statut_activite === 'pause') { pausedAgencyModal.agency = ag; pausedAgencyModal.open = true; return; } form.agence = ag; wizard.step++; };
            
            const getPauseMessage = (ag) => { 
                if(!ag) return ''; 
                if (ag.motif_pause === 'Vacances') {
                    if (ag.date_pause_debut && ag.date_pause_fin) {
                        const start = new Date(ag.date_pause_debut).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long' });
                        const end = new Date(ag.date_pause_fin).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long' });
                        return `Cette agence est en vacances du ${start} au ${end}.`; 
                    } else { return "Cette agence est en vacances (Dates non pr√©cis√©es)."; }
                }
                if(ag.motif_pause === 'Complet') return "Cette agence est compl√®te (Surcharg√©e)."; 
                if(ag.motif_pause === 'Travaux') return "Cette agence est ferm√©e pour travaux."; 
                return `Cette agence est indisponible pour le motif suivant : ${ag.motif_pause || 'Pause momentan√©e'}.`; 
            };
            
            const selectSource = (src) => { if (!form.modele || !form.modele.trim()) { alert('Merci de renseigner le mod√®le du v√©hicule avant de continuer.'); return; } form.source = src; wizard.step++; };
            
            // Fonction pour valider et envoyer le SMS (avec v√©rification Google Calendar)
            const validateAndSendSMS = async () => {
                // Emp√™cher les doubles clics
                if (wizard.loading) return;
                
                // OUVRIR LE SMS IMM√âDIATEMENT avec les donn√©es du formulaire
                const tempRdv = {
                    ...form,
                    agenceId: form.agence.id,
                    statut: 'confirme'
                };
                const smsLink = generateMsgLink(tempRdv, 'confirm');
                if (smsLink) {
                    window.open(smsLink, '_blank');
                }
                
                // Cr√©er le RDV en arri√®re-plan (sans bloquer)
                finalizeRdv('confirme', false).catch(err => {
                    console.error('Erreur cr√©ation RDV:', err);
                });
            };
            
            // Fonction pour cr√©er un RDV "a_confirmer" avec SMS
            const finalizeRdvWithSMS = async (statut) => {
                // Emp√™cher les doubles clics
                if (wizard.loading) return;
                
                // Cr√©er le RDV
                await finalizeRdv(statut, false);
                
                // Ouvrir le SMS apr√®s cr√©ation
                const tempRdv = {
                    ...form,
                    agenceId: form.agence.id,
                    statut: statut
                };
                const smsLink = generateMsgLink(tempRdv, 'confirm');
                if (smsLink) {
                    window.open(smsLink, '_blank');
                }
            };
            
            const finalizeRdv = async (statut, openSMS = false) => {
                // Emp√™cher les doubles clics
                if (wizard.loading) return;
                wizard.loading = true;
                
                try {
                    // V√âRIFIER LA CONNEXION √Ä L'AGENDA AVANT D'ENVOYER LE SMS
                    const isTokenValid = await checkGoogleCalendarTokenValid();
                    const isConnected = isGoogleCalendarConnected.value && isTokenValid;
                    
                    const motifFinal = form.motif === '__CUSTOM__' ? (form.motifCustom || '') : (form.motif || '');
                    const rdvData = {
                        ...form,
                        agenceId: form.agence.id,
                        prix: parseFloat(form.agence.prix)||0,
                        statut,
                        motif: motifFinal,
                        created: new Date(),
                        createdBy: user.name,
                        rappelFait: false,
                        dansAgenda: false,
                        enAttenteAgenda: !isConnected // Mettre en attente si pas connect√©
                    };
                    delete rdvData.motifCustom;
                    
                    const docRef = await db.collection('rendezvous').add(rdvData);
                    const newRdv = { id: docRef.id, ...rdvData };
                    
                    let placedInAgenda = false;
                    
                    // Ajouter automatiquement √† Google Calendar seulement si connect√©
                    if (isConnected) {
                        try {
                            const eventResult = await createGoogleCalendarEvent(newRdv);
                            // Marquer comme ajout√© dans l'agenda et stocker l'ID de l'√©v√©nement
                            await db.collection('rendezvous').doc(docRef.id).update({ 
                                dansAgenda: true,
                                googleCalendarEventId: eventResult.eventId || eventResult.id,
                                enAttenteAgenda: false
                            });
                            newRdv.dansAgenda = true;
                            newRdv.googleCalendarEventId = eventResult.eventId || eventResult.id;
                            newRdv.enAttenteAgenda = false;
                            placedInAgenda = true;
                        } catch (err) {
                            console.error('Erreur lors de l\'ajout √† Google Calendar:', err);
                            
                            // D√©tecter les erreurs de token m√™me apr√®s v√©rification
                            const errorMessage = err.message || '';
                            const isTokenError = errorMessage.includes('401') || 
                                               errorMessage.includes('403') || 
                                               errorMessage.includes('Invalid Credentials') ||
                                               errorMessage.includes('expired') ||
                                               errorMessage.includes('token');
                            
                            if (isTokenError) {
                                // Mettre en attente si erreur de token
                                await db.collection('rendezvous').doc(docRef.id).update({ 
                                    enAttenteAgenda: true
                                });
                            }
                            // Ne pas bloquer la cr√©ation du RDV si l'ajout √† Google Calendar √©choue
                        }
                    }
                    
                    // Afficher le message de confirmation moderne
                    if (placedInAgenda) {
                        showNotification('Rendez-vous cr√©√© et plac√© dans l\'agenda Google Calendar', 'success', 'fa-calendar-check');
                    } else if (!isConnected) {
                        // Ne pas afficher de notification si on n'est pas connect√© (le modal s'en charge)
                    } else {
                        showNotification('Rendez-vous cr√©√©. Connectez Google Calendar dans les param√®tres pour l\'ajouter √† l\'agenda', 'warning', 'fa-calendar-plus');
                    }
                    
                    // Ouvrir le SMS si demand√© et si le statut est "confirme"
                    if (openSMS && statut === 'confirme') {
                        const smsLink = generateMsgLink(newRdv, 'confirm');
                        if (smsLink) {
                            window.open(smsLink, '_blank');
                        }
                    }
                    
                    wizard.open = false;
                    
                    // Retourner le RDV cr√©√© pour pouvoir v√©rifier son √©tat
                    return newRdv;
                } catch (err) {
                    console.error('Erreur lors de la cr√©ation du rendez-vous:', err);
                    alert('‚ùå Erreur lors de la cr√©ation du rendez-vous. Veuillez r√©essayer.');
                    return null;
                } finally {
                    wizard.loading = false;
                }
            };
            
            const openRdvFiche = async (r) => { 
                // Charger les donn√©es compl√®tes depuis Firestore pour avoir les notes √† jour
                try {
                    const doc = await db.collection('rendezvous').doc(r.id).get();
                    const data = doc.data();
                    // Convertir les timestamps Firestore en conservant le format original pour compatibilit√©
                    const fullData = { 
                        id: doc.id, 
                        ...data,
                        // Conserver le timestamp Firestore tel quel, on le convertira √† l'affichage
                        created: data.created || r.created
                    };
                    clientModal.rdv = fullData; 
                    showDiscountInput.value = !!fullData.geste_commercial; 
                    clientModal.view = 'main';
                    clientModal.open = true;
                } catch (error) {
                    // Fallback si erreur
                    clientModal.rdv = { ...r }; 
                    showDiscountInput.value = !!r.geste_commercial; 
                    clientModal.view = 'main';
                    clientModal.open = true;
                }
            };
            const updateRdv = async (r) => { await db.collection('rendezvous').doc(r.id).update(r); clientModal.open = false; };
            const toggleOkM = async (rdv, e) => {
                if (e) e.stopPropagation();
                const newTag = rdv.tag === 'OK M' ? null : 'OK M';
                await db.collection('rendezvous').doc(rdv.id).update({ tag: newTag });
                rdv.tag = newTag;
            };
            const resendReminder = async (r) => {
                const rappelType = getRappelType(r);
                const link = generateMsgLink(r, rappelType);
                if(link) {
                    window.open(link, '_blank');
                }
            };
            const softDeleteRdv = (r) => { selectedIds.value = [r.id]; clientModal.open = false; openBulkConfirm('soft_delete', 'Envoyer ce RDV √† la corbeille ?'); };
            const deleteRdv = softDeleteRdv;
            
            const openCancelChoice = (r) => { cancelModal.rdv = r; cancelModal.open = true; };
            const confirmCancel = async (r, who) => { 
                const wasHonored = r.statut === 'honore';
                await db.collection('rendezvous').doc(r.id).update({ statut: 'annule', motif: who, honorBilling: null }); 
                if (wasHonored) {
                    await deleteTransactionsForRdv(r.id);
                }
                cancelModal.open = false; 
                clientModal.open = false; 
            };
            const quickCancel = async (r) => { 
                openCustomConfirm("Annulation Rapide", "Annuler ce rendez-vous maintenant ?", async () => { 
                    const wasHonored = r.statut === 'honore';
                    await db.collection('rendezvous').doc(r.id).update({ statut: 'annule', honorBilling: null }); 
                    if (wasHonored) {
                        await deleteTransactionsForRdv(r.id);
                    }
                    customConfirmModal.open = false; 
                }); 
            };
            
            const openEdit = (r) => { editModal.rdv = r; editModal.form = { civilite: r.civilite || 'M.', nom: r.nom, telephone: r.telephone, modele: r.modele, source: r.source, agenceId: r.agenceId }; editModal.open = true; };
           const saveEdit = async () => {
                if(!editModal.rdv) return;

                // 1. D√©tection du changement d'agence
                const oldAgencyId = editModal.rdv.agenceId;
                const newAgencyId = editModal.form.agenceId;
                const agencyChanged = oldAgencyId !== newAgencyId;

                // On pr√©pare les donn√©es mises √† jour
                const updatedRdvData = { ...editModal.rdv, ...editModal.form };

                // Mise √† jour du prix si l'agence change (optionnel, selon ta logique)
                if (agencyChanged) {
                    const newAgency = agences.value.find(a => a.id === newAgencyId);
                    if (newAgency) { editModal.form.prix = parseFloat(newAgency.prix) || 0; }
                }

                // 2. Sauvegarde en Base de Donn√©es (Firebase)
                await db.collection('rendezvous').doc(editModal.rdv.id).update(editModal.form);

                // 3. GESTION INTELLIGENTE GOOGLE CALENDAR
                if (editModal.rdv.dansAgenda && editModal.rdv.googleCalendarEventId && googleCalendarConnected.value && googleAccessToken.value) {
                    try {
                        if (agencyChanged) {
                            // üö® CAS CRITIQUE : CHANGEMENT D'AGENCE
                            console.log("üîÑ Changement d'agence d√©tect√© : D√©placement du RDV...");

                            // A. On supprime l'√©v√©nement de l'ANCIEN agenda (en utilisant l'ancien ID agence)
                            // On cr√©e un faux objet RDV avec les vieilles infos juste pour la suppression
                            const oldRdvRef = { 
                                ...editModal.rdv, 
                                agenceId: oldAgencyId 
                            };
                            await deleteGoogleCalendarEvent(oldRdvRef);

                            // B. On cr√©e l'√©v√©nement dans le NOUVEL agenda
                            // On s'assure que les donn√©es envoy√©es ont le bon nouvel ID d'agence
                            updatedRdvData.agenceId = newAgencyId; 
                            const newEventResult = await createGoogleCalendarEvent(updatedRdvData);

                            // C. On met √† jour le nouvel ID Google dans la base de donn√©es
                            await db.collection('rendezvous').doc(editModal.rdv.id).update({
                                googleCalendarEventId: newEventResult.id
                            });

                            // D. Mise √† jour locale pour que l'interface soit juste
                            editModal.rdv.googleCalendarEventId = newEventResult.id;
                            console.log("‚úÖ RDV d√©plac√© avec succ√®s vers la nouvelle agence !");

                        } else {
                            // CAS STANDARD : M√™me agence, juste une modif d'heure/nom/etc.
                            await updateGoogleCalendarEvent(updatedRdvData);
                            console.log("‚úÖ RDV mis √† jour (m√™me agence)");
                        }
                    } catch (err) {
                        console.error('Erreur lors de la synchro Google Calendar:', err);
                        alert("‚ö†Ô∏è Donn√©es sauvegard√©es, mais erreur de synchro Google Calendar : " + err.message);
                    }
                }
                
                // Mise √† jour de l'affichage local final
                Object.assign(editModal.rdv, editModal.form);
                editModal.open = false;
            };

            const openHonorCheck = (r) => { honorModal.rdv = r; honorModal.open = true; };
            const finalizeHonor = async (withMandat) => {
                if(!honorModal.rdv) return;
                const r = honorModal.rdv;
                const patch = { statut: 'honore', honorBilling: 'facture', tag: withMandat ? 'OK M' : null };
                await db.collection('rendezvous').doc(r.id).update(patch);
                Object.assign(r, patch);
                if(clientModal.rdv && clientModal.rdv.id === r.id) { Object.assign(clientModal.rdv, patch); }
                // Cr√©er la transaction automatiquement
                await createTransactionForRdv(r);
                launchFireworks();
                honorModal.open = false;
                clientModal.open = false;
            };
            
            const openDiscountModal = () => { discountModal.amount = null; discountModal.reason = ''; discountModal.customReason = ''; discountModal.error = ''; discountModal.open = true; };
            const saveDiscount = async () => {
                discountModal.error = '';
                if (!discountModal.amount && discountModal.amount !== 0) { discountModal.error = "Veuillez entrer un montant."; return; }
                let finalReason = discountModal.reason;
                if (finalReason === 'Autre') finalReason = discountModal.customReason;
                if (!finalReason) { discountModal.error = "Veuillez choisir ou saisir un motif."; return; }
                if (clientModal.rdv) {
                    clientModal.rdv.geste_commercial = discountModal.amount;
                    clientModal.rdv.motif_geste = finalReason;
                    await db.collection('rendezvous').doc(clientModal.rdv.id).update({ geste_commercial: discountModal.amount, motif_geste: finalReason });
                }
                discountModal.open = false;
            };
            const removeDiscount = async () => {
                openCustomConfirm("Supprimer le geste", "Voulez-vous retirer le geste commercial ?", async () => {
                    if (clientModal.rdv) {
                        clientModal.rdv.geste_commercial = null; clientModal.rdv.motif_geste = null;
                        await db.collection('rendezvous').doc(clientModal.rdv.id).update({ geste_commercial: firebase.firestore.FieldValue.delete(), motif_geste: firebase.firestore.FieldValue.delete() });
                        discountModal.open = false; customConfirmModal.open = false;
                    }
                });
            }

            const updateStatus = async (r, s) => { 
                if(s==='honor_fact') { openHonorCheck(r); return; } 
                
                // V√©rifier si le RDV √©tait honor√© avant le changement
                const wasHonored = r.statut === 'honore';
                
                const patch = { statut: s };
                if(s==='honor_free') { patch.statut='honore'; patch.honorBilling='gratuit'; launchFireworks(); } 
                if(s==='noshow') { patch.statut='pas_venu'; patch.honorBilling=null; const today = new Date().toISOString().split('T')[0]; let type = 'noshow'; if(r.date === today) type = 'noshow_today'; const link = generateMsgLink(r, type); if(link) window.open(link, '_blank'); } 
                if(s==='reset') { patch.statut='confirme'; patch.honorBilling=null; patch.motif=null; delete patch.geste_commercial; delete patch.motif_geste; patch.tag = null; } 
                
                await db.collection('rendezvous').doc(r.id).update(patch); 
                Object.assign(r, patch);
                if(clientModal.rdv && clientModal.rdv.id === r.id) Object.assign(clientModal.rdv, patch);
                
                // Si le RDV √©tait honor√© et ne l'est plus, supprimer les transactions associ√©es
                if(wasHonored && patch.statut !== 'honore') {
                    await deleteTransactionsForRdv(r.id);
                }
                
                // Cr√©er la transaction si le RDV est honor√©
                if(s==='honor_free') {
                    await createTransactionForRdv(r);
                    await checkAndCreateBonusTransactions(r.createdBy);
                }
                
                clientModal.open = false; 
            };

            const launchFireworks = () => { for(let i=0; i<50; i++) { const c = document.createElement('div'); c.className = 'confetti'; c.style.left = Math.random() * 100 + 'vw'; c.style.top = -10 + 'px'; c.style.backgroundColor = ['#ff0', '#f00', '#0f0', '#00f', '#f0f'][Math.floor(Math.random()*5)]; c.style.animationDuration = (Math.random() * 2 + 1) + 's'; document.body.appendChild(c); setTimeout(() => c.remove(), 3000); } };

            const openRescheduleModal = (r) => { rescheduleModal.rdv = r; rescheduleModal.date = r.date; rescheduleModal.heure = r.heure; rescheduleModal.oldDate = r.date; rescheduleModal.oldHeure = r.heure; rescheduleModal.motif = ''; rescheduleModal.step = 1; rescheduleModal.open = true; };
            const confirmRescheduleStep1 = async () => { 
                if(!rescheduleModal.date || !rescheduleModal.heure) return alert('Date/Heure requises'); 
                const newDate = rescheduleModal.date; const newHeure = rescheduleModal.heure;
                const oldInfo = `Ancien : ${formatDateFr(rescheduleModal.rdv.date)} √† ${rescheduleModal.rdv.heure}`;
                const motifText = rescheduleModal.motif ? ` Motif: ${rescheduleModal.motif}` : '';
                const note = { text: `üìÖ RDV Report√©. ${oldInfo}${motifText}`, author: 'Syst√®me', date: new Date().toISOString() };
                let notes = rescheduleModal.rdv.notes || []; notes.push(note);
                
                // Mettre √† jour le RDV avec le motif de d√©placement
                const updateData = { 
                    date: newDate, 
                    heure: newHeure, 
                    notes: notes, 
                    rappelFait: false,
                    motifDeplacement: rescheduleModal.motif || null
                };
                
                await db.collection('rendezvous').doc(rescheduleModal.rdv.id).update(updateData); 
                
                // Mettre √† jour l'objet local
                Object.assign(rescheduleModal.rdv, updateData);
                if(clientModal.rdv && clientModal.rdv.id === rescheduleModal.rdv.id) { 
                    Object.assign(clientModal.rdv, updateData);
                }
                
                // Mettre √† jour l'√©v√©nement Google Calendar si pr√©sent
                if (googleCalendarConnected.value && googleAccessToken.value && rescheduleModal.rdv.dansAgenda && rescheduleModal.rdv.googleCalendarEventId) {
                    try {
                        await updateGoogleCalendarEvent(rescheduleModal.rdv);
                    } catch (err) {
                        console.error('Erreur lors de la mise √† jour Google Calendar:', err);
                    }
                }
                
                rescheduleModal.step = 2; 
            };
            const sendRescheduleSMS = () => { const link = generateMsgLink(rescheduleModal.rdv, 'reschedule'); if(link) window.open(link, '_blank'); rescheduleModal.open = false; clientModal.open = false; rescheduleModal.step = 1; };
            const openReschedule = (r) => openRescheduleModal(r);
            
            const changeView = async (v) => { 
                view.value = v; 
                displayLimit.value = 20; 
                if(v !== 'list') { currentFilter.value = 'all'; } 
                selectedIds.value = [];
                
                // Charger les transactions si on acc√®de au portefeuille (prospecteur)
                if (v === 'portefeuille' && user.role !== 'admin' && user.name) {
                    await loadUserTransactions();
                }
            };
            
            const loadUserTransactions = async () => {
                try {
                    // D√©truire l'ancien listener s'il existe
                    if (transactionListener) {
                        transactionListener();
                        transactionListener = null;
                    }
                    
                    // Cr√©er les transactions manquantes pour les RDV d√©j√† honor√©s
                    await createMissingTransactionsForUser(user.name);
                    
                    // Charger d'abord les transactions une fois pour avoir les donn√©es imm√©diatement
                try {
                    const transSnapshot = await db.collection('transactions')
                        .where('userId', '==', user.name)
                        .get();
                    
                    transactions.value = transSnapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data,
                            date: data.date && data.date.toDate ? data.date.toDate() : (data.date ? new Date(data.date) : new Date())
                        };
                        });
                        
                        // Trier par date d√©croissante
                        transactions.value.sort((a, b) => {
                            const dateA = a.date instanceof Date ? a.date.getTime() : new Date(a.date).getTime();
                            const dateB = b.date instanceof Date ? b.date.getTime() : new Date(b.date).getTime();
                            return dateB - dateA;
                        });
                    } catch (loadErr) {
                        console.error('Erreur chargement initial transactions:', loadErr);
                    }
                    
                    // Cr√©er un listener en temps r√©el pour les transactions (sans orderBy pour √©viter les probl√®mes d'index)
                    const query = db.collection('transactions')
                        .where('userId', '==', user.name);
                    
                    transactionListener = query.onSnapshot(snap => {
                        const newTransactions = snap.docs.map(doc => {
                            const data = doc.data();
                            return {
                                id: doc.id,
                                ...data,
                                date: data.date && data.date.toDate ? data.date.toDate() : (data.date ? new Date(data.date) : new Date())
                            };
                        });
                        
                        // Trier par date d√©croissante
                        newTransactions.sort((a, b) => {
                            const dateA = a.date instanceof Date ? a.date.getTime() : new Date(a.date).getTime();
                            const dateB = b.date instanceof Date ? b.date.getTime() : new Date(b.date).getTime();
                            return dateB - dateA;
                        });
                        
                        transactions.value = newTransactions;
                    }, err => {
                        console.error('Erreur listener transactions:', err);
                        // En cas d'erreur, recharger une fois
                        db.collection('transactions')
                            .where('userId', '==', user.name)
                            .get()
                            .then(transSnapshot => {
                                transactions.value = transSnapshot.docs.map(doc => {
                                    const data = doc.data();
                                    return {
                                        id: doc.id,
                                        ...data,
                                        date: data.date && data.date.toDate ? data.date.toDate() : (data.date ? new Date(data.date) : new Date())
                                    };
                                });
                                transactions.value.sort((a, b) => {
                                    const dateA = a.date instanceof Date ? a.date.getTime() : new Date(a.date).getTime();
                                    const dateB = b.date instanceof Date ? b.date.getTime() : new Date(b.date).getTime();
                                    return dateB - dateA;
                                });
                            });
                    });
                } catch (err) {
                    console.error('Erreur chargement transactions utilisateur:', err);
                    transactions.value = [];
                }
            };

            // Cr√©er les transactions manquantes pour les RDV honor√©s qui n'ont pas encore de transaction
            const createMissingTransactionsForUser = async (userId) => {
                try {
                    // R√©cup√©rer tous les RDV honor√©s de cet utilisateur
                    const honoredRdvs = rdvList.value.filter(r => 
                        r.statut === 'honore' && r.createdBy === userId
                    );
                    
                    if (honoredRdvs.length === 0) return;
                    
                    // R√©cup√©rer toutes les transactions existantes pour cet utilisateur
                    const existingTrans = await db.collection('transactions')
                        .where('userId', '==', userId)
                        .get();
                    
                    const existingRdvIds = new Set();
                    existingTrans.docs.forEach(doc => {
                        const data = doc.data();
                        if (data.rdvId && data.type === 'rdv_honore') {
                            existingRdvIds.add(data.rdvId);
                        }
                    });
                    
                    // Cr√©er les transactions manquantes
                    const transactionsToCreate = [];
                    
                    const basePrice = parseFloat(globalCommission.base) || 10;
                    
                    for (const rdv of honoredRdvs) {
                        if (existingRdvIds.has(rdv.id)) continue;
                        
                        const transactionData = {
                            userId: userId,
                            type: 'rdv_honore',
                            amount: basePrice,
                            label: `RDV honor√© - ${rdv.civilite} ${rdv.nom}${rdv.tag === 'OK M' ? ' (OK M)' : ''}`,
                            date: rdv.date ? new Date(rdv.date) : new Date(),
                            rdvId: rdv.id,
                            agenceId: rdv.agenceId || null,
                            hidden: false,
                            createdAt: new Date()
                        };
                        
                        transactionsToCreate.push(transactionData);
                    }
                    
                    // Cr√©er les transactions par batch de 500
                    if (transactionsToCreate.length > 0) {
                        for (let i = 0; i < transactionsToCreate.length; i += 500) {
                            const batch = db.batch();
                            const batchData = transactionsToCreate.slice(i, i + 500);
                            
                            batchData.forEach(transactionData => {
                                const transactionRef = db.collection('transactions').doc();
                                batch.set(transactionRef, transactionData);
                            });
                            
                            await batch.commit();
                        }
                    }
                    
                    // V√©rifier et cr√©er les transactions de bonus apr√®s avoir cr√©√© les transactions RDV
                    await checkAndCreateBonusTransactions(userId);
                } catch (err) {
                    console.error('Erreur cr√©ation transactions manquantes:', err);
                }
            };
            const resetListFilters = () => { search.value = ''; listFilters.agenceId = ''; listFilters.date = ''; listFilters.prospecteur = ''; currentFilter.value = 'all'; displayLimit.value=20; };
            const showUpcoming = () => { currentFilter.value = 'upcoming'; view.value = 'list'; displayLimit.value=20; fromDashboard.value = true; };
            const showLive = () => { currentFilter.value = 'live'; view.value = 'list'; displayLimit.value=20; fromDashboard.value = true; };
            const showHonored = () => { currentFilter.value = 'honored'; view.value = 'list'; displayLimit.value=20; fromDashboard.value = true; };
            const showNoShow = () => { currentFilter.value = 'noshow'; view.value = 'list'; displayLimit.value=20; fromDashboard.value = true; };
            const showCancelled = () => { currentFilter.value = 'cancelled'; view.value = 'list'; displayLimit.value=20; fromDashboard.value = true; };
            const goBackFromList = () => { if (fromDashboard.value) { view.value = 'dashboard'; fromDashboard.value = false; resetListFilters(); } else { resetListFilters(); } };

            const filteredAgences = computed(() => { 
                let source = visibleAgencies.value;
                if(!agencySearch.value) return source; 
                const s = agencySearch.value.toLowerCase(); 
                return source.filter(ag => ag.nom.toLowerCase().includes(s)); 
            });
            const trashList = computed(() => rdvList.value.filter(r => r.statut === 'poubelle'));
            const trashCount = computed(() => trashList.value.length);
            const restoreRdv = (r) => { selectedIds.value = [r.id]; openBulkConfirm('restore_trash', 'Restaurer ce rendez-vous ?'); };
            const hardDeleteRdv = (r) => { selectedIds.value = [r.id]; openBulkConfirm('delete_trash', 'Supprimer D√âFINITIVEMENT ce rendez-vous ? (Irr√©versible)'); };

            const isEnCours = (r) => { if(!r.date || !r.heure) return false; const start = new Date(r.date+'T'+r.heure); const end = new Date(start.getTime() + 60*60*1000); return now.value >= start && now.value < end && ['confirme','a_confirmer'].includes(r.statut); };
            const activeRdvCount = computed(() => rdvList.value.filter(r => isEnCours(r)).length);

            const filteredList = computed(() => { 
                let l = rdvList.value.filter(r => r.statut !== 'poubelle'); 
                if (listFilters.agenceId) l = l.filter(r => r.agenceId === listFilters.agenceId);
                if (listFilters.prospecteur) l = l.filter(r => r.createdBy === listFilters.prospecteur);
                if (listFilters.date) l = l.filter(r => r.date === listFilters.date);
                if (currentFilter.value === 'upcoming') { if (!listFilters.date) { const today = new Date().toISOString().split('T')[0]; l = l.filter(r => r.statut === 'confirme' && r.date >= today); } } 
                else if (currentFilter.value === 'live') l = l.filter(r => isEnCours(r));
                else if (currentFilter.value === 'honored') l = l.filter(r => r.statut === 'honore');
                else if (currentFilter.value === 'noshow') l = l.filter(r => r.statut === 'pas_venu');
                else if (currentFilter.value === 'cancelled') l = l.filter(r => r.statut === 'annule');
                if (search.value) { const s = search.value.toLowerCase(); const sDigits = normalizePhone(search.value); l = l.filter(r => (r.nom || '').toLowerCase().includes(s) || (r.modele || '').toLowerCase().includes(s) || (sDigits && normalizePhone(r.telephone).includes(sDigits))); } 
                const noBaseFilter = currentFilter.value === 'all' && !listFilters.agenceId && !listFilters.prospecteur && !listFilters.date && !search.value;
                if (noBaseFilter) return [];
                return l.sort((a, b) => { if (a.date !== b.date) return a.date.localeCompare(b.date); return (a.heure || '').localeCompare(b.heure || ''); });
            });
            const displayedList = computed(() => filteredList.value.slice(0, displayLimit.value));

            const allProspectors = computed(() => { const activeTeam = teamList.value.map(u => u.name); const admins = adminNamesList.value; return Array.from(new Set([...activeTeam, ...admins])).sort(); });
            
            // Filtrer uniquement les prospecteurs (sans les admins)
            const onlyProspectors = computed(() => {
                return teamList.value.filter(u => {
                    const isAdminName = adminNamesList.value.includes(u.name);
                    const isAdminRole = u.role === 'admin';
                    return !isAdminName && !isAdminRole;
                });
            });
            const selectAll = (e) => { const list = view.value === 'trash' ? trashList.value : filteredList.value; if(e.target.checked) { selectedIds.value = list.map(r => r.id); } else { selectedIds.value = []; } };
            const toggleSelection = (id) => { if(selectedIds.value.includes(id)) { selectedIds.value = selectedIds.value.filter(i => i !== id); } else { selectedIds.value.push(id); } };
            const isAllSelected = computed(() => { const list = view.value === 'trash' ? trashList.value : filteredList.value; return list.length > 0 && selectedIds.value.length === list.length; });

            const openBulkConfirm = (action, label) => { bulkModal.action = action; bulkModal.label = label; bulkModal.open = true; };
            const openCustomConfirm = (title, message, onConfirm) => { customConfirmModal.title = title; customConfirmModal.message = message; customConfirmModal.onConfirm = onConfirm; customConfirmModal.open = true; };
            const executeBulkAction = async () => {
                const batch = db.batch();
                if (bulkModal.action === 'soft_delete') { 
                    selectedIds.value.forEach(id => { 
                        const ref = db.collection('rendezvous').doc(id); 
                        batch.update(ref, { statut: 'poubelle' }); 
                    }); 
                }
                else if (bulkModal.action === 'restore_selection' || bulkModal.action === 'restore_trash') { 
                    selectedIds.value.forEach(id => { 
                        const ref = db.collection('rendezvous').doc(id); 
                        batch.update(ref, { statut: 'confirme' }); 
                    }); 
                }
                else if (bulkModal.action === 'delete_selection' || bulkModal.action === 'delete_trash') { 
                    // Supprimer les √©v√©nements Google Calendar avant de supprimer les RDV
                    if (googleCalendarConnected.value && googleAccessToken.value) {
                        for (const id of selectedIds.value) {
                            const rdv = rdvList.value.find(r => r.id === id);
                            if (rdv && rdv.dansAgenda && rdv.googleCalendarEventId) {
                                try {
                                    await deleteGoogleCalendarEvent(rdv);
                                } catch (err) {
                                    console.error('Erreur suppression Google Calendar:', err);
                                }
                            }
                        }
                    }
                    selectedIds.value.forEach(id => { 
                        const ref = db.collection('rendezvous').doc(id); 
                        batch.delete(ref); 
                    }); 
                }
                else if (bulkModal.action === 'empty_trash') { 
                    // Supprimer les √©v√©nements Google Calendar avant de vider la corbeille
                    if (googleCalendarConnected.value && googleAccessToken.value) {
                        for (const r of trashList.value) {
                            if (r.dansAgenda && r.googleCalendarEventId) {
                                try {
                                    await deleteGoogleCalendarEvent(r);
                                } catch (err) {
                                    console.error('Erreur suppression Google Calendar:', err);
                                }
                            }
                        }
                    }
                    trashList.value.forEach(r => { 
                        const ref = db.collection('rendezvous').doc(r.id); 
                        batch.delete(ref); 
                    }); 
                }
                else { 
                    let patch = {}; 
                    if (bulkModal.action === 'honor_fact') { 
                        patch = { statut: 'honore', honorBilling: 'facture' }; 
                    } else if (bulkModal.action === 'noshow') { 
                        patch = { statut: 'pas_venu', honorBilling: null }; 
                    } 
                    if(Object.keys(patch).length > 0) { 
                        selectedIds.value.forEach(id => { 
                            const ref = db.collection('rendezvous').doc(id); 
                            batch.update(ref, patch); 
                        }); 
                    } 
                }
                await batch.commit();
                
                // Cr√©er les transactions pour les RDV honor√©s en masse
                if (bulkModal.action === 'honor_fact') {
                    for (const id of selectedIds.value) {
                        const rdv = rdvList.value.find(r => r.id === id);
                        if (rdv) {
                            await createTransactionForRdv(rdv);
                        }
                    }
                }
                
                selectedIds.value = []; bulkModal.open = false;
            };

            const formatDateFr = (d) => d ? new Date(d).toLocaleDateString('fr-FR') : '';
            const formatDateShort = (d) => d ? new Date(d).toLocaleDateString('fr-FR', {day:'numeric', month:'short'}) : '';
            const formatDateLong = (d) => d ? new Date(d).toLocaleDateString('fr-FR', {weekday:'long', day:'numeric', month:'long'}) : '';
            const formatPrice = (p) => new Intl.NumberFormat('fr-FR', {style:'currency', currency:'EUR'}).format(p);
            
            // Helper pour convertir les timestamps Firestore en Date
            const getCreatedDate = (rdv) => {
                if (!rdv || !rdv.created) return null;
                try {
                    let date = null;
                    if (rdv.created && typeof rdv.created.toDate === 'function') {
                        date = rdv.created.toDate();
                    } else if (rdv.created && rdv.created.seconds) {
                        date = new Date(rdv.created.seconds * 1000);
                    } else if (rdv.created) {
                        date = new Date(rdv.created);
                    }
                    // V√©rifier que la date est valide
                    if (date && !isNaN(date.getTime())) {
                        return date;
                    }
                } catch (e) {
                    console.error('Erreur conversion date:', e);
                }
                return null;
            };
            
            const getCreatedTime = (rdv) => {
                const date = getCreatedDate(rdv);
                if (!date) return '';
                try {
                    return date.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
                } catch (e) {
                    return '';
                }
            };
            const getAgenceName = (id) => agences.value.find(a=>a.id===id)?.nom || 'Inconnue';
            const getRappelType = (r) => { if (!r.date) return 'rappel'; const today = new Date(); today.setHours(0,0,0,0); const d = new Date(r.date); d.setHours(0,0,0,0); const diffDays = Math.round((d - today) / 86400000); if (diffDays === 0) return 'rappel_today'; return 'rappel'; };
            const getRappelLabel = (r) => { const type = getRappelType(r); if(type === 'rappel_today') return 'Rappel Aujourd\'hui'; return 'Rappel Demain'; };
            
            const generateMsgLink = (data, type) => {
                const ag = agences.value.find(a => a.id === data.agenceId) || data.agence || {}; const tpls = ag.templates || {}; 
                let tpl = tpls[type]; 
                if (!tpl) tpl = getDefaultTemplate(type); 
                const showPrice = user.role === 'admin'; const prixStr = (showPrice && ag.prix) ? (ag.prix + '‚Ç¨ ' + (ag.tva ? 'TTC' : 'HT')) : ''; 
                let dateRappelStr = ''; if (data.date) { const today = new Date(); today.setHours(0,0,0,0); const d = new Date(data.date); d.setHours(0,0,0,0); const diffDays = Math.round((d - today) / 86400000); if (diffDays === 0) dateRappelStr = "aujourd'hui"; else if (diffDays === 1) dateRappelStr = "demain"; else dateRappelStr = formatDateLong(data.date); }
                let oldDateLong = ''; let oldHeure = ''; if(type === 'reschedule' && rescheduleModal.oldDate) { oldDateLong = formatDateLong(rescheduleModal.oldDate); oldHeure = rescheduleModal.oldHeure || ''; }
                let msg = tpl.replace(/{{CIVILITE}}/g, data.civilite||'').replace(/{{NOM}}/g, data.nom||'').replace(/{{PRENOM}}/g, data.nom||'').replace(/{{DATE_LONG}}/g, formatDateLong(data.date)).replace(/{{DATE_RAPPEL}}/g, dateRappelStr || formatDateLong(data.date)).replace(/{{HEURE}}/g, data.heure||'').replace(/{{MODELE}}/g, data.modele||'').replace(/{{AGENCE}}/g, ag.nom||'').replace(/{{ADRESSE}}/g, ag.adresse||'').replace(/{{PLAN}}/g, ag.maps||'').replace(/{{PRIX}}/g, prixStr).replace(/{{TAGLINE}}/g, ag.tagline||ag.nom||'');
                if(type === 'reschedule' && rescheduleModal.oldDate) { msg = msg.replace(/{{OLD_DATE_LONG}}/g, oldDateLong).replace(/{{OLD_HEURE}}/g, oldHeure); }
                const sep = navigator.userAgent.toLowerCase().includes('iphone') ? '&' : '?'; return `sms:${normalizePhone(data.telephone)}${sep}body=${encodeURIComponent(msg)}`;
            };
            const getDefaultTemplate = (t) => { if(t==='confirm') return "Bonjour {{NOM}}, RDV confirm√© le {{DATE_LONG}} √† {{HEURE}} chez {{AGENCE}}."; if(t==='reschedule') return "Report Confirm√© ‚Äì {{AGENCE}}\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nBonjour,\nVotre rendez-vous du {{OLD_DATE_LONG}} √† {{OLD_HEURE}} est report√©.\n\n‚óÜ Nouveau RDV :\n‚Üí Date & Heure : {{DATE_LONG}} √† {{HEURE}}\n‚Üí Mod√®le : {{MODELE}}\n‚óÜ Lieu : {{ADRESSE}}\n\nMerci de nous pr√©venir en cas d‚Äôimpr√©vu\n\n√Ä bient√¥t,\nL‚Äô√©quipe {{AGENCE}}"; if(t==='rappel') return "Rappel RDV demain √† {{HEURE}} chez {{AGENCE}}."; if(t==='noshow') return "Bonjour {{NOM}}, vous n'√™tes pas venu au RDV."; if(t==='noshow_today') return "Bonjour {{NOM}}, vous aviez RDV aujourd'hui √† {{HEURE}} chez {{AGENCE}}. Vous n'√™tes pas venu."; return ""; };
            const openSettings = () => { settingsModal.open = true; if(agences.value.length) editingMsgAgence.value = agences.value[0]; };
            const openAgencyEdit = async (ag) => { 
                if(ag) { 
                    editingAgency.value = JSON.parse(JSON.stringify(ag)); 
                    if(editingAgency.value.motif_pause && !['Vacances','Complet','Travaux'].includes(editingAgency.value.motif_pause)) { 
                        pauseReasonSelect.value = 'Autre'; 
                    } else { 
                        pauseReasonSelect.value = editingAgency.value.motif_pause || 'Vacances'; 
                    } 
                } else { 
                    editingAgency.value = { nom:'', adresse:'', maps:'', tagline:'', agendaEmail:'', agendaColor:'3', tva:true, prix:0, templates:{}, heureOuverture:'', heureFermeture:'', heurePauseDebut:'', heurePauseFin:'', horairesIdentiques:false, dimancheFerme:false }; 
                } 
                if(!editingAgency.value.statut_activite) editingAgency.value.statut_activite = 'actif'; 
                if(!editingAgency.value.agendaColor) editingAgency.value.agendaColor = '3'; 
                if(!editingAgency.value.heureOuverture) editingAgency.value.heureOuverture = '08:00'; 
                if(!editingAgency.value.heureFermeture) editingAgency.value.heureFermeture = '19:00';
                
                // Plus besoin de charger la liste des agendas, on utilise directement l'email 
            // Initialiser les horaires par jour si non d√©finis
            for(let i = 0; i < 7; i++) {
                if(!editingAgency.value[`horaires_${i}_ouverture`]) editingAgency.value[`horaires_${i}_ouverture`] = '';
                if(!editingAgency.value[`horaires_${i}_fermeture`]) editingAgency.value[`horaires_${i}_fermeture`] = '';
            }
            if(editingAgency.value.horairesIdentiques === undefined) editingAgency.value.horairesIdentiques = false;
            if(editingAgency.value.dimancheFerme === undefined) editingAgency.value.dimancheFerme = false;
            };
            
            const applyHorairesToAllDays = () => {
                if(editingAgency.value.horairesIdentiques && editingAgency.value.heureOuverture && editingAgency.value.heureFermeture) {
                    for(let i = 0; i < 6; i++) { // Pas le dimanche
                        editingAgency.value[`horaires_${i}_ouverture`] = editingAgency.value.heureOuverture;
                        editingAgency.value[`horaires_${i}_fermeture`] = editingAgency.value.heureFermeture;
                    }
                }
            };
            const updatePauseReason = () => { if(pauseReasonSelect.value !== 'Autre') { editingAgency.value.motif_pause = pauseReasonSelect.value; } else { editingAgency.value.motif_pause = ''; } };
            const calculateTTC = () => { const ht = parseFloat(editingAgency.value.prix_ht) || 0; const tva = parseFloat(editingAgency.value.tva_taux) || 0; editingAgency.value.prix = (ht * (1 + (tva / 100))).toFixed(2); };
            const saveEditingAgency = async () => { if(!editingAgency.value.nom) return; if(editingAgency.value.id) { await db.collection('agences').doc(editingAgency.value.id).update(editingAgency.value); } else { await db.collection('agences').add(editingAgency.value); } editingAgency.value = null; };
            const saveAgency = async (ag) => { await db.collection('agences').doc(ag.id).update(ag); };
            const deleteAgency = async (id) => { openCustomConfirm("Supprimer Agence", "Voulez-vous vraiment supprimer cette agence ?", async () => { await db.collection('agences').doc(id).delete(); customConfirmModal.open = false; }); };
            const addSource = async () => { if(!newSource.value) return; const updated = [...sourcesList.value, newSource.value]; await db.collection('settings').doc('global').set({sources:updated}, {merge:true}); newSource.value = ''; };
            const removeSource = async (src) => { const updated = sourcesList.value.filter(s => s !== src); await db.collection('settings').doc('global').set({sources:updated}, {merge:true}); };
            const addMotif = async () => { if(!newMotif.value) return; const updated = [...motifsList.value, newMotif.value]; await db.collection('settings').doc('global').set({motifs:updated}, {merge:true}); newMotif.value = ''; };
            const removeMotif = async (motif) => { const updated = motifsList.value.filter(m => m !== motif); await db.collection('settings').doc('global').set({motifs:updated}, {merge:true}); };
            const changeSourceLogo = async (src) => { const url = prompt("Entrez l'URL de l'image pour " + src + " :"); if(url) { const newLogos = { ...sourceLogos.value, [src]: url }; await db.collection('settings').doc('global').set({ logos: newLogos }, { merge: true }); } };
            const getLogo = (src) => { if(sourceLogos.value && sourceLogos.value[src]) return sourceLogos.value[src]; const s = (src||'').toLowerCase(); if(s.includes('coin')) return 'https://upload.wikimedia.org/wikipedia/commons/e/e1/Leboncoin_Logo_2016.svg'; if(s.includes('centrale')) return 'https://play-lh.googleusercontent.com/y3t-tGfqK_uJ0XQYV9xLqXoXwzX_zXwX_XwX_XwX_XwX_XwX_XwX_XwX_XwX_XwX_XwX_XwX_XwX_XwX_XwX_XwX_XwX_Xw'; if(s.includes('facebook')) return 'https://upload.wikimedia.org/wikipedia/commons/b/b8/2021_Facebook_icon.svg'; if(s.includes('google')) return 'https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg'; return `https://www.google.com/s2/favicons?domain=${s.replace(' ','')}.com&sz=64`; };
            const insertTag = (tag) => { if(!editingMsgAgence.value) return; const area = document.querySelector('textarea'); if(area) { area.setRangeText(tag, area.selectionStart, area.selectionEnd, 'end'); editingMsgAgence.value.templates[editingMsgType.value] = area.value; } };
            
            const dateOptions = computed(() => { const arr = []; const today = new Date(); const days = ['Dim','Lun','Mar','Mer','Jeu','Ven','Sam']; const months = ['Jan','F√©v','Mar','Avr','Mai','Juin','Juil','Ao√ªt','Sep','Oct','Nov','D√©c']; for(let i=0; i<14; i++) { const d = new Date(); d.setDate(today.getDate()+i); const year = d.getFullYear(); const month = String(d.getMonth() + 1).padStart(2, '0'); const day = String(d.getDate()).padStart(2, '0'); const localDateString = `${year}-${month}-${day}`; arr.push({ val: localDateString, dayName: days[d.getDay()], dayNum: d.getDate(), month: months[d.getMonth()], isToday: i === 0 }); } return arr; });
            const timeSlots = computed(() => { const slots = []; for (let hour = 9; hour <= 19; hour++) { const hStr = String(hour).padStart(2, '0'); slots.push(`${hStr}:00`); if (hour !== 19) { slots.push(`${hStr}:30`); } } return slots; });

            const commonCars = ref([
                "Renault Clio", "Renault Megane", "Renault Captur", "Renault Austral", "Renault Arkana", "Renault Zoe", "Renault Scenic", "Renault Espace", "Renault Twingo", "Renault Kangoo",
                "Peugeot 208", "Peugeot 2008", "Peugeot 308", "Peugeot 3008", "Peugeot 5008", "Peugeot 508", "Peugeot Rifter", "Peugeot Traveller",
                "Citroen C3", "Citroen C3 Aircross", "Citroen C4", "Citroen C5 Aircross", "Citroen C5 X", "Citroen Berlingo",
                "Volkswagen Golf", "Volkswagen Polo", "Volkswagen Tiguan", "Volkswagen T-Roc", "Volkswagen T-Cross", "Volkswagen Passat", "Volkswagen Touareg", "Volkswagen ID.3", "Volkswagen ID.4", "Volkswagen Golf R-Line",
                "Audi A1", "Audi A3", "Audi A4", "Audi A5", "Audi A6", "Audi Q2", "Audi Q3", "Audi Q5", "Audi Q7", "Audi Q8", "Audi RS3", "Audi RSQ3",
                "BMW S√©rie 1", "BMW S√©rie 3", "BMW S√©rie 5", "BMW X1", "BMW X3", "BMW X5", "BMW M2", "BMW M3", "BMW M4",
                "Mercedes Classe A", "Mercedes Classe C", "Mercedes Classe E", "Mercedes GLA", "Mercedes CLA", "Mercedes GLE", "Mercedes GLC",
                "Toyota Yaris", "Toyota Corolla", "Toyota C-HR", "Toyota RAV4", "Toyota Aygo", "Toyota Highlander",
                "Ford Fiesta", "Ford Puma", "Ford Focus", "Ford Kuga", "Ford Ranger", "Ford Mustang",
                "Fiat 500", "Fiat Panda", "Fiat Tipo", "Fiat 500X",
                "Dacia Sandero", "Dacia Duster", "Dacia Jogger", "Dacia Spring",
                "Hyundai Tucson", "Hyundai Kona", "Hyundai i20", "Hyundai i30", "Hyundai Ioniq 5",
                "Kia Sportage", "Kia Niro", "Kia Picanto", "Kia Rio", "Kia EV6",
                "Tesla Model 3", "Tesla Model Y", "Tesla Model S", "Tesla Model X",
                "Nissan Qashqai", "Nissan Juke", "Nissan X-Trail", "Nissan Leaf",
                "Mini Cooper", "Mini Countryman", "Mini Clubman",
                "Seat Ibiza", "Seat Leon", "Seat Arona", "Seat Ateca", "Seat Cupra",
                "Skoda Fabia", "Skoda Octavia", "Skoda Kamiq", "Skoda Karoq", "Skoda Kodiaq",
                "Volvo XC40", "Volvo XC60", "Volvo XC90",
                "Land Rover Evoque", "Land Rover Velar", "Land Rover Sport",
                "Porsche Macan", "Porsche Cayenne", "Porsche 911"
            ]);

            const getCalendarColor = (colorId) => {
                const colors = {
                    1: '#7986CB', // Lavender
                    2: '#33B679', // Sage
                    3: '#8E24AA', // Grape (Raisin)
                    4: '#E67C73', // Flamingo
                    5: '#F6BF26', // Banana
                    6: '#F4511E', // Tangerine
                    7: '#039BE5', // Peacock
                    8: '#616161', // Graphite
                    9: '#3F51B5', // Blueberry
                    10: '#0B8043', // Basil
                    11: '#D50000'  // Tomato
                };
                return colors[colorId] || colors[3]; // Par d√©faut Raisin
            };
            
            const pastePhoneNumber = async () => {
                try {
                    const text = await navigator.clipboard.readText();
                    if (text) {
                        let cleaned = text.replace(/^\+33/, '0').replace(/^0033/, '0').replace(/\D/g, '');
                        if (cleaned.startsWith('33') && cleaned.length === 11) cleaned = '0' + cleaned.substring(2);
                        if (cleaned.length > 10) cleaned = cleaned.substring(0, 10);
                        if (cleaned.length === 10) {
                            form.telephone = formatPhone(cleaned);
                            const digits = normalizePhone(form.telephone);
                            const exist = rdvList.value.find(r => normalizePhone(r.telephone) === digits);
                            if (exist) {
                                form.nom = exist.nom;
                                form.civilite = exist.civilite;
                                form.modele = exist.modele;
                                clientExists.value = true;
                            } else {
                                clientExists.value = false;
                            }
                        }
                    }
                } catch (err) {
                    console.error('Erreur collage:', err);
                }
            };
            
            // Fonctions Google Calendar API
            // IMPORTANT : Vous devez obtenir un Client ID Google OAuth 2.0
            // 1. Allez sur https://console.cloud.google.com/
            // 2. Cr√©ez un projet ou s√©lectionnez-en un
            // 3. Activez l'API Google Calendar
            // 4. Cr√©ez des identifiants OAuth 2.0 (Application Web)
            // 5. Ajoutez votre domaine dans les URI de redirection autoris√©s
            // 6. Copiez le Client ID et collez-le ci-dessous
            const GOOGLE_CLIENT_ID = '827395252951-arojm83q4sthmlf0gk8bvn9aa95kgijc.apps.googleusercontent.com';
            
           const initGoogleCalendar = () => {
                if (typeof google !== 'undefined' && google.accounts && GOOGLE_CLIENT_ID) {
                    googleTokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: GOOGLE_CLIENT_ID,
                        scope: 'https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/calendar.readonly',
                        callback: (tokenResponse) => {
                            if (tokenResponse.access_token) {
                                // 1. On r√©cup√®re l'email pour confirmer qui est connect√©
                                fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                                    headers: { 'Authorization': `Bearer ${tokenResponse.access_token}` }
                                })
                                .then(res => res.json())
                                .then(async (data) => {
                                    const email = data.email || '';
                                    
                                    // 2. SAUVEGARDE CLOUD (FIREBASE)
                                    // Seul l'admin a le droit d'√©craser le token global
                                    if (user.role === 'admin') {
                                        try {
                                            await db.collection('settings').doc('google_token').set({
                                                token: tokenResponse.access_token,
                                                email: email,
                                                updatedAt: new Date().toISOString()
                                            });
                                            
                                            // Mise √† jour locale imm√©diate pour l'admin
                                            googleAccessToken.value = tokenResponse.access_token;
                                            googleCalendarUserEmail.value = email;
                                            googleCalendarConnected.value = true;
                                            
                                            // Charger la liste des agendas
                                            await fetchGoogleCalendarList();
                                            
                                            // V√©rifier le token apr√®s connexion
                                            setTimeout(() => {
                                                checkAndUpdateTokenStatus();
                                            }, 1000);
                                            
                                            alert("‚úÖ Connexion Google r√©ussie et synchronis√©e avec toute l'√©quipe !");
                                            
                                            // Si on venait du wizard, fermer le modal de connexion
                                            if (googleCalendarDisconnectedModal.fromWizard) {
                                                googleCalendarDisconnectedModal.open = false;
                                                googleCalendarDisconnectedModal.fromWizard = false;
                                            }
                                        } catch (e) {
                                            console.error("Erreur sauvegarde token:", e);
                                            alert("Erreur lors de la sauvegarde de la connexion.");
                                        }
                                    } else {
                                        alert("Seul un administrateur peut modifier la connexion Google Agenda principale.");
                                    }
                                })
                                .catch(err => console.error('Erreur r√©cup√©ration email:', err));
                            }
                        }
                    });
                    
                    // V√©rifier et restaurer le token sauvegard√© si admin
                    if (user.role === 'admin') {
                        const savedToken = localStorage.getItem('google_calendar_token');
                        const savedEmail = localStorage.getItem('google_calendar_email');
                        if (savedToken && savedEmail) {
                            // V√©rifier si le token est encore valide en testant une requ√™te
                            fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                                headers: { 'Authorization': `Bearer ${savedToken}` }
                            })
                            .then(async (res) => {
                                if (res.ok) {
                                    googleAccessToken.value = savedToken;
                                    googleCalendarUserEmail.value = savedEmail;
                                    googleCalendarConnected.value = true;
                                    // Charger la liste des agendas au d√©marrage
                                    await fetchGoogleCalendarList();
                                } else {
                                    // Token invalide, nettoyer
                                    localStorage.removeItem('google_calendar_token');
                                    localStorage.removeItem('google_calendar_email');
                                    localStorage.removeItem('google_calendar_token_date');
                                }
                            })
                            .catch(() => {
                                // Erreur, nettoyer
                                localStorage.removeItem('google_calendar_token');
                                localStorage.removeItem('google_calendar_email');
                                localStorage.removeItem('google_calendar_token_date');
                            });
                        }
                    }
                }
            };
            
            const connectGoogleCalendar = () => {
                if (googleTokenClient) {
                    // Si on vient du wizard avec connexion obligatoire, noter qu'on attend la connexion
                    const wasFromWizard = googleCalendarDisconnectedModal.fromWizard && googleCalendarRequired.value;
                    const wasConnectedBefore = googleCalendarConnected.value;
                    
                    googleTokenClient.requestAccessToken({ prompt: 'consent' });
                    
                    // Si on vient du wizard avec connexion obligatoire, v√©rifier apr√®s un d√©lai si on s'est connect√©
                    if (wasFromWizard) {
                        setTimeout(async () => {
                            // V√©rifier si on est maintenant connect√©
                            const isTokenValid = await checkGoogleCalendarTokenValid();
                            const isConnected = isGoogleCalendarConnected.value && isTokenValid;
                            
                            // Si on n'est toujours pas connect√© et que c'√©tait obligatoire, fermer le wizard
                            if (!isConnected && googleCalendarRequired.value && googleCalendarDisconnectedModal.fromWizard) {
                                wizard.open = false;
                                googleCalendarDisconnectedModal.open = false;
                                googleCalendarDisconnectedModal.fromWizard = false;
                            }
                        }, 2000); // Attendre 2 secondes pour laisser le temps √† la popup de se fermer
                    }
                } else {
                    alert('Google Calendar n\'est pas encore initialis√©. Veuillez rafra√Æchir la page.');
                }
            };
            
            const disconnectGoogleCalendar = async () => {
                if (googleAccessToken.value && typeof google !== 'undefined' && google.accounts) {
                    google.accounts.oauth2.revoke(googleAccessToken.value);
                }
                
                // Si c'est l'admin qui se d√©connecte, supprimer le token de Firestore pour d√©connecter tout le monde
                if (user.role === 'admin') {
                    try {
                        await db.collection('settings').doc('google_token').delete();
                    } catch (err) {
                        console.error('Erreur lors de la suppression du token:', err);
                    }
                }
                
                googleCalendarConnected.value = false;
                googleCalendarUserEmail.value = '';
                googleAccessToken.value = '';
                googleCalendarTokenValid.value = false; // R√©initialiser l'√©tat du token
                localStorage.removeItem('google_calendar_token');
                localStorage.removeItem('google_calendar_email');
                googleCalendarList.value = [];
            };
            
            // Initialisation Google Calendar pour les prospecteurs
            const initProspecteurGoogleCalendar = () => {
                if (typeof google !== 'undefined' && google.accounts && GOOGLE_CLIENT_ID) {
                    prospecteurGoogleTokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: GOOGLE_CLIENT_ID,
                        scope: 'https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/calendar.readonly',
                        callback: (tokenResponse) => {
                            if (tokenResponse.access_token) {
                                // V√©rifier que l'email est bien agendacetnsolutions@gmail.fr
                                fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                                    headers: { 'Authorization': `Bearer ${tokenResponse.access_token}` }
                                })
                                .then(res => res.json())
                                .then(async (data) => {
                                    const email = data.email || '';
                                    
                                    // V√©rifier que l'email correspond √† agendacetnsolutions@gmail.fr
                                    if (email.toLowerCase() !== 'agendacetnsolutions@gmail.fr') {
                                        alert('‚ùå Vous devez vous connecter avec le compte agendacetnsolutions@gmail.fr');
                                        if (typeof google !== 'undefined' && google.accounts) {
                                            google.accounts.oauth2.revoke(tokenResponse.access_token);
                                        }
                                        return;
                                    }
                                    
                                    // Sauvegarder le token localement pour les prospecteurs
                                    prospecteurGoogleCalendarToken.value = tokenResponse.access_token;
                                    prospecteurGoogleCalendarConnected.value = true;
                                    prospecteurGoogleCalendarTokenExpired.value = false;
                                    // D√©finir l'expiration du token (55 minutes)
                                    prospecteurTokenExpirationTime.value = Date.now() + (55 * 60 * 1000);
                                    localStorage.setItem('prospecteur_google_calendar_token', tokenResponse.access_token);
                                    localStorage.setItem('prospecteur_google_calendar_email', email);
                                    localStorage.setItem('prospecteur_google_calendar_token_date', new Date().toISOString());
                                    
                                    // D√©marrer le rafra√Æchissement automatique
                                    startProspecteurTokenRefresh();
                                    
                                    showNotification('‚úÖ Connect√© √† Google Agenda avec succ√®s', 'success', 'fa-calendar-check');
                                    // V√©rifier le token apr√®s connexion
                                    setTimeout(() => {
                                        checkAndUpdateTokenStatus();
                                    }, 1000);
                                })
                                .catch(err => {
                                    console.error('Erreur r√©cup√©ration email:', err);
                                    showNotification('‚ùå Erreur lors de la connexion', 'error', 'fa-exclamation-triangle');
                                });
                            }
                        }
                    });
                    
                    // Restaurer le token sauvegard√© si disponible
                    const savedToken = localStorage.getItem('prospecteur_google_calendar_token');
                    const savedEmail = localStorage.getItem('prospecteur_google_calendar_email');
                    if (savedToken && savedEmail) {
                        // V√©rifier si le token est encore valide
                        fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                            headers: { 'Authorization': `Bearer ${savedToken}` }
                        })
                        .then(async (res) => {
                            if (res.ok) {
                                prospecteurGoogleCalendarToken.value = savedToken;
                                prospecteurGoogleCalendarConnected.value = true;
                                prospecteurGoogleCalendarTokenExpired.value = false;
                                // D√©finir l'expiration du token (55 minutes)
                                prospecteurTokenExpirationTime.value = Date.now() + (55 * 60 * 1000);
                                // D√©marrer le rafra√Æchissement automatique
                                startProspecteurTokenRefresh();
                            } else {
                                // Token invalide, nettoyer
                                localStorage.removeItem('prospecteur_google_calendar_token');
                                localStorage.removeItem('prospecteur_google_calendar_email');
                                localStorage.removeItem('prospecteur_google_calendar_token_date');
                                prospecteurGoogleCalendarConnected.value = false;
                                prospecteurGoogleCalendarTokenExpired.value = true;
                            }
                        })
                        .catch(() => {
                            localStorage.removeItem('prospecteur_google_calendar_token');
                            localStorage.removeItem('prospecteur_google_calendar_email');
                            localStorage.removeItem('prospecteur_google_calendar_token_date');
                            prospecteurGoogleCalendarConnected.value = false;
                            prospecteurGoogleCalendarTokenExpired.value = true;
                        });
                    }
                }
            };
            
            // Fonction pour g√©rer le clic sur le bouton Google Calendar des prospecteurs
            const handleProspecteurGoogleCalendar = () => {
                // Si l'admin est connect√©, on utilise son token automatiquement
                if (googleCalendarConnected.value && googleAccessToken.value) {
                    prospecteurGoogleCalendarConnected.value = true;
                    prospecteurGoogleCalendarToken.value = googleAccessToken.value;
                    prospecteurGoogleCalendarTokenExpired.value = false;
                    showNotification('‚úÖ Connect√© automatiquement via l\'admin', 'success', 'fa-calendar-check');
                    return;
                }
                
                // Si d√©j√† connect√©, proposer de se d√©connecter
                if (prospecteurGoogleCalendarConnected.value && prospecteurGoogleCalendarToken.value) {
                    if (confirm('Voulez-vous vous d√©connecter de Google Agenda ?')) {
                        disconnectProspecteurGoogleCalendar();
                    }
                    return;
                }
                
                // Si le token est expir√©, proposer de se reconnecter
                if (prospecteurGoogleCalendarTokenExpired.value) {
                    if (confirm('Votre session a expir√©. Voulez-vous vous reconnecter √† Google Agenda ?')) {
                        connectProspecteurGoogleCalendar();
                    }
                    return;
                }
                
                // Sinon, se connecter
                connectProspecteurGoogleCalendar();
            };
            
            // Fonction pour se connecter √† Google Calendar (prospecteurs)
            const connectProspecteurGoogleCalendar = () => {
                if (prospecteurGoogleTokenClient) {
                    prospecteurGoogleTokenClient.requestAccessToken({ prompt: 'consent' });
                } else {
                    initProspecteurGoogleCalendar();
                    if (prospecteurGoogleTokenClient) {
                        prospecteurGoogleTokenClient.requestAccessToken({ prompt: 'consent' });
                    } else {
                        alert('Google Calendar n\'est pas encore initialis√©. Veuillez rafra√Æchir la page.');
                    }
                }
            };
            
            // Fonction pour se d√©connecter de Google Calendar (prospecteurs)
            const disconnectProspecteurGoogleCalendar = () => {
                if (prospecteurGoogleCalendarToken.value && typeof google !== 'undefined' && google.accounts) {
                    google.accounts.oauth2.revoke(prospecteurGoogleCalendarToken.value);
                }
                prospecteurGoogleCalendarConnected.value = false;
                prospecteurGoogleCalendarToken.value = '';
                prospecteurGoogleCalendarTokenExpired.value = false;
                localStorage.removeItem('prospecteur_google_calendar_token');
                localStorage.removeItem('prospecteur_google_calendar_email');
                localStorage.removeItem('prospecteur_google_calendar_token_date');
                
                // Arr√™ter le rafra√Æchissement automatique
                if (prospecteurTokenRefreshInterval) {
                    clearInterval(prospecteurTokenRefreshInterval);
                    prospecteurTokenRefreshInterval = null;
                }
                
                showNotification('D√©connect√© de Google Agenda', 'info', 'fa-sign-out-alt');
            };
            
            // Fonction pour d√©marrer le rafra√Æchissement automatique du token (toutes les 45 minutes)
            const startProspecteurTokenRefresh = () => {
                // Arr√™ter l'ancien intervalle si existe
                if (prospecteurTokenRefreshInterval) {
                    clearInterval(prospecteurTokenRefreshInterval);
                    prospecteurTokenRefreshInterval = null;
                }
                
                // Ne pas d√©marrer si l'admin est connect√© (on utilise son token)
                if (googleCalendarConnected.value && googleAccessToken.value) {
                    return;
                }
                
                // Rafra√Æchir toutes les 45 minutes
                prospecteurTokenRefreshInterval = setInterval(() => {
                    if (prospecteurGoogleCalendarConnected.value && prospecteurGoogleCalendarToken.value && prospecteurGoogleTokenClient) {
                        // Ne pas rafra√Æchir si l'admin est connect√©
                        if (googleCalendarConnected.value && googleAccessToken.value) {
                            return;
                        }
                        
                        console.log("üîÑ Rafra√Æchissement automatique du token Google Agenda (prospecteur)...");
                        prospecteurGoogleTokenClient.requestAccessToken({ prompt: 'none' });
                    }
                }, 45 * 60 * 1000); // 45 minutes
            };
            
            // Fonction pour v√©rifier l'expiration du token
            const checkProspecteurTokenExpiration = async () => {
                // Si l'admin est connect√©, on utilise son token
                if (googleCalendarConnected.value && googleAccessToken.value) {
                    prospecteurGoogleCalendarConnected.value = true;
                    prospecteurGoogleCalendarToken.value = googleAccessToken.value;
                    prospecteurGoogleCalendarTokenExpired.value = false;
                    // Utiliser le token admin, donc pas d'expiration pour le prospecteur
                    prospecteurTokenExpirationTime.value = null;
                    return;
                }
                
                // V√©rifier le token local du prospecteur
                if (prospecteurGoogleCalendarToken.value) {
                    try {
                        const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                            headers: { 'Authorization': `Bearer ${prospecteurGoogleCalendarToken.value}` }
                        });
                        
                        if (!response.ok) {
                            // Token expir√©
                            prospecteurGoogleCalendarTokenExpired.value = true;
                            prospecteurGoogleCalendarConnected.value = false;
                            prospecteurTokenExpirationTime.value = null;
                            showNotification('‚ö†Ô∏è Votre session Google Agenda a expir√©. Veuillez vous reconnecter.', 'warning', 'fa-exclamation-triangle');
                        } else {
                            prospecteurGoogleCalendarTokenExpired.value = false;
                            // D√©finir l'expiration du token (55 minutes)
                            prospecteurTokenExpirationTime.value = Date.now() + (55 * 60 * 1000);
                        }
                    } catch (err) {
                        console.error('Erreur v√©rification token:', err);
                        prospecteurGoogleCalendarTokenExpired.value = true;
                        prospecteurTokenExpirationTime.value = null;
                    }
                }
            };
            
            // Liste des agendas Google
            const googleCalendarList = ref([]);
            const loadingCalendars = ref(false);
            
            // R√©cup√©rer la liste des agendas Google
            const fetchGoogleCalendarList = async () => {
                if (!googleAccessToken.value || !googleCalendarConnected.value) {
                    googleCalendarList.value = [];
                    return;
                }
                
                loadingCalendars.value = true;
                try {
                    // R√©cup√©rer TOUS les calendriers (sans aucun filtre)
                    const response = await fetch('https://www.googleapis.com/calendar/v3/users/me/calendarList?maxResults=250', {
                        headers: {
                            'Authorization': `Bearer ${googleAccessToken.value}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('üìÖ Calendriers re√ßus de Google:', data.items?.length || 0);
                        
                        // Prendre TOUS les calendriers sans filtre
                        const allCalendars = (data.items || []).map(cal => ({
                            id: cal.id,
                            summary: cal.summary || cal.id,
                            description: cal.description || '',
                            primary: cal.primary || false,
                            accessRole: cal.accessRole || '',
                            backgroundColor: cal.backgroundColor || '#8b5cf6',
                            foregroundColor: cal.foregroundColor || '#000000'
                        }));
                        
                        // Trier : agenda principal en premier, puis par nom
                        googleCalendarList.value = allCalendars.sort((a, b) => {
                            if (a.primary && !b.primary) return -1;
                            if (!a.primary && b.primary) return 1;
                            return a.summary.localeCompare(b.summary, 'fr');
                        });
                        
                        console.log('‚úÖ Liste finale des calendriers:', googleCalendarList.value.length);
                        
                        // SYNCHRONISER LES STATUTS apr√®s avoir charg√© la liste
                        try {
                            const now = new Date();
                            const startDate = new Date(now);
                            startDate.setDate(startDate.getDate() - 7);
                            startDate.setHours(0, 0, 0, 0);
                            const endDate = new Date(now);
                            endDate.setDate(endDate.getDate() + 7);
                            endDate.setHours(23, 59, 59, 999);
                            
                            const timeMin = startDate.toISOString();
                            const timeMax = endDate.toISOString();
                            
                            // R√©cup√©rer tous les calendriers (primary + agences)
                            const calendarIds = ['primary'];
                            agences.value.forEach(agence => {
                                if (agence.agendaEmail && agence.agendaEmail.trim()) {
                                    calendarIds.push(agence.agendaEmail.trim());
                                }
                            });
                            
                            const allGoogleEvents = [];
                            for (const calendarId of calendarIds) {
                                try {
                                    const encodedId = encodeURIComponent(calendarId);
                                    const url = `https://www.googleapis.com/calendar/v3/calendars/${encodedId}/events?timeMin=${timeMin}&timeMax=${timeMax}&singleEvents=true&orderBy=startTime`;
                                    
                                    const eventResponse = await fetch(url, {
                                        headers: {
                                            'Authorization': `Bearer ${googleAccessToken.value}`
                                        }
                                    });
                                    
                                    if (eventResponse.ok) {
                                        const eventData = await eventResponse.json();
                                        if (eventData.items) {
                                            allGoogleEvents.push(...eventData.items);
                                        }
                                    }
                                } catch (err) {
                                    console.warn(`Erreur synchronisation calendrier ${calendarId}:`, err);
                                }
                            }
                        } catch (syncErr) {
                            console.error('Erreur lors de la synchronisation des statuts:', syncErr);
                        }
                    } else if (response.status === 401) {
                        // Token expir√© ou invalide
                        console.error('‚ùå Token expir√© ou invalide');
                        googleCalendarList.value = [];
                        googleCalendarConnected.value = false;
                        googleAccessToken.value = '';
                        alert('‚ö†Ô∏è Votre session Google Calendar a expir√©. Veuillez vous reconnecter en cliquant sur "Se connecter avec Google".');
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        const errorMessage = errorData.error?.message || 'Erreur inconnue';
                        console.error('‚ùå Erreur lors de la r√©cup√©ration des agendas:', errorMessage);
                        alert('‚ùå Erreur lors de la r√©cup√©ration des calendriers : ' + errorMessage);
                        googleCalendarList.value = [];
                    }
                } catch (err) {
                    console.error('‚ùå Erreur lors de la r√©cup√©ration des agendas Google:', err);
                    alert('‚ùå Erreur lors de la r√©cup√©ration des calendriers. Veuillez r√©essayer ou vous reconnecter √† Google Calendar.');
                    googleCalendarList.value = [];
                } finally {
                    loadingCalendars.value = false;
                }
            };
            
// ============================================================
            // ‚úÖ SYST√àME API DIRECTE (Stable & Sans doublons)
            // ============================================================

            // 0. V√âRIFICATION DE LA VALIDIT√â DU TOKEN
            const checkGoogleCalendarTokenValid = async () => {
                const token = getActiveGoogleToken();
                if (!token) return false;
                
                try {
                    // Tester le token en faisant une requ√™te simple √† l'API Google Calendar
                    const response = await fetch('https://www.googleapis.com/calendar/v3/users/me/calendarList?maxResults=1', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    // Si 401 ou 403, le token est invalide ou expir√©
                    if (response.status === 401 || response.status === 403) {
                        return false;
                    }
                    
                    return response.ok;
                } catch (err) {
                    console.error('Erreur v√©rification token:', err);
                    return false;
                }
            };

            // 1. CR√âATION (Donne un vrai ID Google)
            const createGoogleCalendarEvent = async (rdv) => {
                // V√©rif s√©curit√© - utiliser le token actif (admin ou prospecteur)
                const token = getActiveGoogleToken();
                if (!token) throw new Error("Non connect√© √† Google.");

                const agence = agences.value.find(a => a.id === rdv.agenceId);
                // On utilise l'email de l'agence comme ID de calendrier, ou 'primary' par d√©faut
                const calendarId = (agence?.agendaEmail && agence.agendaEmail.trim()) ? agence.agendaEmail.trim() : 'primary';
                const agendaColor = agence?.agendaColor || '10'; 

                // Titre et Description
                const titre = `C&N - ${rdv.civilite || ''} ${rdv.nom || ''} - ${rdv.telephone || ''} - ${rdv.modele || ''}`;
                
                let startDateTime, endDateTime;
                if (rdv.date && rdv.heure) {
                    const [year, month, day] = rdv.date.split('-').map(Number);
                    const [hours, minutes] = rdv.heure.split(':').map(Number);
                    const rdvDate = new Date(year, month - 1, day, hours, minutes, 0);
                    const endDate = new Date(rdvDate);
                    endDate.setHours(endDate.getHours() + 1); // Dur√©e 1h
                    
                    startDateTime = rdvDate.toISOString();
                    endDateTime = endDate.toISOString();
                }

                let description = '';
                if (rdv.lienAnnonce) description += `<b>Lien annonce :</b> ${rdv.lienAnnonce}<br>`;
                if (rdv.motif) description += `<b>Motif :</b> ${rdv.motif}<br>`;
                if (rdv.motifDeplacement) description += `<b>Motif report :</b> ${rdv.motifDeplacement}`;

                const eventPayload = {
                    summary: titre,
                    location: agence ? agence.nom : '',
                    description: description,
                    start: { dateTime: startDateTime },
                    end: { dateTime: endDateTime },
                    colorId: agendaColor
                };

                // Appel DIRECT √† Google
                const response = await fetch(`https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendarId)}/events`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(eventPayload)
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error?.message || "Erreur Google API");
                }

                const data = await response.json();
                console.log("‚úÖ RDV cr√©√© via API Directe, ID:", data.id);
                
                // IMPORTANT : On retourne le VRAI ID Google pour pouvoir le supprimer plus tard
                return { id: data.id, eventId: data.id };
            };

            // 2. MISE √Ä JOUR (Utilise PATCH pour √©viter les doublons)
            const updateGoogleCalendarEvent = async (rdv) => {
                const token = getActiveGoogleToken();
                if (!token) return;
                
                // Si c'est un ancien RDV (robot), on le recr√©e car on ne peut pas le modifier proprement
                if (!rdv.googleCalendarEventId || rdv.googleCalendarEventId.startsWith('evt_robot_')) {
                    console.warn("Ancien format d√©tect√©, on recr√©e l'√©v√©nement...");
                    return await createGoogleCalendarEvent(rdv);
                }

                const agence = agences.value.find(a => a.id === rdv.agenceId);
                const calendarId = (agence?.agendaEmail && agence.agendaEmail.trim()) ? agence.agendaEmail.trim() : 'primary';

                let startDateTime, endDateTime;
                if (rdv.date && rdv.heure) {
                    const [year, month, day] = rdv.date.split('-').map(Number);
                    const [hours, minutes] = rdv.heure.split(':').map(Number);
                    const rdvDate = new Date(year, month - 1, day, hours, minutes, 0);
                    const endDate = new Date(rdvDate);
                    endDate.setHours(endDate.getHours() + 1);
                    startDateTime = rdvDate.toISOString();
                    endDateTime = endDate.toISOString();
                }

                const titre = `C&N - ${rdv.civilite || ''} ${rdv.nom || ''} - ${rdv.telephone || ''} - ${rdv.modele || ''}`;

                // PATCH modifie seulement les champs n√©cessaires sans effacer le reste
                const response = await fetch(`https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendarId)}/events/${rdv.googleCalendarEventId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        summary: titre,
                        start: { dateTime: startDateTime },
                        end: { dateTime: endDateTime }
                    })
                });

                if (!response.ok) {
                    // Si l'√©v√©nement n'existe plus, on le recr√©e
                    if (response.status === 404 || response.status === 410) {
                        return await createGoogleCalendarEvent(rdv);
                    }
                    // Sinon on ignore l'erreur silencieusement ou on log
                    console.warn("Impossible de modifier l'√©v√©nement Google");
                    return; 
                }

                const data = await response.json();
                console.log("‚úÖ RDV modifi√© via API Directe !");
                return { id: data.id };
            };

            // 3. SUPPRESSION DIRECTE
            const deleteGoogleCalendarEvent = async (rdv) => {
                const token = getActiveGoogleToken();
                if (!token) return;
                
                // S√©curit√© pour les vieux RDV
                if (!rdv.googleCalendarEventId || rdv.googleCalendarEventId.startsWith('evt_robot_')) {
                    alert("‚ö†Ô∏è Cet √©v√©nement date de l'ancien syst√®me. Veuillez le supprimer manuellement de Google Agenda (une seule fois).");
                    return;
                }

                const agence = agences.value.find(a => a.id === rdv.agenceId);
                const calendarId = (agence?.agendaEmail && agence.agendaEmail.trim()) ? agence.agendaEmail.trim() : 'primary';

                const response = await fetch(`https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendarId)}/events/${rdv.googleCalendarEventId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok || response.status === 404 || response.status === 410) {
                    console.log("‚úÖ RDV supprim√© de Google Agenda");
                } else {
                    console.error("Erreur suppression", await response.json());
                    alert("Erreur lors de la suppression sur Google Agenda.");
                }
            };
            // G√©rer le clic sur le bouton "Agenda" dans la liste des confirmations
            const handleAddToAgendaClick = async (rdv) => {
                // V√©rifier d'abord si le token est vraiment valide
                const isTokenValid = await checkGoogleCalendarTokenValid();
                const isConnected = isGoogleCalendarConnected.value && isTokenValid;
                
                if (!isConnected) {
                    // Afficher le modal de reconnexion
                    reconnectAgendaModal.rdv = rdv;
                    reconnectAgendaModal.open = true;
                    return;
                }
                
                // Si connect√©, ajouter directement √† l'agenda
                await addToAgenda(rdv);
            };
            
            // G√©rer la reconnexion et ajout automatique √† l'agenda
            const handleReconnectForAgenda = async (rdv) => {
                reconnectAgendaModal.open = false;
                
                // Se reconnecter
                if (user.role === 'admin') {
                    connectGoogleCalendar();
                } else {
                    // Pour les prospecteurs, utiliser la fonction existante
                    if (prospecteurGoogleTokenClient) {
                        prospecteurGoogleTokenClient.requestAccessToken({ prompt: 'consent' });
                    } else {
                        connectProspecteurGoogleCalendar();
                    }
                }
                
                // Attendre un peu que la connexion soit √©tablie
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // V√©rifier si on est maintenant connect√©
                const isTokenValid = await checkGoogleCalendarTokenValid();
                const isConnected = isGoogleCalendarConnected.value && isTokenValid;
                
                if (isConnected && rdv) {
                    // Ajouter automatiquement √† l'agenda
                    try {
                        await addToAgenda(rdv);
                        showNotification('‚úÖ C\'est bon, c\'est plac√© dans l\'agenda !', 'success', 'fa-calendar-check');
                    } catch (err) {
                        console.error('Erreur ajout automatique:', err);
                    }
                }
            };
            
            // Ajouter un rendez-vous √† l'agenda Google
            const addToAgenda = async (rdv) => {
                try {
                    // V√©rifier d'abord si le token est vraiment valide
                    const isTokenValid = await checkGoogleCalendarTokenValid();
                    if (!isTokenValid || !isGoogleCalendarConnected.value) {
                        // Afficher le modal de reconnexion au lieu d'alert
                        reconnectAgendaModal.rdv = rdv;
                        reconnectAgendaModal.open = true;
                        return;
                    }
                    
                    const eventResult = await createGoogleCalendarEvent(rdv);
                    
                    // Mettre √† jour le RDV dans Firestore
                    await db.collection('rendezvous').doc(rdv.id).update({
                        dansAgenda: true,
                        googleCalendarEventId: eventResult.id || eventResult.eventId,
                        enAttenteAgenda: false
                    });
                    
                    // Mettre √† jour localement
                    rdv.dansAgenda = true;
                    rdv.googleCalendarEventId = eventResult.id || eventResult.eventId;
                    if (rdv.enAttenteAgenda !== undefined) rdv.enAttenteAgenda = false;
                    
                    if (clientModal.rdv && clientModal.rdv.id === rdv.id) {
                        clientModal.rdv.dansAgenda = true;
                        clientModal.rdv.googleCalendarEventId = eventResult.id || eventResult.eventId;
                        if (clientModal.rdv.enAttenteAgenda !== undefined) clientModal.rdv.enAttenteAgenda = false;
                    }
                    
                    showNotification('‚úÖ Rendez-vous ajout√© √† l\'agenda avec succ√®s !', 'success', 'fa-calendar-check');
                } catch (err) {
                    console.error('Erreur lors de l\'ajout √† l\'agenda:', err);
                    
                    // D√©tecter les erreurs de token (401, 403)
                    const errorMessage = err.message || '';
                    const isTokenError = errorMessage.includes('401') || 
                                       errorMessage.includes('403') || 
                                       errorMessage.includes('Invalid Credentials') ||
                                       errorMessage.includes('expired') ||
                                       errorMessage.includes('token');
                    
                    if (isTokenError) {
                        // Afficher le modal de reconnexion
                        reconnectAgendaModal.rdv = rdv;
                        reconnectAgendaModal.open = true;
                    } else {
                        alert('‚ùå Erreur lors de l\'ajout √† l\'agenda : ' + errorMessage);
                    }
                }
            };
            
            // G√©rer le clic sur "Retirer de l'agenda" avec v√©rification de connexion
            const handleRemoveFromAgendaClick = async (rdv) => {
                // V√©rifier d'abord si le token est vraiment valide
                const isTokenValid = await checkGoogleCalendarTokenValid();
                const isConnected = isGoogleCalendarConnected.value && isTokenValid;
                
                if (!isConnected) {
                    // Afficher le modal de reconnexion
                    reconnectAgendaModal.rdv = rdv;
                    reconnectAgendaModal.open = true;
                    return;
                }
                
                // Si connect√©, retirer directement de l'agenda
                await removeFromAgenda(rdv);
            };
            
            // Retirer un rendez-vous de l'agenda Google
            const removeFromAgenda = async (rdv) => {
                try {
                    if (!googleCalendarConnected.value || !googleAccessToken.value) {
                        alert('‚ö†Ô∏è Vous n\'√™tes pas connect√© √† Google Calendar.');
                        return;
                    }
                    
                    // Confirmer la suppression
                    const confirmDelete = confirm('√ätes-vous s√ªr de vouloir retirer ce rendez-vous de l\'agenda Google Calendar ?');
                    if (!confirmDelete) return;
                    
                    // Activer l'indicateur de chargement
                    if (clientModal.rdv && clientModal.rdv.id === rdv.id) {
                        clientModal.removingFromAgenda = true;
                    }
                    
                    // Supprimer l'√©v√©nement Google Calendar si l'ID existe
                    if (rdv.googleCalendarEventId) {
                        try {
                            await deleteGoogleCalendarEvent(rdv);
                            console.log('‚úÖ √âv√©nement supprim√© de Google Calendar');
                        } catch (deleteErr) {
                            // Si l'√©v√©nement n'existe plus (404), c'est OK
                            if (deleteErr.message && !deleteErr.message.includes('404') && !deleteErr.message.includes('not found')) {
                                console.warn('‚ö†Ô∏è Erreur lors de la suppression de l\'√©v√©nement Google Calendar:', deleteErr);
                                // On continue quand m√™me pour mettre √† jour la base de donn√©es
                            } else {
                                console.log('‚ÑπÔ∏è √âv√©nement d√©j√† supprim√© ou introuvable');
                            }
                        }
                    }
                    
                    // Mettre √† jour le RDV dans Firestore
                    await db.collection('rendezvous').doc(rdv.id).update({
                        dansAgenda: false,
                        googleCalendarEventId: null
                    });
                    
                    // Mettre √† jour localement
                    rdv.dansAgenda = false;
                    rdv.googleCalendarEventId = null;
                    
                    if (clientModal.rdv && clientModal.rdv.id === rdv.id) {
                        clientModal.rdv.dansAgenda = false;
                        clientModal.rdv.googleCalendarEventId = null;
                    }
                    
                    showNotification('Rendez-vous retir√© de l\'agenda avec succ√®s', 'success', 'fa-calendar-times');
                } catch (err) {
                    console.error('Erreur lors de la suppression de l\'agenda:', err);
                    alert('‚ùå Erreur lors de la suppression de l\'agenda : ' + (err.message || 'Erreur inconnue'));
                } finally {
                    // D√©sactiver l'indicateur de chargement
                    if (clientModal.rdv && clientModal.rdv.id === rdv.id) {
                        clientModal.removingFromAgenda = false;
                    }
                }
            };
            
            const copyToAgenda = async (rdv, event) => {
                try {
                    // Si connect√© √† Google Calendar, cr√©er l'√©v√©nement via l'API
                    if (googleCalendarConnected.value && googleAccessToken.value) {
                        await createGoogleCalendarEvent(rdv);
                        
                        if (event) {
                            const btn = event.target.closest('button');
                            if (btn) {
                                const originalText = btn.innerHTML;
                                btn.innerHTML = '<i class="fa-solid fa-check text-[10px]"></i> <span>Cr√©√© !</span>';
                                btn.classList.add('bg-green-100', 'text-green-700', 'border-green-300');
                                setTimeout(() => {
                                    btn.innerHTML = originalText;
                                    btn.classList.remove('bg-green-100', 'text-green-700', 'border-green-300');
                                }, 2000);
                            }
                        }
                        return;
                    }
                    
                    // Sinon, utiliser l'ancienne m√©thode (ouvrir Google Calendar)
                    const civilite = rdv.civilite || '';
                    const nom = rdv.nom || '';
                    const telephone = rdv.telephone || '';
                    const modele = rdv.modele || '';
                    const agenceNom = getAgenceName(rdv.agenceId) || '';
                    
                    const titre = `C&N - ${civilite} ${nom} - ${telephone} - ${modele}`;
                    
                    const agence = agences.value.find(a => a.id === rdv.agenceId);
                    const agendaEmail = agence?.agendaEmail || '';
                    const agendaColor = agence?.agendaColor || '3';
                    
                    let dateStart = '';
                    let dateEnd = '';
                    
                    if (rdv.date && rdv.heure) {
                        const [year, month, day] = rdv.date.split('-').map(Number);
                        const [hours, minutes] = rdv.heure.split(':').map(Number);
                        const rdvDate = new Date(year, month - 1, day, hours, minutes, 0);
                        const startDate = new Date(rdvDate);
                        const startStr = startDate.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                        const endDate = new Date(rdvDate);
                        endDate.setHours(endDate.getHours() + 1);
                        const endStr = endDate.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                        dateStart = startStr;
                        dateEnd = endStr;
                    }
                    
                    const params = new URLSearchParams();
                    // Pour les agendas partag√©s, utiliser le param√®tre src avec l'email du calendrier
                    if (agendaEmail && agendaEmail.trim() !== '') {
                        // Nettoyer l'email et l'encoder correctement
                        const cleanEmail = agendaEmail.trim();
                        params.append('src', cleanEmail);
                    }
                    params.append('action', 'TEMPLATE');
                    params.append('text', titre);
                    if (dateStart && dateEnd) {
                        params.append('dates', `${dateStart}/${dateEnd}`);
                    }
                    if (agenceNom) {
                        params.append('location', agenceNom);
                    }
                    const colorIdNum = parseInt(agendaColor) || 3;
                    if (colorIdNum >= 1 && colorIdNum <= 11) {
                        params.append('colorId', colorIdNum.toString());
                    }
                    
                    // Construire l'URL avec le param√®tre src pour l'agenda partag√©
                    const googleCalendarUrl = `https://calendar.google.com/calendar/u/0/r/eventedit?${params.toString()}`;
                    window.open(googleCalendarUrl, '_blank');
                    
                    if (event) {
                        const btn = event.target.closest('button');
                        if (btn) {
                            const originalText = btn.innerHTML;
                            btn.innerHTML = '<i class="fa-solid fa-check text-[10px]"></i> <span>Ouvert !</span>';
                            btn.classList.add('bg-green-100', 'text-green-700', 'border-green-300');
                            setTimeout(() => {
                                btn.innerHTML = originalText;
                                btn.classList.remove('bg-green-100', 'text-green-700', 'border-green-300');
                            }, 2000);
                        }
                    }
                } catch (err) {
                    console.error('Erreur Google Calendar:', err);
                    const errorMessage = err.message || 'Erreur lors de la cr√©ation de l\'√©v√©nement';
                    
                    // Afficher un message d'erreur plus clair
                    if (event) {
                        const btn = event.target.closest('button');
                        if (btn) {
                            const originalText = btn.innerHTML;
                            btn.innerHTML = '<i class="fa-solid fa-exclamation-triangle text-[10px]"></i> <span>Erreur</span>';
                            btn.classList.add('bg-red-100', 'text-red-700', 'border-red-300');
                            setTimeout(() => {
                                btn.innerHTML = originalText;
                                btn.classList.remove('bg-red-100', 'text-red-700', 'border-red-300');
                            }, 3000);
                        }
                    }
                    
                    // Afficher une alerte avec le message d'erreur d√©taill√©
                    alert('‚ùå Erreur Google Calendar\n\n' + errorMessage + '\n\nüí° V√©rifiez que :\n- L\'email de l\'agenda partag√© est correct dans les param√®tres de l\'agence\n- Vous avez les permissions d\'√©criture sur cet agenda partag√©\n- Vous √™tes bien connect√© √† Google Calendar');
                }
            };

            // Variables pour le calendrier semaine
            const getWeekStart = (date) => {
                const d = new Date(date);
                d.setHours(0, 0, 0, 0);
                const day = d.getDay();
                // Convertir dimanche (0) en 7 pour faciliter le calcul
                const dayOfWeek = day === 0 ? 7 : day;
                // Calculer le lundi de la semaine (jour 1)
                const diff = d.getDate() - dayOfWeek + 1;
                const monday = new Date(d);
                monday.setDate(diff);
                return monday;
            };

            const currentWeekStart = ref(getWeekStart(new Date()));
            const calendarEvents = ref({}); // { '2024-01-15': [{type: 'google', ...}, {type: 'rdv', ...}] }
            const calendarLoading = ref(false);
            const calendarAgencyFilter = ref('');
            const calendarHours = Array.from({length: 16}, (_, i) => {
                const hour = 8 + i;
                return `${String(hour).padStart(2, '0')}:00`;
            });

            // Navigation du calendrier
            const previousWeek = () => {
                const newDate = new Date(currentWeekStart.value);
                newDate.setDate(newDate.getDate() - 7);
                currentWeekStart.value = newDate;
                loadCalendarEvents();
            };

            const nextWeek = () => {
                const newDate = new Date(currentWeekStart.value);
                newDate.setDate(newDate.getDate() + 7);
                currentWeekStart.value = newDate;
                loadCalendarEvents();
            };

            const goToToday = () => {
                currentWeekStart.value = getWeekStart(new Date());
                loadCalendarEvents();
            };

            // Calculer les jours de la semaine
            const calendarWeekDays = computed(() => {
                const days = [];
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayStr = today.toISOString().split('T')[0];

                const dayNames = ['DIM.', 'LUN.', 'MAR.', 'MER.', 'JEU.', 'VEN.', 'SAM.'];

                // S'assurer que currentWeekStart est bien un lundi
                const weekStart = new Date(currentWeekStart.value);
                weekStart.setHours(0, 0, 0, 0);

                for (let i = 0; i < 7; i++) {
                    const date = new Date(weekStart);
                    date.setDate(weekStart.getDate() + i);
                    date.setHours(0, 0, 0, 0);
                    
                    // Utiliser toLocaleDateString pour √©viter les probl√®mes de timezone
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const dateStr = `${year}-${month}-${day}`;
                    
                    const isToday = dateStr === todayStr;
                    const dayOfWeek = date.getDay(); // 0 = dimanche, 1 = lundi, etc.

                    days.push({
                        date: dateStr,
                        dayName: dayNames[dayOfWeek],
                        dayNumber: date.getDate(),
                        isToday,
                        dayOfWeek
                    });
                }

                return days;
            });

            // R√©cup√©rer les √©v√©nements Google Calendar
            const fetchGoogleCalendarEvents = async () => {
                if (!googleAccessToken.value) return;

                calendarLoading.value = true;
                try {
                    // R√©cup√©rer les agendas selon le filtre
                    const calendarIds = [];
                    
                    if (calendarAgencyFilter.value) {
                        // Si un filtre d'agence est s√©lectionn√©, utiliser UNIQUEMENT cet agenda
                        const agence = agences.value.find(a => a.id === calendarAgencyFilter.value);
                        if (agence && agence.agendaEmail && agence.agendaEmail.trim()) {
                            calendarIds.push(agence.agendaEmail.trim());
                        } else {
                            // Si l'agence n'a pas d'email sp√©cifique, utiliser primary
                            calendarIds.push('primary');
                        }
                    } else {
                        // Sinon, r√©cup√©rer tous les agendas partag√©s
                        calendarIds.push('primary');
                        agences.value.forEach(agence => {
                            if (agence.agendaEmail && agence.agendaEmail.trim()) {
                                calendarIds.push(agence.agendaEmail.trim());
                            }
                        });
                    }

                    // Calculer la plage de dates (semaine en cours)
                    const startDate = new Date(currentWeekStart.value);
                    startDate.setHours(0, 0, 0, 0);
                    const endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 7);
                    endDate.setHours(23, 59, 59, 999);
                    
                    const timeMin = startDate.toISOString();
                    const timeMax = endDate.toISOString();

                    const allEvents = [];
                    const allGoogleEvents = []; // Pour la synchronisation des statuts

                    // R√©cup√©rer les √©v√©nements de chaque calendrier
                    for (const calendarId of calendarIds) {
                        try {
                            const encodedId = encodeURIComponent(calendarId);
                            const url = `https://www.googleapis.com/calendar/v3/calendars/${encodedId}/events?timeMin=${timeMin}&timeMax=${timeMax}&singleEvents=true&orderBy=startTime`;
                            
                            const response = await fetch(url, {
                                headers: {
                                    'Authorization': `Bearer ${googleAccessToken.value}`
                                }
                            });

                            if (response.ok) {
                                const data = await response.json();
                                if (data.items) {
                                    // Ajouter tous les √©v√©nements pour la synchronisation
                                    allGoogleEvents.push(...data.items);
                                    
                                    data.items.forEach(event => {
                                        const start = event.start?.dateTime || event.start?.date;
                                        if (start) {
                                            const eventDate = new Date(start);
                                            // Utiliser toLocaleDateString pour √©viter les probl√®mes de timezone
                                            const year = eventDate.getFullYear();
                                            const month = String(eventDate.getMonth() + 1).padStart(2, '0');
                                            const day = String(eventDate.getDate()).padStart(2, '0');
                                            const dateStr = `${year}-${month}-${day}`;
                                            
                                            if (!allEvents[dateStr]) {
                                                allEvents[dateStr] = [];
                                            }
                                            
                                            // Filtrer par agence si un filtre est actif
                                            if (calendarAgencyFilter.value) {
                                                const agence = agences.value.find(a => a.id === calendarAgencyFilter.value);
                                                // Ne garder que les √©v√©nements de l'agence s√©lectionn√©e
                                                if (agence && agence.agendaEmail && agence.agendaEmail.trim() === calendarId) {
                                                    allEvents[dateStr].push({
                                                        type: 'google',
                                                        id: event.id,
                                                        summary: event.summary || 'Sans titre',
                                                        start: event.start,
                                                        end: event.end,
                                                        location: event.location || '',
                                                        color: getCalendarColor(parseInt(agence.agendaColor || '3'))
                                                    });
                                                }
                                            } else {
                                                // Si pas de filtre, afficher tous les √©v√©nements
                                                allEvents[dateStr].push({
                                                    type: 'google',
                                                    id: event.id,
                                                    summary: event.summary || 'Sans titre',
                                                    start: event.start,
                                                    end: event.end,
                                                    location: event.location || '',
                                                    color: getCalendarColor(parseInt(agences.value.find(a => a.agendaEmail === calendarId)?.agendaColor || '3'))
                                                });
                                            }
                                        }
                                    });
                                }
                            }
                        } catch (err) {
                            console.warn(`Erreur lors de la r√©cup√©ration du calendrier ${calendarId}:`, err);
                        }
                    }

                    // Mettre √† jour les √©v√©nements (remplacer les anciens √©v√©nements Google)
                    Object.keys(allEvents).forEach(dateStr => {
                        if (!calendarEvents.value[dateStr]) {
                            calendarEvents.value[dateStr] = [];
                        }
                        // Supprimer les anciens √©v√©nements Google et ajouter les nouveaux
                        calendarEvents.value[dateStr] = [
                            ...calendarEvents.value[dateStr].filter(e => e.type !== 'google'),
                            ...allEvents[dateStr]
                        ];
                    });

                } catch (err) {
                    console.error('Erreur lors de la r√©cup√©ration des √©v√©nements Google Calendar:', err);
                } finally {
                    calendarLoading.value = false;
                }
            };

            const saveSyncSettings = async () => {
                try {
                    await db.collection('settings').doc('calendar_sync').set({
                        syncAfterRdvTime: syncSettings.syncAfterRdvTime,
                        syncInterval: syncSettings.syncInterval,
                        updatedAt: new Date().toISOString()
                    }, { merge: true });
                } catch (err) {
                    console.error('Erreur lors de la sauvegarde des r√©glages de synchronisation:', err);
                }
            };

            // Fonction de synchronisation manuelle (pour forcer la synchronisation imm√©diatement)
            const manualSyncGoogleCalendar = async () => {
                if (!googleCalendarConnected.value || !googleAccessToken.value) {
                    alert('Google Calendar n\'est pas connect√©.');
                    return;
                }

                try {
                    // Afficher un indicateur de chargement
                    const loadingMsg = 'Synchronisation en cours...';
                    console.log(loadingMsg);

                    // R√©cup√©rer les √©v√©nements des 7 derniers jours et 7 prochains jours
                    const now = new Date();
                    const startDate = new Date(now);
                    startDate.setDate(startDate.getDate() - 7);
                    startDate.setHours(0, 0, 0, 0);
                    const endDate = new Date(now);
                    endDate.setDate(endDate.getDate() + 7);
                    endDate.setHours(23, 59, 59, 999);
                    
                    const timeMin = startDate.toISOString();
                    const timeMax = endDate.toISOString();
                    
                    // R√©cup√©rer tous les calendriers
                    const calendarIds = ['primary'];
                    agences.value.forEach(agence => {
                        if (agence.agendaEmail && agence.agendaEmail.trim()) {
                            calendarIds.push(agence.agendaEmail.trim());
                        }
                    });
                    
                    const allGoogleEvents = [];
                    for (const calendarId of calendarIds) {
                        try {
                            const encodedId = encodeURIComponent(calendarId);
                            const url = `https://www.googleapis.com/calendar/v3/calendars/${encodedId}/events?timeMin=${timeMin}&timeMax=${timeMax}&singleEvents=true&orderBy=startTime`;
                            
                            const response = await fetch(url, {
                                headers: {
                                    'Authorization': `Bearer ${googleAccessToken.value}`
                                }
                            });
                            
                            if (response.ok) {
                                const data = await response.json();
                                if (data.items) {
                                    allGoogleEvents.push(...data.items);
                                }
                            }
                        } catch (err) {
                            console.warn(`Erreur synchronisation calendrier ${calendarId}:`, err);
                        }
                    }
                    
                    alert('‚úÖ Synchronisation termin√©e !');
                    console.log('‚úÖ Synchronisation manuelle Google Calendar effectu√©e');
                } catch (err) {
                    console.error('Erreur synchronisation manuelle:', err);
                    alert('‚ùå Erreur lors de la synchronisation. V√©rifiez la console pour plus de d√©tails.');
                }
            };

            // Charger les √©v√©nements du calendrier (Google + RDV)
            const loadCalendarEvents = () => {
                // R√©initialiser les √©v√©nements pour la semaine en cours
                const startDate = new Date(currentWeekStart.value);
                startDate.setHours(0, 0, 0, 0);
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 7);
                
                // Nettoyer les anciens √©v√©nements qui ne sont plus dans la plage
                Object.keys(calendarEvents.value).forEach(dateStr => {
                    const date = new Date(dateStr);
                    if (date < startDate || date >= endDate) {
                        delete calendarEvents.value[dateStr];
                    }
                });

                // Charger les RDV de l'application avec filtre d'agence
                rdvList.value.forEach(rdv => {
                    if (rdv.date && rdv.statut !== 'poubelle') {
                        // Filtrer par agence si un filtre est s√©lectionn√©
                        if (calendarAgencyFilter.value && rdv.agenceId !== calendarAgencyFilter.value) {
                            return;
                        }

                        // Utiliser directement la date string pour √©viter les probl√®mes de timezone
                        const dateStr = rdv.date;
                        const rdvDateOnly = new Date(dateStr + 'T00:00:00');
                        const startDateOnly = new Date(startDate.toISOString().split('T')[0] + 'T00:00:00');
                        const endDateOnly = new Date(endDate.toISOString().split('T')[0] + 'T00:00:00');
                        
                        if (rdvDateOnly >= startDateOnly && rdvDateOnly < endDateOnly) {
                            if (!calendarEvents.value[dateStr]) {
                                calendarEvents.value[dateStr] = [];
                            }
                            // V√©rifier si le RDV n'est pas d√©j√† dans la liste
                            const existingIndex = calendarEvents.value[dateStr].findIndex(e => e.type === 'rdv' && e.id === rdv.id);
                            if (existingIndex >= 0) {
                                // Mettre √† jour l'√©v√©nement existant
                                calendarEvents.value[dateStr][existingIndex] = {
                                    type: 'rdv',
                                    id: rdv.id,
                                    ...rdv
                                };
                            } else {
                                // Ajouter le nouvel √©v√©nement
                                calendarEvents.value[dateStr].push({
                                    type: 'rdv',
                                    id: rdv.id,
                                    ...rdv
                                });
                            }
                        }
                    }
                });

                // Charger les √©v√©nements Google Calendar si connect√©
                if (googleCalendarConnected.value) {
                    fetchGoogleCalendarEvents();
                }
            };

            const refreshCalendarEvents = () => {
                calendarEvents.value = {};
                loadCalendarEvents();
            };

            // Obtenir les horaires pour un jour sp√©cifique
            const getDayHours = (agence, dateStr) => {
                if (!agence) return null;
                
                const date = new Date(dateStr + 'T00:00:00');
                const dayIndex = date.getDay(); // 0 = dimanche, 1 = lundi, etc.
                // Convertir dimanche (0) en 6 pour correspondre √† notre index
                const adjustedDayIndex = dayIndex === 0 ? 6 : dayIndex - 1;
                
                // V√©rifier si des horaires sp√©cifiques existent pour ce jour
                const dayOpen = agence[`horaires_${adjustedDayIndex}_ouverture`];
                const dayClose = agence[`horaires_${adjustedDayIndex}_fermeture`];
                
                if (dayOpen && dayClose) {
                    return { open: dayOpen, close: dayClose };
                }
                
                // Sinon utiliser les horaires par d√©faut
                if (agence.heureOuverture && agence.heureFermeture) {
                    return { open: agence.heureOuverture, close: agence.heureFermeture };
                }
                
                return null;
            };

            // V√©rifier si un cr√©neau est dans une p√©riode de fermeture
            const isClosedSlot = (dateStr, hourStr) => {
                if (!calendarAgencyFilter.value) return false;
                
                const agence = agences.value.find(a => a.id === calendarAgencyFilter.value);
                if (!agence) return false;
                
                const dayHours = getDayHours(agence, dateStr);
                if (!dayHours) return false;
                
                const [hour, minute] = hourStr.split(':').map(Number);
                const [openHour, openMinute] = dayHours.open.split(':').map(Number);
                const [closeHour, closeMinute] = dayHours.close.split(':').map(Number);
                
                const currentTime = hour * 60 + minute;
                const openTime = openHour * 60 + openMinute;
                const closeTime = closeHour * 60 + closeMinute;
                
                // V√©rifier si c'est avant l'ouverture ou apr√®s la fermeture
                if (currentTime < openTime || currentTime >= closeTime) {
                    return true;
                }
                
                // V√©rifier si c'est pendant la pause d√©jeuner
                if (agence.heurePauseDebut && agence.heurePauseFin) {
                    const [pauseStartHour, pauseStartMin] = agence.heurePauseDebut.split(':').map(Number);
                    const [pauseEndHour, pauseEndMin] = agence.heurePauseFin.split(':').map(Number);
                    const pauseStart = pauseStartHour * 60 + pauseStartMin;
                    const pauseEnd = pauseEndHour * 60 + pauseEndMin;
                    if (currentTime >= pauseStart && currentTime < pauseEnd) {
                        return true;
                    }
                }
                
                return false;
            };

            // Obtenir le message de fermeture pour un cr√©neau
            const getClosedMessage = (dateStr, hourStr) => {
                if (!calendarAgencyFilter.value) return '';
                
                const agence = agences.value.find(a => a.id === calendarAgencyFilter.value);
                if (!agence) return '';
                
                const dayHours = getDayHours(agence, dateStr);
                if (!dayHours) return '';
                
                const [hour, minute] = hourStr.split(':').map(Number);
                const [openHour, openMinute] = dayHours.open.split(':').map(Number);
                const [closeHour, closeMinute] = dayHours.close.split(':').map(Number);
                
                const currentTime = hour * 60 + minute;
                const openTime = openHour * 60 + openMinute;
                const closeTime = closeHour * 60 + closeMinute;
                
                if (currentTime < openTime) {
                    return `Ferm√© - Ouverture √† ${dayHours.open}`;
                }
                
                if (currentTime >= closeTime) {
                    return `Ferm√© - Fermeture √† ${dayHours.close}`;
                }
                
                if (agence.heurePauseDebut && agence.heurePauseFin) {
                    const [pauseStartHour, pauseStartMin] = agence.heurePauseDebut.split(':').map(Number);
                    const [pauseEndHour, pauseEndMin] = agence.heurePauseFin.split(':').map(Number);
                    const pauseStart = pauseStartHour * 60 + pauseStartMin;
                    const pauseEnd = pauseEndHour * 60 + pauseEndMin;
                    if (currentTime >= pauseStart && currentTime < pauseEnd) {
                        return `Ferm√© - Pause de ${agence.heurePauseDebut} √† ${agence.heurePauseFin}`;
                    }
                }
                
                return '';
            };

            // Obtenir l'heure d'ouverture pour un jour sp√©cifique (pour la ligne visuelle)
            const getOpeningTime = (day) => {
                if (!calendarAgencyFilter.value) return null;
                
                const agence = agences.value.find(a => a.id === calendarAgencyFilter.value);
                if (!agence) return null;
                
                const dayHours = getDayHours(agence, day.date);
                if (!dayHours) return null;
                
                return dayHours.open;
            };

            // Obtenir les infos d'ouverture pour l'affichage dans l'en-t√™te
            const getDayHoursInfo = (day) => {
                if (!calendarAgencyFilter.value) return null;
                
                const agence = agences.value.find(a => a.id === calendarAgencyFilter.value);
                if (!agence) return null;
                
                const dayHours = getDayHours(agence, day.date);
                if (!dayHours) return null;
                
                const pause = agence.heurePauseDebut && agence.heurePauseFin 
                    ? `${agence.heurePauseDebut} - ${agence.heurePauseFin}` 
                    : null;
                
                return {
                    open: dayHours.open,
                    close: dayHours.close,
                    pause: pause
                };
            };

            // V√©rifier si un jour est compl√®tement ferm√©
            const isDayClosed = (day) => {
                if (!calendarAgencyFilter.value) return false;
                
                const agence = agences.value.find(a => a.id === calendarAgencyFilter.value);
                if (!agence) return false;
                
                const date = new Date(day.date + 'T00:00:00');
                const dayIndex = date.getDay();
                const adjustedDayIndex = dayIndex === 0 ? 6 : dayIndex - 1;
                
                // V√©rifier si le dimanche est marqu√© comme ferm√©
                if (adjustedDayIndex === 6 && agence.dimancheFerme) {
                    return true;
                }
                
                return false;
            };

            // Obtenir les √©v√©nements pour un cr√©neau horaire sp√©cifique
            const getEventsForSlot = (dateStr, hourStr) => {
                const events = calendarEvents.value[dateStr] || [];
                const [hour] = hourStr.split(':').map(Number);
                
                return events.filter(event => {
                    if (event.type === 'rdv') {
                        if (!event.heure) return false;
                        const [eventHour] = event.heure.split(':').map(Number);
                        return eventHour === hour;
                    } else if (event.type === 'google') {
                        const start = event.start?.dateTime || event.start?.date;
                        if (!start) return false;
                        const eventDate = new Date(start);
                        const eventHour = eventDate.getHours();
                        return eventHour === hour;
                    }
                    return false;
                });
            };

            // Obtenir le style d'un √©v√©nement (position et taille)
            const getEventStyle = (event, dateStr, hourStr) => {
                const [hour] = hourStr.split(':').map(Number);
                let top = 0;
                let height = 60; // Hauteur par d√©faut d'un cr√©neau (1 heure)

                if (event.type === 'google') {
                    const start = new Date(event.start?.dateTime || event.start?.date);
                    const end = new Date(event.end?.dateTime || event.end?.date);
                    const startHour = start.getHours();
                    const startMinute = start.getMinutes();
                    const duration = (end - start) / (1000 * 60); // Dur√©e en minutes
                    
                    if (startHour === hour) {
                        top = (startMinute / 60) * 60;
                        height = Math.max(20, (duration / 60) * 60);
                    } else {
                        return { display: 'none' };
                    }
                } else if (event.type === 'rdv') {
                    if (event.heure) {
                        const [eventHour, eventMinute] = event.heure.split(':').map(Number);
                        if (eventHour === hour) {
                            top = (eventMinute / 60) * 60;
                        } else {
                            return { display: 'none' };
                        }
                    }
                }

                // Couleur selon le type
                let backgroundColor = '#8b5cf6';
                if (event.type === 'google') {
                    backgroundColor = event.color || '#4285f4';
                } else if (event.type === 'rdv') {
                    backgroundColor = getAgenceColor(event.agenceId);
                }

                return {
                    top: `${top}px`,
                    height: `${height}px`,
                    backgroundColor: backgroundColor
                };
            };

            // Obtenir le titre d'un √©v√©nement
            const getEventTitle = (event) => {
                if (event.type === 'rdv') {
                    return `${event.civilite || ''} ${event.nom || ''} ${event.modele ? '- ' + event.modele : ''}`.trim();
                } else if (event.type === 'google') {
                    return event.summary || 'Sans titre';
                }
                return '';
            };

            // Obtenir l'heure d'un √©v√©nement
            const getEventTime = (event) => {
                if (event.type === 'rdv') {
                    return event.heure || '';
                } else if (event.type === 'google') {
                    const start = event.start?.dateTime || event.start?.date;
                    if (!start) return '';
                    const date = new Date(start);
                    return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                }
                return '';
            };

            // V√©rifier si c'est le cr√©neau horaire actuel
            const isCurrentTimeSlot = (dateStr, hourStr) => {
                const now = new Date();
                const todayStr = now.toISOString().split('T')[0];
                const [hour] = hourStr.split(':').map(Number);
                return dateStr === todayStr && now.getHours() === hour;
            };

            // Obtenir le style pour la ligne d'ouverture
            const getOpeningLineStyle = (day) => {
                const openingTime = getOpeningTime(day);
                if (!openingTime) return { display: 'none' };
                
                const [hour, minute] = openingTime.split(':').map(Number);
                // Calculer la position exacte en pixels
                // Chaque cr√©neau horaire fait 60px de haut
                // Si l'ouverture est √† 9h30, c'est 1h30 apr√®s 8h00 = 1.5 cr√©neaux = 90px
                const hoursFromStart = hour - 8;
                const minutesInPixels = (minute / 60) * 60; // Convertir les minutes en pixels
                const topPosition = (hoursFromStart * 60) + minutesInPixels;
                
                return {
                    top: `${topPosition}px`
                };
            };

            // Cr√©er un RDV depuis un cr√©neau horaire
            const createRdvFromTimeSlot = (dateStr, hourStr) => {
                const [hour, minute = 0] = hourStr.split(':').map(Number);
                const timeStr = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                
                // Ouvrir le wizard d'abord
                startWizard();
                
                // Pr√©-remplir le formulaire apr√®s l'initialisation
                setTimeout(() => {
                    form.date = dateStr;
                    form.heure = timeStr;
                    
                    // Pr√©-s√©lectionner l'agence si un filtre est actif
                    if (calendarAgencyFilter.value) {
                        const selectedAgence = agences.value.find(a => a.id === calendarAgencyFilter.value);
                        if (selectedAgence) {
                            form.agence = selectedAgence;
                            form.agenceId = calendarAgencyFilter.value;
                            // Passer directement √† l'√©tape 2 (Informations Client) car agence, date et heure sont d√©j√† d√©finis
                            wizard.step = 2;
                        }
                    }
                }, 100);
            };

            // Ouvrir les d√©tails d'un √©v√©nement
            const openEventDetails = (event) => {
                if (event.type === 'rdv') {
                    openRdvFiche(event);
                } else {
                    // Pour les √©v√©nements Google, on pourrait ouvrir une modal ou le lien
                    alert(`${event.summary}\n\n${getEventTime(event)}\n${event.location || ''}`);
                }
            };

            // Formater le titre de la semaine
            const formatCalendarWeekTitle = () => {
                const start = new Date(currentWeekStart.value);
                const end = new Date(start);
                end.setDate(start.getDate() + 6);
                
                const startStr = start.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long' });
                const endStr = end.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
                
                if (start.getMonth() === end.getMonth()) {
                    return `${startStr} - ${end.getDate()} ${end.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })}`;
                }
                return `${startStr} - ${endStr}`;
            };

            // Obtenir la couleur d'une agence
            const getAgenceColor = (agenceId) => {
                const agence = agences.value.find(a => a.id === agenceId);
                if (agence && agence.agendaColor) {
                    return getCalendarColor(parseInt(agence.agendaColor));
                }
                return '#8b5cf6';
            };

            // Auto-refresh toutes les 2 minutes
            let autoRefreshInterval = null;
            
            
            watch(() => view.value, (newView) => {
                // V√©rifier le token quand on arrive sur le dashboard
                if (newView === 'dashboard' && user.role === 'admin' && googleCalendarConnected.value) {
                    // V√©rifier le token apr√®s un court d√©lai pour laisser le temps √† la page de se charger
                    setTimeout(() => {
                        checkAndUpdateTokenStatus();
                    }, 500);
                }
                
                if (newView === 'agenda') {
                    loadCalendarEvents();
                    // D√©marrer l'auto-refresh
                    if (autoRefreshInterval) clearInterval(autoRefreshInterval);
                    autoRefreshInterval = setInterval(() => {
                        if (view.value === 'agenda' && googleCalendarConnected.value) {
                            refreshCalendarEvents();
                        }
                    }, 120000); // 2 minutes
                } else {
                    // Arr√™ter l'auto-refresh si on quitte la vue agenda
                    if (autoRefreshInterval) {
                        clearInterval(autoRefreshInterval);
                        autoRefreshInterval = null;
                    }
                }
            });

            // Charger les √©v√©nements quand on change de vue ou quand les donn√©es changent
            watch([() => currentWeekStart.value, () => calendarAgencyFilter.value, () => rdvList.value.length], () => {
                if (view.value === 'agenda') {
                    loadCalendarEvents();
                }
            });

            const filteredDaily = computed(() => { 
    if (!rdvList.value) return [];
    
    // 1. On prend l'horloge syst√®me (qui tourne toute seule)
    const d = new Date(now.value);
    
    // 2. Si le bouton "Demain" est activ√©, on ajoute 1 jour √† l'horloge
    if (isTimelineTomorrow.value) {
        d.setDate(d.getDate() + 1);
    }

    // 3. On formate la date cible
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    const targetDate = `${year}-${month}-${day}`;
    
    // 4. On filtre
    let list = rdvList.value.filter(r => r.date === targetDate && r.statut !== 'poubelle');
    
    // Filtres habituels
    if (dashboardFilters.agencyId) list = list.filter(r => r.agenceId === dashboardFilters.agencyId);
    if (dashboardFilters.userId) list = list.filter(r => r.createdBy === dashboardFilters.userId);
    if (dashboardFilters.onlyLive) list = list.filter(r => isEnCours(r));
    
    return list.sort((a,b) => a.heure.localeCompare(b.heure)).map(r => ({...r, agenceNom: agences.value.find(a=>a.id===r.agenceId)?.nom})); 
});
            const displayedDaily = computed(() => filteredDaily.value.slice(0, dashboardLimit.value));
            const sortedDaily = computed(() => displayedDaily.value);
            const rdvTodayCount = computed(() => filteredDaily.value.length);
            const timelineActiveCount = computed(() => {
                if (!rdvList.value) return 0;
                // Utiliser la m√™me logique que filteredDaily pour la date
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowStr = tomorrow.toISOString().split('T')[0];
                
                // Si on est en mode "demain", utiliser demain, sinon TOUJOURS utiliser aujourd'hui
                const targetDate = timelineShowTomorrow.value ? tomorrowStr : todayStr;
                
                let list = rdvList.value.filter(r => r.date === targetDate && r.statut !== 'poubelle');
                if (dashboardFilters.agencyId) list = list.filter(r => r.agenceId === dashboardFilters.agencyId);
                if (dashboardFilters.userId) list = list.filter(r => r.createdBy === dashboardFilters.userId);
                return list.filter(r => isEnCours(r)).length;
            });
            
            const isTimelineTomorrow = computed(() => timelineShowTomorrow.value);
            
            const showTimelineTomorrow = () => {
                // Basculer entre "aujourd'hui" et "demain"
                timelineShowTomorrow.value = !timelineShowTomorrow.value;
                // Mettre √† jour filters.date pour la coh√©rence (mais on ne l'utilise plus pour la logique)
                const today = new Date();
                if (timelineShowTomorrow.value) {
                    // Aller √† demain
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    filters.date = tomorrow.toISOString().split('T')[0];
                } else {
                    // Revenir √† aujourd'hui
                    filters.date = today.toISOString().split('T')[0];
                }
            };
            
            // Notifications visuelles
            const isNewRdvFromOther = (rdv) => {
                if (!rdv.created || !rdv.createdBy) return false;
                if (rdv.createdBy === user.name) return false; // Pas un RDV cr√©√© par moi
                try {
                    const createdDate = rdv.created && rdv.created.toDate ? rdv.created.toDate() : (rdv.created ? new Date(rdv.created) : null);
                    if (!createdDate) return false;
                    const now = new Date();
                    const diffMinutes = (now - createdDate) / (1000 * 60);
                    return diffMinutes > 0 && diffMinutes <= 30; // Nouveau si cr√©√© il y a moins de 30 minutes
                } catch (e) {
                    return false;
                }
            };
            
            const isRdvApproaching = (rdv) => {
                if (!rdv.date || !rdv.heure || rdv.statut === 'poubelle') return false;
                const today = new Date().toISOString().split('T')[0];
                if (rdv.date !== today) return false;
                
                const [hours, minutes] = rdv.heure.split(':').map(Number);
                const rdvTime = new Date();
                rdvTime.setHours(hours, minutes, 0, 0);
                
                const now = new Date();
                const diffMinutes = (rdvTime - now) / (1000 * 60);
                
                return diffMinutes > 0 && diffMinutes <= 15; // Entre maintenant et 15 minutes
            };
            
            const needsRappel = (rdv) => {
                if (!rdv.date || rdv.rappelFait) return false;
                if (!['confirme', 'a_confirmer'].includes(rdv.statut)) return false;
                return isSoon(rdv.date) && !isCreatedToday(rdv.created);
            };
            
            const isSoon = (dStr) => {
                if (!dStr) return false;
                const nowDate = now.value ? new Date(now.value) : new Date();
                const today = new Date(nowDate); today.setHours(0, 0, 0, 0);
                const d = new Date(dStr); d.setHours(0, 0, 0, 0);
                const diffDays = Math.round((d - today) / 86400000);
                if (diffDays === 0) return true;
                if (diffDays === 1) { const hour = nowDate.getHours(); return hour >= 16; }
                return false;
            };

            const isCreatedToday = (d) => {
                if (!d) return false;
                const date = new Date(d);
                const today = new Date();
                return (date.getDate() === today.getDate() && date.getMonth() === today.getMonth() && date.getFullYear() === today.getFullYear());
            };

            const getDayDiff = (dStr) => {
                if (!dStr) return null;
                const base = now.value ? new Date(now.value) : new Date(); base.setHours(0, 0, 0, 0);
                const d = new Date(dStr); d.setHours(0, 0, 0, 0);
                return Math.round((d - base) / 86400000);
            };

            const rappelsList = computed(() => rdvList.value.filter((r) => ['confirme', 'a_confirmer'].includes(r.statut) && !r.rappelFait && isSoon(r.date) && !isCreatedToday(r.created) && (getDayDiff(r.date) !== 0 || (r.heure && r.heure > new Date().toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'})))));
            const rappelFilters = reactive({ day: 'today', agenceId: '', userId: '' });
            const isRappelToday = (r) => getDayDiff(r.date) === 0;
            const isRappelTomorrow = (r) => getDayDiff(r.date) === 1;
            const rappelsDisplay = computed(() => {
                let list = rappelsList.value;
                if (rappelFilters.day === 'today') { list = list.filter((r) => isRappelToday(r)); } else if (rappelFilters.day === 'tomorrow') { list = list.filter((r) => isRappelTomorrow(r)); }
                if (rappelFilters.agenceId) { list = list.filter((r) => r.agenceId === rappelFilters.agenceId); }
                if (rappelFilters.userId) { list = list.filter((r) => r.createdBy === rappelFilters.userId); }
                return list;
            });
            const rappelsVeilleCount = computed(() => rappelsList.value.filter(r => isRappelTomorrow(r)).length);
            const rappelsJourCount = computed(() => rappelsList.value.filter(r => isRappelToday(r)).length);
            const confirmList = computed(() => rdvList.value.filter((r) => r.statut === 'a_confirmer'));
            const rappelCount = computed(() => rappelsList.value.length);
            const confirmCount = computed(() => confirmList.value.length);
            
            const detailedStats = computed(() => {
                const now = new Date(); const currentMonth = now.getMonth(); const currentYear = now.getFullYear();
                
                let targetUser = statsFilterUser.value;
                if (user.role !== 'admin') {
                    targetUser = user.name;
                }

                let filteredList = rdvList.value.filter(r => { if (!r.date) return false; if (r.statut === 'poubelle') return false; const d = new Date(r.date); return d.getMonth() === currentMonth && d.getFullYear() === currentYear; });
                if(statsFilterAgency.value) { filteredList = filteredList.filter(r => r.agenceId === statsFilterAgency.value); }
                if(targetUser) { filteredList = filteredList.filter(r => r.createdBy === targetUser); }
                
                const total = filteredList.length; const honored = filteredList.filter(r => r.statut === 'honore').length; const noshow = filteredList.filter(r => r.statut === 'pas_venu').length; const finished = honored + noshow; const rate = finished > 0 ? Math.round((honored / finished) * 100) : 0;
                return { total, honored, noshow, rate };
            });
            
            // Statistiques mandats par agence
            const mandatsParAgence = computed(() => {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                
                let targetUser = statsFilterUser.value;
                if (user.role !== 'admin') {
                    targetUser = user.name;
                }
                
                // Filtrer les RDV du mois en cours
                let filteredList = rdvList.value.filter(r => {
                    if (!r.date) return false;
                    if (r.statut === 'poubelle') return false;
                    const d = new Date(r.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                });
                
                // Appliquer le filtre par agence si une agence est s√©lectionn√©e
                if(statsFilterAgency.value) {
                    // Convertir en string pour √©viter les probl√®mes de type
                    const selectedAgencyId = String(statsFilterAgency.value);
                    filteredList = filteredList.filter(r => {
                        // Si le RDV n'a pas d'agence, on l'exclut quand on filtre par agence
                        if (!r.agenceId) return false;
                        return String(r.agenceId) === selectedAgencyId;
                    });
                }
                
                if(targetUser) {
                    filteredList = filteredList.filter(r => r.createdBy === targetUser);
                }
                
                // Grouper par agence
                const statsByAgency = {};
                
                filteredList.forEach(rdv => {
                    const agenceId = rdv.agenceId || 'sans-agence';
                    if (!statsByAgency[agenceId]) {
                        statsByAgency[agenceId] = {
                            agenceId: agenceId,
                            nom: getAgenceName(agenceId),
                            total: 0,
                            mandatsSignes: 0
                        };
                    }
                    statsByAgency[agenceId].total++;
                    if (rdv.tag === 'OK M') {
                        statsByAgency[agenceId].mandatsSignes++;
                    }
                });
                
                // Convertir en tableau et trier par nombre de mandats sign√©s
                return Object.values(statsByAgency)
                    .sort((a, b) => b.mandatsSignes - a.mandatsSignes);
            });
            
            const openStatsModal = () => { statsFilterAgency.value = ''; statsFilterUser.value = ''; statsModal.open = true; };
            
            // Calcul des commissions pour le commercial connect√© (AVEC LOGIQUE RECURRENTE)
            const userCommissionStats = computed(() => {
                if (user.role === 'admin') return null; 
                
                const basePrice = parseFloat(globalCommission.base) || 0;
                const bonusThreshold = parseInt(globalCommission.threshold) || 21;
                const bonusStep = parseInt(globalCommission.step) || 10;
                const bonusAmount = parseFloat(globalCommission.amount) || 100;

                const now = new Date(); const currentMonth = now.getMonth(); const currentYear = now.getFullYear();
                
                const honoredRdvs = rdvList.value.filter(r => {
                    if (r.statut !== 'honore' || r.createdBy !== user.name || !r.date) return false;
                    const d = new Date(r.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                });

                const count = honoredRdvs.length;
                let baseEarnings = count * basePrice;
                let bonusEarnings = 0;

                // Logique r√©currente: 
                // Si threshold=21, step=10, amount=100.
                // 21 -> 100
                // 31 -> 200
                if (count >= bonusThreshold) {
                    // (21-21)/10 + 1 = 1 * 100 = 100
                    // (31-21)/10 + 1 = 2 * 100 = 200
                    const multiplier = Math.floor((count - bonusThreshold) / bonusStep) + 1;
                    bonusEarnings = multiplier * bonusAmount;
                }

                // Add Tips
                const currentMonthKey = `${currentMonth}-${currentYear}`;
                // Get tip for this user from loaded tips object (reactive)
                const myUserEntry = teamList.value.find(u => u.name === user.name);
                let tipEarnings = 0;
                if(myUserEntry && tips[myUserEntry.id]) {
                    tipEarnings = tips[myUserEntry.id];
                }

                const totalEarnings = baseEarnings + bonusEarnings + tipEarnings;

                return { 
                    count, 
                    baseEarnings, 
                    bonusEarnings, 
                    tipEarnings, 
                    totalEarnings,
                    justReachedTier: (count >= bonusThreshold) && ((count - bonusThreshold) % bonusStep === 0) // Visual effect trigger
                };
            });

           // STATS ADMIN AVEC CALCUL MARGE (CORRIG√â : EXCLURE ADMINS DES COMMISSIONS)
            const stats = computed(() => {
                const nowStr = new Date().toISOString().split('T')[0];
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();

                const upcoming = rdvList.value.filter(r => r.statut==='confirme' && r.date >= nowStr && r.statut !== 'poubelle').length;
                const honored = rdvList.value.filter(r => r.statut==='honore').length;
                const noshow = rdvList.value.filter(r => r.statut==='pas_venu').length;
                const cancelled = rdvList.value.filter(r => r.statut==='annule').length;

                // CA BRUT (Tout le monde compte pour le CA)
                const ca = rdvList.value.filter(r => r.honorBilling==='facture').reduce((acc,r) => { 
                    const price = parseFloat(r.prix) || 0; 
                    const discount = parseFloat(r.geste_commercial) || 0; 
                    return acc + (price - discount); 
                }, 0);

                // CA Journalier
                const ca_daily = rdvList.value.filter(r => r.honorBilling==='facture' && r.date === nowStr).reduce((acc,r) => { 
                    const price = parseFloat(r.prix) || 0; 
                    const discount = parseFloat(r.geste_commercial) || 0; 
                    return acc + (price - discount); 
                }, 0);

                // Commissions Totales (Filtrage des Admins)
                const commissionMap = {}; 
                rdvList.value.forEach(r => {
                    if (r.statut === 'honore' && r.date) {
                        const d = new Date(r.date);
                        if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
                            const uName = r.createdBy || 'Syst√®me';
                            if (!commissionMap[uName]) commissionMap[uName] = 0;
                            commissionMap[uName]++;
                        }
                    }
                });

                let totalCommissions = 0;
                
                const basePrice = parseFloat(globalCommission.base) || 0;
                const bonusThreshold = parseInt(globalCommission.threshold) || 21;
                const bonusStep = parseInt(globalCommission.step) || 10;
                const bonusAmount = parseFloat(globalCommission.amount) || 100;

                for (const [userName, count] of Object.entries(commissionMap)) {
                    // --- NOUVELLE LOGIQUE : V√âRIFIER SI C'EST UN ADMIN ---
                    // 1. V√©rifier dans la liste des noms admins (hardcod√©/settings)
                    const isNameInAdminList = adminNamesList.value.includes(userName);
                    // 2. V√©rifier dans la liste des utilisateurs (r√¥le)
                    const userObj = teamList.value.find(u => u.name === userName);
                    const isRoleAdmin = userObj && userObj.role === 'admin';

                    // Si c'est un admin, on ne calcule PAS de commission (co√ªt = 0)
                    if (isNameInAdminList || isRoleAdmin) {
                        continue; 
                    }
                    // -----------------------------------------------------

                    let userTotal = count * basePrice;
                    if (count >= bonusThreshold) {
                        const multiplier = Math.floor((count - bonusThreshold) / bonusStep) + 1;
                        userTotal += (multiplier * bonusAmount);
                    }
                    
                    // Add Tips from teamList (seulement pour les non-admins)
                    if (userObj && tips[userObj.id]) {
                        userTotal += parseFloat(tips[userObj.id]);
                    }

                    totalCommissions += userTotal;
                }

                const net = ca - totalCommissions;

                return { upcoming, honored, noshow, cancelled, ca, ca_daily, commissions: totalCommissions, net };
            });

            const isLateAndNoStatus = (r) => { if(!r.date || !r.heure) return false; const start = new Date(r.date+'T'+r.heure); const end = new Date(start.getTime() + 60*60*1000); return now.value >= end && ['confirme','a_confirmer'].includes(r.statut); };
            const getProgressPercent = (r) => { if(!r.date || !r.heure) return 0; const start = new Date(r.date+'T'+r.heure).getTime(); const end = start + 3600000; const current = now.value.getTime(); if(current < start) return 0; if(current > end) return 100; return ((current - start) / (end - start)) * 100; };
            const getRdvTimeStatus = (r) => { if(!r.date || !r.heure) return 'futur'; const start = new Date(r.date+'T'+r.heure).getTime(); const current = now.value.getTime(); if(current >= start && current < start + 3600000) return 'en_cours'; if(current < start && (start - current) < 172800000) return 'bientot'; return 'futur'; };
            const getRelativeRdvLabel = (r) => { if (!r.date || !r.heure) return ''; const nowDate = now.value ? new Date(now.value) : new Date(); const start = new Date(r.date + 'T' + r.heure); const dureeRdvMs = 60 * 60 * 1000; const diffMs = start - nowDate; if (diffMs <= -dureeRdvMs) return ''; if (diffMs < 0 && diffMs > -dureeRdvMs) { return 'RDV en cours'; } const diffMin = Math.round(diffMs / 60000); if (diffMin < 1) { return "RDV dans moins d‚Äô1 minute"; } if (diffMin < 60) { return `RDV dans ${diffMin} min`; } const diffHours = Math.floor(diffMin / 60); const restMin = diffMin % 60; if (diffHours < 24) { if (restMin === 0) { return `RDV dans ${diffHours}h`; } return `RDV dans ${diffHours}h ${restMin}min`; } const diffDays = Math.round(diffMin / (24 * 60)); if (diffDays === 1) { return 'RDV dans 1 jour'; } return `RDV dans ${diffDays} jours`; };
            const nextRdvLabel = computed(() => { if (!rdvList.value || rdvList.value.length === 0) return ''; const todayStr = new Date().toISOString().split('T')[0]; const nowDate = now.value ? new Date(now.value) : new Date(); const candidates = rdvList.value.filter(r => r.date === todayStr && r.statut !== 'poubelle' && r.heure).map(r => ({ rdv: r, start: new Date(r.date + 'T' + r.heure) })).filter(o => o.start > nowDate); if (candidates.length === 0) return ''; candidates.sort((a, b) => a.start - b.start); return getRelativeRdvLabel(candidates[0].rdv); });
            const pendingStatusList = computed(() => { return rdvList.value.filter(r => { if(!['confirme', 'a_confirmer'].includes(r.statut)) return false; if(!r.date || !r.heure) return false; const end = new Date(r.date+'T'+r.heure).getTime() + 3600000; return now.value.getTime() > end; }); });
            const pendingStatusCount = computed(() => pendingStatusList.value.length);

            // Computed pour les stats du prospecteur
            const prospecteurStats = computed(() => {
                if (!selectedProspecteur.value) return { ca: 0, honoredCount: 0, commissions: 0, tips: 0, net: 0, tiers: [] };

                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                
                // CA g√©n√©r√© (RDV honor√©s ce mois)
                const honoredRdv = rdvList.value.filter(r => {
                    if (r.statut !== 'honore' || r.createdBy !== selectedProspecteur.value) return false;
                    if (!r.date) return false;
                    const d = new Date(r.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                });

                const ca = honoredRdv.reduce((acc, r) => {
                    const price = parseFloat(r.prix) || 0;
                    const discount = parseFloat(r.geste_commercial) || 0;
                    return acc + (price - discount);
                }, 0);

                const honoredCount = honoredRdv.length;

                // Calcul des commissions
                const basePrice = parseFloat(globalCommission.base) || 0;
                const bonusThreshold = parseInt(globalCommission.threshold) || 21;
                const bonusStep = parseInt(globalCommission.step) || 10;
                const bonusAmount = parseFloat(globalCommission.amount) || 100;

                let commissions = honoredCount * basePrice;
                if (honoredCount >= bonusThreshold) {
                    const multiplier = Math.floor((honoredCount - bonusThreshold) / bonusStep) + 1;
                    commissions += (multiplier * bonusAmount);
                }

                // Pourboires (calcul√©s depuis les transactions)
                const member = teamList.value.find(m => m.name === selectedProspecteur.value);
                const currentMonthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                const tips = (member && member.tips && member.tips[currentMonthKey]) || 0;

                const net = ca - commissions - tips;

                // Paliers
                const tiers = [];
                for (let i = bonusThreshold; i <= honoredCount + bonusStep; i += bonusStep) {
                    tiers.push({
                        level: Math.floor((i - bonusThreshold) / bonusStep) + 1,
                        count: i,
                        reached: honoredCount >= i
                    });
                }

                return { ca, honoredCount, commissions, tips, net, tiers };
            });

            // Toutes les transactions (admin)
            const allTransactions = computed(() => {
                if (!selectedProspecteur.value) return [];
                return transactions.value;
            });

            // Transactions visibles (prospecteur) - Afficher TOUTES les transactions
            const visibleTransactions = computed(() => {
                // Afficher toutes les transactions, m√™me celles cach√©es (elles auront un indicateur visuel)
                return transactions.value.filter(t => t.userId === user.name);
            });

            // Portefeuille utilisateur (prospecteur) - Calcul bas√© sur les transactions non cach√©es
            const userPortefeuille = computed(() => {
                // Calculer le total uniquement avec les transactions non cach√©es
                const total = transactions.value
                    .filter(t => t.userId === user.name && !t.hidden)
                    .reduce((acc, t) => acc + (parseFloat(t.amount) || 0), 0);
                return { total };
            });

            // Stats de chaque prospecteur (pour les cartes)
            const prospectorsWithStats = computed(() => {
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                
                return onlyProspectors.value.map(prosp => {
                    const honoredRdv = rdvList.value.filter(r => {
                        if (r.statut !== 'honore' || r.createdBy !== prosp.name) return false;
                        if (!r.date) return false;
                        const d = new Date(r.date);
                        return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                    });

                    const ca = honoredRdv.reduce((acc, r) => {
                        const price = parseFloat(r.prix) || 0;
                        const discount = parseFloat(r.geste_commercial) || 0;
                        return acc + (price - discount);
                    }, 0);

                    const honoredCount = honoredRdv.length;

                    // Calcul des commissions
                    const basePrice = parseFloat(globalCommission.base) || 0;
                    const bonusThreshold = parseInt(globalCommission.threshold) || 21;
                    const bonusStep = parseInt(globalCommission.step) || 10;
                    const bonusAmount = parseFloat(globalCommission.amount) || 100;

                    let commissions = honoredCount * basePrice;
                    if (honoredCount >= bonusThreshold) {
                        const multiplier = Math.floor((honoredCount - bonusThreshold) / bonusStep) + 1;
                        commissions += (multiplier * bonusAmount);
                    }

                    const currentMonthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                    const tips = (prosp.tips && prosp.tips[currentMonthKey]) || 0;

                    const net = ca - commissions - tips;

                    return {
                        name: prosp.name,
                        ca,
                        honoredCount,
                        net
                    };
                });
            });

            // Prospecteurs filtr√©s par recherche
            const displayedProspectors = computed(() => {
                if (!portefeuilleSearch.value) return prospectorsWithStats.value;
                const search = portefeuilleSearch.value.toLowerCase();
                return prospectorsWithStats.value.filter(p => p.name.toLowerCase().includes(search));
            });

            // Stats admin (solde jour brut, solde mois brut, solde mois net)
            const adminStats = computed(() => {
                const today = new Date().toISOString().split('T')[0];
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();

                // CA du jour (brut) = prix des RDV honor√©s aujourd'hui
                const caDaily = rdvList.value
                    .filter(r => r.statut === 'honore' && r.date === today)
                    .reduce((acc, r) => {
                        const price = parseFloat(r.prix) || 0;
                        const discount = parseFloat(r.geste_commercial) || 0;
                        return acc + (price - discount);
                    }, 0);

                // CA du mois (brut) = prix des RDV honor√©s ce mois
                const caMonthly = rdvList.value
                    .filter(r => {
                        if (r.statut !== 'honore' || !r.date) return false;
                        const d = new Date(r.date);
                        return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                    })
                    .reduce((acc, r) => {
                        const price = parseFloat(r.prix) || 0;
                        const discount = parseFloat(r.geste_commercial) || 0;
                        return acc + (price - discount);
                    }, 0);

                // Calcul des commissions du mois (ce qu'on verse aux prospecteurs)
                const basePrice = parseFloat(globalCommission.base) || 10;
                const bonusThreshold = parseInt(globalCommission.threshold) || 21;
                const bonusStep = parseInt(globalCommission.step) || 10;
                const bonusAmount = parseFloat(globalCommission.amount) || 100;
                const currentMonthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                
                let monthlyCommissions = 0;
                const monthlyCommissionMap = {};
                
                // Compter les RDV honor√©s par prospecteur ce mois
                rdvList.value.forEach(r => {
                    if (r.statut === 'honore' && r.createdBy && r.date) {
                        const d = new Date(r.date);
                        if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
                            const uName = r.createdBy;
                            const userObj = teamList.value.find(u => u.name === uName);
                            const isRoleAdmin = userObj && userObj.role === 'admin';
                            const isNameInAdminList = adminNamesList.value.includes(uName);
                            
                            // Exclure les admins des commissions
                            if (!isNameInAdminList && !isRoleAdmin) {
                                if (!monthlyCommissionMap[uName]) monthlyCommissionMap[uName] = 0;
                                monthlyCommissionMap[uName]++;
                            }
                        }
                    }
                });

                // Calculer les commissions totales du mois (primes + bonus + pourboires)
                for (const [userName, count] of Object.entries(monthlyCommissionMap)) {
                    let userTotal = count * basePrice;
                    if (count >= bonusThreshold) {
                        const multiplier = Math.floor((count - bonusThreshold) / bonusStep) + 1;
                        userTotal += (multiplier * bonusAmount);
                    }
                    
                    // Ajouter les pourboires du mois
                    const userObj = teamList.value.find(u => u.name === userName);
                    if (userObj && userObj.tips && userObj.tips[currentMonthKey]) {
                        userTotal += parseFloat(userObj.tips[currentMonthKey]) || 0;
                    }

                    monthlyCommissions += userTotal;
                }

                // CA net du mois = CA brut du mois - commissions du mois
                const netMonthly = caMonthly - monthlyCommissions;

                return { 
                    caDaily,      // Solde du jour (brut)
                    caMonthly,    // Solde du mois (brut)
                    netMonthly    // Solde du mois (net = brut - commissions)
                };
            });
            const displayStatus = (r) => { if(r.statut === 'honore') return user.role==='admin' ? (r.honorBilling==='facture'?'Honor√© ‚Ä¢ Factur√©':'Honor√© ‚Ä¢ Non factur√©') : 'Honor√©'; if(r.statut === 'pas_venu') return 'Pas Venu'; if(r.statut === 'annule') return 'Annul√©'; if(r.statut === 'a_confirmer') return '√Ä Confirmer'; return 'Confirm√©'; };
            const statusClass = (s) => ({ 'honore': 'bg-green-100 text-green-700', 'pas_venu': 'bg-red-100 text-red-700', 'annule': 'bg-gray-200 text-gray-500', 'a_confirmer': 'bg-orange-100 text-orange-700', 'confirme': 'bg-blue-100 text-blue-700' }[s] || 'bg-gray-100');
            const validateAction = async (r, type) => { 
                if(type==='rappels') {
                    const now = new Date();
                    const note = { 
                        text: `üîî Rappel envoy√©`, 
                        author: user.name, 
                        date: now.toISOString(),
                        type: 'rappel'
                    };
                    let notes = r.notes || []; 
                    notes.push(note);
                    await db.collection('rendezvous').doc(r.id).update({ 
                        rappelFait: true,
                        rappelFaitDate: now.toISOString(),
                        rappelFaitHeure: now.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'}),
                        notes: notes
                    }); 
                    r.rappelFait = true;
                    r.rappelFaitDate = now.toISOString();
                    r.rappelFaitHeure = now.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
                    r.notes = notes;
                    if(clientModal.rdv && clientModal.rdv.id === r.id) {
                        clientModal.rdv.rappelFait = true;
                        clientModal.rdv.rappelFaitDate = now.toISOString();
                        clientModal.rdv.rappelFaitHeure = now.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
                        clientModal.rdv.notes = notes;
                    }
                }
                if(type==='confirmations') {
                    // V√©rifier si le RDV est dans l'agenda avant de valider
                    if (!r.dansAgenda) {
                        // Afficher un modal moderne au lieu d'un confirm()
                        return new Promise((resolve) => {
                            confirmAgendaModal.rdv = r;
                            confirmAgendaModal.onConfirm = async (confirmed) => {
                                if (confirmed) {
                                    // L'utilisateur confirme qu'il a ajout√© √† l'agenda, on valide
                                    await db.collection('rendezvous').doc(r.id).update({ statut:'confirme' });
                                    r.statut = 'confirme';
                                } else {
                                    // L'utilisateur veut d'abord ajouter √† l'agenda
                                    // Ne rien faire, il pourra cliquer sur le bouton Agenda
                                }
                                confirmAgendaModal.open = false;
                                confirmAgendaModal.rdv = null;
                                confirmAgendaModal.onConfirm = null;
                                resolve();
                            };
                            confirmAgendaModal.open = true;
                        });
                    } else {
                        await db.collection('rendezvous').doc(r.id).update({ statut:'confirme' }); 
                    }
                }
            };
            const generateLink = (r, type) => generateMsgLink(r, type);

            return {
                user, loginEmail, loginPass, view, login, logout, loginAdminSelection, finalizeAdminLogin,
                rdvList, agences, sourcesList, stats, sortedDaily, filteredList, displayedList, rappelsList, confirmList, rappelCount, confirmCount,
                wizard, form, clientModal, settingsModal, cancelModal,
                rescheduleModal, openRescheduleModal, confirmRescheduleStep1, sendRescheduleSMS, deleteRdv: softDeleteRdv, softDeleteRdv,
                changeView, showUpcoming, showLive, showHonored, showNoShow, showCancelled, goBackFromList, fromDashboard, // NEW EXPORTS
                currentFilter, listFilters, resetListFilters, displayLimit,
                startWizard, finalizeRdv, selectSource, validateAndSendSMS, finalizeRdvWithSMS, googleCalendarDisconnectedModal,
                openRdvFiche, updateRdv, toggleOkM, resendReminder, openCancelChoice, confirmCancel, quickCancel, updateStatus, rdvMenuOpen,
                openSettings, openAgencyEdit, saveEditingAgency, editingAgency, saveAgency, deleteAgency, addSource, removeSource, changeSourceLogo, getLogo,
                newSource, motifsList, newMotif, addMotif, removeMotif, editingMsgAgence, editingMsgType, clientExists, insertTag, msgLabels,
                generateMsgLink, generateLink, validateAction,
                dateOptions, timeSlots, commonCars, pastePhoneNumber, copyToAgenda, showCustomTime, updateGoogleCalendarEvent, deleteGoogleCalendarEvent, addToAgenda, removeFromAgenda, fetchGoogleCalendarList, googleCalendarList, loadingCalendars,
                syncSettings, saveSyncSettings, 
                filters, search, 
                formatDateFr, formatDateShort, formatDateLong, formatPrice, isEnCours, isLateAndNoStatus, displayStatus, statusClass, getAgenceName, getCreatedDate, getCreatedTime, isNewRdvFromOther, isRdvApproaching, needsRappel, getCalendarColor,
                normalizePhone, onWizardPhoneInput, onModalPhoneInput,
                getRappelType, getRappelLabel,
                openReschedule,
                currentFullDateLabel, checkAgenceAndProceed, pausedAgencyModal, pauseReasonSelect, updatePauseReason,
                getPauseMessage, getProgressPercent, getRdvTimeStatus,
                pendingStatusList, pendingStatusCount, getRelativeRdvLabel,
                selectedIds, selectAll, toggleSelection, isAllSelected, bulkModal, openBulkConfirm, executeBulkAction, 
                trashList, trashCount, restoreRdv, hardDeleteRdv,
                agencySearch, filteredAgences,
                calculateTTC, conversionRate, conversionRateColor, conversionEmoji, activeRdvCount,
                // NEW VARS
                teamList, newMember, addTeamMember, toggleBlockTeamMember, deleteTeamMember, mobileMenuOpen, welcomeModal,
                adminNamesList, newAdminName, addAdminName, removeAdminName,
                newNoteText, addNote,showDiscountInput, allProspectors, dashboardFilters, dashboardLimit, filteredDaily,rdvTodayCount, nextRdvLabel, currentTheme, isTimelineTomorrow, showTimelineTomorrow,
                googleCalendarConnected, googleCalendarUserEmail, isGoogleCalendarConnected, googleCalendarTokenValid, checkingToken, checkAndUpdateTokenStatus, tokenTimeRemaining, connectGoogleCalendar, disconnectGoogleCalendar, manualSyncGoogleCalendar,
                prospecteurGoogleCalendarConnected, prospecteurGoogleCalendarTokenExpired, prospecteurTokenTimeRemaining, prospecteurGoogleCalendarTokenValid, checkingProspecteurToken, checkAndUpdateProspecteurTokenStatus, handleProspecteurGoogleCalendar, getActiveGoogleToken, activeGoogleToken,
                confirmAgendaModal, reconnectAgendaModal, googleCalendarInfoModal, handleAddToAgendaClick, handleRemoveFromAgendaClick, handleReconnectForAgenda, handleCloseDisconnectedModal, saveGoogleCalendarRequired, googleCalendarRequired,
                // CALENDRIER
                currentWeekStart, calendarWeekDays, calendarHours, calendarEvents, calendarLoading, calendarAgencyFilter,
                previousWeek, nextWeek, goToToday, refreshCalendarEvents, createRdvFromTimeSlot, openEventDetails,
                getEventsForSlot, getEventStyle, getEventTitle, getEventTime, isCurrentTimeSlot, formatCalendarWeekTitle, getAgenceColor,
                isClosedSlot, getClosedMessage, getOpeningTime, getOpeningLineStyle, getDayHoursInfo, isDayClosed,
                applyHorairesToAllDays,
                honorModal, openHonorCheck, finalizeHonor,
                editModal, openEdit, saveEdit, deleteNote,
                
                discountModal, openDiscountModal, saveDiscount, removeDiscount,
                reminderAlertModal, rappelsVeilleCount, rappelsJourCount,
                teamEditModal, openTeamEdit, saveTeamMemberEdit, 
                customConfirmModal, openCustomConfirm, rappelFilters, rappelsDisplay,
                globalSettings, saveGlobalSettings,
                pendingStatusModal,
                notificationToast, showNotification, 
                
                // NEW STATS & PRICING
                statsModal, openStatsModal, detailedStats, mandatsParAgence, statsFilterAgency, statsFilterUser, visibleAgencies, userCommissionStats,
                globalCommission, tips, saveTip,
                
                // PORTAFEUILLE
                portefeuilleSearch, selectedProspecteur, filteredProspectors, transactions, prospecteurEdit,
                filterProspectors, selectProspecteur, loadProspecteurData, saveProspecteurSettings,
                hideTransaction, showTransaction, deleteTransaction, getTransactionIcon, loadUserTransactions,
                prospecteurStats, allTransactions, visibleTransactions, userPortefeuille,
                onlyProspectors, prospectorsWithStats, displayedProspectors, adminStats,
                createTransactionForRdv, checkAndCreateBonusTransactions, deleteTransactionsForRdv, createMissingTransactionsForUser, getRdvFromTransaction, tipModal, openTipModal, saveTipTransaction
            };
        }
    }).mount('#app');
</script>
</body> 
</html>
