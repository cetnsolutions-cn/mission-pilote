<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Portail Commercial Centralisé</title>
 
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
    /* NOUVEAU : Verrouille la hauteur de l'application */
    html, body, #root { 
        height: 100%; 
        width: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden; /* Important : empêche le scroll global du navigateur */
    }

    body { 
        font-family: 'Montserrat', sans-serif; 
        background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #00f2fe 100%);
        background-size: 400% 400%;
        animation: gradientShift 15s ease infinite;
        user-select: none; 
        -webkit-user-select: none; 
        -webkit-tap-highlight-color: transparent;
        /* NOUVEAU : Fixe le corps de page aux bords de l'écran mobile */
        position: fixed;
        inset: 0;
    }

    @keyframes gradientShift {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
    }

    @keyframes glow {
        0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
        50% { box-shadow: 0 0 30px rgba(59, 130, 246, 0.6); }
    }

    @keyframes shimmer {
        0% { background-position: -1000px 0; }
        100% { background-position: 1000px 0; }
    }

    .loader { 
        border-top-color: #667eea; 
        border-right-color: #764ba2;
        border-bottom-color: #f093fb;
        border-left-color: #4facfe;
        -webkit-animation: spinner 1s linear infinite; 
        animation: spinner 1s linear infinite; 
    }
    
    @keyframes spinner { 
        0% { transform: rotate(0deg); } 
        100% { transform: rotate(360deg); } 
    }
    
    .suggestions-list { 
        position: absolute; 
        background: rgba(255, 255, 255, 0.95); 
        backdrop-filter: blur(20px);
        width: 100%; 
        border: 1px solid rgba(255, 255, 255, 0.3); 
        border-radius: 1rem; 
        z-index: 50; 
        max-height: 200px; 
        overflow-y: auto; 
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    .suggestion-item { 
        padding: 0.75rem 1rem; 
        cursor: pointer; 
        font-size: 0.875rem; 
        transition: all 0.2s ease;
    }
    
    .suggestion-item:hover { 
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        transform: translateX(4px);
    }
    
    .modal-overlay { 
        position: fixed; 
        top: 0; 
        left: 0; 
        right: 0; 
        bottom: 0; 
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(8px);
        display: flex; 
        justify-content: center; 
        align-items: center; 
        z-index: 1000; 
        padding: 1rem; 
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .modal-content { 
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        padding: 2rem; 
        border-radius: 1.5rem; 
        max-width: 400px; 
        width: 100%; 
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        border: 1px solid rgba(255, 255, 255, 0.3);
        animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    
    .error-popup { 
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        border: 1px solid #fca5a5; 
        color: #dc2626; 
        padding: 1rem; 
        border-radius: 0.75rem; 
        font-size: 0.9rem;
        box-shadow: 0 10px 15px -3px rgba(220, 38, 38, 0.2);
    }

    /* Scrollbar invisible mais fonctionnelle pour le contenu interne */
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    .sidebar-transition { transition: transform 0.3s ease-in-out; }

    /* Glassmorphism effect */
    .glass {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* Enhanced card hover effects */
    .card-hover {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .card-hover:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    /* Gradient text */
    .gradient-text {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    /* Animated blob */
    .blob {
        border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
        animation: blob 20s infinite;
    }

    @keyframes blob {
        0% { border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%; }
        25% { border-radius: 58% 42% 75% 25% / 76% 46% 54% 24%; }
        50% { border-radius: 50% 50% 33% 67% / 55% 27% 73% 45%; }
        75% { border-radius: 33% 67% 58% 42% / 63% 68% 32% 37%; }
        100% { border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%; }
    }

    .animate-blob {
        animation: blob 7s infinite;
    }

    .animation-delay-2000 {
        animation-delay: 2s;
    }

    .animation-delay-4000 {
        animation-delay: 4s;
    }

    @keyframes shimmer {
        0% { background-position: -100% 0; }
        100% { background-position: 100% 0; }
    }

    .animate-shimmer {
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
        background-size: 200% 100%;
        animation: shimmer 2s infinite;
    }
</style>
</head>
<body oncontextmenu="return false;">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDoc, deleteDoc, doc, setDoc, query, orderBy, limit, getDocs, updateDoc, onSnapshot, where, writeBatch, increment } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // --- CONFIGURATION BDD ---
        const firebaseConfig = {
            apiKey: "AIzaSyA7-qZ8z9ET27RnWJiZBkYPsJdn3XU8ckg",
            authDomain: "rdv-message.firebaseapp.com",
            projectId: "rdv-message",
            storageBucket: "rdv-message.firebasestorage.app",
            messagingSenderId: "262090614175",
            appId: "1:262090614175:web:921a04c11d66e4d1a7c9aa",
            measurementId: "G-YCGJ44WY7L"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const secondaryApp = initializeApp(firebaseConfig, "Secondary");
        const secondaryAuth = getAuth(secondaryApp);

        const { useState, useEffect, useCallback, useMemo } = React;
        const { jsPDF } = window.jspdf;

        // --- MAPPAGE DES STATUTS ---
        const StatusMap = {
            Pending: { label: "En attente", color: "orange" },
            Envoyé: { label: "Envoyé", color: "blue" },
            Reflection: { label: "En réflexion", color: "yellow" },
            Signed: { label: "Validé / Payé", color: "green" }, 
            Drafted: { label: "Validé / Payé", color: "green" }, 
            Abandoned: { label: "Refusé / Abandonné", color: "slate" },
            Declined: { label: "Refusé", color: "red" },
            RequestDelete: { label: "Demande Suppr.", color: "red" },
            ToDraft: { label: "À Traiter", color: "orange" }
        };

        const Icon = ({ name, size = 20, className }) => {
            const icons = {
                menu: '<line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line>',
                zap: '<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>',
                search: '<circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>',
                calendar: '<rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>',
                car: '<rect x="3" y="10" width="18" height="8" rx="2"></rect><path d="M5 10l2-5h10l2 5"></path><line x1="12" y1="15" x2="12" y2="15"></line>',
                settings: '<circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>',
                save: '<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline>',
                trash: '<polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>',
                users: '<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path>',
                download: '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line>',
                list: '<line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line>',
                phone: '<path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>',
                mail: '<path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline>',
                mapPin: '<path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle>',
                link: '<path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>',
                briefcase: '<rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>',
                lock: '<rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path>',
                unlock: '<rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"></path>',
                power: '<path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path><line x1="12" y1="2" x2="12" y2="12"></line>',
                eye: '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>',
                eyeOff: '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>',
                key: '<path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path>',
                layout: '<rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line>',
                fileText: '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline>',
                edit: '<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>',
                check: '<polyline points="20 6 9 17 4 12"></polyline>',
                x: '<line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>',
                refreshCw: '<path d="M23 4v6h-6"></path><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>',
                bell: '<path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path>',
                smile: '<circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line>',
                upload: '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line>',
                clipboardCheck: '<path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect><path d="M9 14l2 2 4-4"></path>',
                dollar: '<line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>',
                wallet: '<path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"></path><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"></path><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"></path>',
                folder: '<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>',
                logOut: '<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line>'
            };
            return React.createElement('svg', {
                xmlns: "http://www.w3.org/2000/svg",
                width: size, height: size, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round",
                className: className,
                dangerouslySetInnerHTML: { __html: icons[name] || '' }
            });
        };

        // --- MOTEUR PDF ---
        const generateOrderPDF = (orderData, settings) => {
            const doc = new jsPDF();
            
            const colors = {
                darkBlue: [15, 23, 42],
                accent: [59, 130, 246],
                text: [51, 65, 85],
                lightBg: [248, 250, 252],
                white: [255, 255, 255]
            };

            const taxLabel = settings.taxType || "HT";

            doc.setFillColor(...colors.darkBlue);
            doc.rect(0, 0, 210, 50, 'F');

            if (settings.logo) {
                try {
                    doc.addImage(settings.logo, 'PNG', 15, 10, 40, 30, undefined, 'FAST');
                } catch(e) {}
            }

            doc.setFont("helvetica", "bold");
            doc.setFontSize(24);
            doc.setTextColor(...colors.white);
            doc.text("ORDRE DE MISSION PILOTE", 200, 25, { align: "right" });
            
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(200, 200, 200);
            
            const refString = orderData.reference || "N/A";
            const dateToDisplay = orderData.createdAt && orderData.createdAt.seconds ? orderData.createdAt.seconds * 1000 : (orderData.createdAt || new Date());
            doc.text(`RÉF: ${refString}`, 200, 35, { align: "right" });
            doc.text(`Date: ${new Date(dateToDisplay).toLocaleDateString('fr-FR')}`, 200, 40, { align: "right" });

            doc.setFillColor(255, 255, 255);
            doc.roundedRect(145, 55, 55, 10, 1, 1, 'F');
            doc.setFontSize(9);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(220, 38, 38);
            doc.text("SEMAINE PILOTE - SANS ENGAGEMENT", 172.5, 61, { align: "center" });

            let y = 75;
            doc.setFontSize(9);
            doc.setTextColor(...colors.text);
            doc.setFont("helvetica", "bold");
            doc.text("PRESTATAIRE", 15, y);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(0);
            y += 5;
            doc.text(settings.myCompanyName || "Votre Société", 15, y);
            doc.text(settings.myAddress || "", 15, y+5);
            doc.text(settings.myEmail || "", 15, y+10);
            if(settings.mySiret) doc.text(`SIRET: ${settings.mySiret}`, 15, y+15);

            doc.setFont("helvetica", "bold");
            doc.setTextColor(...colors.darkBlue);
            doc.text("CLIENT", 115, 80);
            
            doc.setTextColor(0);
            doc.setFontSize(11);
            doc.text(orderData.companyName || "Nom Client", 115, 88);
            
            doc.setFont("helvetica", "normal");
            doc.setFontSize(9);
            
            const addressLines = doc.splitTextToSize(orderData.address || "Adresse", 85);
            doc.text(addressLines, 115, 94);
            
            let yAfterAddress = 94 + (addressLines.length * 4);
            
            const sirenDisplay = (orderData.siren === "EN COURS") ? "EN COURS D'IMMATRICULATION" : orderData.siren;
            doc.text(`SIREN: ${sirenDisplay}`, 115, yAfterAddress);
            
            if(orderData.clientEmail) {
                doc.text(orderData.clientEmail, 115, yAfterAddress + 5);
            }

            y = 130;
            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(...colors.darkBlue);
            doc.text("DÉTAILS DE LA MISSION", 15, y);

            y += 5;
            doc.setFillColor(...colors.darkBlue);
            doc.rect(15, y, 180, 10, 'F');
            doc.setTextColor(...colors.white);
            doc.setFontSize(9);
            doc.text("DESCRIPTION", 20, y+6.5);
            doc.text("DÉTAIL / VALEUR", 130, y+6.5);
            
            y += 10;

            const repCount = parseInt(orderData.salesRepsCount) || 1;
            const repLabel = repCount > 1 ? "Commerciaux" : "Commercial";

            const rows = [
                ["Période d'essai", `Du ${new Date(orderData.startDate).toLocaleDateString('fr-FR')} au ${new Date(orderData.endDate).toLocaleDateString('fr-FR')} (7 jours)`],
                ["Type de mission", "Qualification de leads automobiles"],
                ["Nombre de Commerciaux", `${repCount} ${repLabel}`],
                ["Plafond RDV (Semaine Pilote)", `${orderData.maxRdvTotal || '-'} RDV Max / Semaine`],
                ["Tarif Unitaire", `${orderData.ratePerAppointment} € ${taxLabel} / RDV`],
                ["Zone d'intervention", `${orderData.radiusKm} km autour de l'agence`],
                ["Critères Véhicule", `Max ${orderData.maxKmPerVehicle} km | Année > ${orderData.minVehicleYear}`]
            ];

            if (orderData.excludedVehicles && orderData.excludedVehicles.trim() !== "") {
                rows.push(["Modèles Exclus", orderData.excludedVehicles]);
            }

            rows.forEach((row, i) => {
                if (i % 2 === 0) {
                    doc.setFillColor(248, 250, 252);
                    doc.rect(15, y, 180, 8, 'F');
                }
                doc.setTextColor(...colors.text);
                doc.setFont("helvetica", "normal");
                doc.text(row[0], 20, y+5.5);
                doc.setFont("helvetica", "bold");
                doc.setTextColor(0);
                doc.text(row[1], 130, y+5.5);
                doc.setDrawColor(226, 232, 240);
                doc.line(15, y+8, 195, y+8);
                y += 8;
            });

            y = 225;
            doc.setDrawColor(200);
            doc.setLineWidth(0.5);
            doc.line(15, y-5, 195, y-5);

            doc.setFontSize(8);
            doc.setTextColor(...colors.text);
            doc.text("POUR LE PRESTATAIRE", 15, y);
            doc.text("Cachet et Signature :", 15, y+5);
            
            if (settings.stamp) {
                try {
                    doc.addImage(settings.stamp, 'PNG', 15, y+8, 35, 25, undefined, 'FAST');
                } catch(e) {}
            }

            doc.text("POUR LE CLIENT", 120, y);
            doc.text("Date, Cachet et Signature :", 120, y+5);
        
            
            doc.setDrawColor(200);
            doc.rect(120, y+13, 75, 25);

            y = 270;
            doc.setFontSize(7);
            doc.setTextColor(100);
            doc.setFont("helvetica", "bold");
            doc.text("CONDITIONS GÉNÉRALES DE PRESTATION :", 15, y);
            doc.setFont("helvetica", "normal");
            y += 4;
            
            const cgvLines = [
                `1. Le prestataire s'engage à fournir des rendez-vous qualifiés selon les critères définis ci-dessus.`,
                `2. Seuls les rendez-vous honorés (prospect présent au rendez-vous et qualifié) seront facturés au tarif de ${orderData.ratePerAppointment} € ${taxLabel}.`,
                `3. La durée et l'engagement de mission est valable pour une durée de une semaine (7 jours) selon les dates prédéfinies ci-dessus.`,
                `4. Mission sans engagement et sans renouvellement : à l'issue de la semaine, le client est libre d'arrêter ou de signer un contrat de collaboration.`,
                `5. Le client s'engage à fournir un accès à son agenda pour permettre la pose des créneaux.`
            ];

            cgvLines.forEach(line => {
                doc.text(line, 15, y);
                y += 3.5;
            });
        
            doc.save(`MissionPilote_${refString}.pdf`);
        };

        const formatPhoneNumber = (value) => {
            if (!value) return value;
            const numbersOnly = value.replace(/[^\d]/g, '');
            let formatted = '';
            for (let i = 0; i < numbersOnly.length; i++) {
                if (i > 0 && i % 2 === 0) formatted += ' ';
                formatted += numbersOnly[i];
            }
            return formatted.substring(0, 14);
        };

        const SuccessModal = ({ isOpen, onClose, reference, isEditing }) => {
            if (!isOpen) return null;

            return React.createElement('div', { className: "modal-overlay" },
                React.createElement('div', { className: "modal-content text-center" },
                    React.createElement('div', { className: "relative inline-flex mb-6" },
                        React.createElement('div', { className: "absolute inset-0 bg-green-400 rounded-full blur-xl opacity-50 animate-pulse" }),
                        React.createElement('div', { className: "relative h-20 w-20 bg-gradient-to-br from-green-400 to-emerald-600 rounded-full flex items-center justify-center text-white shadow-2xl" },
                            React.createElement(Icon, { name: "check", size: 40 })
                        )
                    ),
                    React.createElement('h3', { className: "text-2xl font-black text-slate-800 mb-3 gradient-text" }, isEditing ? "Mise à jour réussie !" : "Mission générée !"),
                    React.createElement('p', { className: "text-slate-600 mb-8 font-medium" },
                        `Le PDF de la mission ${reference} a été ${isEditing ? 'mis à jour et téléchargé' : 'généré et téléchargé'} avec succès.`
                    ),
                    React.createElement('button', {
                        onClick: onClose,
                        className: "w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-3.5 rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-[1.02] active:scale-[0.98]"
                    }, "Fermer et continuer")
                )
            );
        };

        // --- COMPONENTS ---

        function Login({ onLogin }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [showPassword, setShowPassword] = useState(false);
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (err) {
                    setError("Identifiants incorrects ou compte bloqué.");
                    setLoading(false);
                }
            };

            return React.createElement('div', { className: "min-h-screen flex items-center justify-center p-4 relative overflow-hidden" },
                React.createElement('div', { className: "absolute inset-0 overflow-hidden" },
                    React.createElement('div', { className: "absolute top-0 left-0 w-96 h-96 bg-blue-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob" }),
                    React.createElement('div', { className: "absolute top-0 right-0 w-96 h-96 bg-purple-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob animation-delay-2000" }),
                    React.createElement('div', { className: "absolute bottom-0 left-1/2 w-96 h-96 bg-pink-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob animation-delay-4000" })
                ),
                React.createElement('div', { className: "relative bg-white/90 backdrop-blur-xl rounded-3xl shadow-2xl p-8 md:p-10 max-w-md w-full border border-white/20" },
                    React.createElement('div', { className: "text-center mb-8" },
                        React.createElement('div', { className: "inline-flex items-center justify-center w-20 h-20 rounded-full bg-gradient-to-br from-blue-600 to-purple-600 mb-4 shadow-lg" },
                            React.createElement(Icon, { name: "key", size: 40, className: "text-white" })
                        ),
                        React.createElement('h1', { className: "text-3xl font-black gradient-text mb-2" }, "PORTAIL PARTENAIRE"),
                        React.createElement('p', { className: "text-slate-600 text-sm mt-2 font-medium" }, "Connectez-vous à votre espace centralisé.")
                    ),
                    React.createElement('form', { onSubmit: handleLogin, className: "space-y-6" },
                        React.createElement('div', null,
                            React.createElement('label', { className: "block text-sm font-bold text-slate-700 mb-2" }, "Email"),
                            React.createElement('input', {
                                type: "email",
                                required: true,
                                value: email,
                                onChange: (e) => setEmail(e.target.value),
                                className: "w-full border-2 border-slate-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all bg-slate-50/50 hover:bg-white"
                            })
                        ),
                        React.createElement('div', null,
                            React.createElement('label', { className: "block text-sm font-bold text-slate-700 mb-2" }, "Mot de passe"),
                            React.createElement('div', { className: "relative" },
                                React.createElement('input', {
                                    type: showPassword ? "text" : "password",
                                    required: true,
                                    value: password,
                                    onChange: (e) => setPassword(e.target.value),
                                    className: "w-full border-2 border-slate-200 rounded-xl px-4 py-3 pr-12 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all bg-slate-50/50 hover:bg-white"
                                }),
                                React.createElement('button', {
                                    type: "button",
                                    onClick: () => setShowPassword(!showPassword),
                                    className: "absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 transition",
                                    title: showPassword ? "Masquer" : "Afficher"
                                }, React.createElement(Icon, { name: showPassword ? "eyeOff" : "eye", size: 20 }))
                            )
                        ),
                        error && React.createElement('p', { className: "text-red-600 text-sm text-center font-medium bg-red-50 p-3 rounded-xl border border-red-200" }, error),
                        React.createElement('button', {
                            type: "submit",
                            disabled: loading,
                            className: "w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold py-3.5 rounded-xl transition-all duration-300 flex justify-center items-center gap-2 shadow-lg hover:shadow-xl transform hover:scale-[1.02] active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed"
                        }, loading ? React.createElement('div', { className: "loader border-4 border-white border-t-transparent rounded-full w-5 h-5" }) : null, loading ? "Connexion..." : "Se connecter")
                    )
                )
            );
        }
// --- MODULE AFFAIRES (RECTIFIÉ : BOUTON POUBELLE DÉDIÉ) ---
function AdminTodoModule({ user, db, setCurrentModule, setCurrentOrder, globalSettings }) {
    const [viewMode, setViewMode] = useState('menu'); // 'menu' ou 'list'
    const [internalTab, setInternalTab] = useState('all'); // 'all', 'missions', 'contracts', 'trash'
    const [items, setItems] = useState([]);
    const [loading, setLoading] = useState(true);
    
    // Modales & Édition
    const [selectedItem, setSelectedItem] = useState(null); 
    const [actionStep, setActionStep] = useState(null); 
    const [reasonText, setReasonText] = useState('');
    const [pdfPreviewUrl, setPdfPreviewUrl] = useState(null);

    // --- CHARGEMENT ---
    useEffect(() => {
        setLoading(true);
        const qOrders = query(collection(db, "orders"), orderBy("createdAt", "desc"), limit(100));
        const qContracts = query(collection(db, "contracts"), orderBy("createdAt", "desc"), limit(100));

        const unsub1 = onSnapshot(qOrders, (snap) => {
            const orders = snap.docs.map(d => ({ ...d.data(), id: d.id, type: 'Mission' }));
            updateList(orders, null);
        });
        const unsub2 = onSnapshot(qContracts, (snap) => {
            const contracts = snap.docs.map(d => ({ ...d.data(), id: d.id, type: 'Contrat' }));
            updateList(null, contracts);
        });

        let currentOrders = []; let currentContracts = [];
        const updateList = (newOrders, newContracts) => {
            if (newOrders) currentOrders = newOrders;
            if (newContracts) currentContracts = newContracts;
            const merged = [...currentOrders, ...currentContracts].sort((a, b) => {
                const dateA = a.createdAt?.seconds || 0;
                const dateB = b.createdAt?.seconds || 0;
                return dateB - dateA;
            });
            setItems(merged);
            setLoading(false);
        };
        return () => { unsub1(); unsub2(); };
    }, [db]);

    // --- FILTRES ---
    // 1. Les dossiers actifs (À Traiter)
    const todoItems = items.filter(i => ["Pending", "ToDraft", "SentToClient", "Reflection"].includes(i.status));
    
    // 2. La Corbeille (Demandes de suppression)
    const trashItems = items.filter(i => i.status === 'RequestDelete');

    // 3. L'Historique (Le reste : Validé, Refusé...)
    const historyItems = items.filter(i => !["Pending", "ToDraft", "SentToClient", "Reflection", "RequestDelete"].includes(i.status));

    // Compteurs
    const counts = {
        todoTotal: todoItems.length,
        trashTotal: trashItems.length,
        missions: todoItems.filter(i => i.type === 'Mission').length,
        contracts: todoItems.filter(i => i.type === 'Contrat').length
    };

    // Sélection des items à afficher
    const getDisplayedItems = () => {
        if (viewMode === 'history') return historyItems;
        if (internalTab === 'trash') return trashItems; // Onglet Poubelle
        
        // Onglets normaux
        if (internalTab === 'missions') return todoItems.filter(i => i.type === 'Mission');
        if (internalTab === 'contracts') return todoItems.filter(i => i.type === 'Contrat');
        return todoItems; // 'all'
    };
    
    const displayedItems = getDisplayedItems();

    // --- ACTIONS ---
    const markAsRead = async (item) => {
        if(item.adminRead) return;
        try {
            const itemRef = doc(db, item.type === 'Mission' ? "orders" : "contracts", item.id);
            await updateDoc(itemRef, { adminRead: true });
        } catch (error) { console.error("Erreur lecture", error); }
    };

    const handleOpenItem = (item) => { 
        markAsRead(item); 
        setSelectedItem(item); 
        setActionStep(null); 
        setReasonText(''); 
    };

    const handlePreviewPdf = (e, item) => { 
        e.stopPropagation(); 
        markAsRead(item); 
        const url = generateOrderPDF(item, globalSettings, 'url'); 
        setPdfPreviewUrl(url); 
    };
    
    const openAction = (step, msg) => { setActionStep(step); setReasonText(msg); };
    
    const executeAction = async (actionType) => {
        const batch = writeBatch(db);
        const col = selectedItem.type === 'Mission' ? "orders" : "contracts";
        const ref = doc(db, col, selectedItem.id);
        const finalMsg = reasonText || "";

        if (actionType === 'validate') {
            const status = selectedItem.type === 'Contrat' ? 'Signed' : 'Envoyé';
            const amount = selectedItem.type === 'Contrat' ? (globalSettings.contractAmount || 0) : (globalSettings.pilotMissionAmount || 0);
            batch.update(ref, { status: status, adminMessage: finalMsg, validatedAt: new Date(), readBySalesRep: false, adminRead: true });
            if (amount > 0 && selectedItem.salesRepId) {
                batch.update(doc(db, "users", selectedItem.salesRepId), { totalEarnings: increment(amount) });
            }
        } 
        else if (actionType === 'refuse') {
            batch.update(ref, { status: 'Declined', declinedReason: finalMsg, readBySalesRep: false, adminRead: true });
        }
        else if (actionType === 'reflection') {
            batch.update(ref, { status: 'Reflection', reflectionReason: finalMsg, readBySalesRep: false, adminRead: true });
        }
        else if (actionType === 'delete_permanent') {
            batch.delete(ref);
        }
        else if (actionType === 'restore') {
            // Restaure en Pending
            batch.update(ref, { status: 'Pending', deleteReason: null, adminRead: true });
        }

        await batch.commit();
        setSelectedItem(null);
    };

    // --- HELPER AFFICHAGE ---
    const DetailBlock = ({ title, data }) => (
        React.createElement('div', { className: "mb-6 bg-slate-50 p-4 rounded-2xl border border-slate-100" },
            React.createElement('h4', { className: "text-xs font-black text-slate-400 uppercase tracking-widest mb-3 border-b border-slate-200 pb-2" }, title),
            React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-y-3 gap-x-6" },
                data.map((row, i) => (
                    row.value ? React.createElement('div', { key: i, className: "flex flex-col" },
                        React.createElement('span', { className: "text-[10px] font-bold text-slate-500 uppercase" }, row.label),
                        React.createElement('span', { className: "text-sm font-bold text-slate-800 break-words" }, row.value)
                    ) : null
                ))
            )
        )
    );

    // --- RENDER ---
    return React.createElement('div', { className: "w-full pb-20" },
        
        // 1. MENU PRINCIPAL
        viewMode === 'menu' ? (
            React.createElement('div', { className: "p-6 md:p-10 max-w-4xl mx-auto animate-in slide-in-from-bottom-4 duration-500" },
                React.createElement('div', { className: "text-center mb-10" },
                    React.createElement('h2', { className: "text-3xl font-black text-slate-900" }, "Pilotage Commercial"),
                    React.createElement('p', { className: "text-slate-500 font-medium mt-2" }, "Gérez les demandes entrantes.")
                ),

                // GROS BOUTON "À TRAITER"
                React.createElement('button', { 
                    onClick: () => { setViewMode('list'); setInternalTab('all'); }, 
                    className: "w-full bg-white/95 backdrop-blur-xl p-8 rounded-[2.5rem] shadow-2xl shadow-blue-200/50 border-2 border-blue-100 hover:scale-[1.02] transition-all duration-300 group relative overflow-hidden flex flex-col items-center justify-center min-h-[280px] hover:shadow-3xl" 
                },
                    // Fond décoratif
                    React.createElement('div', { className: "absolute top-0 right-0 w-64 h-64 bg-blue-50 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob" }),
                    React.createElement('div', { className: "absolute bottom-0 left-0 w-64 h-64 bg-purple-50 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob animation-delay-2000" }),
                    
                    React.createElement('div', { className: "relative z-10 flex flex-col items-center" },
                        React.createElement('div', { className: "relative h-24 w-24 mb-6" },
                            React.createElement('div', { className: "absolute inset-0 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-full blur-xl opacity-50 group-hover:opacity-75 transition-opacity" }),
                            React.createElement('div', { className: "relative h-24 w-24 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-full flex items-center justify-center text-white shadow-2xl group-hover:rotate-12 transition-transform duration-500" },
                                React.createElement(Icon, { name: "zap", size: 48 })
                            )
                        ),
                        
                        React.createElement('h3', { className: "text-3xl font-black text-slate-800" }, "À Traiter"),
                        React.createElement('p', { className: "text-slate-500 font-bold mt-1" }, "Missions & Contrats"),
                        
                        // BADGE POUBELLE DANS LE GROS BOUTON (Si demande de suppression)
                        counts.trashTotal > 0 && React.createElement('div', { className: "mt-3 flex items-center gap-2 text-red-500 bg-red-50 px-3 py-1 rounded-full text-xs font-bold border border-red-100 animate-pulse" },
                            React.createElement(Icon, { name: "trash", size: 14 }),
                            `${counts.trashTotal} demande(s) de suppression`
                        ),

                        // Badge Global
                        counts.todoTotal > 0 ? 
                            React.createElement('div', { className: "mt-6 bg-gradient-to-r from-slate-900 to-slate-800 text-white px-8 py-3.5 rounded-full font-black text-lg shadow-2xl border border-slate-700" },
                                `${counts.todoTotal} Dossiers en attente`
                            ) :
                            React.createElement('div', { className: "mt-6 bg-gradient-to-r from-green-100 to-emerald-100 text-green-700 px-8 py-3.5 rounded-full font-bold text-lg shadow-lg flex items-center gap-2 border border-green-200" },
                                React.createElement(Icon, { name: "check", size: 20 }),
                                "À jour"
                            )
                    )
                ),

                React.createElement('button', { 
                    onClick: () => setViewMode('history'), 
                    className: "mt-8 w-full text-center text-slate-400 font-bold text-sm hover:text-slate-600 transition flex items-center justify-center gap-2" 
                },
                    React.createElement(Icon, { name: "list", size: 16 }), "Voir l'historique complet (Archives)"
                )
            )
        ) : (
            // 2. VUE LISTE AVEC ONGLETS
            React.createElement('div', { className: "animate-in slide-in-from-right-10 fade-in duration-300" },
                
                // HEADER
                React.createElement('div', { className: "sticky top-0 z-30 bg-slate-100/95 backdrop-blur-md px-4 py-4 md:px-8 border-b border-slate-200/50" },
                    React.createElement('div', { className: "flex items-center gap-4 mb-4" },
                        React.createElement('button', { onClick: () => setViewMode('menu'), className: "flex items-center gap-2 px-4 py-2.5 bg-white rounded-xl shadow-sm border border-slate-200 text-slate-700 font-bold text-sm hover:bg-slate-50 transition active:scale-95" },
                            React.createElement(Icon, { name: "menu", size: 18 }), "Retour"
                        ),
                        React.createElement('h2', { className: "text-xl font-black text-slate-900" }, viewMode === 'history' ? "Historique" : internalTab === 'trash' ? "Corbeille" : "À Traiter")
                    ),

                    // BARRE D'ONGLETS + BOUTON POUBELLE
                    viewMode !== 'history' && React.createElement('div', { className: "flex gap-2" },
                        // Onglets principaux
                        React.createElement('div', { className: "flex-1 flex p-1 bg-white rounded-xl border border-slate-200 shadow-sm" },
                            ['all', 'missions', 'contracts'].map(tab => {
                                const isActive = internalTab === tab;
                                const label = tab === 'all' ? 'TOUT' : tab === 'missions' ? 'MISSIONS' : 'CONTRATS';
                                const count = tab === 'all' ? counts.todoTotal : tab === 'missions' ? counts.missions : counts.contracts;
                                
                                return React.createElement('button', {
                                    key: tab,
                                    onClick: () => setInternalTab(tab),
                                    className: `flex-1 py-2.5 rounded-lg text-[10px] md:text-xs font-black transition-all flex items-center justify-center gap-2 ${isActive ? 'bg-slate-900 text-white shadow-md' : 'text-slate-500 hover:bg-slate-50'}`
                                }, 
                                    label,
                                    count > 0 && React.createElement('span', { className: `px-1.5 py-0.5 rounded-full text-[9px] ${isActive ? 'bg-slate-700 text-white' : 'bg-slate-200 text-slate-600'}` }, count)
                                );
                            })
                        ),
                        // BOUTON POUBELLE SÉPARÉ (Rouge)
                        React.createElement('button', {
                            onClick: () => setInternalTab('trash'),
                            className: `px-4 rounded-xl border flex items-center justify-center transition-all ${internalTab === 'trash' ? 'bg-red-600 text-white border-red-600 shadow-lg' : 'bg-white border-slate-200 text-red-500 hover:bg-red-50'}`
                        },
                            React.createElement(Icon, { name: "trash", size: 20 }),
                            counts.trashTotal > 0 && React.createElement('span', { className: "ml-2 bg-white text-red-600 text-[10px] font-bold px-1.5 rounded-full" }, counts.trashTotal)
                        )
                    )
                ),

                // LISTE
                React.createElement('div', { className: "px-4 md:px-8 pt-6 pb-24" },
                    loading ? React.createElement('div', { className: "loader mx-auto mt-10" }) :
                    displayedItems.length === 0 ? React.createElement('div', { className: "text-center py-20 bg-white/95 backdrop-blur-sm rounded-[2rem] border-2 border-dashed border-slate-200 shadow-lg" }, 
                        React.createElement('div', { className: "relative inline-flex mb-4" },
                            React.createElement('div', { className: "absolute inset-0 bg-slate-200 rounded-full blur-xl opacity-50" }),
                            React.createElement(Icon, { name: internalTab === 'trash' ? "trash" : "check", size: 40, className: "relative text-slate-300" })
                        ),
                        React.createElement('p', { className: "text-slate-500 font-bold text-lg" }, internalTab === 'trash' ? "Corbeille vide." : "Rien à traiter.")
                    ) :
                    React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" },
                        displayedItems.map(item => {
                            const isTrash = item.status === 'RequestDelete';
                            const isContract = item.type === 'Contrat';
                            
                            const borderColor = isTrash ? 'border-red-200 bg-red-50/30' : isContract ? 'border-purple-200' : 'border-blue-200';
                            const iconName = isTrash ? 'trash' : isContract ? 'briefcase' : 'zap';
                            const iconColor = isTrash ? 'text-red-600 bg-white shadow-sm' : isContract ? 'text-purple-600 bg-purple-100' : 'text-blue-600 bg-blue-100';

                            return React.createElement('div', { key: item.id, onClick: () => handleOpenItem(item), className: `relative bg-white/95 backdrop-blur-sm p-6 rounded-[2rem] shadow-lg border-2 transition-all duration-300 active:scale-95 hover:shadow-2xl hover:-translate-y-1 cursor-pointer ${borderColor} card-hover` },
                                React.createElement('div', { className: "flex justify-between items-start mb-4" },
                                    React.createElement('div', { className: `h-12 w-12 rounded-2xl flex items-center justify-center ${iconColor}` }, 
                                        React.createElement(Icon, { name: iconName, size: 24 })
                                    ),
                                    !item.adminRead && React.createElement('span', { className: "bg-red-500 text-white text-[10px] font-bold px-2 py-1 rounded-full animate-pulse shadow-red-200 shadow-md" }, "NOUVEAU"),
                                    item.adminRead && React.createElement('span', { className: "text-[9px] font-black text-slate-400 uppercase tracking-widest bg-slate-100 px-2 py-1 rounded" }, item.type)
                                ),
                                React.createElement('h3', { className: "text-lg font-black text-slate-800 leading-tight mb-1 truncate" }, item.companyName || "Sans Nom"),
                                isTrash ? 
                                    React.createElement('p', { className: "text-xs font-bold text-red-500 mb-4 bg-white p-1.5 rounded-lg inline-block border border-red-100" }, "⚠️ Suppression demandée") :
                                    React.createElement('p', { className: "text-xs font-bold text-slate-400 mb-4" }, item.reference || "Réf manquante"),

                                React.createElement('div', { className: "flex items-center gap-2 mb-4" },
                                    React.createElement('div', { className: "h-6 w-6 rounded-full bg-slate-100 flex items-center justify-center text-slate-500" }, React.createElement(Icon, { name: "user", size: 12 })),
                                    React.createElement('p', { className: "text-xs font-bold text-slate-600" }, item.salesRepName || "Commercial inconnu")
                                ),
                                React.createElement('div', { className: "border-t border-slate-100 pt-3 flex justify-between items-center" },
                                    React.createElement('p', { className: "text-[10px] text-slate-400 font-mono" }, new Date(item.createdAt?.seconds * 1000).toLocaleDateString()),
                                    React.createElement('button', { onClick: (e) => handlePreviewPdf(e, item), className: "flex items-center gap-1 bg-slate-100 hover:bg-slate-200 px-3 py-1.5 rounded-lg text-xs font-bold text-slate-700 transition" },
                                        React.createElement(Icon, { name: "fileText", size: 14 }), "PDF"
                                    )
                                )
                            );
                        })
                    )
                )
            )
        ),

        // 3. MODALE DÉTAILS
        selectedItem && React.createElement('div', { className: "fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm animate-in fade-in" },
            React.createElement('div', { className: "bg-white w-full max-w-3xl rounded-[2.5rem] overflow-hidden shadow-2xl flex flex-col max-h-[90vh] animate-in zoom-in-95" },
                
                // Header
                React.createElement('div', { className: "px-8 py-5 border-b bg-white flex justify-between items-center sticky top-0 z-10" },
                    React.createElement('div', null, 
                        React.createElement('p', { className: "text-[10px] font-black text-slate-400 uppercase tracking-widest" }, selectedItem.status === 'RequestDelete' ? "Gestion Suppression" : "Détails Dossier"),
                        React.createElement('h2', { className: "text-xl font-black text-slate-900 truncate max-w-[200px] md:max-w-md" }, selectedItem.companyName)
                    ),
                    React.createElement('button', { onClick: () => setSelectedItem(null), className: "p-3 bg-slate-50 hover:bg-slate-100 rounded-full transition" }, React.createElement(Icon, { name: "x", size: 20 }))
                ),

                // Content
                React.createElement('div', { className: "p-8 overflow-y-auto bg-white custom-scrollbar" },
                    actionStep ? (
                        // ACTION VIEW
                        React.createElement('div', { className: "flex flex-col items-center justify-center h-full py-10" },
                            React.createElement('div', { className: "w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center text-slate-500 mb-4" }, React.createElement(Icon, { name: "message-square", size: 32 })),
                            React.createElement('h4', { className: "text-xl font-black mb-2" }, "Confirmation"),
                            React.createElement('p', { className: "text-slate-400 text-sm mb-6" }, "Message pour le commercial (Optionnel)"),
                            React.createElement('textarea', { className: "w-full p-4 bg-slate-50 rounded-2xl border-2 border-slate-100 mb-6 outline-none focus:border-slate-300 transition font-medium", rows: 3, placeholder: "Votre message...", value: reasonText, onChange: e => setReasonText(e.target.value) }),
                            React.createElement('div', { className: "flex gap-3 w-full" }, 
                                React.createElement('button', { onClick: () => setActionStep(null), className: "flex-1 py-4 bg-white border-2 border-slate-100 rounded-2xl font-bold text-slate-600 hover:bg-slate-50" }, "Retour"), 
                                React.createElement('button', { 
                                    onClick: () => executeAction(actionStep),
                                    className: "flex-1 py-4 bg-gradient-to-r from-slate-900 to-slate-800 text-white rounded-2xl font-bold hover:from-slate-800 hover:to-slate-700 shadow-lg transition-all duration-300 hover:scale-[1.02] active:scale-[0.98] border border-slate-700" 
                                }, "Valider")
                            )
                        )
                    ) : (
                        // DETAILS VIEW
                        React.createElement('div', null,
                            
                            // ALERT SUPPRESSION
                            selectedItem.status === 'RequestDelete' && React.createElement('div', { className: "mb-8 bg-red-50 p-6 rounded-3xl border-2 border-red-100" },
                                React.createElement('div', { className: "flex items-center gap-3 mb-2 text-red-700" },
                                    React.createElement(Icon, { name: "trash", size: 24 }),
                                    React.createElement('h3', { className: "font-black text-lg" }, "Demande de Suppression")
                                ),
                                React.createElement('p', { className: "text-red-900 font-medium italic mb-6 bg-white p-3 rounded-xl border border-red-100" }, `Motif : "${selectedItem.deleteReason || "Non spécifié"}"`),
                                React.createElement('div', { className: "flex gap-3" },
                                    React.createElement('button', { onClick: () => openAction('restore', ''), className: "flex-1 py-3 bg-white border-2 border-slate-200 text-slate-700 font-bold rounded-xl hover:bg-slate-50" }, "Refuser (Restaurer)"),
                                    React.createElement('button', { onClick: () => openAction('delete_permanent', ''), className: "flex-1 py-3 bg-red-600 text-white font-bold rounded-xl shadow-lg hover:bg-red-700 border-2 border-red-600" }, "Accepter (Supprimer)")
                                )
                            ),

                            // INFO BLOCKS
                            React.createElement(DetailBlock, { 
                                title: "🏢 Société", 
                                data: [
                                    { label: "Nom", value: selectedItem.companyName },
                                    { label: "SIRET", value: selectedItem.siren },
                                    { label: "Adresse", value: selectedItem.address },
                                ]
                            }),
                            React.createElement(DetailBlock, { 
                                title: "👤 Contact", 
                                data: [
                                    { label: "Dirigeant", value: `${selectedItem.directorCivility || ''} ${selectedItem.directorFirstName || ''} ${selectedItem.directorLastName || ''}` },
                                    { label: "Email", value: selectedItem.clientEmail || selectedItem.email },
                                    { label: "Tél", value: selectedItem.clientPhone || selectedItem.phone },
                                ]
                            }),
                            selectedItem.type === 'Mission' && React.createElement(DetailBlock, { 
                                title: "🎯 Mission", 
                                data: [
                                    { label: "Dates", value: `${new Date(selectedItem.startDate).toLocaleDateString()} au ${new Date(selectedItem.endDate).toLocaleDateString()}` },
                                    { label: "Obj. RDV", value: selectedItem.targetAppointments },
                                    { label: "Rayon", value: `${selectedItem.radiusKm} km` },
                                    { label: "Véhicules", value: `Min ${selectedItem.minVehicleYear} / Max ${selectedItem.maxKmPerVehicle} km` },
                                    { label: "Exclusions", value: selectedItem.excludedVehicles },
                                    { label: "Tarif", value: `${selectedItem.ratePerAppointment} €` },
                                ]
                            }),
                            selectedItem.type === 'Contrat' && React.createElement(DetailBlock, { 
                                title: "📝 Contrat", 
                                data: [
                                    { label: "Obj. Mensuel", value: selectedItem.targetAppointments },
                                    { label: "Rayon", value: `${selectedItem.radius} km` },
                                    { label: "Critères", value: `Min ${selectedItem.minYear} / Max ${selectedItem.maxKm} km` },
                                ]
                            }),

                            // ACTIONS (Si pas suppression)
                            selectedItem.status !== 'RequestDelete' && (
                                (selectedItem.status === 'Pending' || selectedItem.status === 'ToDraft') ? React.createElement('div', { className: "mt-8 pt-6 border-t border-slate-100 flex flex-col gap-3" },
                                    React.createElement('div', { className: "flex gap-4" },
                                        React.createElement('button', { onClick: () => openAction('refuse', ''), className: "flex-1 py-4 bg-red-50 text-red-600 font-bold rounded-2xl border border-red-100 hover:bg-red-100 transition" }, "Refuser"),
                                        React.createElement('button', { onClick: () => openAction('validate', 'Validé.'), className: "flex-1 py-4 bg-gradient-to-r from-slate-900 to-slate-800 text-white font-bold rounded-2xl shadow-xl hover:from-slate-800 hover:to-slate-700 transition-all duration-300 flex items-center justify-center gap-2 hover:scale-[1.02] active:scale-[0.98] border border-slate-700" }, React.createElement(Icon, { name: "check", size: 20 }), "Valider")
                                    )
                                ) : React.createElement('div', { className: "text-center text-slate-400 font-bold text-sm bg-slate-50 p-4 rounded-xl mt-6" }, "Dossier archivé / traité.")
                            )
                        )
                    )
                )
            )
        ),

        // PDF PREVIEW
        pdfPreviewUrl && React.createElement('div', { className: "fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/90 backdrop-blur-md" },
            React.createElement('div', { className: "bg-white w-full max-w-5xl h-[85vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-in zoom-in-95" },
                React.createElement('div', { className: "px-6 py-4 border-b bg-white flex justify-between items-center" }, 
                    React.createElement('h3', { className: "font-bold text-slate-800" }, "Aperçu PDF"), 
                    React.createElement('button', { onClick: () => setPdfPreviewUrl(null), className: "p-2 bg-slate-100 rounded-full hover:bg-slate-200" }, React.createElement(Icon, { name: "x", size: 20 }))
                ),
                React.createElement('iframe', { src: pdfPreviewUrl, className: "flex-1 w-full h-full border-0 bg-slate-50" })
            )
        )
    );
}
// --- DASHBOARD LAYOUT (ULTIMATE V3 : ZERO SCROLLBAR & FULL DESIGN) ---
function DashboardLayout({ user, userData, globalSettings, db, isAdmin, setView, currentOrder, setCurrentOrder, allSalesReps }) {
    const [currentModule, setCurrentModule] = useState('generator');
    const [showSuccessModal, setShowSuccessModal] = useState(null);
    const [todoCount, setTodoCount] = useState(0);
    const [docCount, setDocCount] = useState(0);
    const [scriptCount, setScriptCount] = useState(0);
    const [notifications, setNotifications] = useState([]);
    const [mobileMenuOpen, setMobileMenuOpen] = useState(false);

    // --- LOGIQUE (Inchangée) ---
    useEffect(() => {
        if (isAdmin) {
            const qOrders = query(collection(db, "orders"), where("status", "==", "Pending"));
            const qContracts = query(collection(db, "contracts"), where("status", "==", "ToDraft"));
            const qDelete = query(collection(db, "orders"), where("status", "==", "RequestDelete"));

            const handleSnap = (snap, type) => {
                Promise.all([getDocs(qOrders), getDocs(qContracts), getDocs(qDelete)]).then(([snapO, snapC, snapD]) => {
                    setTodoCount(snapO.size + snapC.size + snapD.size);
                });
                snap.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const data = change.doc.data();
                        const created = data.createdAt?.seconds ? data.createdAt.seconds * 1000 : Date.now();
                        if (Date.now() - created < 300000) {
                            setNotifications(prev => [...prev, { id: change.doc.id, msg: "Nouvelle activité détectée." }]);
                            setTimeout(() => setNotifications(prev => prev.filter(n => n.id !== change.doc.id)), 6000);
                        }
                    }
                });
            };
            const unsub1 = onSnapshot(qOrders, (s) => handleSnap(s, 'orders'));
            const unsub2 = onSnapshot(qContracts, (s) => handleSnap(s, 'contracts'));
            const unsub3 = onSnapshot(qDelete, (s) => handleSnap(s, 'delete'));
            const qDocsAdmin = query(collection(db, "documents"), where("isNew", "==", true), where("uploadedBy", "==", "User"));
            const unsubDocsAdmin = onSnapshot(qDocsAdmin, (snap) => setDocCount(snap.size));
            return () => { unsub1(); unsub2(); unsub3(); unsubDocsAdmin(); };
        } else {
            const unsubUser = onSnapshot(doc(db, "users", user.uid), (docSnap) => { /* ... */ });
            const qDocsUser = query(collection(db, "documents"), where("isNew", "==", true), where("uploadedBy", "==", "Admin"));
            const unsubDocsUser = onSnapshot(qDocsUser, (snap) => {
                const myUnreadDocs = snap.docs.filter(d => { const data = d.data(); return data.salesRepId === 'All' || data.salesRepId === user.uid; });
                setDocCount(myUnreadDocs.length);
            });
            const qScripts = query(collection(db, "adminScripts"));
            const unsubScripts = onSnapshot(qScripts, (snap) => {
                let count = 0;
                snap.docs.forEach(doc => {
                    const data = doc.data();
                    if (!data.readByUsers || !data.readByUsers.includes(user.uid)) { count++; }
                });
                setScriptCount(count);
            });
            return () => { unsubUser(); unsubDocsUser(); unsubScripts(); };
        }
    }, [isAdmin, db, user.uid, userData?.totalEarnings]);

    const allMenuItems = [
        { id: 'generator', label: 'Générateur', icon: 'layout' },
        { id: 'contractGenerator', label: 'Contrat Collab.', icon: 'briefcase' },
        { id: 'myOrders', label: 'Mes Demandes', icon: 'list' },
        { id: 'wallet', label: 'Porte-monnaie', icon: 'wallet' },
        { id: 'documents', label: 'Documents', icon: 'folder', badge: docCount > 0 ? docCount : null },
        { id: 'quickNotes', label: 'Prise de Note', icon: 'zap' },
        { id: 'scripts', label: 'Scripts d\'appel', icon: 'fileText', badge: (!isAdmin && scriptCount > 0) ? scriptCount : null },
    ];

    if (isAdmin) allMenuItems.push({ id: 'adminTodo', label: 'Affaires', icon: 'clipboardCheck', badge: todoCount > 0 ? todoCount : null });
    allMenuItems.push({ id: 'profile', label: 'Mon Profil', icon: 'users' });

    const getRoleLabel = (role) => { if (role === 'admin') return 'ADMINISTRATEUR'; if (role === 'intern') return 'STAGIAIRE'; return 'COMMERCIAL'; };
    
    const renderModule = () => {
        switch(currentModule) {
            case 'generator': return React.createElement(FormPanel, { user, userData, globalSettings, db, isAdmin, setCurrentModule, currentOrder, setCurrentOrder, setShowSuccessModal });
            case 'contractGenerator': return React.createElement(ContractGeneratorModule, { user, userData, db, currentOrder });
            case 'quickNotes': return React.createElement(QuickNotesModule, { user, db, setCurrentModule, setCurrentOrder });
            case 'myOrders': return React.createElement(MyOrdersModule, { user, userData, db, globalSettings, setCurrentModule, setCurrentOrder, isAdmin, allSalesReps });
            case 'scripts': return React.createElement(ScriptsModule, { user, db, isAdmin, allSalesReps });
            case 'documents': return React.createElement(DocumentsModule, { user, db, isAdmin, allSalesReps, globalSettings });
            case 'wallet': return React.createElement(WalletModule, { user, userData, db, isAdmin });
            case 'adminTodo': return React.createElement(AdminTodoModule, { user, db, setCurrentModule, setCurrentOrder, globalSettings, userData });
            case 'profile': return React.createElement(CommercialProfileModule, { user, userData, db });
            default: return React.createElement(FormPanel, { user, userData, globalSettings, db, isAdmin, setCurrentModule, currentOrder, setCurrentOrder, setShowSuccessModal });
        }
    };

    const handleMenuClick = (moduleId) => { setCurrentModule(moduleId); setMobileMenuOpen(false); };

    // STYLE CSS POUR CACHER LA SCROLLBAR
    const hideScrollbarStyles = `
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    `;

    // --- DESIGN UI ---
    return React.createElement('div', { className: "h-full w-full bg-[#f8fafc] flex flex-col md:flex-row relative overflow-hidden font-sans text-slate-800" },
        // Injection du style invisible
        React.createElement('style', null, hideScrollbarStyles),

        // SIDEBAR
        React.createElement('aside', { className: `fixed inset-y-0 left-0 z-50 w-64 bg-gradient-to-b from-[#0B1120] via-[#1e293b] to-[#0B1120] text-slate-300 flex flex-col transform transition-transform duration-500 cubic-bezier(0.4, 0, 0.2, 1) border-r border-slate-800/60 shadow-2xl md:translate-x-0 md:static ${mobileMenuOpen ? 'translate-x-0' : '-translate-x-full'}` },
            
            // Background Glow
            React.createElement('div', { className: "absolute top-0 left-0 w-64 h-64 bg-blue-600/20 blur-[100px] pointer-events-none animate-pulse" }),
            React.createElement('div', { className: "absolute bottom-0 right-0 w-64 h-64 bg-purple-600/10 blur-[100px] pointer-events-none" }),

            // 1. HEADER PROFIL
            React.createElement('div', { className: "relative p-6 flex flex-col items-center text-center z-10 border-b border-white/5" },
                userData?.photoURL ? 
                    React.createElement('div', { className: "relative group mb-3" },
                        React.createElement('div', { className: "absolute -inset-0.5 bg-gradient-to-tr from-blue-500 to-cyan-400 rounded-full opacity-60 blur-sm group-hover:opacity-100 transition duration-500" }),
                        React.createElement('img', { src: userData.photoURL, className: "relative h-16 w-16 rounded-full object-cover border-2 border-[#0B1120]" })
                    ) : 
                    React.createElement('div', { className: "relative h-16 w-16 rounded-full bg-slate-800/80 border border-slate-700/50 flex items-center justify-center text-slate-400 mb-3 shadow-inner backdrop-blur-sm" }, React.createElement(Icon, { name: "users", size: 28 })),
                
                React.createElement('h1', { className: "font-bold text-lg tracking-tight text-white truncate w-full" }, userData?.name || "Utilisateur"),
                React.createElement('div', { className: "mt-1.5 inline-flex items-center px-2.5 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-widest bg-white/5 text-blue-400 border border-white/5" }, getRoleLabel(userData?.role)),
                
                !isAdmin && React.createElement('div', { className: "mt-5 w-full bg-gradient-to-r from-emerald-600/20 to-teal-600/20 rounded-xl border border-emerald-500/30 p-3 flex items-center justify-between shadow-xl backdrop-blur-sm" }, 
                    React.createElement('span', { className: "text-xs font-bold text-emerald-300 pl-1 uppercase tracking-wider" }, "Gains"),
                    React.createElement('div', { className: "flex items-center gap-2" },
                        React.createElement(Icon, { name: "dollar", size: 16, className: "text-emerald-400" }),
                        React.createElement('p', { className: "text-lg font-black text-white tracking-wide" }, `${userData?.totalEarnings || 0} €`)
                    )
                )
            ),
            
            // 2. MENU NAVIGATION (SCROLLBAR CACHÉE ICI)
            React.createElement('nav', { className: "flex-1 px-4 py-4 space-y-2 overflow-y-auto scrollbar-hide z-10" },
                allMenuItems.map(item => {
                    const isActive = currentModule === item.id;
                    return React.createElement('button', { 
                        key: item.id, 
                        onClick: () => handleMenuClick(item.id), 
                        className: `w-full relative group flex items-center gap-3 px-3.5 py-3 rounded-xl transition-all duration-300 overflow-hidden ${
                            isActive 
                            ? 'shadow-[0_0_25px_rgba(59,130,246,0.15)]'
                            : 'hover:bg-white/[0.03]'
                        }`
                    }, 
                        isActive ? React.createElement('div', { className: "absolute inset-0 bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600 opacity-100 transition-opacity" }) : null,
                        isActive ? React.createElement('div', { className: "absolute inset-0 bg-gradient-to-r from-transparent via-white/5 to-transparent animate-shimmer" }) : null,
                        !isActive && React.createElement('div', { className: "absolute left-0 bottom-0 top-0 w-1 bg-gradient-to-b from-blue-500 to-purple-500 rounded-r-full transform -translate-x-full group-hover:translate-x-0 transition-transform duration-300" }),

                        React.createElement('div', { className: `relative z-10 flex items-center justify-center p-1.5 rounded-lg transition-all duration-300 ${
                            isActive 
                            ? 'bg-white/20 text-white shadow-lg ring-2 ring-white/20'
                            : 'bg-slate-800/50 text-slate-400 group-hover:text-blue-400 group-hover:bg-slate-800/70 group-hover:scale-110'
                        }`}, 
                            React.createElement(Icon, { name: item.icon, size: 18 })
                        ),

                        React.createElement('span', { className: `relative z-10 text-sm font-medium tracking-wide transition-colors duration-300 ${
                            isActive 
                            ? 'text-white' 
                            : 'text-slate-400 group-hover:text-slate-200'
                        }` }, item.label), 
                        
                        item.badge && React.createElement('span', { className: "absolute right-3 top-1/2 -translate-y-1/2 bg-gradient-to-r from-rose-500 to-pink-600 text-white text-[10px] font-bold h-5 w-5 flex items-center justify-center rounded-full shadow-xl border border-rose-400 animate-pulse z-10 ring-2 ring-rose-300/50" }, item.badge),

                        isActive && React.createElement('div', { className: "absolute top-0 right-0 w-24 h-full bg-gradient-to-l from-white/10 to-transparent skew-x-12" })
                    );
                }),

                React.createElement('div', { className: "my-4 mx-2 border-t border-slate-800/80" }),

                isAdmin && React.createElement('button', { 
                    onClick: () => { setView('admin', 'orders'); setMobileMenuOpen(false); }, 
                    className: "w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:text-amber-400 hover:bg-gradient-to-r hover:from-amber-500/10 hover:to-yellow-500/10 transition-all duration-300 text-sm font-medium group border border-transparent hover:border-amber-500/30 hover:shadow-lg hover:scale-[1.02]" 
                }, 
                    React.createElement(Icon, { name: "settings", size: 18, className: "group-hover:rotate-90 transition-transform duration-500" }), 
                    "Administration"
                ),

                React.createElement('button', { 
                    onClick: () => signOut(auth), 
                    className: "w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:text-red-400 hover:bg-gradient-to-r hover:from-red-500/10 hover:to-rose-500/10 transition-all duration-300 text-sm font-medium group border border-transparent hover:border-red-500/30 hover:shadow-lg hover:scale-[1.02]" 
                }, 
                    React.createElement(Icon, { name: "power", size: 18, className: "group-hover:translate-x-1 group-hover:rotate-12 transition-all duration-300" }), 
                    "Déconnexion"
                )
            )
        ),
        
        mobileMenuOpen && React.createElement('div', { className: "fixed inset-0 bg-[#0B1120]/80 backdrop-blur-sm z-40 md:hidden transition-opacity duration-300", onClick: () => setMobileMenuOpen(false) }),
        
        // CONTENU PRINCIPAL (SCROLLBAR CACHÉE ICI AUSSI)
        React.createElement('div', { className: "flex-1 flex flex-col h-screen overflow-hidden bg-[#F1F5F9]" },
            React.createElement('header', { className: "md:hidden bg-white/80 backdrop-blur-md border-b border-slate-200 p-4 flex justify-between items-center sticky top-0 z-40 shadow-sm" },
                React.createElement('button', { onClick: () => setMobileMenuOpen(true), className: "text-slate-700 p-2 -ml-2 rounded-lg active:scale-95 transition-transform" }, React.createElement(Icon, { name: "menu", size: 28 }), (todoCount > 0 || docCount > 0 || scriptCount > 0) && React.createElement('span', { className: "absolute top-2 right-2 h-3 w-3 bg-rose-500 rounded-full border-2 border-white animate-pulse" })),
                React.createElement('div', { className: "flex items-center gap-3" }, userData?.photoURL ? React.createElement('img', { src: userData.photoURL, className: "h-9 w-9 rounded-full object-cover ring-2 ring-white shadow-md" }) : React.createElement('div', { className: "h-9 w-9 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 ring-2 ring-white shadow-sm" }, React.createElement(Icon, { name: "users", size: 16 })), React.createElement('div', { className: "text-right" }, React.createElement('h1', { className: "font-bold text-slate-800 text-xs leading-tight" }, userData?.name || "User"), !isAdmin && React.createElement('p', { className: "text-[10px] text-emerald-600 font-bold bg-emerald-50 px-1.5 rounded-full mt-0.5 inline-block" }, `${userData?.totalEarnings || 0} €`)))
            ),
            React.createElement('main', { className: "flex-1 overflow-y-auto scrollbar-hide p-4 md:p-8 relative scroll-smooth" }, 
                React.createElement('div', { className: "fixed top-0 right-0 -z-10 w-[600px] h-[600px] bg-blue-100/50 rounded-full blur-[120px] pointer-events-none" }),
                
                renderModule(), 
                
                notifications.map((n, i) => React.createElement('div', { 
                    key: n.id, 
                    className: `fixed top-24 right-4 md:right-8 ${n.type === 'error' ? 'bg-white border-l-4 border-red-500 text-slate-800' : n.type === 'money' ? 'bg-white border-l-4 border-amber-400 text-slate-800' : 'bg-[#0F172A] border-l-4 border-blue-500 text-white'} px-5 py-4 rounded-xl shadow-[0_8px_30px_rgba(0,0,0,0.12)] z-[100] animate-in slide-in-from-right fade-in backdrop-blur-md flex items-center gap-4 min-w-[320px] transition-all duration-300 hover:-translate-y-1`, 
                    style: { marginTop: `${i * 85}px` } 
                }, 
                    React.createElement('div', { className: `p-2.5 rounded-full flex-shrink-0 ${n.type === 'error' ? 'bg-red-50 text-red-600' : n.type === 'money' ? 'bg-amber-50 text-amber-600' : 'bg-blue-500/20 text-blue-400'}` }, React.createElement(Icon, { name: n.type === 'money' ? "dollar" : n.type === 'error' ? "x" : "bell", size: 20 })), 
                    React.createElement('div', null, React.createElement('p', { className: "font-bold text-sm tracking-wide" }, n.type === 'money' ? "Gains !" : n.type === 'info' ? "Document" : "Information"), React.createElement('p', { className: `text-xs mt-0.5 ${n.type === 'error' || n.type === 'money' ? 'text-slate-500' : 'text-slate-400'}` }, n.msg))
                ))
            ),
            React.createElement(SuccessModal, { isOpen: !!showSuccessModal, onClose: () => setShowSuccessModal(null), reference: showSuccessModal?.reference, isEditing: showSuccessModal?.isEditing })
        )
    );
}
 // --- MODULE PORTE-MONNAIE (CORRIGÉ : GESTION ADMIN & HISTORIQUE COMPLET) ---
function WalletModule({ user, userData, db, isAdmin }) {
    const [history, setHistory] = useState([]);
    const [usersList, setUsersList] = useState([]);
    const [globalSettings, setGlobalSettings] = useState({ pilotMissionAmount: 0, contractAmount: 0 });
    
    // États pour la Modal d'Ajustement (Admin)
    const [adjustingUser, setAdjustingUser] = useState(null);
    const [adjustAmount, setAdjustAmount] = useState('');
    const [adjustReason, setAdjustReason] = useState(''); // Nouveau : Motif
    const [adjustType, setAdjustType] = useState('add'); 
    const [processing, setProcessing] = useState(false);

    // Filtres de date (Commercial)
    const today = new Date();
    const [selectedYear, setSelectedYear] = useState(today.getFullYear());
    const [selectedMonth, setSelectedMonth] = useState(today.getMonth());

    useEffect(() => {
        // 1. Charger les réglages globaux
        const unsubSettings = onSnapshot(doc(db, "settings", "global"), (snap) => {
            if(snap.exists()) setGlobalSettings(prev => ({...prev, ...snap.data()}));
        });

        if (isAdmin) {
            // MODE ADMIN : Liste des utilisateurs
            const qUsers = query(collection(db, "users"), where("role", "!=", "admin"));
            const unsubUsers = onSnapshot(qUsers, (snap) => {
                setUsersList(snap.docs.map(d => ({id:d.id, ...d.data()})));
            });
            return () => { unsubSettings(); unsubUsers(); };
        } else {
            // MODE COMMERCIAL : Écouter TOUT l'historique (Missions + Ajustements)
            
            // A. Missions/Contrats Validés
            const qOrders = query(collection(db, "orders"), where("salesRepId", "==", user.uid), where("status", "in", ["Envoyé", "Signed"]));
            const qContracts = query(collection(db, "contracts"), where("salesRepId", "==", user.uid), where("status", "in", ["Signed", "Drafted"]));
            
            // B. Ajustements Manuels (Admin)
            const qAdjustments = query(collection(db, "walletAdjustments"), where("userId", "==", user.uid));

            // Fonction de fusion
            const handleUpdates = (ordersSnap, contractsSnap, adjSnap) => {
                const missions = ordersSnap.docs.map(d => ({
                    id: d.id, type: 'Mission Pilote', 
                    amount: d.data().ratePerAppointment || globalSettings.pilotMissionAmount || 0,
                    date: d.data().validatedAt || d.data().createdAt,
                    isPositive: true,
                    details: d.data().companyName
                }));

                const contrats = contractsSnap.docs.map(d => ({
                    id: d.id, type: 'Contrat Cadre', 
                    amount: globalSettings.contractAmount || 0,
                    date: d.data().validatedAt || d.data().createdAt,
                    isPositive: true,
                    details: d.data().companyName
                }));

                const ajustements = adjSnap.docs.map(d => ({
                    id: d.id, type: 'Ajustement Admin',
                    amount: Math.abs(d.data().amount), // On stocke la valeur absolue pour l'affichage
                    isPositive: d.data().amount >= 0,
                    date: d.data().date,
                    details: d.data().reason || "Régularisation"
                }));

                const allItems = [...missions, ...contrats, ...ajustements];
                setHistory(allItems.sort((a,b) => (b.date?.seconds || 0) - (a.date?.seconds || 0)));
            };

            let snapO = { docs: [] }, snapC = { docs: [] }, snapA = { docs: [] };

            const unsubO = onSnapshot(qOrders, (s) => { snapO = s; handleUpdates(snapO, snapC, snapA); });
            const unsubC = onSnapshot(qContracts, (s) => { snapC = s; handleUpdates(snapO, snapC, snapA); });
            const unsubA = onSnapshot(qAdjustments, (s) => { snapA = s; handleUpdates(snapO, snapC, snapA); });

            return () => { unsubSettings(); unsubO(); unsubC(); unsubA(); };
        }
    }, [user.uid, isAdmin, globalSettings.pilotMissionAmount, globalSettings.contractAmount]);

    // --- ACTIONS ADMIN ---
    const handleSaveAdjustment = async () => {
        if (!adjustAmount || isNaN(adjustAmount) || parseFloat(adjustAmount) <= 0) return alert("Montant invalide.");
        if (!adjustReason.trim()) return alert("Le motif est obligatoire.");

        setProcessing(true);
        try {
            const value = parseFloat(adjustAmount);
            const finalValue = adjustType === 'add' ? value : -value;
            
            const batch = writeBatch(db);
            
            // 1. Mise à jour du solde utilisateur
            const userRef = doc(db, "users", adjustingUser.id);
            batch.update(userRef, { totalEarnings: increment(finalValue) });

            // 2. Création de l'enregistrement d'historique (pour que le commercial le voie)
            const adjRef = doc(collection(db, "walletAdjustments"));
            batch.set(adjRef, {
                userId: adjustingUser.id,
                amount: finalValue,
                reason: adjustReason,
                date: new Date(),
                adminId: user.uid
            });

            await batch.commit();
            
            setAdjustingUser(null); setAdjustAmount(''); setAdjustReason('');
            alert("Solde mis à jour !");
        } catch (e) { alert(e.message); }
        setProcessing(false);
    };

    // --- LOGIQUE FILTRAGE (Commercial) ---
    const getFilteredHistory = () => {
        return history.filter(item => {
            if(!item.date) return false;
            const d = new Date(item.date.seconds * 1000);
            return d.getMonth() === selectedMonth && d.getFullYear() === parseInt(selectedYear);
        });
    };

    const currentMonthHistory = getFilteredHistory();
    const months = ["Janvier", "Février", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"];
    const years = [2024, 2025, 2026];

    const AdjustingUserAvatar = (u) => (
        u.photoURL ?
        React.createElement('img', { src: u.photoURL, className: "h-20 w-20 mx-auto rounded-full object-cover border-4 border-slate-50 shadow-lg" }) :
        React.createElement('div', { className: "h-20 w-20 mx-auto rounded-full bg-slate-100 flex items-center justify-center text-slate-500 font-bold text-3xl border-4 border-slate-50 shadow-lg" }, u.name ? u.name[0].toUpperCase() : "?")
    );

    // --- RENDER ADMIN ---
    if (isAdmin) {
        return React.createElement('div', { className: "max-w-6xl mx-auto space-y-8" },
            React.createElement('div', { className: "flex items-center gap-3 mb-6" },
                React.createElement('div', { className: "p-3 bg-slate-900 rounded-xl text-white" }, React.createElement(Icon, { name: "wallet", size: 28 })),
                React.createElement('div', null,
                    React.createElement('h2', { className: "text-2xl font-bold text-slate-800" }, "Gestion des Portefeuilles"),
                    React.createElement('p', { className: "text-slate-500 text-sm" }, "Gérez les soldes et ajoutez des régularisations.")
                )
            ),
            
            React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" },
                usersList.map(u => 
                    React.createElement('div', { key: u.id, className: "bg-white p-6 rounded-2xl shadow-sm border border-slate-200 hover:shadow-md transition flex flex-col justify-between" },
                        React.createElement('div', null,
                            React.createElement('div', { className: "flex justify-between items-start mb-4" },
                                u.photoURL ? React.createElement('img', { src: u.photoURL, className: "h-12 w-12 rounded-full object-cover border border-slate-200 shadow-sm" }) :
                                React.createElement('div', { className: "h-12 w-12 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 font-bold text-lg border border-slate-200 shadow-sm" }, u.name ? u.name[0].toUpperCase() : "?"),
                                React.createElement('span', { className: "bg-green-50 text-green-700 px-3 py-1 rounded-full text-xs font-bold" }, "ACTIF")
                            ),
                            React.createElement('h3', { className: "font-bold text-lg text-slate-800" }, u.name),
                            React.createElement('p', { className: "text-sm text-slate-400 mb-6 truncate" }, u.email),
                        ),
                        React.createElement('div', { className: "pt-4 border-t border-slate-50" },
                            React.createElement('p', { className: "text-xs font-bold text-slate-400 uppercase mb-1" }, "Solde Actuel"),
                            React.createElement('div', { className: "flex justify-between items-center" },
                                React.createElement('span', { className: "text-3xl font-bold text-slate-800" }, `${u.totalEarnings || 0} €`),
                                React.createElement('button', { 
                                    onClick: () => { setAdjustingUser(u); setAdjustAmount(''); setAdjustReason(''); setAdjustType('add'); },
                                    className: "bg-slate-900 text-white px-4 py-2 rounded-lg hover:bg-slate-700 transition text-sm font-bold flex items-center gap-2"
                                }, React.createElement(Icon, { name: "edit", size: 14 }), "Gérer")
                            )
                        )
                    )
                )
            ),

            // Modal Ajustement
            adjustingUser && React.createElement('div', { className: "fixed inset-0 z-[200] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm" },
                React.createElement('div', { className: "bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 animate-in zoom-in-95" },
                    React.createElement('div', { className: "flex justify-between items-center mb-6" },
                        React.createElement('h3', { className: "text-xl font-bold text-slate-800" }, "Ajuster le Solde"),
                        React.createElement('button', { onClick: () => setAdjustingUser(null), className: "p-2 bg-slate-100 rounded-full hover:bg-slate-200" }, React.createElement(Icon, { name: "x", size: 20 }))
                    ),
                    React.createElement('div', { className: "mb-6 text-center" },
                        AdjustingUserAvatar(adjustingUser),
                        React.createElement('p', { className: "text-sm text-slate-500 mb-1 mt-2" }, `Commercial : ${adjustingUser.name}`),
                        React.createElement('p', { className: "text-3xl font-bold text-slate-800" }, `${adjustingUser.totalEarnings || 0} €`)
                    ),
                    
                    // Choix Type (Ajout / Retrait)
                    React.createElement('div', { className: "bg-slate-50 p-1 rounded-xl flex mb-4" },
                        React.createElement('button', { onClick: () => setAdjustType('add'), className: `flex-1 py-2 rounded-lg text-sm font-bold transition flex items-center justify-center gap-2 ${adjustType === 'add' ? 'bg-white shadow text-green-600' : 'text-slate-400'}` }, React.createElement(Icon, { name: "smile", size: 16 }), "Ajouter (+Val)"),
                        React.createElement('button', { onClick: () => setAdjustType('remove'), className: `flex-1 py-2 rounded-lg text-sm font-bold transition flex items-center justify-center gap-2 ${adjustType === 'remove' ? 'bg-white shadow text-red-600' : 'text-slate-400'}` }, React.createElement(Icon, { name: "trash", size: 16 }), "Retirer (-Dette)")
                    ),

                    // Champs Montant & Motif
                    React.createElement('div', { className: "space-y-4 mb-6" },
                        React.createElement('div', null,
                            React.createElement('label', { className: "block text-xs font-bold text-slate-500 mb-2" }, "Montant (€)"),
                            React.createElement('input', { type: "number", autoFocus: true, value: adjustAmount, onChange: e => setAdjustAmount(e.target.value), placeholder: "Ex: 50", className: "w-full p-4 text-2xl font-bold text-center border border-slate-300 rounded-xl focus:ring-2 focus:ring-slate-900 outline-none" })
                        ),
                        React.createElement('div', null,
                            React.createElement('label', { className: "block text-xs font-bold text-slate-500 mb-2" }, "Motif (Obligatoire)"),
                            React.createElement('input', { type: "text", value: adjustReason, onChange: e => setAdjustReason(e.target.value), placeholder: "Ex: Avance sur commission, Prime...", className: "w-full p-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-slate-900 outline-none text-sm" })
                        )
                    ),

                    React.createElement('button', { onClick: handleSaveAdjustment, disabled: processing, className: `w-full py-4 rounded-xl text-white font-bold text-lg shadow-lg transition flex items-center justify-center gap-2 ${adjustType === 'add' ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'} ${processing ? 'opacity-70 cursor-wait' : ''}` }, processing ? "Sauvegarde..." : (adjustType === 'add' ? "Créditer le compte" : "Débiter le compte"))
                )
            )
        );
    }

    // --- RENDER COMMERCIAL ---
    return React.createElement('div', { className: "max-w-4xl mx-auto space-y-8" },
        React.createElement('div', { className: "flex flex-col md:flex-row justify-between items-center gap-4" },
            React.createElement('h2', { className: "text-2xl font-bold text-slate-800 flex items-center gap-3" }, 
                React.createElement('div', { className: "bg-yellow-500 p-2 rounded-lg text-white" }, React.createElement(Icon, { name: "wallet", size: 24 })),
                "Mon Porte-monnaie"
            ),
            React.createElement('div', { className: "flex gap-2 bg-white p-1 rounded-xl shadow-sm border border-slate-200" },
                React.createElement('select', { value: selectedMonth, onChange: (e) => setSelectedMonth(parseInt(e.target.value)), className: "bg-transparent font-bold text-slate-700 outline-none cursor-pointer py-2 px-3 hover:bg-slate-50 rounded-lg" }, months.map((m, i) => i <= today.getMonth() || selectedYear < today.getFullYear() ? React.createElement('option', { key: i, value: i }, m) : null)),
                React.createElement('select', { value: selectedYear, onChange: (e) => setSelectedYear(parseInt(e.target.value)), className: "bg-transparent font-bold text-slate-700 outline-none cursor-pointer py-2 px-3 hover:bg-slate-50 rounded-lg" }, years.map(y => y <= today.getFullYear() ? React.createElement('option', { key: y, value: y }, y) : null))
            )
        ),

        // Carte Solde Total
        React.createElement('div', { className: "relative overflow-hidden bg-gradient-to-br from-slate-900 to-slate-800 rounded-3xl p-8 shadow-2xl text-white transition-all duration-500" },
            React.createElement('div', { className: "absolute top-0 right-0 p-8 opacity-10" }, React.createElement(Icon, { name: "dollar", size: 120 })),
            React.createElement('p', { className: "text-slate-400 font-bold uppercase tracking-widest text-xs mb-2" }, "SOLDE TOTAL DISPONIBLE"),
            React.createElement('div', { className: "text-6xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-200 to-yellow-500 animate-in fade-in zoom-in duration-500" }, `${userData?.totalEarnings || 0} €`),
            React.createElement('div', { className: "mt-6 flex gap-4 text-sm text-slate-300" },
                React.createElement('span', { className: "flex items-center gap-1" }, React.createElement(Icon, { name: "check", size: 14 }), "Mise à jour temps réel"),
                React.createElement('span', { className: "flex items-center gap-1" }, React.createElement(Icon, { name: "calendar", size: 14 }), `Historique : ${months[selectedMonth]} ${selectedYear}`)
            )
        ),

        // Liste Historique
        React.createElement('div', { className: "animate-in slide-in-from-bottom-4 duration-500" },
            React.createElement('h3', { className: "font-bold text-lg text-slate-700 mb-4 ml-2" }, `Opérations de ${months[selectedMonth]}`),
            currentMonthHistory.length === 0 ? React.createElement('div', { className: "text-center py-12 bg-white rounded-2xl border border-dashed border-slate-200" }, React.createElement('p', { className: "text-slate-400" }, `Aucune opération ce mois-ci.`)) : 
            React.createElement('div', { className: "space-y-3" },
                currentMonthHistory.map((item, i) => {
                    const isMission = item.type === 'Mission Pilote';
                    const isAdjust = item.type === 'Ajustement Admin';
                    const iconColor = isAdjust ? (item.isPositive ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600') : (isMission ? 'bg-blue-50 text-blue-600' : 'bg-purple-50 text-purple-600');
                    const iconName = isAdjust ? (item.isPositive ? 'smile' : 'logOut') : (isMission ? 'zap' : 'briefcase');

                    return React.createElement('div', { key: item.id || i, className: "bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex items-center justify-between hover:shadow-md transition" },
                        React.createElement('div', { className: "flex items-center gap-4" },
                            React.createElement('div', { className: `h-12 w-12 rounded-full flex items-center justify-center ${iconColor}` }, React.createElement(Icon, { name: iconName, size: 20 })),
                            React.createElement('div', null,
                                React.createElement('p', { className: "font-bold text-slate-800" }, item.details),
                                React.createElement('p', { className: "text-xs text-slate-500" }, `${item.type} • ${new Date(item.date.seconds * 1000).toLocaleDateString()}`)
                            )
                        ),
                        React.createElement('div', { className: "text-right" },
                            React.createElement('p', { className: `font-bold text-lg ${item.isPositive ? 'text-green-600' : 'text-red-600'}` }, `${item.isPositive ? '+' : '-'} ${item.amount} €`),
                            isAdjust && React.createElement('span', { className: "text-[10px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full font-bold" }, "MANUEL")
                        )
                    );
                })
            )
        )
    );
}
        
        // Petite fonction utilitaire pour l'avatar dans la modal
        function AdjustingUserAvatar(u) {
             return u.photoURL ?
                React.createElement('img', { src: u.photoURL, className: "h-20 w-20 mx-auto rounded-full object-cover border-2 border-white shadow-md" }) :
                React.createElement('div', { className: "h-20 w-20 mx-auto rounded-full bg-slate-100 flex items-center justify-center text-slate-500 font-bold text-3xl border-2 border-white shadow-md" },
                    u.name ? u.name[0].toUpperCase() : "?"
                );
        }
// --- MODULE DOCUMENTS (CORRIGÉ : BOUTON FILTRE PROPRE) ---
function DocumentsModule({ user, db, isAdmin, allSalesReps, globalSettings }) {
    const [documents, setDocuments] = useState([]);
    const [filterRep, setFilterRep] = useState('All');
    const [isUploading, setIsUploading] = useState(false);
    const [filterType, setFilterType] = useState('All'); 
    const [uploadMode, setUploadMode] = useState('file'); 
    const [editingDoc, setEditingDoc] = useState(null); 
    const [readingNote, setReadingNote] = useState(null); 
    const [previewDoc, setPreviewDoc] = useState(null);   
    const [newName, setNewName] = useState("");
    const [replyText, setReplyText] = useState("");
    const [isReplying, setIsReplying] = useState(false);
    const [newDocFile, setNewDocFile] = useState(null);
    const [noteContent, setNoteContent] = useState(""); 
    const [targetRepId, setTargetRepId] = useState(isAdmin ? "" : user.uid);
    const [docType, setDocType] = useState("Info");
    const [customType, setCustomType] = useState("");
    
    // NOUVEAU : État pour afficher/masquer le menu filtre
    const [showFilters, setShowFilters] = useState(false);

    useEffect(() => {
        let qMain = collection(db, "documents");
        if (!isAdmin) qMain = query(qMain, limit(50)); 
        const unsubMain = onSnapshot(qMain, (snap) => {
            const mainDocs = snap.docs.map(d => {
                const data = d.data();
                return { id: d.id, ...data, sourceCol: 'documents', isMine: data.uploadedBy === (isAdmin ? 'Admin' : 'User') && (isAdmin || data.salesRepId === user.uid) };
            });
            updateList('main', mainDocs);
        });
        let qUserDocs = collection(db, "userDocs");
        if (!isAdmin) qUserDocs = query(qUserDocs, where("userId", "==", user.uid));
        const unsubUserDocs = onSnapshot(qUserDocs, (snap) => {
            const uDocs = snap.docs.map(d => {
                const data = d.data();
                return { id: d.id, name: data.fileName || "Sans nom", url: data.fileData, type: (data.fileName || "").split('.').pop().toUpperCase(), category: data.type || "Autre", salesRepId: data.userId, uploadedBy: 'User', senderName: data.salesRepName, createdAt: data.createdAt, sourceCol: 'userDocs', isMine: data.userId === user.uid };
            });
            updateList('userDocs', uDocs);
        });
        const qScripts = query(collection(db, "adminScripts"));
        const unsubScripts = onSnapshot(qScripts, (snap) => {
            const sDocs = snap.docs.map(d => {
                const data = d.data();
                if (!isAdmin && data.visibleTo && data.visibleTo !== 'All' && data.visibleTo !== user.uid) return null;
                return { id: d.id, name: data.title || "Document", url: data.fileData, type: "PDF", category: data.category || "General", salesRepId: 'All', uploadedBy: 'Admin', createdAt: data.createdAt, sourceCol: 'adminScripts', isMine: isAdmin };
            }).filter(Boolean);
            updateList('adminScripts', sDocs);
        });
        const docMap = { main: [], userDocs: [], adminScripts: [] };
        const updateList = (key, list) => {
            docMap[key] = list;
            let all = [...docMap.main, ...docMap.userDocs, ...docMap.adminScripts];
            if (!isAdmin) all = all.filter(d => d.isMine || d.salesRepId === user.uid || d.salesRepId === 'All');
            else if (filterRep !== 'All') all = all.filter(d => d.salesRepId === filterRep);
            setDocuments(all.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)));
        };
        return () => { unsubMain(); unsubUserDocs(); unsubScripts(); };
    }, [db, isAdmin, user.uid, filterRep]);

    const getDocCategory = (type) => {
        const t = (type || "").toUpperCase();
        if (t === 'NOTE') return 'Message';
        if (['JPG', 'PNG', 'JPEG', 'GIF', 'WEBP'].includes(t)) return 'Image';
        if (['PDF'].includes(t)) return 'PDF';
        return 'Autre';
    };
    const filteredDocuments = documents.filter(doc => {
        if (filterType === 'All') return true;
        return getDocCategory(doc.type) === filterType;
    });

    const handleSend = async (e) => {
        e.preventDefault();
        let finalTitle = docType === 'Autre' ? customType.trim() : docType;
        if (!finalTitle) return alert("Précisez le type.");
        setIsUploading(true);
        try {
            const docData = { category: finalTitle, salesRepId: targetRepId || 'All', uploadedBy: isAdmin ? 'Admin' : 'User', senderName: user.email, isNew: true, createdAt: new Date() };
            if (uploadMode === 'file') {
                if (!newDocFile) throw new Error("Fichier manquant.");
                const reader = new FileReader();
                reader.onloadend = async () => {
                    await addDoc(collection(db, "documents"), { ...docData, name: newDocFile.name, url: reader.result, type: newDocFile.name.split('.').pop().toUpperCase() });
                    finalizeSend();
                };
                reader.readAsDataURL(newDocFile);
            } else {
                if (!noteContent.trim()) throw new Error("Message vide.");
                await addDoc(collection(db, "documents"), { ...docData, name: finalTitle + " (Message)", textContent: noteContent, type: 'NOTE', url: null });
                finalizeSend();
            }
        } catch (e) { alert("Erreur: " + e.message); setIsUploading(false); }
    };
    const finalizeSend = () => { setNewDocFile(null); setNoteContent(""); setCustomType(""); setDocType("Info"); alert("Envoyé !"); setIsUploading(false); };
    const handleDelete = async (docItem) => { if(confirm("Supprimer ?")) { await deleteDoc(doc(db, docItem.sourceCol, docItem.id)); if(previewDoc) setPreviewDoc(null); } };
    const startEdit = (docItem) => { setEditingDoc(docItem); setNewName(docItem.name); };
    const saveRename = async () => { if(editingDoc && newName.trim()) { await updateDoc(doc(db, editingDoc.sourceCol, editingDoc.id), { [editingDoc.sourceCol === 'adminScripts' ? 'title' : editingDoc.sourceCol === 'userDocs' ? 'fileName' : 'name']: newName }); setEditingDoc(null); } };
    const handlePreview = async (docItem) => {
        if (docItem.isNew && !docItem.isMine && docItem.sourceCol === 'documents') try { await updateDoc(doc(db, "documents", docItem.id), { isNew: false }); docItem.isNew = false; } catch (e) {}
        if (docItem.type === 'NOTE') { setReadingNote(docItem); setReplyText(""); } else setPreviewDoc(docItem);
    };
    const handleDownload = (docItem) => { const link = document.createElement('a'); link.href = docItem.url; link.download = docItem.name; document.body.appendChild(link); link.click(); document.body.removeChild(link); };
    const handleReply = async () => { if(!replyText.trim()) return; setIsReplying(true); try { await addDoc(collection(db, "documents"), { category: "Réponse", salesRepId: readingNote.salesRepId || 'All', uploadedBy: isAdmin ? 'Admin' : 'User', senderName: user.email, isNew: true, name: `Rép: ${readingNote.name}`, textContent: replyText, type: 'NOTE', createdAt: new Date() }); alert("Réponse envoyée !"); setReadingNote(null); } catch(e) { alert("Erreur"); } setIsReplying(false); };

    const getFileIconInfo = (type) => {
        const t = (type || "").toUpperCase();
        if (t === 'NOTE') { if (globalSettings?.docIconMsg) return { isCustom: true, url: globalSettings.docIconMsg }; return { isCustom: false, icon: 'message-square', bg: 'bg-blue-100 text-blue-600' }; }
        if (['JPG', 'PNG', 'JPEG', 'GIF', 'WEBP'].includes(t)) { if (globalSettings?.docIconImg) return { isCustom: true, url: globalSettings.docIconImg }; return { isCustom: false, icon: 'image', bg: 'bg-purple-100 text-purple-600' }; }
        if (['PDF'].includes(t)) { if (globalSettings?.docIconPdf) return { isCustom: true, url: globalSettings.docIconPdf }; return { isCustom: false, icon: 'fileText', bg: 'bg-red-100 text-red-600' }; }
        return { isCustom: false, icon: 'file', bg: 'bg-slate-100 text-slate-600' };
    };
    const getCategoryStyle = (cat) => { if(['Info','Facture','Important','ASigner','Réponse'].includes(cat)) { switch(cat) { case 'ASigner': return "bg-red-50 text-red-600 border-red-100"; case 'Important': return "bg-orange-50 text-orange-600 border-orange-100"; case 'Facture': return "bg-green-50 text-green-600 border-green-100"; case 'Réponse': return "bg-purple-50 text-purple-600 border-purple-100"; default: return "bg-blue-50 text-blue-700 border-blue-200"; } } return "bg-slate-50 text-slate-500 border-slate-100"; };

    return React.createElement('div', { className: "max-w-6xl mx-auto space-y-8" },
        React.createElement('div', { className: "flex flex-col md:flex-row justify-between items-center gap-4" },
            React.createElement('div', null, React.createElement('h1', { className: "text-3xl font-black text-slate-900" }, "Documents & Demandes"), React.createElement('p', { className: "text-slate-500 font-bold" }, isAdmin ? "Gestion des fichiers et requêtes." : "Vos échanges avec l'administration.")),
            isAdmin && allSalesReps && React.createElement('select', { value: filterRep, onChange: e => setFilterRep(e.target.value), className: "bg-white border p-2 rounded-lg font-bold text-slate-700 shadow-sm" }, React.createElement('option', { value: "All" }, "Vue d'ensemble"), allSalesReps.map(r => React.createElement('option', { key: r.id, value: r.id }, r.name)))
        ),
        
        // --- ZONE D'UPLOAD ---
        React.createElement('div', { className: "bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm transition-all" },
            React.createElement('div', { className: "flex gap-4 border-b border-slate-100 pb-4 mb-6" },
                React.createElement('button', { onClick: () => setUploadMode('file'), className: `flex items-center gap-2 text-sm font-bold pb-2 transition-all ${uploadMode === 'file' ? 'text-slate-900 border-b-2 border-slate-900' : 'text-slate-400 hover:text-slate-600'}` }, React.createElement(Icon, { name: "upload", size: 16 }), "Envoyer un Fichier"),
                React.createElement('button', { onClick: () => setUploadMode('note'), className: `flex items-center gap-2 text-sm font-bold pb-2 transition-all ${uploadMode === 'note' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-400 hover:text-slate-600'}` }, React.createElement(Icon, { name: "message-square", size: 16 }), "Envoyer une Note / Demande")
            ),
            React.createElement('form', { onSubmit: handleSend, className: "flex flex-col md:flex-row gap-6 items-start w-full" },
                React.createElement('div', { className: "flex-1 w-full min-w-[200px]" },
                    React.createElement('label', { className: "block text-[10px] font-bold text-slate-500 mb-1 ml-1" }, uploadMode === 'file' ? "SÉLECTIONNER FICHIER (PDF, IMG...)" : "VOTRE MESSAGE / DEMANDE"),
                    uploadMode === 'file' ? React.createElement('input', { type: "file", onChange: e => setNewDocFile(e.target.files[0]), className: "block w-full text-sm text-slate-500 file:mr-4 file:py-2.5 file:px-4 file:rounded-xl file:border-0 file:text-xs file:font-bold file:bg-slate-100 file:text-slate-700 hover:file:bg-slate-200 cursor-pointer bg-slate-50 rounded-xl border border-slate-100" }) : React.createElement('textarea', { value: noteContent, onChange: e => setNoteContent(e.target.value), placeholder: "Votre message...", rows: 2, className: "w-full bg-blue-50 border border-blue-100 rounded-xl text-sm p-3 font-medium text-slate-800 outline-none focus:ring-2 focus:ring-blue-500 resize-none" })
                ),
                isAdmin && React.createElement('div', { className: "w-full md:w-64" }, React.createElement('label', { className: "block text-[10px] font-bold text-slate-500 mb-1 ml-1" }, "POUR QUI ?"), React.createElement('select', { value: targetRepId, onChange: e => setTargetRepId(e.target.value), className: "w-full bg-slate-100 border border-slate-200 rounded-xl text-sm font-bold p-2.5 outline-none focus:ring-2 focus:ring-slate-900 transition" }, React.createElement('option', { value: "All" }, "Tout le monde"), allSalesReps && allSalesReps.map(r => React.createElement('option', { key: r.id, value: r.id }, r.name)))),
                React.createElement('div', { className: "w-full md:w-64" }, React.createElement('label', { className: "block text-[10px] font-bold text-slate-500 mb-1 ml-1" }, uploadMode === 'file' ? "TYPE DOCUMENT" : "OBJET DE LA DEMANDE"), React.createElement('div', { className: "flex flex-col gap-3" }, React.createElement('select', { value: docType, onChange: e => setDocType(e.target.value), className: "w-full bg-slate-100 border border-slate-200 rounded-xl text-sm font-bold p-2.5 outline-none focus:ring-2 focus:ring-slate-900 transition" }, React.createElement('option', { value: "Info" }, "Info / Divers"), React.createElement('option', { value: "Facture" }, "Facture"), React.createElement('option', { value: "ASigner" }, "À Signer"), React.createElement('option', { value: "Demande" }, "Demande"), React.createElement('option', { value: "Urgent" }, "Urgent"), React.createElement('option', { value: "Autre" }, "Autre (Préciser)...")), docType === 'Autre' && React.createElement('input', { type: "text", placeholder: "Précisez...", value: customType, onChange: e => setCustomType(e.target.value), className: "w-full bg-white border-2 border-blue-100 rounded-xl text-sm p-2.5 font-bold text-blue-900 outline-none focus:ring-2 focus:ring-blue-500 animate-in slide-in-from-top-2 fade-in" }))),
                React.createElement('div', { className: "w-full md:w-auto md:mt-[1.35rem]" }, React.createElement('button', { type: "submit", disabled: isUploading, className: `px-8 py-2.5 text-white rounded-xl font-bold text-sm shadow-lg transition-all active:scale-95 w-full md:w-auto whitespace-nowrap h-[42px] flex items-center justify-center gap-2 ${uploadMode === 'note' ? 'bg-blue-600 hover:bg-blue-700' : 'bg-slate-900 hover:bg-slate-800'}` }, isUploading ? "Envoi..." : React.createElement(React.Fragment, null, React.createElement(Icon, { name: "send", size: 16 }), uploadMode === 'note' ? "Envoyer Note" : "Envoyer Doc")))
            )
        ),

        // --- SECTION FILTRE (CORRIGÉE : BOUTON ET MENU DÉROULANT) ---
        React.createElement('div', { className: "flex flex-col gap-4" },
            React.createElement('div', { className: "flex justify-between items-center" },
                React.createElement('h3', { className: "text-lg font-black text-slate-800" }, "Mes Fichiers"),
                React.createElement('button', {
                    onClick: () => setShowFilters(!showFilters),
                    className: `flex items-center gap-2 px-4 py-2 rounded-xl font-bold text-sm transition ${showFilters || filterType !== 'All' ? 'bg-slate-900 text-white shadow-lg' : 'bg-white border border-slate-200 text-slate-600 hover:bg-slate-50'}`
                },
                    React.createElement(Icon, { name: "list", size: 16 }),
                    filterType === 'All' ? "Filtrer" : filterType,
                    React.createElement(Icon, { name: showFilters ? "x" : "chevron-down", size: 14 }) // Petite flèche ou croix
                )
            ),
            
            // MENU FILTRE (S'ouvre sous le bouton)
            showFilters && React.createElement('div', { className: "bg-white p-4 rounded-2xl border border-slate-100 shadow-xl animate-in slide-in-from-top-2 fade-in z-20" },
                React.createElement('p', { className: "text-[10px] font-bold text-slate-400 uppercase mb-3" }, "Afficher par type"),
                React.createElement('div', { className: "flex flex-wrap gap-2" },
                    ['All', 'PDF', 'Image', 'Message', 'Autre'].map(type => 
                        React.createElement('button', { 
                            key: type, 
                            onClick: () => { setFilterType(type); setShowFilters(false); }, // On ferme le menu après choix
                            className: `px-4 py-3 rounded-xl text-sm font-bold flex-1 border transition ${filterType === type ? 'bg-blue-50 border-blue-200 text-blue-700' : 'bg-slate-50 border-slate-100 text-slate-600 hover:bg-slate-100'}` 
                        }, type === 'All' ? 'Tout voir' : type)
                    )
                )
            )
        ),

        // --- LISTE ---
        filteredDocuments.length === 0 ? React.createElement('div', { className: "text-center py-20 opacity-50 font-bold text-slate-400 bg-white rounded-3xl border border-dashed border-slate-200" }, "Aucun document trouvé.") :
        React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-3 gap-6" },
            filteredDocuments.map(docItem => {
                const isSign = docItem.category === 'ASigner';
                const isNew = docItem.isNew && !docItem.isMine;
                const isNote = docItem.type === 'NOTE';
                const iconInfo = getFileIconInfo(docItem.type);
                return React.createElement('div', { key: docItem.id, className: `group relative bg-white rounded-2xl p-5 border transition-all duration-300 flex flex-col ${docItem.isMine ? 'border-slate-200' : isNote ? 'border-blue-200 bg-blue-50/30' : 'border-blue-100 shadow-sm hover:shadow-md'}` },
                    isNew && React.createElement('span', { className: "absolute -top-2 -right-2 bg-blue-600 text-white text-[10px] font-black px-2 py-1 rounded-full shadow-lg animate-pulse z-10" }, "NOUVEAU"),
                    React.createElement('div', { className: "flex justify-between items-start mb-4" },
                        React.createElement('div', { className: `h-14 w-14 flex items-center justify-center rounded-2xl shadow-sm border border-black/5 overflow-hidden ${iconInfo.isCustom ? 'bg-white' : iconInfo.bg}` }, iconInfo.isCustom ? React.createElement('img', { src: iconInfo.url, className: "w-full h-full object-cover" }) : React.createElement(Icon, { name: iconInfo.icon, size: 28 })),
                        React.createElement('div', { className: "flex items-center gap-2" }, docItem.isMine && React.createElement('span', { className: "bg-slate-100 text-slate-500 text-[9px] font-black px-2 py-1 rounded uppercase tracking-wider border border-slate-200" }, "MOI"), React.createElement('span', { className: `px-2.5 py-1 rounded-lg text-[9px] font-black uppercase border tracking-wide ${getCategoryStyle(docItem.category)}` }, docItem.category.toUpperCase()))
                    ),
                    React.createElement('div', { className: "mb-6" },
                        React.createElement('h4', { className: "font-bold text-slate-800 truncate mb-1 pr-8 text-[15px]", title: docItem.name }, docItem.name),
                        isNote && React.createElement('p', { className: "text-sm text-slate-600 italic line-clamp-2 mb-2 bg-white/50 p-2 rounded border border-slate-100" }, `"${docItem.textContent}"`),
                        React.createElement('div', { className: "text-xs text-slate-400 font-medium" }, React.createElement('p', null, new Date(docItem.createdAt?.seconds * 1000).toLocaleDateString()), isAdmin && React.createElement('p', { className: "text-indigo-400 mt-1 truncate" }, docItem.uploadedBy === 'Admin' ? `Pour: ${docItem.salesRepId === 'All' ? 'Tous' : 'Individuel'}` : `De: ${docItem.senderName || 'Utilisateur'}`))
                    ),
                    React.createElement('div', { className: "flex items-center justify-between mt-auto pt-4 border-t border-slate-50" },
                        React.createElement('button', { onClick: () => handlePreview(docItem), className: `flex items-center gap-2 text-sm font-bold transition px-4 py-2 rounded-xl ${isNote ? 'bg-blue-600 text-white hover:bg-blue-700 shadow-md' : 'bg-slate-900 text-white hover:bg-slate-800 shadow-md'}` }, React.createElement(Icon, { name: "eye", size: 16 }), isNote ? "Lire & Répondre" : "Aperçu"),
                        React.createElement('div', { className: "flex gap-2" }, !isNote && React.createElement('button', { onClick: () => handleDownload(docItem), className: "p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition border border-transparent hover:border-blue-100", title: "Télécharger" }, React.createElement(Icon, { name: "download", size: 18 })), (isAdmin || docItem.isMine) && React.createElement('div', { className: "flex gap-1" }, !isNote && React.createElement('button', { onClick: () => startEdit(docItem), className: "p-2 text-slate-400 hover:text-slate-700 hover:bg-slate-100 rounded-lg transition" }, React.createElement(Icon, { name: "edit", size: 16 })), React.createElement('button', { onClick: () => handleDelete(docItem), className: "p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition" }, React.createElement(Icon, { name: "trash", size: 16 }))))
                    )
                );
            })
        ),
        readingNote && React.createElement('div', { className: "fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] flex items-center justify-center p-4" },
            React.createElement('div', { className: "bg-white rounded-3xl p-8 w-full max-w-lg shadow-2xl animate-in zoom-in-95 relative flex flex-col max-h-[90vh]" },
                React.createElement('button', { onClick: () => setReadingNote(null), className: "absolute top-4 right-4 p-2 bg-slate-100 rounded-full hover:bg-slate-200" }, React.createElement(Icon, { name: "x", size: 20 })),
                React.createElement('div', { className: "flex items-center gap-3 mb-6" },
                    React.createElement('div', { className: `h-12 w-12 flex items-center justify-center rounded-full shadow-sm border border-black/5 overflow-hidden ${getFileIconInfo('NOTE').isCustom ? 'bg-white' : 'bg-blue-100 text-blue-600'}` }, getFileIconInfo('NOTE').isCustom ? React.createElement('img', { src: getFileIconInfo('NOTE').url, className: "w-full h-full object-cover" }) : React.createElement(Icon, { name: "message-square", size: 24 })),
                    React.createElement('div', null, React.createElement('h3', { className: "text-xl font-black text-slate-800" }, readingNote.category), React.createElement('p', { className: "text-xs text-slate-400" }, new Date(readingNote.createdAt?.seconds * 1000).toLocaleString()))
                ),
                React.createElement('div', { className: "bg-slate-50 p-6 rounded-2xl border border-slate-100 text-slate-700 font-medium leading-relaxed whitespace-pre-wrap overflow-y-auto mb-6 max-h-60" }, readingNote.textContent),
                React.createElement('div', { className: "border-t border-slate-100 pt-4" },
                    React.createElement('label', { className: "block text-xs font-bold text-slate-400 mb-2 uppercase" }, "Répondre rapidement"),
                    React.createElement('textarea', { value: replyText, onChange: (e) => setReplyText(e.target.value), placeholder: "Écrivez votre réponse ici...", className: "w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-blue-500 resize-none h-24 mb-3" }),
                    React.createElement('div', { className: "flex gap-2" }, React.createElement('button', { onClick: () => setReadingNote(null), className: "flex-1 bg-white border border-slate-200 text-slate-600 py-3 rounded-xl font-bold hover:bg-slate-50 transition" }, "Fermer"), React.createElement('button', { onClick: handleReply, disabled: !replyText.trim() || isReplying, className: "flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition flex items-center justify-center gap-2" }, isReplying ? "Envoi..." : React.createElement(React.Fragment, null, React.createElement(Icon, { name: "send", size: 16 }), "Répondre")))
                )
            )
        ),
        previewDoc && React.createElement('div', { className: "fixed inset-0 bg-black/80 backdrop-blur-md z-[200] flex items-center justify-center p-4" },
            React.createElement('div', { className: "bg-white w-full max-w-5xl h-[85vh] rounded-3xl shadow-2xl flex flex-col overflow-hidden animate-in zoom-in-95" },
                React.createElement('div', { className: "px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-white" },
                    React.createElement('div', { className: "flex items-center gap-3" },
                        React.createElement('div', { className: `h-10 w-10 flex items-center justify-center rounded-lg shadow-sm border border-black/5 overflow-hidden ${getFileIconInfo(previewDoc.type).isCustom ? 'bg-white' : getFileIconInfo(previewDoc.type).bg}` }, getFileIconInfo(previewDoc.type).isCustom ? React.createElement('img', { src: getFileIconInfo(previewDoc.type).url, className: "w-full h-full object-cover" }) : React.createElement(Icon, { name: getFileIconInfo(previewDoc.type).icon, size: 20 })),
                        React.createElement('h3', { className: "font-bold text-slate-800 truncate max-w-xs md:max-w-md" }, previewDoc.name)
                    ),
                    React.createElement('div', { className: "flex gap-2" }, React.createElement('button', { onClick: () => handleDownload(previewDoc), className: "flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-xl font-bold text-sm transition" }, React.createElement(Icon, { name: "download", size: 16 }), "Télécharger"), React.createElement('button', { onClick: () => setPreviewDoc(null), className: "p-2 bg-slate-100 hover:bg-red-100 hover:text-red-600 text-slate-500 rounded-xl transition" }, React.createElement(Icon, { name: "x", size: 20 })))
                ),
                React.createElement('div', { className: "flex-1 bg-slate-50 relative overflow-hidden flex items-center justify-center" },
                    ['JPG', 'PNG', 'JPEG', 'GIF', 'WEBP'].includes(previewDoc.type.toUpperCase()) ? React.createElement('img', { src: previewDoc.url, className: "max-w-full max-h-full object-contain shadow-lg" }) :
                    previewDoc.type.toUpperCase() === 'PDF' ? React.createElement('iframe', { src: previewDoc.url, className: "w-full h-full border-0" }) :
                    React.createElement('div', { className: "text-center text-slate-400" }, React.createElement(Icon, { name: "file", size: 64, className: "mx-auto mb-4 opacity-20" }), React.createElement('p', null, "Aperçu non disponible."), React.createElement('button', { onClick: () => handleDownload(previewDoc), className: "text-blue-600 underline mt-2" }, "Télécharger le fichier"))
                )
            )
        ),
        editingDoc && React.createElement('div', { className: "fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4" },
            React.createElement('div', { className: "bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl animate-in zoom-in-95" },
                React.createElement('h3', { className: "text-lg font-black mb-4" }, "Renommer"),
                React.createElement('input', { value: newName, onChange: (e) => setNewName(e.target.value), className: "w-full border p-3 rounded-xl mb-4 font-bold text-slate-700 outline-none focus:ring-2 ring-slate-900" }),
                React.createElement('div', { className: "flex justify-end gap-2" }, React.createElement('button', { onClick: () => setEditingDoc(null), className: "px-4 py-2 text-slate-500 font-bold hover:bg-slate-50 rounded-lg" }, "Annuler"), React.createElement('button', { onClick: saveRename, className: "px-4 py-2 bg-slate-900 text-white font-bold rounded-lg" }, "Valider"))
            )
        )
    );
}
// --- MODULE SCRIPTS (AVEC ICÔNE CAMÉRA POUR LES PHOTOS) ---
function ScriptsModule({ user, db, isAdmin }) {
    // --- ETATS ---
    const [activeTab, setActiveTab] = useState('Mes Notes'); 
    const [tabs, setTabs] = useState(['Appel Initial', 'Mission Pilote', 'Relance']);
    const [adminScripts, setAdminScripts] = useState([]);
    const [userScripts, setUserScripts] = useState([]);
    
    // Gestion Affichage
    const [showTabMenu, setShowTabMenu] = useState(false);
    const [showUploadForm, setShowUploadForm] = useState(false);

    // Gestion Onglets (Admin)
    const [isManagingTabs, setIsManagingTabs] = useState(false);
    const [newTabName, setNewTabName] = useState("");
    const [tabToDelete, setTabToDelete] = useState(null);

    // Modales / Actions
    const [scriptToDelete, setScriptToDelete] = useState(null);
    const [editingScript, setEditingScript] = useState(null);
    const [previewScript, setPreviewScript] = useState(null);
    const [successMsg, setSuccessMsg] = useState(null);

    // Upload
    const [uploadFile, setUploadFile] = useState(null);
    const [uploadTitle, setUploadTitle] = useState("");
    const [uploadCategory, setUploadCategory] = useState("");

    // --- 1. CHARGEMENT ---
    useEffect(() => {
        const unsubSettings = onSnapshot(doc(db, "settings", "global"), (snap) => {
            if (snap.exists() && snap.data().scriptTabs) {
                const loadedTabs = snap.data().scriptTabs;
                setTabs(loadedTabs);
                if (!uploadCategory && loadedTabs.length > 0) setUploadCategory(loadedTabs[0]);
            }
        });
        const qAdmin = query(collection(db, "adminScripts"));
        const unsubAdmin = onSnapshot(qAdmin, (snap) => {
            setAdminScripts(snap.docs.map(d => ({ id: d.id, ...d.data() })));
        });
        const qUser = query(collection(db, "userScripts"), where("userId", "==", user.uid));
        const unsubUser = onSnapshot(qUser, (snap) => {
            setUserScripts(snap.docs.map(d => ({ id: d.id, ...d.data() })));
        });
        return () => { unsubSettings(); unsubAdmin(); unsubUser(); };
    }, [user.uid]);

    // --- 2. LOGIQUE ---
    const saveTabs = async (newTabs) => { try { await setDoc(doc(db, "settings", "global"), { scriptTabs: newTabs }, { merge: true }); setTabs(newTabs); } catch (e) {} };
    const addTab = () => { if (!newTabName.trim() || tabs.includes(newTabName.trim())) return; saveTabs([...tabs, newTabName.trim()]); setNewTabName(""); };
    const confirmRemoveTab = () => { if (!tabToDelete) return; const newList = tabs.filter(t => t !== tabToDelete); saveTabs(newList); if (activeTab === tabToDelete) setActiveTab('Mes Notes'); setTabToDelete(null); };
    
    const handleAdminUpload = () => {
        if (!uploadFile || !uploadTitle || !uploadCategory) return alert("Veuillez remplir tous les champs.");
        if (uploadCategory === 'Mes Notes') return alert("Impossible d'ajouter un fichier dans 'Mes Notes'.");
        if (uploadFile.size > 900000) {
            return alert("❌ Fichier trop lourd ! (Max 1 Mo). Veuillez réduire la taille de la photo ou compresser le PDF.");
        }

        const reader = new FileReader();
        reader.onloadend = async () => {
            try {
                await addDoc(collection(db, "adminScripts"), {
                    title: uploadTitle, 
                    fileData: reader.result, 
                    category: uploadCategory,
                    createdAt: new Date(), 
                    type: uploadFile.name.split('.').pop().toUpperCase(), 
                    readByUsers: []
                });
                setUploadFile(null); 
                setUploadTitle(""); 
                setShowUploadForm(false);
                setActiveTab(uploadCategory);
                setSuccessMsg({ text: "Document ajouté avec succès !" }); 
                setTimeout(() => setSuccessMsg(null), 3000);
            } catch (error) {
                console.error(error);
                alert("Erreur technique lors de l'envoi.");
            }
        };
        reader.readAsDataURL(uploadFile);
    };

    const handlePreview = async (script) => {
        if (!isAdmin && (!script.readByUsers || !script.readByUsers.includes(user.uid))) {
            try { const currentReads = script.readByUsers || []; await updateDoc(doc(db, "adminScripts", script.id), { readByUsers: [...currentReads, user.uid] }); } catch (e) {}
        }
        setPreviewScript(script);
    };
    const handleDownload = (script) => { const link = document.createElement('a'); link.href = script.fileData; link.download = script.title; document.body.appendChild(link); link.click(); document.body.removeChild(link); };
    const confirmDeleteScript = async () => { if (!scriptToDelete) return; await deleteDoc(doc(db, scriptToDelete.isUser ? "userScripts" : "adminScripts", scriptToDelete.id)); setScriptToDelete(null); };
    
    const saveUserScript = async () => {
        if (!editingScript.title) return;
        const d = { userId: user.uid, title: editingScript.title, content: editingScript.content || "", updatedAt: new Date() };
        if (editingScript.id) await updateDoc(doc(db, "userScripts", editingScript.id), d);
        else await addDoc(collection(db, "userScripts"), { ...d, createdAt: new Date() });
        setEditingScript(null);
    };

    const hasUnreadScripts = (category) => {
        if (isAdmin) return false;
        return adminScripts.some(s => s.category === category && (!s.readByUsers || !s.readByUsers.includes(user.uid)));
    };

    const anyUnreadInTabs = tabs.some(t => hasUnreadScripts(t));

    // --- RENDER ---
    return React.createElement('div', { className: "max-w-6xl mx-auto min-h-[80vh] flex flex-col relative pb-20" },
        
        successMsg && React.createElement('div', { className: "fixed bottom-20 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full bg-slate-900 text-white shadow-2xl flex items-center gap-3 z-[200] animate-in fade-in" }, React.createElement(Icon, { name: "check", size: 20 }), React.createElement('span', { className: "font-bold text-sm" }, successMsg.text)),

        React.createElement('div', { className: "space-y-4 mb-6" },
            React.createElement('div', { className: "flex flex-col md:flex-row justify-between items-start md:items-center gap-4" },
                React.createElement('div', null,
                    React.createElement('h1', { className: "text-3xl font-black text-slate-900" }, "Scripts & Procédures"),
                    React.createElement('p', { className: "text-slate-500 font-bold text-sm" }, "Bibliothèque officielle et vos notes personnelles.")
                ),
                
                React.createElement('div', { className: "w-full md:w-auto" },
                    React.createElement('p', { 
                        className: `text-[10px] font-black uppercase tracking-widest mb-1 ml-1 animate-pulse ${anyUnreadInTabs ? 'text-red-500' : 'text-blue-600'}` 
                    }, anyUnreadInTabs ? "🔔 NOUVEAUX DOCUMENTS DANS LE MENU 👇" : "👇 CLIQUEZ ICI POUR CHANGER DE CATÉGORIE"),

                    React.createElement('div', { className: "relative z-30" },
                        React.createElement('button', { 
                            onClick: () => setShowTabMenu(!showTabMenu),
                            className: `w-full md:w-64 bg-white border-2 text-slate-800 px-4 py-3 rounded-xl font-bold flex items-center justify-between shadow-sm transition-all ${anyUnreadInTabs ? 'border-red-400' : 'border-slate-200 hover:border-slate-900'}`
                        },
                            React.createElement('div', { className: "flex items-center gap-2" },
                                React.createElement(Icon, { name: activeTab === 'Mes Notes' ? "edit" : "folder", size: 18 }),
                                React.createElement('span', null, activeTab)
                            ),
                            React.createElement(Icon, { name: showTabMenu ? "x" : "chevron-down", size: 18 })
                        ),
                        
                        showTabMenu && React.createElement('div', { className: "absolute top-full mt-2 left-0 w-full bg-white rounded-xl shadow-xl border border-slate-100 p-2 animate-in slide-in-from-top-2 fade-in" },
                            React.createElement('button', { 
                                onClick: () => { setActiveTab('Mes Notes'); setShowTabMenu(false); }, 
                                className: `w-full text-left px-4 py-3 rounded-lg font-bold text-sm flex items-center justify-between mb-1 ${activeTab === 'Mes Notes' ? 'bg-yellow-50 text-yellow-700' : 'hover:bg-slate-50 text-slate-600'}` 
                            }, "📝 Mes Notes Perso"),
                            
                            tabs.map(tab => 
                                React.createElement('div', { key: tab, className: "relative group" },
                                    React.createElement('button', { 
                                        onClick: () => { setActiveTab(tab); setShowTabMenu(false); }, 
                                        className: `w-full text-left px-4 py-3 rounded-lg font-bold text-sm flex items-center justify-between ${activeTab === tab ? 'bg-slate-900 text-white' : 'hover:bg-slate-50 text-slate-600'}` 
                                    }, 
                                        tab,
                                        hasUnreadScripts(tab) && React.createElement('span', { className: "bg-red-500 text-white text-[9px] px-2 py-0.5 rounded-full" }, "Nouveau")
                                    ),
                                    isAdmin && isManagingTabs && React.createElement('button', { onClick: (e) => { e.stopPropagation(); setTabToDelete(tab); }, className: "absolute right-2 top-1/2 -translate-y-1/2 p-2 text-red-400 hover:text-red-600" }, React.createElement(Icon, { name: "trash", size: 14 }))
                                )
                            ),
                            
                            isAdmin && React.createElement('div', { className: "mt-2 pt-2 border-t border-slate-100 px-2" },
                                isManagingTabs ? (
                                    React.createElement('div', { className: "flex gap-2" },
                                        React.createElement('input', { value: newTabName, onChange: e => setNewTabName(e.target.value), placeholder: "Nouveau...", className: "flex-1 bg-slate-50 rounded-lg px-2 text-xs font-bold outline-none" }),
                                        React.createElement('button', { onClick: addTab, className: "p-2 bg-green-500 text-white rounded-lg" }, "+"),
                                        React.createElement('button', { onClick: () => setIsManagingTabs(false), className: "text-xs text-slate-400 font-bold underline ml-1" }, "Fin")
                                    )
                                ) : (
                                    React.createElement('button', { onClick: () => setIsManagingTabs(true), className: "w-full py-2 text-center text-xs font-bold text-slate-400 hover:text-slate-600 border border-dashed rounded-lg" }, "Gérer / Ajouter Onglets")
                                )
                            )
                        )
                    )
                )
            )
        ),

        React.createElement('div', { className: "flex-1 bg-white rounded-[2rem] p-6 border border-slate-200 shadow-sm min-h-[400px]" },
            
            activeTab === 'Mes Notes' ? (
                React.createElement('div', null,
                    React.createElement('div', { className: "flex justify-between items-center mb-6" },
                        React.createElement('h2', { className: "text-xl font-black text-slate-800" }, "Mon Bloc-Notes"),
                        React.createElement('button', { onClick: () => setEditingScript({ title: "", content: "" }), className: "bg-yellow-400 text-yellow-900 px-4 py-2 rounded-xl font-bold shadow-sm flex items-center gap-2 text-sm" }, React.createElement(Icon, { name: "edit", size: 16 }), "Nouvelle Note")
                    ),
                    userScripts.length === 0 ? 
                        React.createElement('div', { className: "text-center py-20 opacity-40" }, React.createElement(Icon, { name: "edit", size: 48, className: "mx-auto mb-2 text-slate-300" }), React.createElement('p', { className: "font-bold text-slate-400 text-sm" }, "Aucune note personnelle.")) :
                        React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" },
                            userScripts.map(script => 
                                React.createElement('div', { key: script.id, onClick: () => setEditingScript(script), className: "bg-yellow-50 hover:bg-yellow-100 border border-yellow-200 p-5 rounded-2xl cursor-pointer transition-all flex flex-col h-48 relative group" },
                                    React.createElement('h3', { className: "font-black text-slate-800 mb-2 truncate" }, script.title),
                                    React.createElement('p', { className: "text-xs text-slate-600 font-medium line-clamp-5 flex-1 whitespace-pre-wrap" }, script.content),
                                    React.createElement('div', { className: "absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity" },
                                        React.createElement('button', { onClick: (e) => { e.stopPropagation(); setScriptToDelete({...script, isUser: true}); }, className: "p-2 bg-white rounded-full text-red-400 shadow-sm" }, React.createElement(Icon, { name: "trash", size: 14 }))
                                    )
                                )
                            )
                        )
                )
            ) : (
                React.createElement('div', null,
                    React.createElement('div', { className: "flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4" },
                        React.createElement('h2', { className: "text-xl font-black text-slate-800 flex items-center gap-2" }, React.createElement('span', { className: "text-2xl" }, "📂"), activeTab),
                        
                        isAdmin && React.createElement('button', { 
                            onClick: () => setShowUploadForm(!showUploadForm), 
                            className: `px-4 py-2 rounded-xl font-bold text-sm flex items-center gap-2 transition ${showUploadForm ? 'bg-slate-200 text-slate-600' : 'bg-slate-900 text-white shadow-lg'}`
                        }, React.createElement(Icon, { name: showUploadForm ? "x" : "upload", size: 16 }), showUploadForm ? "Fermer" : "Ajouter un Script")
                    ),

                    isAdmin && showUploadForm && React.createElement('div', { className: "mb-8 bg-slate-50 p-4 rounded-2xl border border-slate-200 animate-in slide-in-from-top-5 fade-in" },
                        React.createElement('div', { className: "flex flex-col gap-4" },
                            React.createElement('div', null,
                                React.createElement('label', { className: "block text-[10px] font-bold text-slate-400 uppercase mb-1" }, "Dans quel onglet ?"),
                                React.createElement('select', { 
                                    value: uploadCategory, 
                                    onChange: e => setUploadCategory(e.target.value),
                                    className: "w-full bg-white px-4 py-3 rounded-xl font-bold text-sm outline-none border border-slate-200 focus:border-slate-900 transition"
                                }, 
                                    tabs.map(t => React.createElement('option', { key: t, value: t }, t))
                                )
                            ),
                            React.createElement('div', null,
                                React.createElement('label', { className: "block text-[10px] font-bold text-slate-400 uppercase mb-1" }, "Titre"),
                                React.createElement('input', { value: uploadTitle, onChange: e => setUploadTitle(e.target.value), placeholder: "Ex: Script...", className: "w-full bg-white px-4 py-3 rounded-xl font-bold text-sm outline-none border border-slate-200 focus:border-slate-900 transition" })
                            ),
                            React.createElement('div', null,
                                React.createElement('label', { className: "block text-[10px] font-bold text-slate-400 uppercase mb-1" }, "Fichier (PDF, IMG) - Max 1Mo"),
                                React.createElement('label', { className: `w-full flex items-center justify-center gap-2 px-4 py-3 rounded-xl border-2 border-dashed cursor-pointer transition ${uploadFile ? 'bg-green-50 border-green-200 text-green-700' : 'bg-white border-slate-300 text-slate-500 hover:bg-slate-100'}` },
                                    React.createElement(Icon, { name: uploadFile ? "check" : "upload", size: 18 }),
                                    React.createElement('span', { className: "text-sm font-bold truncate" }, uploadFile ? uploadFile.name : "Cliquez pour sélectionner"),
                                    React.createElement('input', { type: "file", accept: ".pdf, .jpg, .jpeg, .png, .webp", onChange: e => setUploadFile(e.target.files[0]), className: "hidden" })
                                )
                            ),
                            React.createElement('button', { 
                                onClick: handleAdminUpload, 
                                disabled: !uploadFile || !uploadTitle,
                                className: `w-full py-3 rounded-xl font-bold text-white shadow-lg transition ${!uploadFile || !uploadTitle ? 'bg-slate-300 cursor-not-allowed' : 'bg-slate-900 hover:bg-black'}` 
                            }, "Publier le document")
                        )
                    ),

                    adminScripts.filter(s => s.category === activeTab).length === 0 ?
                        React.createElement('div', { className: "text-center py-20 opacity-40" }, React.createElement(Icon, { name: "folder", size: 48, className: "mx-auto mb-2 text-slate-300" }), React.createElement('p', { className: "font-bold text-slate-400 text-sm" }, "Aucun document ici.")) :
                        React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-3 gap-4" },
                            adminScripts.filter(s => s.category === activeTab).map(doc => {
                                const isNew = !isAdmin && (!doc.readByUsers || !doc.readByUsers.includes(user.uid));
                                // DETECTION TYPE
                                const isPdf = doc.type && doc.type.includes('PDF');
                                return React.createElement('div', { key: doc.id, className: "group bg-white border border-slate-100 p-4 rounded-2xl transition-all hover:shadow-lg relative flex flex-col" },
                                    isNew && React.createElement('span', { className: "absolute -top-2 -right-2 bg-blue-600 text-white text-[10px] font-black px-2 py-1 rounded-full shadow-lg animate-pulse z-10" }, "NOUVEAU"),
                                    React.createElement('div', { className: "flex items-start gap-3 mb-3" },
                                        // MODIFICATION ICI : ICÔNE ET COULEUR SELON LE TYPE
                                        React.createElement('div', { className: `h-10 w-10 rounded-lg flex items-center justify-center shrink-0 ${isPdf ? 'bg-red-50 text-red-600' : 'bg-indigo-50 text-indigo-600'}` }, 
                                            React.createElement(Icon, { name: isPdf ? "fileText" : "camera", size: 20 })
                                        ),
                                        React.createElement('div', { className: "overflow-hidden" },
                                            React.createElement('h3', { className: "font-bold text-slate-800 leading-tight mb-1 truncate w-full text-sm" }, doc.title),
                                            React.createElement('p', { className: "text-[10px] text-slate-400 font-medium" }, new Date(doc.createdAt?.seconds * 1000).toLocaleDateString())
                                        )
                                    ),
                                    React.createElement('div', { className: "mt-auto flex gap-2" },
                                        React.createElement('button', { onClick: () => handlePreview(doc), className: "flex-1 flex items-center justify-center gap-2 bg-slate-900 text-white py-2 rounded-lg font-bold text-xs hover:bg-slate-800 transition" }, React.createElement(Icon, { name: "eye", size: 14 }), "Aperçu"),
                                        isAdmin && React.createElement('button', { onClick: (e) => { e.stopPropagation(); setScriptToDelete({...doc, isUser: false}); }, className: "p-2 bg-red-50 text-red-500 rounded-lg hover:bg-red-100" }, React.createElement(Icon, { name: "trash", size: 14 }))
                                    )
                                );
                            })
                        )
                )
            )
        ),

        previewScript && React.createElement('div', { className: "fixed inset-0 bg-black/80 backdrop-blur-md z-[200] flex items-center justify-center p-4" },
            React.createElement('div', { className: "bg-white w-full max-w-5xl h-[85vh] rounded-3xl shadow-2xl flex flex-col overflow-hidden animate-in zoom-in-95" },
                React.createElement('div', { className: "px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-white" },
                    React.createElement('div', { className: "flex items-center gap-3" },
                        // ICÔNE DANS LA MODALE AUSSI
                        React.createElement('div', { className: `p-2 rounded-lg ${previewScript.type && previewScript.type.includes('PDF') ? 'bg-red-50 text-red-600' : 'bg-indigo-50 text-indigo-600'}` }, React.createElement(Icon, { name: previewScript.type && previewScript.type.includes('PDF') ? "fileText" : "camera", size: 20 })),
                        React.createElement('h3', { className: "font-bold text-slate-800 truncate max-w-[200px]" }, previewScript.title)
                    ),
                    React.createElement('div', { className: "flex gap-2" },
                        React.createElement('button', { onClick: () => handleDownload(previewScript), className: "flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-xl font-bold text-sm transition" }, React.createElement(Icon, { name: "download", size: 16 }), "DL"),
                        React.createElement('button', { onClick: () => setPreviewScript(null), className: "p-2 bg-slate-100 hover:bg-red-100 hover:text-red-600 text-slate-500 rounded-xl" }, React.createElement(Icon, { name: "x", size: 20 }))
                    )
                ),
                React.createElement('div', { className: "flex-1 bg-slate-50 relative overflow-hidden flex items-center justify-center" },
                    (previewScript.type && previewScript.type.includes('PDF')) ? 
                        React.createElement('iframe', { src: previewScript.fileData, className: "w-full h-full border-0" }) :
                        React.createElement('img', { src: previewScript.fileData, className: "max-w-full max-h-full object-contain" })
                )
            )
        ),

        editingScript && React.createElement('div', { className: "fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm" },
            React.createElement('div', { className: "bg-yellow-50 w-full max-w-2xl rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[85vh] animate-in zoom-in-95 border-4 border-white" },
                React.createElement('div', { className: "px-8 py-6 border-b border-yellow-100 flex justify-between items-center bg-yellow-50" },
                    React.createElement('input', { value: editingScript.title, onChange: e => setEditingScript({...editingScript, title: e.target.value}), placeholder: "Titre de la note...", className: "text-2xl font-black text-yellow-900 bg-transparent outline-none placeholder-yellow-900/30 w-full" }),
                    React.createElement('button', { onClick: () => setEditingScript(null), className: "p-2 bg-yellow-100 text-yellow-700 rounded-full hover:bg-yellow-200" }, React.createElement(Icon, { name: "x", size: 24 }))
                ),
                React.createElement('textarea', { value: editingScript.content, onChange: e => setEditingScript({...editingScript, content: e.target.value}), placeholder: "Écrivez votre script ou vos notes ici...", className: "flex-1 w-full p-8 bg-yellow-50/50 text-yellow-900 font-medium text-lg leading-relaxed outline-none resize-none placeholder-yellow-900/20" }),
                React.createElement('div', { className: "p-6 border-t border-yellow-100 bg-yellow-50 flex justify-end gap-3" },
                    editingScript.id && React.createElement('button', { onClick: () => { setScriptToDelete({...editingScript, isUser: true}); }, className: "px-6 py-3 rounded-xl font-bold text-red-600 hover:bg-red-50 transition" }, "Supprimer"),
                    React.createElement('button', { onClick: saveUserScript, className: "px-8 py-3 rounded-xl font-bold text-white bg-yellow-600 hover:bg-yellow-700 shadow-lg transition flex items-center gap-2" }, React.createElement(Icon, { name: "save", size: 18 }), "Enregistrer")
                )
            )
        ),

        (scriptToDelete || tabToDelete) && React.createElement('div', { className: "fixed inset-0 z-[200] flex items-center justify-center p-4 bg-slate-900/70 backdrop-blur-sm" },
            React.createElement('div', { className: "bg-white rounded-3xl p-8 w-full max-w-sm shadow-2xl animate-in zoom-in-95 text-center" },
                React.createElement('div', { className: "w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4" }, React.createElement(Icon, { name: "trash", size: 32 })),
                React.createElement('h3', { className: "text-xl font-black text-slate-900 mb-2" }, tabToDelete ? "Supprimer l'onglet ?" : "Supprimer le script ?"),
                React.createElement('p', { className: "text-slate-500 text-sm mb-6" }, tabToDelete ? "Les scripts de cet onglet seront masqués." : "Cette action est définitive."),
                React.createElement('div', { className: "flex gap-3" },
                    React.createElement('button', { onClick: () => { setScriptToDelete(null); setTabToDelete(null); }, className: "flex-1 py-3 rounded-xl font-bold text-slate-600 bg-slate-100 hover:bg-slate-200 transition" }, "Annuler"),
                    React.createElement('button', { onClick: tabToDelete ? confirmRemoveTab : confirmDeleteScript, className: "flex-1 py-3 rounded-xl font-bold text-white bg-red-600 hover:bg-red-700 shadow-lg transition" }, "Confirmer")
                )
            )
        )
    );
}
// --- MODULE MES DEMANDES (CORRIGÉ : NOM DU COMMERCIAL VISIBLE POUR ADMIN) ---
function MyOrdersModule({ user, db, globalSettings, setCurrentModule, setCurrentOrder, isAdmin, allSalesReps }) {
    const [orders, setOrders] = useState([]);
    const [contracts, setContracts] = useState([]);
    const [filter, setFilter] = useState('All');
    const [selectedRepId, setSelectedRepId] = useState(isAdmin ? 'All' : 'Me');

    useEffect(() => {
        const salesId = (isAdmin && selectedRepId === 'All') ? null : (isAdmin ? selectedRepId : user.uid);
        let qO = collection(db, "orders");
        let qC = collection(db, "contracts");

        if (salesId) {
            qO = query(qO, where("salesRepId", "==", salesId));
            qC = query(qC, where("salesRepId", "==", salesId));
        } else {
            qO = query(qO, limit(100)); 
            qC = query(qC, limit(100));
        }

        const unsubO = onSnapshot(qO, (snap) => setOrders(snap.docs.map(d => ({id:d.id, type: 'Mission', ...d.data()}))));
        const unsubC = onSnapshot(qC, (snap) => setContracts(snap.docs.map(d => ({id:d.id, type: 'Contrat', ...d.data()}))));
        
        return () => { unsubO(); unsubC(); };
    }, [db, isAdmin, selectedRepId, user.uid]);

    const displayedItems = useMemo(() => {
        let items = [];
        if (filter === 'All' || filter === 'Missions') items = [...items, ...orders];
        if (filter === 'All' || filter === 'Contrats') items = [...items, ...contracts];
        return items.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
    }, [orders, contracts, filter]);

    const handleFix = (item) => {
        setCurrentOrder(item);
        setCurrentModule(item.type === 'Mission' ? 'generator' : 'contractGenerator');
    };

    const requestDelete = async (item) => {
        const reason = prompt("Pourquoi supprimer ?");
        if (reason) await updateDoc(doc(db, item.type === 'Mission' ? "orders" : "contracts", item.id), { status: 'RequestDelete', deleteReason: reason });
    };

    // --- LOGIQUE D'AFFICHAGE DES STATUTS ---
    const getStatusDesign = (item) => {
        const status = item.status;
        // Priorité : Si l'admin a marqué "Vu" (InReview ou flag adminRead), on affiche VU
        if ( (status === 'InReview' || item.adminRead) && status !== 'Envoyé' && status !== 'Signed' && status !== 'Declined' && status !== 'SentToClient' && status !== 'Reflection') {
            return { color: 'bg-indigo-100 text-indigo-700', label: '👀 VU PAR ADMIN', icon: 'eye' };
        }

        switch(status) {
            case 'Pending': case 'ToDraft': return { color: 'bg-slate-100 text-slate-500', label: 'En attente', icon: 'clock' };
            case 'Envoyé': case 'Drafted': return { color: 'bg-green-50 text-green-700', label: 'VALIDÉ & ENVOYÉ', icon: 'check' };
            case 'Signed': return { color: 'bg-green-100 text-green-800', label: 'SIGNÉ / PAYÉ', icon: 'dollar' };
            case 'SentToClient': return { color: 'bg-blue-50 text-blue-700', label: 'Envoyé au Client', icon: 'send' };
            case 'Reflection': return { color: 'bg-yellow-50 text-yellow-700', label: 'EN RÉFLEXION', icon: 'help-circle' };
            case 'Declined': return { color: 'bg-red-50 text-red-600', label: 'REFUSÉ', icon: 'x' };
            case 'RequestDelete': return { color: 'bg-red-100 text-red-800', label: 'Demande Suppr.', icon: 'trash' };
            default: return { color: 'bg-slate-50 text-slate-500', label: status, icon: 'info' };
        }
    };

    return React.createElement('div', { className: "max-w-6xl mx-auto space-y-8" },
        React.createElement('div', { className: "flex flex-col md:flex-row justify-between items-center gap-4" },
            React.createElement('div', null,
                React.createElement('h1', { className: "text-3xl font-black text-slate-900" }, "Mes Demandes"),
                React.createElement('p', { className: "text-slate-500 font-bold" }, "Suivi en temps réel.")
            ),
            React.createElement('div', { className: "flex bg-white p-1 rounded-full border shadow-sm" },
                ['All', 'Missions', 'Contrats'].map(f => 
                    React.createElement('button', { 
                        key: f, onClick: () => setFilter(f),
                        className: `px-6 py-2.5 rounded-full text-sm font-bold transition-all ${filter === f ? 'bg-slate-900 text-white shadow' : 'text-slate-500 hover:bg-slate-50'}`
                    }, f === 'All' ? 'Tout' : f)
                )
            )
        ),

        isAdmin && allSalesReps && React.createElement('div', { className: "bg-blue-50 p-4 rounded-xl border border-blue-100 flex items-center gap-3" },
            React.createElement(Icon, { name: "search", className: "text-blue-500" }),
            React.createElement('span', { className: "font-bold text-blue-800 text-sm" }, "Vue Admin :"),
            React.createElement('select', { value: selectedRepId, onChange: (e) => setSelectedRepId(e.target.value), className: "bg-white border p-2 rounded text-sm font-bold text-slate-700" },
                React.createElement('option', { value: "All" }, "Voir tout le monde"),
                allSalesReps.map(r => React.createElement('option', { key: r.id, value: r.id }, r.name))
            )
        ),

        displayedItems.length === 0 ? React.createElement('div', { className: "text-center py-20 bg-white rounded-[2rem] border border-dashed border-slate-200" }, React.createElement('p', { className: "text-slate-400 font-bold" }, "Aucune demande en cours.")) :
        React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-6" },
            displayedItems.map(item => {
                const statusInfo = getStatusDesign(item);
                // Récupération du nom du commercial pour l'Admin
                const repName = isAdmin && allSalesReps ? (allSalesReps.find(r => r.id === item.salesRepId)?.name || "Non identifié") : null;
                
                return React.createElement('div', { key: item.id, className: "bg-white rounded-[2rem] p-6 shadow-sm border border-slate-100 hover:shadow-lg transition duration-300 relative overflow-hidden group" },
                    React.createElement('div', { className: `absolute left-0 top-0 bottom-0 w-2 ${statusInfo.color.split(' ')[0].replace('bg-', 'bg-').replace('-50', '-400').replace('-100', '-500')}` }),
                    
                    React.createElement('div', { className: "pl-4" },
                        React.createElement('div', { className: "flex justify-between items-center mb-3" },
                            React.createElement('span', { className: "text-[10px] font-black uppercase tracking-widest text-slate-400" }, item.type + " • " + new Date(item.createdAt?.seconds * 1000).toLocaleDateString()),
                            React.createElement('div', { className: `flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-bold ${statusInfo.color}` },
                                React.createElement(Icon, { name: statusInfo.icon, size: 14 }),
                                statusInfo.label.toUpperCase()
                            )
                        ),

                        // --- AJOUT : Affichage du Commercial pour l'Admin ---
                        isAdmin && React.createElement('div', { className: "mb-2 flex items-center gap-1.5" },
                            React.createElement('div', { className: "bg-indigo-50 text-indigo-700 px-2 py-0.5 rounded text-[11px] font-bold flex items-center gap-1 uppercase tracking-wider" },
                                React.createElement(Icon, { name: "user", size: 10 }),
                                repName
                            )
                        ),
                        // ----------------------------------------------------

                        React.createElement('h3', { className: "text-xl font-black text-slate-900 mb-1" }, item.companyName || "Société Inconnue"),
                        React.createElement('p', { className: "text-sm text-slate-500 font-medium mb-4" }, `Réf: ${item.reference || 'N/A'}`),

                        (item.adminMessage || item.declinedReason || item.reflectionReason) && React.createElement('div', { className: `mb-4 p-4 rounded-xl text-sm font-medium ${item.status === 'Declined' ? 'bg-red-50 text-red-800' : item.status === 'Reflection' ? 'bg-yellow-50 text-yellow-800' : 'bg-green-50 text-green-800'}` },
                            React.createElement('p', { className: "font-bold mb-1 opacity-70 uppercase text-[10px]" }, item.status === 'Declined' ? "Raison du refus :" : item.status === 'Reflection' ? "Note de l'admin :" : "Message validation :"),
                            item.declinedReason || item.reflectionReason || item.adminMessage
                        ),

                        React.createElement('div', { className: "pt-4 border-t border-slate-50 flex justify-between items-center" },
                            React.createElement('div', { className: "flex gap-2" },
                                item.type === 'Mission' && (item.status === 'Envoyé' || item.status === 'Signed') &&
                                React.createElement('button', { onClick: () => generateOrderPDF(item, globalSettings), className: "p-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition", title: "Télécharger PDF" }, React.createElement(Icon, { name: "download", size: 18 })),
                                
                                (item.status === 'Declined' || item.status === 'Reflection') &&
                                React.createElement('button', { onClick: () => handleFix(item), className: "px-4 py-2 bg-slate-900 text-white rounded-lg text-xs font-bold hover:bg-slate-800 transition shadow-lg" }, "Modifier / Corriger")
                            ),
                            
                            item.status !== 'Signed' && item.status !== 'Envoyé' && item.status !== 'RequestDelete' &&
                            React.createElement('button', { onClick: () => requestDelete(item), className: "text-slate-300 hover:text-red-500 transition" }, React.createElement(Icon, { name: "trash", size: 18 }))
                        )
                    )
                );
            })
        )
    );
}
// --- MODULE PRISE DE NOTES (CORRIGÉ : TRANSFERT EMAIL & DATA) ---
function QuickNotesModule({ user, db, setCurrentModule, setCurrentOrder }) {
    const [leads, setLeads] = useState([]);
    const [loading, setLoading] = useState(true);
    const [form, setForm] = useState({ company: '', contact: '', email: '', phone: '', note: '' });

    // Charger les notes (Trié par date décroissante)
    useEffect(() => {
        const q = query(collection(db, "leads"), where("userId", "==", user.uid));
        
        const unsub = onSnapshot(q, (snap) => {
            const loadedLeads = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            // Tri côté client pour éviter les index Firebase manquants
            loadedLeads.sort((a, b) => {
                const dateA = a.createdAt?.seconds || 0;
                const dateB = b.createdAt?.seconds || 0;
                return dateB - dateA;
            });
            setLeads(loadedLeads);
            setLoading(false);
        });
        return () => unsub();
    }, [user.uid, db]);

    const handleSave = async (e) => {
        e.preventDefault();
        if (!form.company && !form.contact) return alert("Indiquez au moins un nom ou une société.");
        
        // Optimistic UI : Ajout immédiat pour la fluidité
        const tempLead = { ...form, id: 'temp', createdAt: { seconds: Date.now() / 1000 } };
        setLeads(prev => [tempLead, ...prev]);

        try {
            await addDoc(collection(db, "leads"), {
                ...form,
                userId: user.uid,
                createdAt: new Date()
            });
            setForm({ company: '', contact: '', email: '', phone: '', note: '' });
        } catch (err) { alert("Erreur sauvegarde : " + err.message); }
    };

    const handleDelete = async (id) => {
        if(confirm("Supprimer cette note ?")) await deleteDoc(doc(db, "leads", id));
    };

    // --- CORRECTION ICI : TRANSFERT COMPLET DES DONNÉES (EMAIL INCLUS) ---
    const toMission = (lead) => {
        setCurrentOrder({
            isDraftImport: true,
            companyName: lead.company,
            directorLastName: lead.contact,
            clientEmail: lead.email, // Transfert explicite de l'email
            email: lead.email,       // Double sécurité
            clientPhone: lead.phone,
            phone: lead.phone,
            reference: "Nouveau",
        });
        setCurrentModule('generator');
    };

    const toContract = (lead) => {
        setCurrentOrder({
            isDraftImport: true,
            companyName: lead.company,
            directorLastName: lead.contact,
            email: lead.email,       // Transfert explicite de l'email
            clientEmail: lead.email, // Double sécurité
            phone: lead.phone,
            clientPhone: lead.phone
        });
        setCurrentModule('contractGenerator');
    };

    return React.createElement('div', { className: "max-w-6xl mx-auto space-y-8" },
        React.createElement('div', { className: "flex items-center gap-3 mb-6" },
            React.createElement('div', { className: "p-3 bg-yellow-100 rounded-xl text-yellow-600" }, React.createElement(Icon, { name: "zap", size: 28 })),
            React.createElement('div', null,
                React.createElement('h2', { className: "text-2xl font-bold text-slate-800" }, "Prise de Notes Rapide"),
                React.createElement('p', { className: "text-slate-500 text-sm" }, "Saisissez vos prospects à la volée. Sauvegarde automatique.")
            )
        ),

        React.createElement('div', { className: "grid grid-cols-1 lg:grid-cols-3 gap-8" },
            
            // COLONNE GAUCHE : Formulaire
            React.createElement('div', { className: "lg:col-span-1" },
                React.createElement('form', { onSubmit: handleSave, className: "bg-white p-6 rounded-2xl shadow-lg border border-slate-100 sticky top-6" },
                    React.createElement('h3', { className: "font-bold text-slate-700 mb-4 flex items-center gap-2" }, 
                        React.createElement(Icon, { name: "edit", size: 18 }), "Nouveau Contact"
                    ),
                    React.createElement('div', { className: "space-y-4" },
                        React.createElement('div', null,
                            React.createElement('label', { className: "text-xs font-bold text-slate-400 uppercase ml-1" }, "Société / Pro"),
                            React.createElement('input', { className: "w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-3 font-bold text-slate-700 focus:ring-2 focus:ring-yellow-400 outline-none", placeholder: "Ex: Garage AD...", value: form.company, onChange: e => setForm({...form, company: e.target.value}) })
                        ),
                        React.createElement('div', null,
                            React.createElement('label', { className: "text-xs font-bold text-slate-400 uppercase ml-1" }, "Interlocuteur"),
                            React.createElement('input', { className: "w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-2 outline-none", placeholder: "Nom Prénom", value: form.contact, onChange: e => setForm({...form, contact: e.target.value}) })
                        ),
                        React.createElement('div', { className: "grid grid-cols-2 gap-2" },
                            React.createElement('input', { className: "w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none", placeholder: "Email", value: form.email, onChange: e => setForm({...form, email: e.target.value}) }),
                            React.createElement('input', { className: "w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none", placeholder: "Téléphone", value: form.phone, onChange: e => setForm({...form, phone: e.target.value}) })
                        ),
                        React.createElement('textarea', { className: "w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-3 text-sm outline-none resize-none h-24", placeholder: "Notes diverses (besoins, contexte...)", value: form.note, onChange: e => setForm({...form, note: e.target.value}) }),
                        
                        React.createElement('button', { type: "submit", className: "w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-3 rounded-xl shadow-lg transition flex items-center justify-center gap-2" },
                            React.createElement(Icon, { name: "save", size: 18 }), "Enregistrer la note"
                        )
                    )
                )
            ),

            // COLONNE DROITE : Liste
            React.createElement('div', { className: "lg:col-span-2 space-y-4" },
                loading ? React.createElement('div', { className: "text-center py-10" }, React.createElement('div', { className: "loader h-8 w-8 mx-auto border-4 border-slate-300 rounded-full" })) :
                leads.length === 0 ? React.createElement('div', { className: "text-center py-12 bg-white rounded-2xl border border-dashed border-slate-300" }, 
                    React.createElement(Icon, { name: "list", size: 40, className: "mx-auto text-slate-300 mb-2" }),
                    React.createElement('p', { className: "text-slate-400" }, "Aucune note pour le moment.")
                ) :
                leads.map(lead => 
                    React.createElement('div', { key: lead.id, className: "bg-white p-5 rounded-xl shadow-sm border border-slate-200 hover:shadow-md transition group relative" },
                        React.createElement('button', { onClick: () => handleDelete(lead.id), className: "absolute top-4 right-4 text-slate-300 hover:text-red-500 transition" }, React.createElement(Icon, { name: "trash", size: 16 })),
                        
                        React.createElement('div', { className: "flex flex-col md:flex-row md:items-center justify-between gap-4" },
                            React.createElement('div', { className: "flex-1" },
                                React.createElement('h4', { className: "font-bold text-lg text-slate-800" }, lead.company || "Société inconnue"),
                                React.createElement('div', { className: "flex flex-wrap gap-3 mt-1 text-sm text-slate-500" },
                                    lead.contact && React.createElement('span', { className: "flex items-center gap-1" }, React.createElement(Icon, { name: "users", size: 14 }), lead.contact),
                                    lead.phone && React.createElement('span', { className: "flex items-center gap-1 text-slate-800 font-mono bg-slate-100 px-1 rounded" }, React.createElement(Icon, { name: "phone", size: 14 }), lead.phone),
                                    lead.email && React.createElement('span', { className: "flex items-center gap-1 text-blue-600" }, React.createElement(Icon, { name: "mail", size: 14 }), lead.email)
                                ),
                                lead.note && React.createElement('p', { className: "mt-3 text-sm text-slate-600 bg-yellow-50 p-2 rounded border border-yellow-100 italic" }, `"${lead.note}"`)
                            ),
                            
                            React.createElement('div', { className: "flex flex-row md:flex-col gap-2 shrink-0 border-t md:border-t-0 md:border-l border-slate-100 pt-4 md:pt-0 md:pl-4" },
                                React.createElement('button', { onClick: () => toMission(lead), className: "flex-1 md:w-40 bg-blue-50 hover:bg-blue-100 text-blue-700 px-3 py-2 rounded-lg text-xs font-bold transition flex items-center justify-center gap-2" },
                                    React.createElement(Icon, { name: "zap", size: 14 }), "Créer Mission"
                                ),
                                React.createElement('button', { onClick: () => toContract(lead), className: "flex-1 md:w-40 bg-indigo-50 hover:bg-indigo-100 text-indigo-700 px-3 py-2 rounded-lg text-xs font-bold transition flex items-center justify-center gap-2" },
                                    React.createElement(Icon, { name: "briefcase", size: 14 }), "Créer Contrat"
                                )
                            )
                        )
                    )
                )
            )
        )
    );
}
   // --- MODULE CONTRAT COLLABORATION (CORRIGÉ : SCROLL MOBILE + BOUTON VISIBLE) ---
function ContractGeneratorModule({ user, userData, db, currentOrder }) {
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState('');
    const [success, setSuccess] = useState(false);
    
    // État initial du formulaire
    const initialFormState = {
        companyName: '', siren: '', address: '',
        directorCivility: 'M.', directorFirstName: '', directorLastName: '',
        email: '', phone: '',
        radius: '', minYear: '', maxKm: '', excludedVehicles: '', targetAppointments: ''
    };

    const [form, setForm] = useState(initialFormState);

    // --- EFFET : CHARGEMENT DES DONNÉES SI MODIFICATION ---
    useEffect(() => {
        if (currentOrder) {
            setForm({
                companyName: currentOrder.companyName || '',
                siren: currentOrder.siren || '',
                address: currentOrder.address || '',
                directorCivility: currentOrder.directorCivility || 'M.',
                directorFirstName: currentOrder.directorFirstName || '',
                directorLastName: currentOrder.directorLastName || '',
                email: currentOrder.email || currentOrder.clientEmail || '',
                phone: currentOrder.phone || currentOrder.clientPhone || '',
                radius: currentOrder.radius || '',
                minYear: currentOrder.minYear || '',
                maxKm: currentOrder.maxKm || '',
                excludedVehicles: currentOrder.excludedVehicles || '',
                targetAppointments: currentOrder.targetAppointments || ''
            });
        } else {
            setForm(initialFormState);
        }
    }, [currentOrder]);

    const searchSiren = async () => {
        if (form.siren.length < 9) return alert("Numéro SIREN incomplet");
        setLoading(true); setError('');
        try {
            const response = await fetch(`https://recherche-entreprises.api.gouv.fr/search?q=${form.siren}`);
            const data = await response.json();
            if (data.results && data.results.length > 0) {
                const company = data.results[0];
                setForm(prev => ({
                    ...prev,
                    companyName: company.nom_complet,
                    address: company.siege.adresse,
                }));
            } else setError("Aucune entreprise trouvée.");
        } catch (error) { setError("Erreur API."); }
        setLoading(false);
    };

    const handleSubmit = async () => {
        if(!form.companyName || !form.email || !form.phone || !form.targetAppointments) {
            return setError("Remplissez les champs obligatoires (*).");
        }
        
        setLoading(true);
        try {
            const contractData = {
                ...form,
                salesRepId: user.uid,
                salesRepName: userData?.name || user.email,
                status: 'ToDraft',
                updatedAt: new Date(),
                declinedReason: null,
                reflectionReason: null,
                readBySalesRep: false 
            };

            if (currentOrder && currentOrder.id && !currentOrder.isDraftImport) {
                await updateDoc(doc(db, "contracts", currentOrder.id), contractData);
                setSuccess("Dossier mis à jour et renvoyé à l'admin !");
            } else {
                await addDoc(collection(db, "contracts"), {
                    ...contractData,
                    createdAt: new Date()
                });
                setSuccess("Demande de contrat envoyée !");
            }

            setForm(initialFormState);
            setTimeout(() => setSuccess(false), 4000);
        } catch(e) { setError("Erreur : " + e.message); }
        setLoading(false);
    };

    const MiniInput = ({ label, placeholder, value, name, type="text", colSpan="col-span-1" }) => (
        React.createElement('div', { className: colSpan },
            React.createElement('label', { className: "block text-[10px] font-bold text-slate-500 uppercase mb-1 truncate" }, label),
            React.createElement('input', { 
                type: type, 
                placeholder: placeholder, 
                value: value, 
                onChange: (e) => setForm({...form, [name]: e.target.value}), 
                className: "w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-medium focus:bg-white focus:border-purple-500 outline-none transition-colors h-9" 
            })
        )
    );

    // MODIFICATION ICI : pb-40 pour le mobile, lg:pb-0 pour le PC
    return React.createElement('div', { className: "max-w-6xl mx-auto w-full flex flex-col pb-40 lg:pb-0 lg:h-full lg:overflow-hidden" },
        
        // Header Compact
        React.createElement('div', { className: "mb-4 flex justify-between items-center shrink-0" },
            React.createElement('div', { className: "flex items-center gap-3" },
                React.createElement('div', { className: "bg-purple-600 text-white p-2 rounded-lg shadow-md" }, React.createElement(Icon, { name: "briefcase", size: 20 })),
                React.createElement('div', null,
                    React.createElement('h2', { className: "text-2xl font-bold text-slate-800" }, currentOrder?.id ? "Modifier le Contrat" : "Nouveau Contrat"),
                    currentOrder?.id && React.createElement('p', { className: "text-xs text-orange-600 font-bold" }, "Mode Correction : Les modifications seront renvoyées à l'admin.")
                )
            ),
            (success || error) && React.createElement('div', { className: `px-4 py-2 rounded-lg text-sm font-bold ${typeof success === 'string' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'} animate-in fade-in` }, 
                typeof success === 'string' ? `✅ ${success}` : error
            )
        ),

        // Container Global (Grid 3 colonnes) - MODIFIÉ POUR SCROLL
        React.createElement('div', { className: "bg-white p-5 rounded-2xl shadow-sm border border-slate-200 grid grid-cols-1 lg:grid-cols-3 gap-6 items-start lg:flex-1 lg:overflow-hidden" },
            
            // COLONNE 1 : ENTREPRISE
            React.createElement('div', { className: "space-y-3 lg:overflow-y-auto lg:h-full lg:pr-2" },
                React.createElement('h3', { className: "text-sm font-bold text-purple-700 uppercase tracking-wider border-b border-slate-100 pb-2 mb-2" }, "1. Entreprise"),
                
                React.createElement('div', { className: "flex gap-2 items-end" },
                    React.createElement('div', { className: "flex-1" },
                        React.createElement('label', { className: "block text-[10px] font-bold text-slate-500 uppercase mb-1" }, "SIREN"),
                        React.createElement('input', { className: "w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm h-9 font-mono", placeholder: "9 chiffres", value: form.siren, onChange: e => setForm({...form, siren: e.target.value}) })
                    ),
                    React.createElement('button', { 
                        onClick: searchSiren, 
                        disabled: loading, 
                        className: "bg-slate-800 text-white px-4 h-9 rounded-lg text-xs font-bold hover:bg-slate-700 transition whitespace-nowrap" 
                    }, "Rechercher")
                ),
                
                MiniInput({ label: "Nom Société *", name: "companyName", value: form.companyName, placeholder: "Nom commercial" }),
                
                React.createElement('div', null,
                    React.createElement('label', { className: "block text-[10px] font-bold text-slate-500 uppercase mb-1" }, "Adresse Complète"),
                    React.createElement('textarea', { 
                        rows: 2, 
                        value: form.address, 
                        onChange: e => setForm({...form, address: e.target.value}), 
                        className: "w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm resize-none focus:bg-white focus:border-purple-500 outline-none" 
                    })
                )
            ),

            // COLONNE 2 : CONTACT
            React.createElement('div', { className: "space-y-3 lg:border-l lg:border-slate-100 lg:pl-6 lg:overflow-y-auto lg:h-full lg:pr-2" },
                React.createElement('h3', { className: "text-sm font-bold text-purple-700 uppercase tracking-wider border-b border-slate-100 pb-2 mb-2" }, "2. Signataire"),
                
                React.createElement('div', { className: "flex gap-2" },
                    React.createElement('div', { className: "w-20" },
                        React.createElement('label', { className: "block text-[10px] font-bold text-slate-500 uppercase mb-1" }, "Civilité"),
                        React.createElement('select', { value: form.directorCivility, onChange: e => setForm({...form, directorCivility: e.target.value}), className: "w-full bg-slate-50 border border-slate-200 rounded-lg px-1 py-2 text-sm h-9" },
                            React.createElement('option', { value: "M." }, "M."),
                            React.createElement('option', { value: "Mme" }, "Mme")
                        )
                    ),
                    React.createElement('div', { className: "flex-1" },
                        MiniInput({ label: "Nom *", name: "directorLastName", value: form.directorLastName, placeholder: "Nom" })
                    )
                ),
                MiniInput({ label: "Prénom", name: "directorFirstName", value: form.directorFirstName, placeholder: "Prénom" }),
                
                React.createElement('div', { className: "grid grid-cols-2 gap-2" },
                    MiniInput({ label: "Email *", name: "email", value: form.email, type: "email", placeholder: "@" }),
                    MiniInput({ label: "Téléphone *", name: "phone", value: form.phone, type: "tel", placeholder: "06.." })
                )
            ),

            // COLONNE 3 : CRITÈRES
            React.createElement('div', { className: "space-y-3 lg:border-l lg:border-slate-100 lg:pl-6 flex flex-col lg:h-full" },
                React.createElement('div', { className: "lg:flex-1 lg:overflow-y-auto lg:pr-2 space-y-3" },
                    React.createElement('h3', { className: "text-sm font-bold text-purple-700 uppercase tracking-wider border-b border-slate-100 pb-2 mb-2" }, "3. Critères & Objectifs"),
                    
                    React.createElement('div', { className: "grid grid-cols-2 gap-2" },
                        MiniInput({ label: "Objectif RDV *", name: "targetAppointments", value: form.targetAppointments, type: "number", placeholder: "Ex: 20" }),
                        MiniInput({ label: "Rayon (km) *", name: "radius", value: form.radius, type: "number", placeholder: "Ex: 30" })
                    ),
                    
                    React.createElement('div', { className: "grid grid-cols-2 gap-2" },
                        MiniInput({ label: "Année Min *", name: "minYear", value: form.minYear, type: "number", placeholder: "2012" }),
                        MiniInput({ label: "Kilométrage max *", name: "maxKm", value: form.maxKm, type: "number", placeholder: "150000" })
                    ),

                    MiniInput({ label: "Véhicules Exclus", name: "excludedVehicles", value: form.excludedVehicles, placeholder: "Optionnel" })
                ),

                React.createElement('div', { className: "mt-auto pt-4 shrink-0" },
                    React.createElement('button', { 
                        onClick: handleSubmit, 
                        disabled: loading, 
                        className: `w-full py-3 rounded-xl font-bold text-white shadow-lg transition-all flex items-center justify-center gap-2 ${loading ? 'bg-slate-400' : 'bg-gradient-to-r from-purple-600 to-indigo-600 hover:scale-[1.02]'}` 
                    }, 
                        loading ? "..." : React.createElement(React.Fragment, null, currentOrder?.id ? "RENVOYER À L'ADMIN" : "ENVOYER LA DEMANDE", React.createElement(Icon, { name: "send", size: 16 }))
                    )
                )
            )
        )
    );
}
// --- MODULE GENERATEUR (OPTIMISÉ : ECRAN UNIQUE SUR PC) ---
function FormPanel({ user, userData, globalSettings, db, isAdmin, setCurrentModule, currentOrder, setCurrentOrder, setShowSuccessModal }) {
    const [step, setStep] = useState(1);
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState('');
    const [isSiretPending, setIsSiretPending] = useState(false);
    
    // États pour l'adresse (API Gouv)
    const [addressSuggestions, setAddressSuggestions] = useState([]);
    const [showSuggestions, setShowSuggestions] = useState(false);
    
    const [editingSection, setEditingSection] = useState(null); 

    const getToday = () => new Date().toISOString().split('T')[0];

    const initialForm = {
        siret: '', companyName: '', address: '', 
        directorCivility: 'M.', directorFirstName: '', directorLastName: '', 
        clientEmail: '', clientPhone: '',
        targetAppointments: '', salesRepsCount: 1, 
        startDate: getToday(), endDate: '',
        radiusKm: '', minVehicleYear: '', maxKmPerVehicle: '', excludedVehicles: ''
    };

    const [form, setForm] = useState(initialForm);

    useEffect(() => {
        if (currentOrder) {
            setForm({ ...initialForm, ...currentOrder, 
                siret: currentOrder.siren === 'EN COURS' ? '' : currentOrder.siren || '',
                startDate: currentOrder.startDate || getToday()
            });
            setIsSiretPending(currentOrder.siren === 'EN COURS');
        }
    }, [currentOrder]);

    // Calcul Auto Date Fin
    useEffect(() => {
        if (form.startDate && (!isAdmin || !form.endDate)) {
            const date = new Date(form.startDate);
            date.setDate(date.getDate() + 7);
            setForm(prev => ({ ...prev, endDate: date.toISOString().split('T')[0] }));
        }
    }, [form.startDate, isAdmin]);

    // --- MOTEUR RECHERCHE ADRESSE (API GOUV) ---
    const handleAddressInput = async (e) => {
        const val = e.target.value;
        setForm(prev => ({ ...prev, address: val }));
        
        if (val.length > 3) {
            try {
                const res = await fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(val)}&limit=5`);
                const data = await res.json();
                if (data.features) {
                    setAddressSuggestions(data.features);
                    setShowSuggestions(true);
                }
            } catch (err) {
                console.log("Erreur adresse", err);
            }
        } else {
            setShowSuggestions(false);
        }
    };

    const selectAddress = (feature) => {
        setForm(prev => ({ ...prev, address: feature.properties.label }));
        setShowSuggestions(false);
    };

    // Formatage téléphone
    const handlePhoneChange = (e) => {
        const raw = e.target.value.replace(/[^\d]/g, '');
        let formatted = '';
        for (let i = 0; i < raw.length; i++) {
            if (i > 0 && i % 2 === 0) formatted += ' ';
            formatted += raw[i];
        }
        setForm(prev => ({ ...prev, clientPhone: formatted.substring(0, 14) }));
    };

    const fetchCompanyData = async () => {
        if (form.siret.length < 9) return setError("SIRET invalide.");
        setLoading(true); setError(null);
        try {
            const res = await fetch(`https://recherche-entreprises.api.gouv.fr/search?q=${form.siret}&page=1&per_page=1`);
            const data = await res.json();
            if (data.results?.[0]) {
                const r = data.results[0];
                const d = r.dirigeants?.[0];
                setForm(prev => ({
                    ...prev,
                    companyName: r.nom_complet, address: r.siege?.adresse, siret: r.siren,
                    directorFirstName: d ? d.prenoms.split(' ')[0] : prev.directorFirstName,
                    directorLastName: d ? d.nom : prev.directorLastName,
                    directorCivility: d ? (d.sexe === 'M' ? 'M.' : 'Mme') : prev.directorCivility
                }));
            } else setError("Aucune entreprise trouvée.");
        } catch (e) { setError("Erreur API."); }
        setLoading(false);
    };

    const handleVerify = () => {
        setError(null);
        if (!form.companyName) return setError("Nom société requis.");
        if (!form.clientEmail) return setError("Email requis.");
        if (!form.targetAppointments) return setError("Plafond RDV requis.");
        setStep(2);
        // Pas de scroll auto sur desktop, uniquement mobile
        if(window.innerWidth < 1024) window.scrollTo(0,0);
    };

    const handleFinalSubmit = async () => {
        setLoading(true);
        try {
            let refString = currentOrder?.reference;
            if (!refString) {
                const settingsSnap = await getDoc(doc(db, "settings", "global"));
                let currentSeq = settingsSnap.exists() ? settingsSnap.data().sequenceNumber || 367 : 367;
                const datePrefix = new Date().getFullYear() + "" + (new Date().getMonth() + 1).toString().padStart(2, '0');
                refString = `MISS-${datePrefix}-${currentSeq.toString().padStart(4, '0')}`;
                await updateDoc(doc(db, "settings", "global"), { sequenceNumber: currentSeq + 1 });
            }
            const finalData = {
                ...form, siren: isSiretPending ? "EN COURS" : form.siret, reference: refString,
                salesRepId: user.uid, salesRepName: userData.name, salesRepEmail: user.email,
                status: currentOrder?.id ? currentOrder.status : 'Pending', createdAt: new Date(), updatedAt: new Date(),
                ratePerAppointment: globalSettings.defaultRate || 50, maxRdvTotal: parseInt(form.targetAppointments),
                clientPhone: form.clientPhone.replace(/\s/g, '')
            };
            let orderId = currentOrder?.id;
            if (orderId) await updateDoc(doc(db, "orders", orderId), finalData);
            else { const docRef = await addDoc(collection(db, "orders"), finalData); orderId = docRef.id; }
            generateOrderPDF({ ...finalData, id: orderId }, globalSettings);
            setShowSuccessModal({ reference: refString, isEditing: !!currentOrder?.id });
            setForm(initialForm); setStep(1); setCurrentOrder(null);
        } catch (e) { setError("Erreur: " + e.message); }
        setLoading(false);
    };

    // --- VUE 1 : FORMULAIRE (OPTIMISÉ DESKTOP ONE-PAGE) ---
    if (step === 1) {
        return React.createElement('div', { className: "w-full max-w-7xl mx-auto p-4 md:p-8 lg:h-full lg:flex lg:flex-col lg:overflow-hidden" }, // Modif ici pour hauteur max
            // Header
            React.createElement('div', { className: "flex justify-between items-center mb-4 lg:mb-2 shrink-0" },
                React.createElement('div', null,
                    React.createElement('h1', { className: "text-2xl md:text-3xl font-black text-slate-900" }, currentOrder ? "Modifier" : "Nouvelle Mission"),
                    React.createElement('p', { className: "text-slate-500 font-bold text-sm" }, "Saisie des informations.")
                ),
                React.createElement('button', { onClick: () => setCurrentModule('myOrders'), className: "bg-slate-200 hover:bg-slate-300 text-slate-700 px-4 py-2 rounded-xl font-bold transition text-sm" }, "Retour")
            ),
            error && React.createElement('div', { className: "bg-red-50 text-red-600 p-3 rounded-xl font-bold mb-4 border border-red-200 flex items-center gap-2 shrink-0" }, React.createElement(Icon, { name: "x" }), error),
            
            // Main Card (Scrollable inside only if needed on desktop)
            React.createElement('div', { className: "bg-white p-5 md:p-8 rounded-[2rem] shadow-xl shadow-slate-200/50 border border-slate-100 flex-1 flex flex-col lg:overflow-hidden" },
                
                // Conteneur scrollable interne (pour petits écrans laptop)
                React.createElement('div', { className: "lg:flex-1 lg:overflow-y-auto lg:pr-2" },
                    
                    // BLOC SIRET (Compacté pour Desktop)
                    React.createElement('div', { className: "mb-6 lg:mb-4 bg-slate-50 p-4 lg:py-2 rounded-2xl border border-slate-200" },
                        React.createElement('div', { className: "flex flex-col lg:flex-row lg:items-center gap-3" },
                            React.createElement('label', { className: "block text-xs font-black text-slate-400 uppercase whitespace-nowrap lg:mt-1" }, "Recherche :"),
                            React.createElement('input', { 
                                value: form.siret, 
                                onChange: e => setForm({...form, siret: e.target.value}), 
                                placeholder: "Numéro SIRET...", 
                                className: "w-full lg:w-48 bg-white border-2 border-slate-200 rounded-xl px-3 py-2 lg:py-1.5 font-bold outline-none focus:border-blue-500 transition text-sm" 
                            }),
                            React.createElement('button', { 
                                onClick: fetchCompanyData, 
                                disabled: loading, 
                                className: "w-full lg:w-auto bg-blue-600 text-white px-4 py-2 lg:py-1.5 rounded-xl font-bold shadow-sm hover:bg-blue-700 transition text-sm" 
                            }, loading ? "..." : "Trouver"),
                            React.createElement('div', { className: "hidden lg:block w-px h-6 bg-slate-300 mx-2" }), // Séparateur
                            React.createElement('label', { className: "flex items-center gap-2 cursor-pointer" },
                                React.createElement('input', { type: "checkbox", checked: isSiretPending, onChange: e => setIsSiretPending(e.target.checked), className: "w-4 h-4 text-blue-600 rounded" }),
                                React.createElement('span', { className: "font-bold text-slate-600 text-xs" }, "SIRET en cours")
                            )
                        )
                    ),

                    // GRID PRINCIPALE (Client Gauche / Mission Droite)
                    React.createElement('div', { className: "grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12" },
                        
                        // COLONNE GAUCHE : CLIENT
                        React.createElement('div', { className: "space-y-4 lg:space-y-3" },
                            React.createElement('h3', { className: "text-lg font-black text-slate-800 flex items-center gap-2 border-b border-slate-100 pb-2" }, React.createElement(Icon, { name: "user", className: "text-blue-500" }), "CLIENT"),
                            React.createElement('div', null,
                                React.createElement('label', { className: "block text-[10px] font-bold text-slate-400 mb-1 ml-1" }, "Nom Société *"),
                                React.createElement('input', { value: form.companyName, onChange: e => setForm({...form, companyName: e.target.value}), className: "w-full bg-slate-50 border border-slate-200 rounded-xl p-3 lg:p-2 font-bold text-slate-800 outline-none focus:bg-white focus:ring-2 ring-slate-900 transition" })
                            ),
                            React.createElement('div', { className: "grid grid-cols-3 gap-3 lg:gap-2" },
                                React.createElement('div', null,
                                    React.createElement('label', { className: "block text-[10px] font-bold text-slate-400 mb-1 ml-1" }, "Civilité"),
                                    React.createElement('select', { value: form.directorCivility, onChange: e => setForm({...form, directorCivility: e.target.value}), className: "w-full bg-slate-50 border border-slate-200 rounded-xl p-3 lg:p-2 font-bold outline-none" }, React.createElement('option', { value: "M." }, "M."), React.createElement('option', { value: "Mme" }, "Mme"))
                                ),
                                React.createElement('div', { className: "col-span-2" },
                                    React.createElement('label', { className: "block text-[10px] font-bold text-slate-400 mb-1 ml-1" }, "Prénom & Nom *"),
                                    React.createElement('div', { className: "flex gap-2" },
                                        React.createElement('input', { placeholder: "Prénom", value: form.directorFirstName, onChange: e => setForm({...form, directorFirstName: e.target.value}), className: "w-full bg-slate-50 border border-slate-200 rounded-xl p-3 lg:p-2 font-bold outline-none" }),
                                        React.createElement('input', { placeholder: "Nom", value: form.directorLastName, onChange: e => setForm({...form, directorLastName: e.target.value}), className: "w-full bg-slate-50 border border-slate-200 rounded-xl p-3 lg:p-2 font-bold outline-none" })
                                    )
                                )
                            ),
                            React.createElement('div', { className: "grid grid-cols-1 sm:grid-cols-2 gap-3 lg:gap-2" },
                                React.createElement('div', null, React.createElement('label', { className: "block text-[10px] font-bold text-slate-400 mb-1 ml-1" }, "Email *"), React.createElement('input', { type: "email", value: form.clientEmail, onChange: e => setForm({...form, clientEmail: e.target.value}), className: "w-full bg-slate-50 border border-slate-200 rounded-xl p-3 lg:p-2 font-bold outline-none" })),
                                React.createElement('div', null, React.createElement('label', { className: "block text-[10px] font-bold text-slate-400 mb-1 ml-1" }, "Téléphone *"), React.createElement('input', { value: form.clientPhone, onChange: handlePhoneChange, className: "w-full bg-slate-50 border border-slate-200 rounded-xl p-3 lg:p-2 font-bold outline-none" }))
                            ),
                            
                            // INPUT ADRESSE
                            React.createElement('div', { className: "relative" },
                                React.createElement('label', { className: "block text-[10px] font-bold text-slate-400 mb-1 ml-1" }, "Adresse Complète *"),
                                React.createElement('input', { 
                                    value: form.address, 
                                    onChange: handleAddressInput, 
                                    onFocus: () => form.address.length > 3 && setShowSuggestions(true),
                                    onBlur: () => setTimeout(() => setShowSuggestions(false), 200),
                                    placeholder: "Tapez l'adresse...",
                                    className: "w-full bg-slate-50 border border-slate-200 rounded-xl p-3 lg:p-2 font-bold text-slate-600 outline-none focus:bg-white focus:border-blue-400 transition" 
                                }),
                                showSuggestions && addressSuggestions.length > 0 && React.createElement('ul', { className: "absolute z-50 left-0 right-0 mt-1 bg-white border border-slate-200 rounded-xl shadow-xl max-h-60 overflow-y-auto" },
                                    addressSuggestions.map((feature, i) => 
                                        React.createElement('li', { 
                                            key: i, 
                                            onClick: () => selectAddress(feature),
                                            className: "px-4 py-3 hover:bg-blue-50 cursor-pointer text-sm font-medium text-slate-700 border-b border-slate-50 last:border-0" 
                                        }, feature.properties.label)
                                    )
                                )
                            )
                        ),

                        // COLONNE DROITE : MISSION
                        React.createElement('div', { className: "space-y-4 lg:space-y-3" },
                            React.createElement('h3', { className: "text-lg font-black text-slate-800 flex items-center gap-2 border-b border-slate-100 pb-2" }, React.createElement(Icon, { name: "target", className: "text-red-500" }), "MISSION"),
                            React.createElement('div', { className: "grid grid-cols-2 gap-4 lg:gap-2" },
                                React.createElement('div', null, React.createElement('label', { className: "block text-[10px] font-bold text-slate-400 mb-1 ml-1" }, "Début"), React.createElement('input', { type: "date", value: form.startDate, onChange: e => setForm({...form, startDate: e.target.value}), className: "w-full bg-white border-2 border-blue-100 rounded-xl p-3 lg:p-2 font-bold text-slate-800 outline-none focus:border-blue-500" })),
                                React.createElement('div', null, React.createElement('label', { className: "block text-[10px] font-bold text-slate-400 mb-1 ml-1" }, "Fin"), React.createElement('input', { type: "date", value: form.endDate, disabled: !isAdmin, className: "w-full bg-slate-100 border border-slate-200 rounded-xl p-3 lg:p-2 font-bold text-slate-500 outline-none" }))
                            ),
                            React.createElement('div', { className: "grid grid-cols-2 gap-4 lg:gap-2" },
                                React.createElement('div', null, React.createElement('label', { className: "block text-[10px] font-bold text-slate-400 mb-1 ml-1" }, "Plafond RDV"), React.createElement('input', { type: "number", placeholder:"ex: 20", value: form.targetAppointments, onChange: e => setForm({...form, targetAppointments: e.target.value}), className: "w-full bg-slate-50 border border-slate-200 rounded-xl p-3 lg:p-2 font-bold text-center text-lg outline-none" })),
                                React.createElement('div', null, React.createElement('label', { className: "block text-[10px] font-bold text-slate-400 mb-1 ml-1" }, "Rayon (km)"), React.createElement('input', { type: "number", placeholder:"ex: 30", value: form.radiusKm, onChange: e => setForm({...form, radiusKm: e.target.value}), className: "w-full bg-slate-50 border border-slate-200 rounded-xl p-3 lg:p-2 font-bold text-center text-lg outline-none" }))
                            ),
                            React.createElement('div', { className: "pt-4 lg:pt-2 border-t border-slate-100" },
                                React.createElement('label', { className: "block text-xs font-black text-slate-400 uppercase mb-3 lg:mb-2" }, "Critères"),
                                React.createElement('div', { className: "grid grid-cols-2 gap-4 lg:gap-2 mb-3 lg:mb-2" },
                                    React.createElement('div', null, React.createElement('label', { className: "block text-[10px] font-bold text-slate-400 mb-1" }, "Année Min"), React.createElement('input', { type: "number", placeholder:"ex: 2012", value: form.minVehicleYear, onChange: e => setForm({...form, minVehicleYear: e.target.value}), className: "w-full bg-slate-50 border border-slate-200 rounded-xl p-3 lg:p-2 font-bold outline-none" })),
                                    React.createElement('div', null, React.createElement('label', { className: "block text-[10px] font-bold text-slate-400 mb-1" }, "Km Max"), React.createElement('input', { type: "number", placeholder:"ex: 150000", value: form.maxKmPerVehicle, onChange: e => setForm({...form, maxKmPerVehicle: e.target.value}), className: "w-full bg-slate-50 border border-slate-200 rounded-xl p-3 lg:p-2 font-bold outline-none" }))
                                ),
                                React.createElement('input', { placeholder: "Véhicules Exclus (Optionnel)...", value: form.excludedVehicles, onChange: e => setForm({...form, excludedVehicles: e.target.value}), className: "w-full bg-slate-50 border border-slate-200 rounded-xl p-3 lg:p-2 font-bold text-sm outline-none" })
                            )
                        )
                    )
                ),

                // FOOTER BUTTON (Fixe en bas du conteneur parent sur desktop)
                React.createElement('div', { className: "mt-6 lg:mt-4 pt-4 lg:pt-2 border-t border-slate-100 shrink-0" },
                    React.createElement('button', { onClick: handleVerify, className: "w-full py-4 lg:py-3 bg-slate-900 hover:bg-black text-white rounded-2xl shadow-xl font-bold text-lg flex items-center justify-center gap-3 transition-transform hover:-translate-y-1" }, "VÉRIFIER AVANT ENVOI", React.createElement(Icon, { name: "check", size: 20 }))
                )
            )
        );
    }

    // VUE 2 : RÉCAPITULATIF (BOUTON EDIT CORRIGÉ & EDITION INLINE)
    if (step === 2) {
        return React.createElement('div', { className: "w-full max-w-3xl mx-auto p-4 md:p-12" },
            React.createElement('div', { className: "text-center mb-10" },
                React.createElement('h2', { className: "text-3xl font-light text-slate-900 tracking-wide mb-2" }, "Récapitulatif"),
                React.createElement('p', { className: "text-sm font-medium text-slate-400 uppercase tracking-widest" }, "Vérifiez et validez")
            ),
            React.createElement('div', { className: "bg-white rounded-3xl shadow-2xl shadow-slate-200/60 overflow-hidden border border-slate-100" },
                // Bloc Client
                React.createElement('div', { className: "p-8 border-b border-slate-100 relative group" },
                    // CORRECTION ICI : "edit" au lieu de "edit-2" et couleur plus foncée "bg-slate-100 text-slate-600"
                    React.createElement('button', { 
                        onClick: () => setEditingSection(editingSection === 'client' ? null : 'client'), 
                        className: `absolute top-8 right-8 transition p-2 rounded-full ${editingSection === 'client' ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-600 hover:text-blue-600'}` 
                    }, React.createElement(Icon, { name: editingSection === 'client' ? "check" : "edit", size: 18 })),
                    
                    React.createElement('h3', { className: "text-xs font-black text-slate-300 uppercase tracking-wider mb-4" }, "Client & Contact"),
                    editingSection === 'client' ? (
                        React.createElement('div', { className: "space-y-3 animate-in fade-in" },
                            React.createElement('input', { value: form.companyName, onChange: e => setForm({...form, companyName: e.target.value}), className: "w-full border p-2 rounded font-bold text-lg", placeholder: "Société" }),
                            React.createElement('div', { className: "flex gap-2" },
                                React.createElement('select', { value: form.directorCivility, onChange: e => setForm({...form, directorCivility: e.target.value}), className: "border p-2 rounded" }, React.createElement('option', {value:"M."}, "M."), React.createElement('option', {value:"Mme"}, "Mme")),
                                React.createElement('input', { value: form.directorFirstName, onChange: e => setForm({...form, directorFirstName: e.target.value}), className: "border p-2 rounded flex-1", placeholder: "Prénom" }),
                                React.createElement('input', { value: form.directorLastName, onChange: e => setForm({...form, directorLastName: e.target.value}), className: "border p-2 rounded flex-1", placeholder: "Nom" })
                            ),
                            React.createElement('input', { value: form.clientEmail, onChange: e => setForm({...form, clientEmail: e.target.value}), className: "w-full border p-2 rounded", placeholder: "Email" }),
                            React.createElement('input', { value: form.clientPhone, onChange: handlePhoneChange, className: "w-full border p-2 rounded", placeholder: "Téléphone" }),
                            React.createElement('input', { value: form.address, onChange: handleAddressInput, className: "w-full border p-2 rounded", placeholder: "Adresse" }),
                            React.createElement('button', { onClick: () => setEditingSection(null), className: "w-full bg-green-600 text-white font-bold py-2 rounded mt-2" }, "Valider les modifications")
                        )
                    ) : (
                        React.createElement('div', { className: "space-y-1" },
                            React.createElement('p', { className: "text-2xl font-serif text-slate-900" }, form.companyName),
                            React.createElement('p', { className: "text-slate-600 font-medium" }, `${form.directorCivility} ${form.directorFirstName} ${form.directorLastName}`),
                            React.createElement('div', { className: "flex flex-col gap-1 mt-3 text-sm text-slate-500" },
                                React.createElement('span', { className: "flex items-center gap-2" }, React.createElement(Icon, { name: "mail", size: 14 }), form.clientEmail),
                                React.createElement('span', { className: "flex items-center gap-2" }, React.createElement(Icon, { name: "phone", size: 14 }), form.clientPhone),
                                React.createElement('span', { className: "flex items-center gap-2" }, React.createElement(Icon, { name: "mapPin", size: 14 }), form.address)
                            )
                        )
                    )
                ),
                // Bloc Mission
                React.createElement('div', { className: "p-8 border-b border-slate-100 relative group bg-slate-50/30" },
                    // CORRECTION ICI : "edit" et couleur
                    React.createElement('button', { 
                        onClick: () => setEditingSection(editingSection === 'mission' ? null : 'mission'), 
                        className: `absolute top-8 right-8 transition p-2 rounded-full ${editingSection === 'mission' ? 'bg-green-100 text-green-700' : 'bg-white text-slate-600 hover:text-blue-600 shadow-sm'}` 
                    }, React.createElement(Icon, { name: editingSection === 'mission' ? "check" : "edit", size: 18 })),
                    
                    React.createElement('h3', { className: "text-xs font-black text-slate-300 uppercase tracking-wider mb-4" }, "Paramètres Mission"),
                    editingSection === 'mission' ? (
                        React.createElement('div', { className: "grid grid-cols-2 gap-4 animate-in fade-in" },
                            React.createElement('div', null, React.createElement('label', {className:"text-[10px] font-bold"}, "Début"), React.createElement('input', { type: "date", value: form.startDate, onChange: e => setForm({...form, startDate: e.target.value}), className: "w-full border p-2 rounded bg-white" })),
                            React.createElement('div', null, React.createElement('label', {className:"text-[10px] font-bold"}, "Fin"), React.createElement('input', { type: "date", value: form.endDate, disabled:!isAdmin, className: "w-full border p-2 rounded bg-slate-100" })),
                            React.createElement('div', null, React.createElement('label', {className:"text-[10px] font-bold"}, "Obj RDV"), React.createElement('input', { type: "number", value: form.targetAppointments, onChange: e => setForm({...form, targetAppointments: e.target.value}), className: "w-full border p-2 rounded bg-white" })),
                            React.createElement('div', null, React.createElement('label', {className:"text-[10px] font-bold"}, "Rayon"), React.createElement('input', { type: "number", value: form.radiusKm, onChange: e => setForm({...form, radiusKm: e.target.value}), className: "w-full border p-2 rounded bg-white" })),
                            React.createElement('div', { className: "col-span-2" }, React.createElement('button', { onClick: () => setEditingSection(null), className: "w-full bg-green-600 text-white font-bold py-2 rounded mt-2" }, "Valider"))
                        )
                    ) : (
                        React.createElement('div', { className: "grid grid-cols-2 gap-8" },
                            React.createElement('div', null, React.createElement('p', { className: "text-xs text-slate-400 font-bold mb-1" }, "Période"), React.createElement('p', { className: "text-slate-800 font-bold" }, `Du ${new Date(form.startDate).toLocaleDateString('fr-FR')}`), React.createElement('p', { className: "text-slate-800 font-bold" }, `Au ${new Date(form.endDate).toLocaleDateString('fr-FR')}`)),
                            React.createElement('div', null, React.createElement('p', { className: "text-xs text-slate-400 font-bold mb-1" }, "Objectifs"), React.createElement('p', { className: "text-slate-800 font-bold" }, `${form.targetAppointments} RDV à atteindre`), React.createElement('p', { className: "text-slate-800 font-bold" }, `Rayon : ${form.radiusKm} km`))
                        )
                    )
                ),
                // Bloc Cibles
                React.createElement('div', { className: "p-8 relative group" },
                    // CORRECTION ICI : "edit" et couleur
                    React.createElement('button', { 
                        onClick: () => setEditingSection(editingSection === 'vehicle' ? null : 'vehicle'), 
                        className: `absolute top-8 right-8 transition p-2 rounded-full ${editingSection === 'vehicle' ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-600 hover:text-blue-600'}` 
                    }, React.createElement(Icon, { name: editingSection === 'vehicle' ? "check" : "edit", size: 18 })),
                    
                    React.createElement('h3', { className: "text-xs font-black text-slate-300 uppercase tracking-wider mb-4" }, "Ciblage Véhicules"),
                    editingSection === 'vehicle' ? (
                        React.createElement('div', { className: "space-y-3 animate-in fade-in" },
                            React.createElement('div', { className: "grid grid-cols-2 gap-4" },
                                React.createElement('div', null, React.createElement('label', {className:"text-[10px] font-bold"}, "Année Min"), React.createElement('input', { type: "number", value: form.minVehicleYear, onChange: e => setForm({...form, minVehicleYear: e.target.value}), className: "w-full border p-2 rounded" })),
                                React.createElement('div', null, React.createElement('label', {className:"text-[10px] font-bold"}, "Km Max"), React.createElement('input', { type: "number", value: form.maxKmPerVehicle, onChange: e => setForm({...form, maxKmPerVehicle: e.target.value}), className: "w-full border p-2 rounded" }))
                            ),
                            React.createElement('input', { value: form.excludedVehicles, onChange: e => setForm({...form, excludedVehicles: e.target.value}), className: "w-full border p-2 rounded", placeholder: "Exclusions" }),
                            React.createElement('button', { onClick: () => setEditingSection(null), className: "w-full bg-green-600 text-white font-bold py-2 rounded mt-2" }, "Valider")
                        )
                    ) : (
                        React.createElement('div', null,
                            React.createElement('div', { className: "flex gap-4 items-center" }, React.createElement('span', { className: "bg-slate-900 text-white px-3 py-1 rounded text-sm font-bold" }, `Min ${form.minVehicleYear}`), React.createElement('span', { className: "bg-slate-100 text-slate-600 px-3 py-1 rounded text-sm font-bold" }, `Max ${parseInt(form.maxKmPerVehicle).toLocaleString()} km`)),
                            form.excludedVehicles && React.createElement('p', { className: "mt-4 text-sm text-red-500 font-medium" }, `⛔ Exclusions : ${form.excludedVehicles}`)
                        )
                    )
                ),
                React.createElement('div', { className: "p-4 bg-slate-900 text-white text-center" },
                    React.createElement('button', { onClick: handleFinalSubmit, disabled: loading || editingSection !== null, className: `w-full py-4 rounded-xl font-bold text-lg transition flex items-center justify-center gap-3 ${editingSection ? 'opacity-50 cursor-not-allowed bg-slate-700' : 'hover:bg-slate-800'}` }, 
                        editingSection ? "Terminez les modifications..." : loading ? "Génération..." : React.createElement(React.Fragment, null, "VALIDER DÉFINITIVEMENT", React.createElement(Icon, { name: "check", size: 24 }))
                    )
                )
            )
        );
    }
}
// --- MODULE PROFIL (CORRIGÉ : SUPPRESSION PHOTO + CHOIX AVATAR) ---
function CommercialProfileModule({ user, userData, db }) {
    const [firstName, setFirstName] = useState('');
    const [lastName, setLastName] = useState('');
    const [loading, setLoading] = useState(false);
    const [message, setMessage] = useState('');
    const [isEditing, setIsEditing] = useState(false);
    const [showAvatarSelector, setShowAvatarSelector] = useState(false);

    // Liste d'avatars prédéfinis (Personnages)
    const predefinedAvatars = [
        "https://api.dicebear.com/9.x/avataaars/svg?seed=Felix",
        "https://api.dicebear.com/9.x/avataaars/svg?seed=Aneka",
        "https://api.dicebear.com/9.x/avataaars/svg?seed=Zoe",
        "https://api.dicebear.com/9.x/avataaars/svg?seed=Jack",
        "https://api.dicebear.com/9.x/avataaars/svg?seed=Sam",
        "https://api.dicebear.com/9.x/avataaars/svg?seed=Milo"
    ];

    // Synchronisation des données
    useEffect(() => {
        if (userData) {
            setFirstName(userData.firstName || '');
            setLastName(userData.lastName || '');
        }
    }, [userData]);

    // Upload Photo (Fichier local)
    const handlePhoto = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onloadend = async () => {
            try {
                await updateDoc(doc(db, "users", user.uid), { photoURL: reader.result });
                setMessage("Photo mise à jour !");
                setTimeout(() => setMessage(''), 3000);
                setShowAvatarSelector(false);
            } catch (e) { setMessage("Erreur upload"); }
        };
        reader.readAsDataURL(file);
    };

    // Sélectionner un Avatar prédéfini
    const handleSelectAvatar = async (url) => {
        try {
            await updateDoc(doc(db, "users", user.uid), { photoURL: url });
            setMessage("Avatar choisi !");
            setTimeout(() => setMessage(''), 3000);
            setShowAvatarSelector(false);
        } catch (e) { setMessage("Erreur sauvegarde avatar"); }
    };

    // Supprimer la photo (Remise à zéro)
    const handleDeletePhoto = async () => {
        if(!confirm("Supprimer votre photo de profil ?")) return;
        try {
            await updateDoc(doc(db, "users", user.uid), { photoURL: null });
            setMessage("Photo supprimée.");
            setTimeout(() => setMessage(''), 3000);
        } catch (e) { setMessage("Erreur suppression"); }
    };

    // Sauvegarde Nom
    const handleSaveName = async (e) => {
        e.preventDefault();
        setLoading(true);
        try {
            const newName = `${firstName} ${lastName}`.trim();
            await updateDoc(doc(db, "users", user.uid), { firstName, lastName, name: newName });
            setMessage("Profil mis à jour !");
            setTimeout(() => setMessage(''), 3000);
            setIsEditing(false);
        } catch (e) { setMessage("Erreur sauvegarde"); }
        setLoading(false);
    };

    return React.createElement('div', { className: "max-w-4xl mx-auto space-y-8 pb-10" },
        
        // HEADER
        React.createElement('div', { className: "flex flex-col gap-1" },
            React.createElement('h1', { className: "text-4xl font-black text-slate-900 tracking-tight" }, "Mon Espace"),
            React.createElement('p', { className: "text-slate-500 font-medium" }, "Gérez votre identité et vos préférences.")
        ),

        // CARTE PRINCIPALE
        React.createElement('div', { className: "bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border border-slate-100" },
            
            // BANNIÈRE
            React.createElement('div', { className: "h-40 bg-gradient-to-r from-slate-900 via-slate-800 to-slate-900 relative" },
                React.createElement('div', { className: "absolute inset-0 opacity-20 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]" })
            ),

            // CONTENU PROFIL
            React.createElement('div', { className: "px-8 md:px-12 pb-10 relative" },
                
                // AVATAR FLOTTANT + ACTIONS
                React.createElement('div', { className: "relative -mt-16 mb-6 flex flex-col items-start" },
                    React.createElement('div', { className: "relative" },
                        React.createElement('div', { className: "h-32 w-32 rounded-[2rem] p-1 bg-white shadow-xl" },
                            React.createElement('div', { className: "h-full w-full rounded-[1.8rem] overflow-hidden bg-slate-100 relative group" },
                                userData?.photoURL 
                                    ? React.createElement('img', { src: userData.photoURL, className: "w-full h-full object-cover" })
                                    : React.createElement('div', { className: "w-full h-full flex items-center justify-center text-slate-400" }, React.createElement(Icon, { name: "users", size: 48 })),
                                
                                // Overlay au survol (Upload)
                                React.createElement('label', { className: "absolute inset-0 bg-black/60 flex flex-col items-center justify-center text-white opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer z-10" },
                                    React.createElement(Icon, { name: "upload", size: 24 }),
                                    React.createElement('span', { className: "text-[10px] font-bold uppercase mt-1" }, "Changer"),
                                    React.createElement('input', { type: "file", accept: "image/*", className: "hidden", onChange: handlePhoto })
                                )
                            )
                        ),
                        // BOUTON SUPPRIMER (Si photo existe)
                        userData?.photoURL && React.createElement('button', { 
                            onClick: handleDeletePhoto,
                            className: "absolute -top-2 -right-2 bg-red-500 text-white p-2 rounded-full shadow-lg hover:bg-red-600 transition z-20",
                            title: "Supprimer la photo"
                        }, React.createElement(Icon, { name: "trash", size: 14 }))
                    ),

                    // BOUTON CHOIX AVATAR (Texte en dessous)
                    React.createElement('button', { 
                        onClick: () => setShowAvatarSelector(!showAvatarSelector),
                        className: "mt-3 text-sm font-bold text-blue-600 hover:text-blue-800 flex items-center gap-2 bg-blue-50 px-3 py-1.5 rounded-lg transition"
                    }, 
                        React.createElement(Icon, { name: "smile", size: 16 }),
                        "Choisir un personnage"
                    ),

                    // SÉLECTEUR D'AVATAR (Affichage conditionnel)
                    showAvatarSelector && React.createElement('div', { className: "mt-4 p-4 bg-slate-50 border border-slate-200 rounded-2xl animate-in slide-in-from-top-2 fade-in w-full max-w-md" },
                        React.createElement('p', { className: "text-xs font-bold text-slate-400 uppercase mb-3" }, "Sélectionnez un avatar"),
                        React.createElement('div', { className: "flex gap-3 overflow-x-auto pb-2" },
                            predefinedAvatars.map((url, i) => 
                                React.createElement('button', { 
                                    key: i, 
                                    onClick: () => handleSelectAvatar(url),
                                    className: "h-12 w-12 min-w-[3rem] rounded-full bg-white border-2 border-slate-200 hover:border-blue-500 hover:scale-110 transition overflow-hidden"
                                }, React.createElement('img', { src: url, className: "w-full h-full object-cover" }))
                            )
                        )
                    )
                ),

                // INFOS & FORMULAIRE
                React.createElement('div', { className: "flex flex-col lg:flex-row gap-10 justify-between mt-4" },
                    
                    // COLONNE GAUCHE : Identité statique
                    React.createElement('div', { className: "flex-1 space-y-2" },
                        React.createElement('div', { className: "flex items-center gap-3" },
                            React.createElement('h2', { className: "text-3xl font-black text-slate-900" }, userData?.name || "Utilisateur"),
                            userData?.role === 'admin' && React.createElement('span', { className: "bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-wider" }, "ADMIN"),
                            userData?.role === 'sales' && React.createElement('span', { className: "bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-wider" }, "PARTENAIRE")
                        ),
                        React.createElement('div', { className: "flex items-center gap-2 text-slate-500 font-medium" },
                            React.createElement(Icon, { name: "mail", size: 16 }),
                            React.createElement('span', null, user.email)
                        ),
                        React.createElement('div', { className: "pt-4 flex gap-2 text-xs font-mono text-slate-400" },
                            React.createElement('span', null, `ID: ${user.uid.substring(0, 8)}...`)
                        )
                    ),

                    // COLONNE DROITE : Formulaire Éditable
                    React.createElement('div', { className: "flex-1 w-full lg:max-w-md bg-slate-50 rounded-3xl p-6 border border-slate-100" },
                        !isEditing ? (
                            React.createElement('div', { className: "space-y-4" },
                                React.createElement('div', { className: "flex justify-between items-center" },
                                    React.createElement('p', { className: "text-xs font-bold text-slate-400 uppercase" }, "Mes Informations"),
                                    React.createElement('button', { onClick: () => setIsEditing(true), className: "text-blue-600 hover:bg-blue-100 p-2 rounded-full transition" }, React.createElement(Icon, { name: "edit", size: 18 }))
                                ),
                                React.createElement('div', { className: "grid grid-cols-2 gap-4" },
                                    React.createElement('div', { className: "bg-white p-3 rounded-xl border border-slate-100" },
                                        React.createElement('p', { className: "text-[10px] text-slate-400 mb-1" }, "Prénom"),
                                        React.createElement('p', { className: "font-bold text-slate-800" }, userData?.firstName || "-")
                                    ),
                                    React.createElement('div', { className: "bg-white p-3 rounded-xl border border-slate-100" },
                                        React.createElement('p', { className: "text-[10px] text-slate-400 mb-1" }, "Nom"),
                                        React.createElement('p', { className: "font-bold text-slate-800" }, userData?.lastName || "-")
                                    )
                                ),
                                message && React.createElement('div', { className: "bg-green-100 text-green-700 p-3 rounded-xl text-center text-xs font-bold flex items-center justify-center gap-2" }, React.createElement(Icon, { name: "check", size: 14 }), message)
                            )
                        ) : (
                            React.createElement('form', { onSubmit: handleSaveName, className: "space-y-4 animate-in fade-in" },
                                React.createElement('p', { className: "text-xs font-bold text-slate-400 uppercase mb-2" }, "Modification"),
                                React.createElement('div', { className: "grid grid-cols-2 gap-3" },
                                    React.createElement('div', null,
                                        React.createElement('input', { placeholder:"Prénom", value: firstName, onChange: e => setFirstName(e.target.value), className: "w-full p-3 bg-white border-2 border-blue-100 rounded-xl font-bold text-slate-800 outline-none focus:border-blue-500 transition" })
                                    ),
                                    React.createElement('div', null,
                                        React.createElement('input', { placeholder:"Nom", value: lastName, onChange: e => setLastName(e.target.value), className: "w-full p-3 bg-white border-2 border-blue-100 rounded-xl font-bold text-slate-800 outline-none focus:border-blue-500 transition" })
                                    )
                                ),
                                React.createElement('div', { className: "flex gap-2" },
                                    React.createElement('button', { type: "button", onClick: () => setIsEditing(false), className: "flex-1 py-3 bg-white border border-slate-200 text-slate-500 font-bold rounded-xl hover:bg-slate-50" }, React.createElement(Icon, { name: "x", size: 18 })),
                                    React.createElement('button', { type: "submit", disabled: loading, className: "flex-1 py-3 bg-slate-900 text-white font-bold rounded-xl hover:bg-black shadow-lg flex items-center justify-center gap-2" }, loading ? "..." : React.createElement(React.Fragment, null, "Enregistrer", React.createElement(Icon, { name: "save", size: 16 })))
                                )
                            )
                        )
                    )
                )
            )
        ),

        // BLOC SUPPORT
        React.createElement('div', { className: "bg-gradient-to-br from-blue-600 to-indigo-700 rounded-[2.5rem] p-8 md:p-10 text-white shadow-2xl shadow-blue-200 flex flex-col md:flex-row items-center justify-between gap-6 relative overflow-hidden" },
            React.createElement('div', { className: "absolute top-0 right-0 -mr-10 -mt-10 h-64 w-64 bg-white opacity-10 rounded-full blur-3xl" }),
            React.createElement('div', { className: "relative z-10 text-center md:text-left" },
                React.createElement('div', { className: "flex items-center justify-center md:justify-start gap-2 mb-2 opacity-80" },
                    React.createElement(Icon, { name: "briefcase", size: 16 }),
                    React.createElement('span', { className: "text-xs font-bold uppercase tracking-widest" }, "SUPPORT PARTENAIRE")
                ),
                React.createElement('h3', { className: "text-3xl font-black mb-2" }, "C&N Solutions"),
                React.createElement('p', { className: "text-blue-100 font-medium max-w-md" }, "Une urgence ? Une question sur votre contrat ou une mission ? Notre équipe dédiée vous répond.")
            ),
            React.createElement('a', { 
                href: "tel:0985408925",
                className: "relative z-10 bg-white text-blue-600 hover:bg-blue-50 px-8 py-4 rounded-2xl font-black text-xl shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all duration-300 flex items-center gap-3 group"
            },
                React.createElement('div', { className: "bg-blue-100 p-2 rounded-full group-hover:bg-blue-200 transition" }, 
                    React.createElement(Icon, { name: "phone", size: 24 })
                ),
                "09 85 40 89 25"
            )
        )
    );
}
        // --- GESTIONNAIRE APP (Inchangé) ---
        function App() {
            const [user, setUser] = useState(null);
            const [userData, setUserData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('dashboard');
            const [currentOrder, setCurrentOrder] = useState(null);
            const [allSalesReps, setAllSalesReps] = useState(null);
            const [adminTab, setAdminTab] = useState('orders'); 

            const setViewAndTab = (newView, newTab = 'orders') => {
                setAdminTab(newTab);
                setView(newView);
            };
            
            const [globalSettings, setGlobalSettings] = useState({
                defaultRate: 50,
                taxType: 'HT',
                sequenceNumber: 367,
                myCompanyName: '',
                myAddress: '',
                mySiret: '',
                myEmail: '',
                pilotMissionAmount: 0,
                contractAmount: 0
            });

            const isAdmin = (userData?.role === 'admin' || user?.email === 'contact@cetn-solutions.fr');

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
                    if (currentUser) {
                        const userRef = doc(db, "users", currentUser.uid);
  const unsubDoc = onSnapshot(userRef, (docSnap) => {
    if (docSnap.exists()) {
        let data = {
            firstName: '',
            lastName: '',
            name: 'Commercial', 
            role: 'sales',
            totalEarnings: 0,
            ...docSnap.data()
        };

        if (data.firstName && data.lastName) {
            data.name = `${data.firstName} ${data.lastName}`;
        } else if (data.name && data.name.includes(' ')) {
            const parts = data.name.split(' ');
            if(parts.length >= 2) {
                data.firstName = parts[0];
                data.lastName = parts.slice(1).join(' ');
            }
        }
        
        if (currentUser.email === "contact@cetn-solutions.fr" && data.role !== 'admin') {
            data = { ...data, role: 'admin', name: data.name || 'Administrateur Principal', firstName: 'Administrateur', lastName: 'Principal' };
        } else if (!data.role) {
            data = { ...data, role: 'sales', name: data.name || 'Commercial', firstName: 'Commercial', lastName: 'Partenaire' };
        }

        if (data.isBlocked) {
            signOut(auth);
            alert("Votre accès a été suspendu. Contactez l'administrateur.");
            setUser(null);
            setUserData(null);
        } else {
            setUser(currentUser);
            setUserData(data);
        }
    } else {
        signOut(auth);
        setUser(null);
        setUserData(null);
    }
    setLoading(false);
});
                    } else {
                        setUser(null);
                        setUserData(null);
                        setLoading(false);
                    }
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if(user) {
                    getDoc(doc(db, "settings", "global")).then(snap => {
                        if(snap.exists()) setGlobalSettings(prev => ({...prev, ...snap.data()}));
                    });
                }
            }, [user]);

            useEffect(() => {
                if (isAdmin) {
                    const qUsers = query(collection(db, "users"));
                    const unsubscribe = onSnapshot(qUsers, (snap) => {
                        const reps = snap.docs.map(d => ({id: d.id, ...d.data()}))
                                               .filter(r => r.role === 'sales' || r.role === 'intern' || r.role === 'admin');
                        setAllSalesReps(reps);
                    });
                    return () => unsubscribe();
                } else {
                    setAllSalesReps(null);
                }
            }, [isAdmin]);
            
            if (loading) return React.createElement('div', { className: "min-h-screen flex items-center justify-center" }, React.createElement('div', { className: "loader h-8 w-8 rounded-full border-4 border-slate-200" }));

            if (!user) return React.createElement(Login);


            if (view === 'admin' && isAdmin) {
                return React.createElement(AdminPanel, {
                    setView: () => setViewAndTab('dashboard', 'orders'),
                    globalSettings,
                    setGlobalSettings,
                    db,
                    currentUser: user,
                    defaultTab: adminTab,
                    setAdminTab: setAdminTab
                });
            }

            return React.createElement(DashboardLayout, {
                user,
                userData,
                globalSettings,
                db,
                isAdmin,
                setView: setViewAndTab,
                currentOrder,
                setCurrentOrder,
                allSalesReps
            });
        }

   // --- ADMIN PANEL (RESPONSIVE ULTRA-OPTIMISÉ MOBILE & PC) ---
function AdminPanel({ setView, globalSettings, setGlobalSettings, db, currentUser, defaultTab, setAdminTab }) {
    // --- ÉTATS ---
    const [orders, setOrders] = useState([]);
    const [users, setUsers] = useState([]);
    const [contracts, setContracts] = useState([]); 
    const [currentTab, setCurrentTab] = useState(defaultTab && defaultTab !== 'orders' ? defaultTab : 'menu');
    const [editingId, setEditingId] = useState(null);
    const [newUser, setNewUser] = useState({ name: '', email: '', password: '', role: 'sales' });

    // --- CHARGEMENT ---
    useEffect(() => {
        const qOrders = query(collection(db, "orders"), orderBy("createdAt", "desc"), limit(100)); 
        const unsubOrders = onSnapshot(qOrders, (snap) => setOrders(snap.docs.map(d => ({id: d.id, ...d.data()}))));
        const qUsers = query(collection(db, "users"));
        const unsubUsers = onSnapshot(qUsers, (snap) => setUsers(snap.docs.map(d => ({id: d.id, ...d.data()}))));
        const qContracts = query(collection(db, "contracts"), orderBy("createdAt", "desc"));
        const unsubContracts = onSnapshot(qContracts, (snap) => setContracts(snap.docs.map(d => ({id: d.id, ...d.data()}))));
        return () => { unsubOrders(); unsubUsers(); unsubContracts(); };
    }, []);

    // --- DONNÉES & FILTRES ---
    const allOrders = orders;
    const trashOrders = orders.filter(o => o.status === 'RequestDelete');
    const pendingContracts = contracts.filter(c => c.status === 'ToDraft'); 

    // --- ACTIONS ---
    const markAsRead = async (col, id) => { try { await updateDoc(doc(db, col, id), { adminRead: true }); } catch (e) {} };
    const handlePreviewAndRead = (item, type) => { generateOrderPDF(item, globalSettings); markAsRead(type === 'Mission' ? "orders" : "contracts", item.id); };
    const deleteOrder = async (id) => { if(confirm("Confirmer suppression définitive ?")) await deleteDoc(doc(db, "orders", id)); };
    const handleDeleteContract = async (id) => { if(confirm("Supprimer ce contrat ?")) await deleteDoc(doc(db, "contracts", id)); };
    const handleDeletionApproval = async (id, approve) => { 
        if(approve) await deleteDoc(doc(db, "orders", id));
        else await updateDoc(doc(db, "orders", id), { status: 'Envoyé', deleteReason: null, adminRead: true });
    };
    const toggleContractStatus = async (c) => { await updateDoc(doc(db, "contracts", c.id), { status: c.status === 'ToDraft' ? 'Drafted' : 'ToDraft', adminRead: true }); };
    
    // User Actions
    const handleSaveUser = async (e) => {
        e.preventDefault();
        if (editingId) {
            try {
                const updateData = { name: newUser.name, role: newUser.role };
                if (newUser.password?.trim()) updateData.password = newUser.password;
                await updateDoc(doc(db, "users", editingId), updateData);
                alert("Mis à jour !"); setEditingId(null); setNewUser({ name: '', email: '', password: '', role: 'sales' });
            } catch (err) { alert(err.message); }
        } else {
            try {
                const cred = await createUserWithEmailAndPassword(secondaryAuth, newUser.email, newUser.password);
                await setDoc(doc(db, "users", cred.user.uid), { ...newUser, isBlocked: false, totalEarnings: 0, createdAt: new Date() });
                setNewUser({ name: '', email: '', password: '', role: 'sales' }); signOut(secondaryAuth); alert("Créé !");
            } catch (err) { alert(err.message); }
        }
    };
    const startEdit = (u) => { setEditingId(u.id); setNewUser({ name: u.name||'', email: u.email, password: u.password||'', role: u.role }); window.scrollTo(0,0); };
    const toggleBlockUser = async (uid, status) => { if (uid === currentUser.uid) return alert("Impossible."); await updateDoc(doc(db, "users", uid), { isBlocked: !status }); };
    const deleteUserAcct = async (uid) => { if (uid === currentUser.uid) return alert("Impossible."); if(confirm("Supprimer ?")) await deleteDoc(doc(db, "users", uid)); };
    const handleUserRateChange = async (uid, field, val) => { await updateDoc(doc(db, "users", uid), { [field]: val===""?null:parseFloat(val) }); };

    // Settings Actions
    const handleImageUpload = (e, f) => { const file = e.target.files[0]; if(!file)return; const r = new FileReader(); r.onloadend=()=>setGlobalSettings(p=>({...p, [f]:r.result})); r.readAsDataURL(file); };
    const saveSettings = async () => { await setDoc(doc(db, "settings", "global"), globalSettings, { merge: true }); alert("Sauvegardé !"); };
    const getUniqueClients = () => { const u={}; allOrders.forEach(o => { if(!u[o.siren] && o.companyName) u[o.siren]=o; }); return Object.values(u); };

    // --- COMPOSANTS UI ADAPTATIFS ---
    const StatusPill = ({ status, isUnread }) => { 
        const styles = { 
            'Pending': 'bg-orange-50 text-orange-600 border-orange-100', 
            'Envoyé': 'bg-blue-50 text-blue-600 border-blue-100', 
            'Signed': 'bg-green-50 text-green-600 border-green-100', 
            'Declined': 'bg-red-50 text-red-600 border-red-100',
            'ToDraft': 'bg-purple-50 text-purple-600 border-purple-100',
            'Drafted': 'bg-teal-50 text-teal-600 border-teal-100'
        }; 
        return React.createElement('div', { className: `flex items-center gap-2 px-2 py-1 md:px-3 md:py-1.5 rounded-lg border ${styles[status] || 'bg-slate-50 text-slate-500 border-slate-100'} text-[9px] md:text-[10px] font-black uppercase tracking-wider shadow-sm whitespace-nowrap` },
            status === 'Generated' ? 'ENVOYÉ' : status,
            isUnread && React.createElement('span', { className: "h-2 w-2 rounded-full bg-red-500 animate-pulse shadow-red-200" })
        );
    };

    const ActionButton = ({ icon, onClick, color = "slate", title }) => (
        React.createElement('button', { 
            onClick: (e) => { e.stopPropagation(); onClick(); }, 
            title: title,
            // Taille tactile optimale (44px min recommandé sur mobile)
            className: `h-11 w-11 md:h-10 md:w-10 flex items-center justify-center rounded-xl transition-all active:scale-90 shadow-md border border-transparent hover:shadow-lg hover:scale-105 ${color === 'red' ? 'bg-gradient-to-br from-red-50 to-red-100 text-red-600 hover:from-red-100 hover:to-red-200' : color === 'blue' ? 'bg-gradient-to-br from-blue-50 to-blue-100 text-blue-600 hover:from-blue-100 hover:to-blue-200' : 'bg-gradient-to-br from-slate-100 to-slate-200 text-slate-600 hover:from-slate-200 hover:to-slate-300 border-slate-200'}` 
        }, React.createElement(Icon, { name: icon, size: 20 }))
    );

    const CardItem = ({ children, statusColor = "bg-slate-200", onClick }) => (
        React.createElement('div', { 
            onClick: onClick,
            className: "relative bg-white/95 backdrop-blur-sm p-4 md:p-5 rounded-[1.5rem] shadow-lg border border-slate-100/50 active:scale-[0.98] transition-all duration-300 cursor-pointer overflow-hidden hover:shadow-xl hover:-translate-y-1 group" 
        },
            React.createElement('div', { className: `absolute left-0 top-0 bottom-0 w-1.5 ${statusColor} group-hover:w-2 transition-all duration-300` }),
            React.createElement('div', { className: "absolute inset-0 bg-gradient-to-br from-white/50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300" }),
            React.createElement('div', { className: "relative z-10" }, children)
        )
    );

    // --- MENU CONFIG ---
    const menuItems = [
        { id: 'orders', label: 'Missions', desc: 'Gestion active', icon: 'zap', color: 'blue', count: null },
        { id: 'contracts', label: 'Contrats', desc: 'Signatures', icon: 'briefcase', color: 'purple', count: pendingContracts.length },
        { id: 'clients', label: 'Clients', desc: 'Base Données', icon: 'users', color: 'green', count: null },
        { id: 'team', label: 'Équipe', desc: 'Commerciaux', icon: 'smile', color: 'orange', count: null },
        { id: 'pricing', label: 'Tarifs', desc: 'Prix & Gains', icon: 'dollar', color: 'yellow', count: null },
        { id: 'trash', label: 'Corbeille', desc: 'Suppressions', icon: 'trash', color: 'red', count: trashOrders.length },
        { id: 'settings', label: 'Config', desc: 'Logo & PDF', icon: 'settings', color: 'slate', count: null },
    ];

    // --- RENDER ---
    return React.createElement('div', { className: "w-full min-h-screen bg-gradient-to-br from-slate-50 via-blue-50/30 to-purple-50/30" },
        
        // 1. MENU ACCUEIL (GRILLE RESPONSIVE)
        currentTab === 'menu' ? (
            React.createElement('div', { className: "p-4 md:p-10 max-w-6xl mx-auto animate-in fade-in duration-300 pb-24" },
                // Header Accueil
                React.createElement('div', { className: "flex flex-col md:flex-row justify-between items-start md:items-end mb-6 md:mb-10 gap-4" },
                    React.createElement('div', null,
                        React.createElement('h1', { className: "text-3xl md:text-4xl font-black text-slate-900 tracking-tight" }, "Admin"),
                        React.createElement('p', { className: "text-slate-500 font-medium text-sm md:text-lg" }, "Tableau de bord principal.")
                    ),
                    React.createElement('button', { onClick: () => setView('dashboard'), className: "w-full md:w-auto bg-white/95 backdrop-blur-sm border-2 border-slate-200 text-slate-700 px-6 py-3 rounded-2xl font-bold shadow-lg hover:shadow-xl active:bg-slate-100 transition-all duration-300 hover:scale-[1.02] flex items-center justify-center gap-3" },
                        React.createElement(Icon, { name: "logOut", size: 20 }), "Quitter"
                    )
                ),
                // Grille : 2 colonnes sur mobile, 3/4 sur desktop
                React.createElement('div', { className: "grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 md:gap-6" },
                    menuItems.map(item => 
                        React.createElement('button', { key: item.id, onClick: () => setCurrentTab(item.id), className: "relative bg-white/95 backdrop-blur-sm p-4 md:p-6 rounded-[1.5rem] md:rounded-[2rem] shadow-lg active:scale-95 border border-slate-100/50 transition-all duration-300 group text-left h-36 md:h-48 flex flex-col justify-between overflow-hidden hover:shadow-2xl hover:-translate-y-1" },
                            React.createElement('div', { className: `absolute -right-4 -top-4 opacity-10 group-hover:opacity-20 transition-opacity text-${item.color}-600` }, React.createElement(Icon, { name: item.icon, size: 80 })),
                            React.createElement('div', { className: "relative" },
                                React.createElement('div', { className: `absolute inset-0 bg-gradient-to-br from-${item.color}-100 to-${item.color}-200 rounded-xl md:rounded-2xl blur-xl opacity-0 group-hover:opacity-50 transition-opacity duration-300` }),
                                React.createElement('div', { className: `relative h-10 w-10 md:h-14 md:w-14 rounded-xl md:rounded-2xl bg-gradient-to-br from-${item.color}-50 to-${item.color}-100 text-${item.color}-600 flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-300` }, React.createElement(Icon, { name: item.icon, size: 20 })),
                            ), // Icone plus petite sur mobile
                            React.createElement('div', { className: "relative z-10" },
                                React.createElement('h3', { className: "text-sm md:text-xl font-black text-slate-800 leading-tight" }, item.label),
                                React.createElement('p', { className: "text-[10px] md:text-xs font-bold text-slate-400 mt-0.5 md:mt-1 uppercase tracking-wide truncate" }, item.desc)
                            ),
                            item.count > 0 && React.createElement('span', { className: "absolute top-3 right-3 md:top-5 md:right-5 bg-gradient-to-r from-red-500 to-rose-600 text-white font-bold h-5 min-w-[1.25rem] px-1 flex items-center justify-center rounded-full text-[10px] md:text-xs shadow-xl animate-pulse z-20 border border-red-400" }, item.count)
                        )
                    )
                )
            )
        ) : (
            // 2. PAGES INTÉRIEURES (100% Mobile Friendly)
            React.createElement('div', { className: "flex flex-col h-screen animate-in slide-in-from-right-8 duration-300" },
                
                // HEADER STICKY COMPACT
                React.createElement('div', { className: "sticky top-0 z-40 bg-white/95 backdrop-blur-xl border-b border-slate-200/60 px-4 py-3 md:px-6 md:py-4 flex items-center gap-3 shadow-lg" },
                    React.createElement('button', { onClick: () => setCurrentTab('menu'), className: "h-10 w-10 flex-shrink-0 flex items-center justify-center bg-gradient-to-br from-slate-100 to-slate-200 text-slate-700 rounded-full active:scale-90 transition-all duration-300 hover:shadow-md hover:scale-105" }, React.createElement(Icon, { name: "menu", size: 20 })),
                    React.createElement('div', { className: "flex-1 overflow-hidden" },
                        React.createElement('h2', { className: "text-lg md:text-xl font-black text-slate-900 leading-none truncate" }, menuItems.find(i => i.id === currentTab)?.label),
                        React.createElement('p', { className: "text-[10px] font-bold text-slate-400 uppercase tracking-widest truncate" }, "Administration")
                    ),
                    React.createElement('div', { className: `h-2 w-2 rounded-full bg-${menuItems.find(i => i.id === currentTab)?.color}-500 shadow-lg` })
                ),

                // CONTENU SCROLLABLE (Padding ajusté)
                React.createElement('div', { className: "flex-1 overflow-y-auto p-3 md:p-8 pb-24" },
                    
                    // --- ONGLET MISSIONS (Card View) ---
                    currentTab === 'orders' && React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-5" },
                        allOrders.map(o => {
                            const color = o.status === 'Pending' ? 'bg-orange-400' : o.status === 'Envoyé' ? 'bg-blue-500' : o.status === 'Signed' ? 'bg-green-500' : 'bg-slate-300';
                            return React.createElement(CardItem, { key: o.id, statusColor: color, onClick: () => handlePreviewAndRead(o, 'Mission') },
                                React.createElement('div', { className: "flex justify-between items-start mb-2 pl-2" },
                                    React.createElement('span', { className: "text-[9px] md:text-[10px] font-mono font-bold text-slate-400 bg-slate-50 px-2 py-1 rounded-md" }, o.reference),
                                    React.createElement(StatusPill, { status: o.status, isUnread: !o.adminRead })
                                ),
                                React.createElement('h3', { className: "font-black text-base md:text-lg text-slate-800 mb-1 pl-2 truncate" }, o.companyName || "Sans nom"),
                                React.createElement('div', { className: "flex items-center gap-2 pl-2 mb-3" },
                                    React.createElement('div', { className: "h-5 w-5 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600" }, React.createElement(Icon, { name: "user", size: 10 })),
                                    React.createElement('p', { className: "text-xs font-bold text-indigo-900 truncate" }, o.salesRepName)
                                ),
                                React.createElement('div', { className: "flex justify-end gap-2 pt-3 border-t border-slate-50 pl-2" },
                                    React.createElement(ActionButton, { icon: "eye", color: "blue", onClick: () => handlePreviewAndRead(o, 'Mission'), title: "Voir" }),
                                    React.createElement(ActionButton, { icon: "trash", color: "red", onClick: () => deleteOrder(o.id), title: "Supprimer" })
                                )
                            );
                        })
                    ),

                    // --- ONGLET CONTRATS (Card View) ---
                    currentTab === 'contracts' && React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-5" },
                        contracts.map(c => {
                            const color = c.status === 'ToDraft' ? 'bg-orange-400' : 'bg-green-500';
                            return React.createElement(CardItem, { key: c.id, statusColor: color, onClick: () => handlePreviewAndRead(c, 'Contrat') },
                                React.createElement('div', { className: "flex justify-between items-start mb-2 pl-2" },
                                    React.createElement('span', { className: "text-[9px] font-bold text-purple-500 bg-purple-50 px-2 py-1 rounded-md uppercase" }, "Contrat"),
                                    React.createElement(StatusPill, { status: c.status, isUnread: !c.adminRead })
                                ),
                                React.createElement('h3', { className: "font-black text-base md:text-lg text-slate-800 mb-1 pl-2 truncate" }, c.companyName),
                                React.createElement('p', { className: "text-xs text-slate-500 font-medium pl-2 mb-3" }, `${c.targetAppointments} RDV • ${c.radius} km`),
                                React.createElement('div', { className: "flex justify-end gap-2 pt-3 border-t border-slate-50 pl-2" },
                                    React.createElement(ActionButton, { icon: "eye", color: "blue", onClick: () => handlePreviewAndRead(c, 'Contrat') }),
                                    React.createElement(ActionButton, { icon: "check", color: "slate", onClick: () => toggleContractStatus(c) }),
                                    React.createElement(ActionButton, { icon: "trash", color: "red", onClick: () => handleDeleteContract(c.id) })
                                )
                            );
                        })
                    ),

                    // --- ONGLET CLIENTS (Card View au lieu de Table) ---
                    currentTab === 'clients' && React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-5" },
                        getUniqueClients().map((c, i) => React.createElement(CardItem, { key: i, statusColor: "bg-green-500" },
                            React.createElement('div', { className: "flex items-center gap-3 mb-3 pl-2" },
                                React.createElement('div', { className: "h-10 w-10 md:h-12 md:w-12 flex-shrink-0 rounded-2xl bg-gradient-to-br from-green-400 to-emerald-600 flex items-center justify-center text-white shadow-lg" }, React.createElement(Icon, { name: "briefcase", size: 20 })),
                                React.createElement('div', { className: "overflow-hidden" },
                                    React.createElement('h3', { className: "font-black text-slate-800 leading-tight truncate text-sm md:text-base" }, c.companyName),
                                    React.createElement('p', { className: "text-[10px] md:text-xs text-slate-400 font-mono truncate" }, c.siren || "N/A")
                                )
                            ),
                            React.createElement('div', { className: "space-y-2 pl-2" },
                                React.createElement('div', { className: "flex items-center gap-2 text-xs font-bold text-slate-600" }, React.createElement(Icon, { name: "user", size: 14 }), React.createElement('span', {className:"truncate"}, c.directorLastName || "N/A")),
                                React.createElement('div', { className: "flex items-center gap-2 text-xs font-bold text-blue-600" }, React.createElement(Icon, { name: "mail", size: 14 }), React.createElement('span', {className:"truncate"}, c.clientEmail || "N/A")),
                                React.createElement('div', { className: "flex items-center gap-2 text-xs font-bold text-slate-600" }, React.createElement(Icon, { name: "phone", size: 14 }), c.clientPhone || "N/A")
                            )
                        ))
                    ),

                    // --- ONGLET EQUIPE ---
                    currentTab === 'team' && React.createElement('div', { className: "space-y-6" },
                        // Formulaire empilé sur mobile
                        React.createElement('div', { className: "bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-5 md:p-6 rounded-[2rem] shadow-2xl text-white border border-slate-700/50 relative overflow-hidden" },
                            React.createElement('div', { className: "absolute inset-0 bg-gradient-to-br from-blue-600/10 to-purple-600/10" }),
                            React.createElement('div', { className: "relative z-10" },
                                React.createElement('h3', { className: "font-bold text-lg mb-4 flex items-center gap-2" }, React.createElement(Icon, { name: "plus", size: 20 }), editingId ? "Modifier" : "Ajouter Membre"),
                                React.createElement('form', { onSubmit: handleSaveUser, className: "flex flex-col gap-3" },
                                    React.createElement('input', { placeholder: "Nom", value: newUser.name, onChange: e => setNewUser({...newUser, name: e.target.value}), className: "p-3 bg-white/10 backdrop-blur-sm rounded-xl text-sm font-bold text-white outline-none border border-white/20 focus:border-white/40 focus:bg-white/15 transition-all" }),
                                    React.createElement('input', { placeholder: "Email", value: newUser.email, onChange: e => setNewUser({...newUser, email: e.target.value}), className: "p-3 bg-white/10 backdrop-blur-sm rounded-xl text-sm font-bold text-white outline-none border border-white/20 focus:border-white/40 focus:bg-white/15 transition-all" }),
                                    React.createElement('div', { className: "flex gap-3" },
                                        React.createElement('input', { placeholder: "Pass", value: newUser.password, onChange: e => setNewUser({...newUser, password: e.target.value}), className: "w-1/2 p-3 bg-white/10 backdrop-blur-sm rounded-xl text-sm font-bold text-white outline-none border border-white/20 focus:border-white/40 focus:bg-white/15 transition-all" }),
                                        React.createElement('select', { value: newUser.role, onChange: e => setNewUser({...newUser, role: e.target.value}), className: "w-1/2 p-3 bg-white/10 backdrop-blur-sm rounded-xl text-sm font-bold text-white outline-none border border-white/20 focus:border-white/40 focus:bg-white/15 transition-all [&>option]:text-black" }, React.createElement('option', { value: "sales" }, "Sales"), React.createElement('option', { value: "admin" }, "Admin"))
                                    ),
                                    React.createElement('div', { className: "flex gap-2 pt-2" },
                                        editingId && React.createElement('button', { type: "button", onClick: () => {setEditingId(null); setNewUser({name:'',email:'',password:'',role:'sales'})}, className: "flex-1 py-3 bg-white/10 hover:bg-white/20 rounded-xl font-bold transition-all duration-300 border border-white/20" }, "Annuler"),
                                        React.createElement('button', { type: "submit", className: "flex-1 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 rounded-xl font-bold shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-[1.02] active:scale-[0.98]" }, "Valider")
                                    )
                                )
                            )
                        ),
                        // Liste Cards
                        React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-5" },
                            users.map(u => React.createElement(CardItem, { key: u.id, statusColor: u.isBlocked ? "bg-red-500" : "bg-green-500" },
                                React.createElement('div', { className: "flex items-center gap-3 mb-2 pl-2" },
                                    u.photoURL ? React.createElement('img', { src: u.photoURL, className: "w-12 h-12 rounded-2xl object-cover shadow-sm" }) : React.createElement('div', { className: "w-12 h-12 rounded-2xl bg-slate-100 flex items-center justify-center text-slate-400 font-black text-xl" }, u.name?.[0]),
                                    React.createElement('div', null,
                                        React.createElement('h4', { className: "font-black text-slate-800 text-sm" }, u.name),
                                        React.createElement('p', { className: "text-[10px] font-bold text-slate-400 uppercase" }, u.role)
                                    )
                                ),
                                React.createElement('div', { className: "flex justify-end gap-2 pt-2 border-t border-slate-50 pl-2" },
                                    React.createElement(ActionButton, { icon: "edit", color: "blue", onClick: () => startEdit(u) }),
                                    React.createElement(ActionButton, { icon: u.isBlocked ? "lock" : "unlock", color: u.isBlocked ? "red" : "slate", onClick: () => toggleBlockUser(u.id, u.isBlocked) }),
                                    React.createElement(ActionButton, { icon: "trash", color: "red", onClick: () => deleteUserAcct(u.id) })
                                )
                            ))
                        )
                    ),

                    // --- ONGLET TARIFS ---
                    currentTab === 'pricing' && React.createElement('div', { className: "space-y-6" },
                        React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-4" },
                            React.createElement('div', { className: "bg-gradient-to-br from-blue-600 via-blue-700 to-indigo-800 rounded-[2rem] p-6 md:p-8 text-white shadow-2xl relative overflow-hidden border border-blue-500/30 hover:shadow-3xl transition-all duration-300 hover:scale-[1.02]" },
                                React.createElement('div', { className: "absolute inset-0 bg-gradient-to-br from-white/10 to-transparent" }),
                                React.createElement(Icon, { name: "zap", size: 80, className: "absolute -right-4 -top-4 opacity-20 animate-pulse" }),
                                React.createElement('h3', { className: "text-sm font-bold mb-1 opacity-90 uppercase tracking-wider" }, "MISSIONS"),
                                React.createElement('div', { className: "flex items-baseline gap-2 relative z-10" },
                                    React.createElement('input', { type: "number", value: globalSettings.pilotMissionAmount, onChange: e => setGlobalSettings({...globalSettings, pilotMissionAmount: parseInt(e.target.value)}), className: "bg-transparent text-4xl md:text-5xl font-black w-24 md:w-32 outline-none border-b-2 border-white/40 focus:border-white transition-all" }),
                                    React.createElement('span', { className: "text-xl font-bold" }, "€")
                                )
                            ),
                            React.createElement('div', { className: "bg-gradient-to-br from-purple-600 via-purple-700 to-pink-800 rounded-[2rem] p-6 md:p-8 text-white shadow-2xl relative overflow-hidden border border-purple-500/30 hover:shadow-3xl transition-all duration-300 hover:scale-[1.02]" },
                                React.createElement('div', { className: "absolute inset-0 bg-gradient-to-br from-white/10 to-transparent" }),
                                React.createElement(Icon, { name: "briefcase", size: 80, className: "absolute -right-4 -top-4 opacity-20 animate-pulse" }),
                                React.createElement('h3', { className: "text-sm font-bold mb-1 opacity-90 uppercase tracking-wider" }, "CONTRATS"),
                                React.createElement('div', { className: "flex items-baseline gap-2 relative z-10" },
                                    React.createElement('input', { type: "number", value: globalSettings.contractAmount, onChange: e => setGlobalSettings({...globalSettings, contractAmount: parseInt(e.target.value)}), className: "bg-transparent text-4xl md:text-5xl font-black w-24 md:w-32 outline-none border-b-2 border-white/40 focus:border-white transition-all" }),
                                    React.createElement('span', { className: "text-xl font-bold" }, "€")
                                )
                            )
                        ),
                        React.createElement('button', { onClick: saveSettings, className: "w-full py-4 bg-gradient-to-r from-slate-900 to-slate-800 text-white rounded-2xl font-bold shadow-xl hover:shadow-2xl active:scale-95 transition-all duration-300 hover:scale-[1.02] border border-slate-700" }, "SAUVEGARDER"),
                        
                        // Exceptions Card View
                        React.createElement('div', { className: "grid grid-cols-1 gap-3" },
                            users.filter(u => u.role !== 'admin').map(u => 
                                React.createElement(CardItem, { key: u.id, statusColor: "bg-yellow-400" },
                                    React.createElement('div', { className: "flex flex-col md:flex-row justify-between items-center gap-3 pl-2" },
                                        React.createElement('div', { className: "text-center md:text-left" },
                                            React.createElement('h4', { className: "font-black text-slate-800" }, u.name),
                                            React.createElement('p', { className: "text-xs font-bold text-slate-400" }, "Personnalisation")
                                        ),
                                        React.createElement('div', { className: "flex gap-3 w-full md:w-auto" },
                                            React.createElement('div', { className: "bg-slate-50 p-2 rounded-xl text-center flex-1" },
                                                React.createElement('p', { className: "text-[9px] text-blue-600 font-bold" }, "MISS."),
                                                React.createElement('input', { type: "number", placeholder: globalSettings.pilotMissionAmount, defaultValue: u.customPilotRate, onBlur: e => handleUserRateChange(u.id, 'customPilotRate', e.target.value), className: "w-full bg-transparent text-center font-bold outline-none text-slate-900 text-lg" })
                                            ),
                                            React.createElement('div', { className: "bg-slate-50 p-2 rounded-xl text-center flex-1" },
                                                React.createElement('p', { className: "text-[9px] text-purple-600 font-bold" }, "CONT."),
                                                React.createElement('input', { type: "number", placeholder: globalSettings.contractAmount, defaultValue: u.customContractRate, onBlur: e => handleUserRateChange(u.id, 'customContractRate', e.target.value), className: "w-full bg-transparent text-center font-bold outline-none text-slate-900 text-lg" })
                                            )
                                        )
                                    )
                                )
                            )
                        )
                    ),

                    // --- ONGLET CORBEILLE (Card View) ---
                    currentTab === 'trash' && React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-3" },
                        trashOrders.map(o => React.createElement(CardItem, { key: o.id, statusColor: "bg-red-500" },
                            React.createElement('div', { className: "pl-2" },
                                React.createElement('h3', { className: "font-black text-slate-800" }, o.companyName),
                                React.createElement('div', { className: "bg-red-50 text-red-600 p-3 rounded-lg text-xs font-medium mt-2 italic border border-red-100" }, `"${o.deleteReason}"`),
                                React.createElement('div', { className: "flex justify-end gap-2 mt-4" },
                                    React.createElement('button', { onClick: () => handlePreviewAndRead(o, 'Mission'), className: "px-4 py-2 bg-slate-100 text-slate-600 rounded-xl text-xs font-bold" }, "Voir"),
                                    React.createElement('button', { onClick: () => handleDeletionApproval(o.id, false), className: "px-4 py-2 bg-slate-100 text-slate-600 rounded-xl text-xs font-bold" }, "Refuser"),
                                    React.createElement('button', { onClick: () => handleDeletionApproval(o.id, true), className: "px-4 py-2 bg-red-600 text-white rounded-xl text-xs font-bold shadow-md" }, "Supprimer")
                                )
                            )
                        ))
                    ),

                    // --- ONGLET CONFIG ---
                    currentTab === 'settings' && React.createElement('div', { className: "bg-white p-5 rounded-[2rem] border border-slate-100 space-y-4 shadow-sm" },
                        React.createElement('h3', { className: "font-bold" }, "Infos Société & PDF"),
                        React.createElement('input', { placeholder: "Nom Société", value: globalSettings.myCompanyName || '', onChange: e => setGlobalSettings({...globalSettings, myCompanyName: e.target.value}), className: "w-full p-4 bg-slate-50 rounded-2xl outline-none font-bold" }),
                        React.createElement('textarea', { placeholder: "Adresse", value: globalSettings.myAddress || '', onChange: e => setGlobalSettings({...globalSettings, myAddress: e.target.value}), className: "w-full p-4 bg-slate-50 rounded-2xl outline-none font-medium h-24" }),
                        React.createElement('div', { className: "grid grid-cols-2 gap-3" },
                            React.createElement('div', { className: "bg-slate-50 p-4 rounded-2xl text-center border-2 border-dashed border-slate-200 relative" },
                                React.createElement('p', { className: "text-[10px] font-bold text-slate-400 uppercase mb-2" }, "Logo"),
                                globalSettings.logo ? React.createElement('img', { src: globalSettings.logo, className: "h-10 mx-auto" }) : React.createElement(Icon, { name: "image", className: "mx-auto text-slate-300" }),
                                React.createElement('input', { type: "file", onChange: e => handleImageUpload(e, 'logo'), className: "absolute inset-0 opacity-0" })
                            ),
                            React.createElement('div', { className: "bg-slate-50 p-4 rounded-2xl text-center border-2 border-dashed border-slate-200 relative" },
                                React.createElement('p', { className: "text-[10px] font-bold text-slate-400 uppercase mb-2" }, "Cachet"),
                                globalSettings.stamp ? React.createElement('img', { src: globalSettings.stamp, className: "h-10 mx-auto" }) : React.createElement(Icon, { name: "check", className: "mx-auto text-slate-300" }),
                                React.createElement('input', { type: "file", onChange: e => handleImageUpload(e, 'stamp'), className: "absolute inset-0 opacity-0" })
                            )
                        ),
                        React.createElement('button', { onClick: saveSettings, className: "w-full bg-slate-900 text-white py-4 rounded-2xl font-bold shadow-lg" }, "ENREGISTRER")
                    )
                )
            )
        )
    );
}
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
